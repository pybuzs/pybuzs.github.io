<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>MySQLé¢è¯•é¢˜</title>
    <url>/2025/06/23/Interview/MySQL%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
    <content><![CDATA[MySQLé¢è¯•é¢˜
æ­¤ç¬”è®°ä¸ºæœ¬äººå¤‡è€ƒé¢è¯•æ—¶æ•´ç†ï¼Œå†…å®¹å¤šæºäºç½‘ç»œæœé›†ï¼Œä»…ä½œåç»­æŸ¥é˜…ä¹‹ç”¨ï¼Œæ— ç›ˆåˆ©æ„å›¾ã€‚è‹¥æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ã€‚
å‚è€ƒèµ„æ–™ï¼š
https://javaguide.cn/
https://www.xiaolincoding.com/
https://pdai.tech
https://javabetter.cn/

ä¸€ã€MySQLåŸºç¡€1ã€æ•°æ®åº“ä¸‰å¤§èŒƒå¼æŸ¥çœ‹ç­”æ¡ˆ
1NF è¦æ±‚å­—æ®µå€¼å¿…é¡»æ˜¯ä¸å¯å†åˆ†çš„åŸå­å€¼ã€‚
åä¾‹ï¼šç”¨æˆ·ä¿¡æ¯è¡¨ä¸­åœ°å€å­—æ®µå­˜å‚¨ â€œåŒ—äº¬å¸‚æµ·æ·€åŒºâ€ï¼Œæœªæ‹†åˆ†ä¸ºçœã€å¸‚ã€åŒºï¼Œè¿å 1NFï¼›æ­£ä¾‹ï¼šæ‹†åˆ†ä¸ºprovinceã€cityã€districtï¼Œæ¯ä¸ªå­—æ®µç‹¬ç«‹å­˜å‚¨ã€‚

2NF 1NFçš„åŸºç¡€ä¸Šï¼Œè¦æ±‚éä¸»å±æ€§å®Œå…¨ä¾èµ–ä¸»é”®ï¼Œé¿å…éƒ¨åˆ†ä¾èµ–ï¼ˆå¦‚è®¢å•æ˜ç»†æ‹†åˆ†ï¼‰ã€‚
åœºæ™¯ï¼šè®¢å•æ˜ç»†è¡¨ï¼ˆï¼ˆè®¢å•å·+å•†å“IDä¸ºä¸»é”®ï¼‰+ é‡‘é¢ ï¼‰ï¼Œè‹¥å­—æ®µè®¢å•é‡‘é¢ä»…ä¾èµ–è®¢å•å·ï¼Œåˆ™å­˜åœ¨éƒ¨åˆ†ä¾èµ–ï¼ˆéä¸»å±æ€§è®¢å•é‡‘é¢ä¸ä¾èµ–å•†å“IDï¼‰ï¼Œè¿å 2NFï¼›ä¼˜åŒ–ï¼šæ‹†åˆ†ä¸ºè®¢å•è¡¨ï¼ˆè®¢å•å·ã€é‡‘é¢ï¼‰å’Œè®¢å•æ˜ç»†è¡¨ï¼ˆè®¢å•å·ã€å•†å“ IDã€æ•°é‡ï¼‰ã€‚

3NF 2NFçš„åŸºç¡€ä¸Šï¼Œéä¸»é”®å­—æ®µä¹‹é—´ä¸èƒ½æœ‰ä¾èµ–å…³ç³»ï¼Œæ¶ˆé™¤ä¼ é€’ä¾èµ–ï¼Œå¦‚å­¦ç”Ÿè¡¨ä¸ç­çº§è¡¨åˆ†ç¦»ã€‚
åä¾‹ï¼šå­¦ç”Ÿè¡¨ï¼ˆå­¦ç”Ÿ IDï¼Œå§“åï¼Œç­çº§ IDï¼Œç­çº§åœ°å€ï¼‰ä¸­ï¼Œç­çº§åœ°å€ä¾èµ–ç­çº§IDï¼Œå½¢æˆ â€œå­¦ç”Ÿ IDâ†’ç­çº§ IDâ†’ç­çº§åœ°å€â€ çš„ä¼ é€’ä¾èµ–ï¼Œè¿å 3NFï¼›ä¼˜åŒ–ï¼šæ‹†åˆ†ä¸ºå­¦ç”Ÿè¡¨ï¼ˆå­¦ç”Ÿ IDï¼Œå§“åï¼Œç­çº§ IDï¼‰å’Œç­çº§è¡¨ï¼ˆç­çº§ IDï¼Œç­çº§åœ°å€ï¼‰ã€‚




2ã€char å’Œ varchar çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼ŸæŸ¥çœ‹ç­”æ¡ˆ


ç‰¹æ€§
CHAR
VARCHAR



å­˜å‚¨æ–¹å¼
å›ºå®šé•¿åº¦
å¯å˜é•¿åº¦


ç©ºé—´å ç”¨
å§‹ç»ˆå ç”¨å®šä¹‰é•¿åº¦ï¼ˆå¯èƒ½æµªè´¹ï¼‰
ä»…å ç”¨å®é™…æ•°æ®é•¿åº¦ + é•¿åº¦æ ‡è¯†


å­˜å‚¨å¼€é”€
æ— é¢å¤–å¼€é”€
é¢å¤–1~2å­—èŠ‚å­˜å‚¨é•¿åº¦


æŸ¥è¯¢é€Ÿåº¦
æ›´å¿«ï¼ˆå›ºå®šé•¿åº¦ç›´æ¥å®šä½ï¼‰
ç¨æ…¢ï¼ˆéœ€è®¡ç®—ä½ç½®ï¼‰


é€‚ç”¨åœºæ™¯
é•¿åº¦å›ºå®šçš„çŸ­å­—ç¬¦ä¸²ï¼ˆå¦‚MD5ï¼‰
é•¿åº¦å˜åŒ–å¤§çš„å­—ç¬¦ä¸²ï¼ˆå¦‚åœ°å€ï¼‰


ç©ºæ ¼å¤„ç†
å­˜å…¥æ—¶è¡¥è¶³ç©ºæ ¼ï¼ŒæŸ¥è¯¢æ—¶å»é™¤
åŸæ ·å­˜å‚¨å’Œè¿”å›



CHAR æ˜¯å®šé•¿åˆ†é…ï¼Œé€‚åˆå­˜å‚¨å›ºå®šé•¿åº¦çŸ­å­—ç¬¦ä¸²ï¼ˆå¦‚éªŒè¯ç ï¼‰ï¼ŒæŸ¥è¯¢æ›´å¿«ä½†å¯èƒ½æµªè´¹ç©ºé—´ï¼›
VARCHAR æ˜¯å˜é•¿å­˜å‚¨ï¼Œé€‚åˆé•¿åº¦ä¸ç¡®å®šçš„æ•°æ®ï¼ˆå¦‚ç”¨æˆ·åï¼‰ï¼Œç©ºé—´åˆ©ç”¨ç‡é«˜ä½†éœ€é¢å¤–é•¿åº¦æ ‡è¯†ã€‚



3ã€varchar (100)å’Œ varchar (10)çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼ŸæŸ¥çœ‹ç­”æ¡ˆ1. å­˜å‚¨æœºåˆ¶
ä¸¤è€…ç›¸åŒç‚¹ï¼š
éƒ½æ˜¯å¯å˜é•¿åº¦å­—ç¬¦ä¸²ç±»å‹
å®é™…å­˜å‚¨ç©ºé—´ &#x3D; å­—ç¬¦æ•° + é•¿åº¦æ ‡è¯†å­—èŠ‚ï¼ˆ1-2å­—èŠ‚ï¼‰
å­˜å‚¨â€Helloâ€æ—¶éƒ½å ç”¨ 5 å­—èŠ‚ + 1 å­—èŠ‚å¼€é”€ &#x3D; 6 å­—èŠ‚å­˜å‚¨ç›¸åŒçš„å­—ç¬¦ä¸²ï¼Œæ‰€å ç”¨ç£ç›˜çš„å­˜å‚¨ç©ºé—´å…¶å®æ˜¯ä¸€æ ·çš„


å·®å¼‚ï¼š
varchar (100) æœ€å¤šå­˜å‚¨100å­—ç¬¦
varchar (10) æœ€å¤šå­˜å‚¨10å­—ç¬¦



2. æ€§èƒ½å½±å“
å†…å­˜åˆ†é…ï¼š
æ’åºæ“ä½œæ—¶ï¼Œæ•°æ®åº“å¯èƒ½æŒ‰æœ€å¤§é•¿åº¦åˆ†é…å†…å­˜
VARCHAR(100) çš„åˆ—å¯èƒ½æ¯” VARCHAR(10) å¤šæ¶ˆè€— 10 å€å†…å­˜


ç´¢å¼•æ•ˆç‡ï¼š
ç´¢å¼•å¤§å°ï¼šVARCHAR(100) ç´¢å¼•å¤§çº¦æ˜¯ VARCHAR(10) ç´¢å¼•çš„ 10 å€




é€‚ç”¨åœºæ™¯ï¼š
varchar(10)ï¼šçŸ­æ–‡æœ¬ï¼ˆå¦‚éªŒè¯ç ã€å•†å“ç¼–ç å‰å‡ ä½ï¼‰ï¼›
varchar(100)ï¼šè¾ƒé•¿æ–‡æœ¬ï¼ˆå¦‚ç”¨æˆ·åã€æ–‡ç« æ ‡é¢˜ã€åœ°å€ç‰‡æ®µï¼‰ã€‚





4ã€inå’Œexistsçš„åŒºåˆ«ï¼ŸæŸ¥çœ‹ç­”æ¡ˆIN è¿ç®—ç¬¦å…ˆæ‰§è¡Œå­æŸ¥è¯¢ï¼Œå°†ç»“æœç¼“å­˜åˆ°ä¸´æ—¶è¡¨ï¼Œç„¶åæ£€æŸ¥ä¸»æŸ¥è¯¢çš„å€¼æ˜¯å¦åœ¨è¿™ä¸ªä¸´æ—¶è¡¨ä¸­ã€‚
exists è¿ç®—ç¬¦å¯¹äºä¸»æŸ¥è¯¢çš„æ¯ä¸€è¡Œï¼Œéƒ½ä¼šæ‰§è¡Œä¸€æ¬¡å­æŸ¥è¯¢æ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒ¹é…è®°å½•
åŒºåˆ«


ç‰¹æ€§
IN
EXISTS



å·¥ä½œåŸç†
æ£€æŸ¥å€¼æ˜¯å¦åœ¨ç»“æœé›†ä¸­
æ£€æŸ¥å­æŸ¥è¯¢æ˜¯å¦è¿”å›ä»»ä½•è¡Œ


æ‰§è¡Œé¡ºåº
å…ˆæ‰§è¡Œå­æŸ¥è¯¢ï¼Œå†æ‰§è¡Œä¸»æŸ¥è¯¢
ä¸»æŸ¥è¯¢çš„æ¯ä¸€è¡Œéƒ½æ‰§è¡Œå­æŸ¥è¯¢


æ€§èƒ½ç‰¹ç‚¹
å­æŸ¥è¯¢ç»“æœé›†å°æ—¶é«˜æ•ˆ
ä¸»æŸ¥è¯¢ç»“æœé›†å°æ—¶é«˜æ•ˆ


NULL å¤„ç†
NULL IN (ç»“æœé›†) æ€»æ˜¯è¿”å› UNKNOWN
ä¸å—å­æŸ¥è¯¢ä¸­ NULL å€¼å½±å“


é€‚ç”¨åœºæ™¯
é™æ€å€¼åˆ—è¡¨æˆ–å°å‹ç»“æœé›†
å…³è”å­æŸ¥è¯¢æˆ–å¤§å‹ç»“æœé›†


å¯è¯»æ€§
æ›´ç›´è§‚ï¼Œæ˜“äºç†è§£
å¯¹åˆå­¦è€…ç¨å¤æ‚




5ã€æ€ä¹ˆå­˜å‚¨ emoji?æŸ¥çœ‹ç­”æ¡ˆå› ä¸º emojiï¼ˆğŸ˜Šï¼‰æ˜¯ 4 ä¸ªå­—èŠ‚çš„ UTF-8 å­—ç¬¦ï¼Œè€Œ MySQL çš„ utf8 å­—ç¬¦é›†åªæ”¯æŒæœ€å¤š 3 ä¸ªå­—èŠ‚çš„ UTF-8 å­—ç¬¦ï¼Œæ‰€ä»¥åœ¨ MySQL ä¸­å­˜å‚¨ emoji æ—¶ï¼Œéœ€è¦ä½¿ç”¨ utf8mb4 å­—ç¬¦é›†ã€‚
ALTER TABLE mytable CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

MySQL 8.0 å·²ç»é»˜è®¤æ”¯æŒ utf8mb4 å­—ç¬¦é›†ï¼Œå¯ä»¥é€šè¿‡ SHOW VARIABLES WHERE Variable_name LIKE &#39;character\_set\_%&#39; OR Variable_name LIKE &#39;collation%&#39;; æŸ¥çœ‹ã€‚


6ã€dropã€delete ä¸ truncate çš„åŒºåˆ«ï¼ŸæŸ¥çœ‹ç­”æ¡ˆDELETE æ”¯æŒè¡Œçº§åˆ é™¤ï¼Œå¯ä»¥å¸¦ WHERE æ¡ä»¶ï¼Œå¯ä»¥å›æ»šã€‚
DROP æ˜¯ç‰©ç†åˆ é™¤ï¼Œç”¨æ¥åˆ é™¤æ•´å¼ è¡¨ï¼ŒåŒ…æ‹¬è¡¨ç»“æ„ï¼Œä¸”ä¸èƒ½å›æ»šã€‚
TRUNCATE ç”¨äºæ¸…ç©ºè¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œä½†ä¼šä¿ç•™è¡¨ç»“æ„ï¼Œä¸èƒ½å›æ»šã€‚


7ã€UNION ä¸ UNION ALL çš„åŒºåˆ«ï¼ŸæŸ¥çœ‹ç­”æ¡ˆUNION ä¼šè‡ªåŠ¨å»é™¤åˆå¹¶åç»“æœé›†ä¸­çš„é‡å¤è¡Œã€‚UNION ALL ä¸ä¼šå»é‡ï¼Œä¼šå°†æ‰€æœ‰ç»“æœé›†åˆå¹¶èµ·æ¥ã€‚


8ã€count(1)ã€count(*) ä¸ count(åˆ—å) çš„åŒºåˆ«ï¼ŸæŸ¥çœ‹ç­”æ¡ˆ
count(*)ï¼š


count(*)ä¼šç»Ÿè®¡ç»“æœé›†ä¸­æ‰€æœ‰è¡Œçš„æ•°é‡ï¼ŒåŒ…æ‹¬æ‰€æœ‰åˆ—ï¼Œä¸å¿½ç•¥ä»»ä½•è¡Œï¼Œå³ä½¿æŸäº›åˆ—åŒ…å«NULLå€¼ã€‚
å®ƒæ˜¯ä¸€ä¸ªæ ‡å‡†çš„SQLå‡½æ•°ï¼Œç”¨äºç»Ÿè®¡è¡¨ä¸­çš„æ€»è¡Œæ•°ã€‚


count(1)ï¼š


count(1)ä¸­çš„1æ˜¯ä¸€ä¸ªå¸¸é‡å€¼ï¼Œè¡¨ç¤ºå¯¹æ¯ä¸€è¡Œè¿›è¡Œè®¡æ•°ã€‚
ç”±äºå¸¸é‡å€¼æ°¸è¿œä¸ä¸ºNULLï¼Œå› æ­¤count(1)å®é™…ä¸Šä¸count(*)ä¸€æ ·è®¡ç®—æ‰€æœ‰è¡Œã€‚
åœ¨MySQLä¸­ï¼Œä¼˜åŒ–å™¨é€šå¸¸ä¼šå°†count(1)ä¼˜åŒ–ä¸ºä¸count(*)ç›¸åŒçš„æ‰§è¡Œè®¡åˆ’ã€‚


count(åˆ—å)ï¼š


count(åˆ—å)ä¼šç»Ÿè®¡ç»“æœé›†ä¸­æŒ‡å®šåˆ—éNULLå€¼çš„æ•°é‡ã€‚
å¦‚æœåˆ—ä¸­çš„æ‰€æœ‰å€¼éƒ½æ˜¯éç©ºçš„ï¼Œé‚£ä¹ˆcount(åˆ—å)çš„ç»“æœä¸count(*)çš„ç»“æœç›¸åŒã€‚
ä½†æ˜¯ï¼Œå¦‚æœåˆ—ä¸­æœ‰ç©ºå€¼ï¼ˆNULLï¼‰ï¼Œé‚£ä¹ˆcount(åˆ—å)çš„ç»“æœä¼šå°äºcount(*)çš„ç»“æœã€‚



9ã€NULL å’Œ â€˜â€™ çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼ŸæŸ¥çœ‹ç­”æ¡ˆ1. æœ¬è´¨å«ä¹‰
NULLï¼šè¡¨ç¤º â€œå€¼ä¸å­˜åœ¨â€æˆ–â€œæœªçŸ¥â€ï¼Œç›¸å½“äº â€œæ— å€¼â€ã€‚å®ƒä¸æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œä¹Ÿä¸æ˜¯æ•°å­— 0ï¼Œè€Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ ‡è®°ã€‚
å¦‚æœåˆ—å…è®¸ NULL ä¸”æœªæŒ‡å®šé»˜è®¤å€¼ï¼Œåˆ™æ’å…¥æ—¶é»˜è®¤ä¸º NULLã€‚

&#39;&#39;ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰ï¼šè¡¨ç¤º â€œç©ºå€¼â€ï¼Œæ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 0 çš„æœ‰æ•ˆå­—ç¬¦ä¸²ï¼Œæ˜ç¡®è¡¨ç¤º â€œè¿™é‡Œæœ‰ä¸€ä¸ªç©ºå­—ç¬¦ä¸²â€ã€‚
éœ€è¦æ˜¾å¼è®¾ç½®é»˜è®¤å€¼ä¸º &#39;&#39;ï¼ˆä¾‹å¦‚ï¼šALTER TABLE tbl MODIFY col VARCHAR(10) DEFAULT &#39;&#39;;ï¼‰ã€‚


2. å­˜å‚¨ç©ºé—´
NULLï¼šé€šå¸¸éœ€è¦é¢å¤– 1 ä½ï¼ˆbitï¼‰æ¥æ ‡è®°å­—æ®µæ˜¯å¦ä¸º NULLï¼ˆå¯¹äºå…è®¸ NULL çš„åˆ—ï¼‰ã€‚

&#39;&#39;ï¼š
å–å†³äºå­˜å‚¨å¼•æ“å’Œå­—ç¬¦é›†ã€‚ä¾‹å¦‚ï¼š

åœ¨ UTF-8 ä¸­ï¼Œ&#39;&#39; å ç”¨ 0 å­—èŠ‚ï¼›
åœ¨ varchar ä¸­ï¼Œå¯èƒ½éœ€è¦ 1~2 å­—èŠ‚å­˜å‚¨é•¿åº¦ä¿¡æ¯ï¼ˆå³ä½¿é•¿åº¦ä¸º 0ï¼‰ã€‚



3. æŸ¥è¯¢ä¸æ¯”è¾ƒ
**NULL**ï¼š

ä¸èƒ½ç”¨ = ç›´æ¥æ¯”è¾ƒï¼Œå¿…é¡»ç”¨ IS NULL æˆ– IS NOT NULLã€‚
WHERE column IS NULL;  -- æ­£ç¡®WHERE column = NULL;   -- é”™è¯¯ï¼æ°¸è¿œè¿”å› false

åœ¨èšåˆå‡½æ•°ï¼ˆå¦‚ COUNT()ã€SUM()ï¼‰ä¸­ä¼šè¢«å¿½ç•¥ï¼ˆé™¤éç”¨ COUNT(*)ï¼‰ã€‚



**&#39;&#39;**ï¼š

å¯ä»¥ç”¨ = ç›´æ¥æ¯”è¾ƒã€‚
WHERE column = &#x27;&#x27;;  -- æ­£ç¡®

åœ¨èšåˆå‡½æ•°ä¸­ä¼šè¢«è§†ä¸ºæœ‰æ•ˆå€¼ã€‚




å…³é”®åˆ¤æ–­æ ‡å‡†ï¼šå¦‚æœæŸå­—æ®µå¿…é¡»æœ‰å€¼ï¼ˆå³ä½¿æ˜¯ç©ºï¼‰ï¼Œç”¨ &#39;&#39;ï¼›å¦‚æœå¯èƒ½æ— éœ€èµ‹å€¼ï¼Œç”¨ NULLã€‚


10ã€mysql çš„æ·±åº¦åˆ†é¡µå¦‚ä½•ä¼˜åŒ–æŸ¥çœ‹ç­”æ¡ˆæ·±åº¦åˆ†é¡µæ˜¯æŒ‡å½“æŸ¥è¯¢ç»“æœé›†å¾ˆå¤§æ—¶ï¼ˆå¦‚ LIMIT 1000000, 10ï¼‰ï¼ŒMySQL éœ€è¦æ‰«æå¤§é‡æ•°æ®æ‰èƒ½è¿”å›å°‘é‡ç»“æœçš„æ€§èƒ½é—®é¢˜åœºæ™¯ã€‚
æ–¹æ¡ˆ1ï¼šæ¸¸æ ‡åˆ†é¡µ
åŸç†ï¼šè®°å½•ä¸Šä¸€é¡µæœ€åä¸€æ¡æ•°æ®çš„ æ ‡è¯†ï¼ˆå¦‚ IDï¼‰ï¼Œç”¨ WHERE ä»£æ›¿ OFFSETã€‚

-- ç¬¬1é¡µï¼šåˆå§‹æŸ¥è¯¢SELECT * FROM t ORDER BY id LIMIT 10; -- è®°æœ€åä¸€æ¡ ID ä¸º last_id  -- ç¬¬2é¡µï¼šåŸºäºæ¸¸æ ‡SELECT * FROM t WHERE id &lt; last_id ORDER BY id DESC LIMIT 10; 


ä¼˜ç‚¹ï¼š

æ—¶é—´å¤æ‚åº¦ O(1)
æ— æ€§èƒ½è¡°å‡
æ”¯æŒé«˜å¹¶å‘


é™åˆ¶ï¼š

åªèƒ½é¡ºåºç¿»é¡µï¼Œä¸èƒ½è·³é¡µï¼Œé€‚åˆ APP æ»šåŠ¨åŠ è½½ã€‚
éœ€æœ‰åºä¸”å”¯ä¸€çš„åˆ—ï¼ˆå¦‚è‡ªå¢IDã€æ—¶é—´æˆ³ï¼‰



æ–¹æ¡ˆ2ï¼šè¦†ç›–ç´¢å¼• + å»¶è¿Ÿå…³è”
åŸç†ï¼šåˆ©ç”¨ç´¢å¼•å…ˆè·å–ä¸»é”®ï¼ˆå‡å°‘æ‰«æé‡ï¼‰ï¼Œå†å›è¡¨å–å…¨å­—æ®µã€‚
SELECT * FROM ordersINNER JOIN (    SELECT id FROM orders    ORDER BY create_time DESC    LIMIT 1000000, 10  -- ç´¢å¼•è¦†ç›–æ‰«æ) AS tmp USING(id);-- USING(id) ç­‰ä»·äº ON table1.id = table2.id 

ä¼˜åŒ–æ•ˆæœï¼š

ç´¢å¼•æ‰«æä»£æ›¿å…¨è¡¨æ‰«æ
å‡å°‘å›è¡¨æ•°æ®é‡
æ€§èƒ½æå‡ 5-10 å€



æ–¹æ¡ˆ3ï¼šèŒƒå›´åˆ†é¡µ
åŸç†ï¼šé€šè¿‡ WHERE æ¡ä»¶ç¼©å°æ‰«æèŒƒå›´
SELECT * FROM t WHERE create_time BETWEEN &#x27;2025-01-01&#x27; AND &#x27;2025-01-31&#x27; ORDER BY id LIMIT 10;

é€‚ç”¨åœºæ™¯ï¼š

æ—¶é—´èŒƒå›´æ˜ç¡®çš„æ•°æ®
åˆ†åŒºè¡¨çš„åˆ†åŒºé”®æŸ¥è¯¢





äºŒã€æ•°æ®åº“æ¶æ„1ã€è¯´è¯´ MySQL çš„åŸºç¡€æ¶æ„ï¼ŸæŸ¥çœ‹ç­”æ¡ˆMySQL é‡‡ç”¨åˆ†å±‚æ¶æ„ï¼Œä¸»è¦åŒ…æ‹¬è¿æ¥å±‚ã€æœåŠ¡å±‚ã€å’Œå­˜å‚¨å¼•æ“å±‚ã€‚
ä¸‹å›¾æ˜¯ MySQL çš„ä¸€ä¸ªç®€è¦æ¶æ„å›¾ï¼Œä»ä¸‹å›¾ä½ å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°å®¢æˆ·ç«¯çš„ä¸€æ¡ SQL è¯­å¥åœ¨ MySQL å†…éƒ¨æ˜¯å¦‚ä½•æ‰§è¡Œçš„ã€‚

â‘ ã€è¿æ¥å±‚ä¸»è¦è´Ÿè´£å®¢æˆ·ç«¯è¿æ¥çš„ç®¡ç†ï¼ŒåŒ…æ‹¬éªŒè¯ç”¨æˆ·èº«ä»½ã€æƒé™æ ¡éªŒã€è¿æ¥ç®¡ç†ç­‰ã€‚å¯ä»¥é€šè¿‡æ•°æ®åº“è¿æ¥æ± æ¥æå‡è¿æ¥çš„å¤„ç†æ•ˆç‡ã€‚
â‘¡ã€æœåŠ¡å±‚æ˜¯ MySQL çš„æ ¸å¿ƒï¼Œä¸»è¦è´Ÿè´£æŸ¥è¯¢è§£æã€ä¼˜åŒ–ã€æ‰§è¡Œç­‰æ“ä½œã€‚åœ¨è¿™ä¸€å±‚ï¼ŒSQL è¯­å¥ä¼šç»è¿‡è§£æã€ä¼˜åŒ–å™¨ä¼˜åŒ–ï¼Œç„¶åè½¬å‘åˆ°å­˜å‚¨å¼•æ“æ‰§è¡Œï¼Œå¹¶è¿”å›ç»“æœã€‚è¿™ä¸€å±‚åŒ…å«æŸ¥è¯¢è§£æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œè®¡åˆ’ç”Ÿæˆå™¨ã€æ—¥å¿—æ¨¡å—ç­‰ã€‚
â‘¢ã€å­˜å‚¨å¼•æ“å±‚è´Ÿè´£æ•°æ®çš„å®é™…å­˜å‚¨å’Œæå–ã€‚MySQL æ”¯æŒå¤šç§å­˜å‚¨å¼•æ“ï¼Œå¦‚ InnoDBã€MyISAMã€Memory ç­‰ã€‚
binlogå†™å…¥åœ¨å“ªä¸€å±‚ï¼Ÿ
binlog åœ¨æœåŠ¡å±‚ï¼Œè´Ÿè´£è®°å½• SQL è¯­å¥çš„å˜åŒ–ã€‚å®ƒè®°å½•äº†æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œæ›´æ”¹çš„æ“ä½œï¼Œç”¨äºæ•°æ®æ¢å¤ã€ä¸»ä»å¤åˆ¶ç­‰ã€‚


2ã€ä¸€æ¡ SQL æŸ¥è¯¢è¯­å¥åœ¨ MySQL ä¸­çš„å®Œæ•´æ‰§è¡Œè¿‡ç¨‹æŸ¥çœ‹ç­”æ¡ˆæ¡ˆä¾‹ SQLSELECT name, age FROM employees WHERE department = &#x27;Sales&#x27; AND salary &gt; 5000 ORDER BY hire_date DESC LIMIT 10;


æ‰§è¡Œè¿‡ç¨‹è¯¦è§£1. è¿æ¥é˜¶æ®µ (Connector)
ä½œç”¨ï¼šå»ºç«‹å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„è¿æ¥
æ¡ˆä¾‹è¿‡ç¨‹ï¼š
åº”ç”¨ç¨‹åºï¼ˆå¦‚Javaç¨‹åºï¼‰é€šè¿‡JDBCé©±åŠ¨è¿æ¥åˆ°MySQL
éªŒè¯ç”¨æˆ·å&#x2F;å¯†ç ï¼ˆå¦‚ï¼šjdbc:mysql://localhost:3306/companyï¼‰
æ£€æŸ¥æƒé™ï¼ˆç¡®è®¤ç”¨æˆ·æœ‰employeesè¡¨çš„SELECTæƒé™ï¼‰
å»ºç«‹è¿æ¥çº¿ç¨‹ï¼ˆshow processlistå¯æŸ¥çœ‹ï¼‰



2. æŸ¥è¯¢ç¼“å­˜ (Query Cache) [MySQL 8.0å·²ç§»é™¤]
MySQL 5.7ä¸­ä»å­˜åœ¨ï¼Œä½†é»˜è®¤ç¦ç”¨


ä½œç”¨ï¼šç¼“å­˜SELECTæŸ¥è¯¢ç»“æœ
æ¡ˆä¾‹è¿‡ç¨‹ï¼š
ç”ŸæˆæŸ¥è¯¢ç¼“å­˜Keyï¼šdepartment=&#39;Sales&#39;, salary&gt;5000, ...
æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦æœ‰å®Œå…¨åŒ¹é…çš„ç»“æœ
è‹¥å­˜åœ¨ç›´æ¥è¿”å›ç»“æœï¼ˆæœ¬æ¡ˆä¾‹å¤§æ¦‚ç‡ä¸ä¼šå‘½ä¸­ï¼Œå› åŒ…å«åŠ¨æ€æ¡ä»¶ï¼‰



3. è§£æå™¨ (Parser)
ä½œç”¨ï¼šè¯­æ³•è§£æï¼Œç”Ÿæˆè§£ææ ‘
æ¡ˆä¾‹è¿‡ç¨‹ï¼š
è¯æ³•åˆ†æï¼šæ‹†åˆ†å…³é”®è¯SELECT â†’ æŸ¥è¯¢å‘½ä»¤name, age â†’ ç›®æ ‡åˆ—FROM employees â†’ æ•°æ®æºWHERE â†’ æ¡ä»¶å¼€å§‹department = &#x27;Sales&#x27; â†’ æ¡ä»¶è¡¨è¾¾å¼...
è¯­æ³•åˆ†æï¼šæ„å»ºè¯­æ³•æ ‘ graph TD
A[SELECT] --&gt; B[ColumnList]
A --&gt; C[FROM]
A --&gt; D[WHERE]
A --&gt; E[ORDER BY]
A --&gt; F[LIMIT]
B --&gt; G[name]
B --&gt; H[age]
C --&gt; I[employees]
D --&gt; J[AND]
J --&gt; K[department=&#x27;Sales&#x27;]
J --&gt; L[salary&gt;5000]
E --&gt; M[hire_date DESC]
F --&gt; N[10]



4. é¢„å¤„ç†å™¨ (Preprocessor)
ä½œç”¨ï¼šè¯­ä¹‰æ£€æŸ¥ï¼Œè¡¨&#x2F;åˆ—è§£æ
æ¡ˆä¾‹è¿‡ç¨‹ï¼š
æ£€æŸ¥employeesè¡¨æ˜¯å¦å­˜åœ¨
éªŒè¯name, age, department, salary, hire_dateåˆ—æ˜¯å¦å­˜åœ¨
è§£æ*ç¬¦å·ï¼ˆæœ¬æ¡ˆä¾‹æœªä½¿ç”¨ï¼‰
æ£€æŸ¥æƒé™ï¼ˆå†æ¬¡ç¡®è®¤SELECTæƒé™ï¼‰



5. ä¼˜åŒ–å™¨ (Optimizer)
ä½œç”¨ï¼šç”Ÿæˆæœ€ä¼˜æ‰§è¡Œè®¡åˆ’

æ¡ˆä¾‹è¿‡ç¨‹ï¼š

ç»Ÿè®¡ä¿¡æ¯åˆ†æï¼š

è¡¨è¡Œæ•°ï¼ˆshow table status like &#39;employees&#39;ï¼‰
ç´¢å¼•åˆ†å¸ƒï¼ˆdepartmentç´¢å¼•ï¼Ÿsalaryç´¢å¼•ï¼Ÿï¼‰


æˆæœ¬ä¼°ç®—ï¼š

å…¨è¡¨æ‰«æ vs ä½¿ç”¨ç´¢å¼•
å‡è®¾å­˜åœ¨idx_dept_salary(department, salary)ç´¢å¼•


æ‰§è¡Œè®¡åˆ’ç”Ÿæˆï¼š
EXPLAIN SELECT ...-- ç»“æœç¤ºä¾‹ï¼šid: 1select_type: SIMPLEtable: employeestype: refkey: idx_dept_salaryrows: 100Extra: Using where; Using filesort
å…³é”®å†³ç­–ï¼š

ä½¿ç”¨idx_dept_salaryç´¢å¼•å¿«é€Ÿå®šä½â€™Salesâ€™éƒ¨é—¨
åœ¨ç´¢å¼•ç»“æœä¸­è¿‡æ»¤salary &gt; 5000
å¯¹ç»“æœé›†è¿›è¡Œæ–‡ä»¶æ’åºï¼ˆfilesortï¼‰
åº”ç”¨LIMIT 10





6. æ‰§è¡Œå™¨ (Executor)
ä½œç”¨ï¼šè°ƒç”¨å­˜å‚¨å¼•æ“æ‰§è¡Œè®¡åˆ’
æ¡ˆä¾‹è¿‡ç¨‹ï¼š
æ‰“å¼€employeesè¡¨
è°ƒç”¨å­˜å‚¨å¼•æ“æ¥å£ï¼š// ä¼ªä»£ç index_read_first(idx_dept_salary, &#x27;Sales&#x27;)while (record = index_read_next()) &#123;    if (record.salary &gt; 5000) &#123;        result_set.add(record.name, record.age);        if (result_set.size() &gt;= 10) break;    &#125;&#125;
å¤„ç†æ’åºï¼š
æ”¶é›†æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è¡Œ
åœ¨å†…å­˜æˆ–ç£ç›˜è¿›è¡Œå¿«é€Ÿæ’åºï¼ˆORDER BY hire_date DESCï¼‰


åº”ç”¨LIMITï¼šå–å‰10æ¡ç»“æœ



7. å­˜å‚¨å¼•æ“ (Storage Engine)
ä½œç”¨ï¼šå®é™…æ•°æ®å­˜å–ï¼ˆä»¥InnoDBä¸ºä¾‹ï¼‰
æ¡ˆä¾‹è¿‡ç¨‹ï¼š
ç´¢å¼•æ‰«æï¼š
ä½¿ç”¨B+æ ‘ç´¢å¼•idx_dept_salaryå®šä½åˆ°ç¬¬ä¸€ä¸ªâ€™Salesâ€™éƒ¨é—¨è®°å½•
æ²¿å¶å­èŠ‚ç‚¹é“¾è¡¨æ‰«æéƒ¨é—¨ä¸ºâ€™Salesâ€™çš„è®°å½•


å›è¡¨æŸ¥è¯¢ï¼š
é€šè¿‡ä¸»é”®è·å–å®Œæ•´è¡Œæ•°æ®ï¼ˆå› SELECTåŒ…å«éç´¢å¼•åˆ—name, age, hire_dateï¼‰


è¿‡æ»¤å¤„ç†ï¼š
å¯¹æ¯æ¡è®°å½•æ£€æŸ¥salary &gt; 5000æ¡ä»¶


æ•°æ®è¿”å›ï¼š
å°†ç¬¦åˆæ¡ä»¶çš„name, age, hire_dateè¿”å›ç»™æ‰§è¡Œå™¨


äº‹åŠ¡æ”¯æŒï¼š
ä¿è¯åœ¨READ COMMITTEDéš”ç¦»çº§åˆ«ä¸‹çœ‹åˆ°ä¸€è‡´çš„æ•°æ®è§†å›¾





8. ç»“æœè¿”å›
ä½œç”¨ï¼šå°†æœ€ç»ˆç»“æœå‘é€ç»™å®¢æˆ·ç«¯

æ¡ˆä¾‹è¿‡ç¨‹ï¼š

æ’åºåçš„ç»“æœé›†æ”¾å…¥ç½‘ç»œç¼“å†²åŒº
é€šè¿‡TCPè¿æ¥é€æ­¥å‘é€ç»™å®¢æˆ·ç«¯
å®¢æˆ·ç«¯ï¼ˆå¦‚MySQLå‘½ä»¤è¡Œï¼‰æ˜¾ç¤ºç»“æœï¼š+----------+-----+| name     | age |+----------+-----+| John Doe | 32  || Jane Smith| 28 |...ï¼ˆå…±10è¡Œï¼‰
æ¸…ç†ä¸´æ—¶èµ„æºï¼ˆæ’åºå†…å­˜ã€æ¸¸æ ‡ç­‰ï¼‰




å…³é”®æµç¨‹æ€»ç»“sequenceDiagram
    participant Client
    participant Connector
    participant Parser
    participant Optimizer
    participant Executor
    participant InnoDB
    
    Client-&gt;&gt;Connector: å‘é€SQLæŸ¥è¯¢
    Connector-&gt;&gt;Parser: æƒé™éªŒè¯åä¼ é€’
    Parser-&gt;&gt;Optimizer: ç”Ÿæˆè§£ææ ‘
    Optimizer-&gt;&gt;Executor: æœ€ä¼˜æ‰§è¡Œè®¡åˆ’
    Executor-&gt;&gt;InnoDB: è°ƒç”¨ç´¢å¼•æ‰«ææ¥å£
    InnoDB-&gt;&gt;Executor: è¿”å›æ•°æ®é¡µ
    Executor-&gt;&gt;InnoDB: è¯·æ±‚å›è¡¨æŸ¥è¯¢
    InnoDB-&gt;&gt;Executor: è¿”å›å®Œæ•´è¡Œæ•°æ®
    Executor-&gt;&gt;Executor: è¿‡æ»¤/æ’åº/LIMIT
    Executor-&gt;&gt;Client: è¿”å›æœ€ç»ˆç»“æœé›†

æ€§èƒ½ä¼˜åŒ–å…³é”®ç‚¹
ç´¢å¼•è®¾è®¡ï¼šåˆ›å»ºå¤åˆç´¢å¼•(department, salary)å¯åŠ é€ŸWHEREè¿‡æ»¤
è¦†ç›–ç´¢å¼•ï¼šè‹¥ç´¢å¼•åŒ…å«æ‰€æœ‰SELECTåˆ—ï¼ˆå¦‚(department, salary, name, age, hire_date)ï¼‰ï¼Œå¯é¿å…å›è¡¨
æ’åºä¼˜åŒ–ï¼šæ·»åŠ hire_dateç´¢å¼•å¯æ¶ˆé™¤filesort
LIMITä¸‹æ¨ï¼šåœ¨å­˜å‚¨å¼•æ“å±‚å°½æ—©åº”ç”¨è¡Œæ•°é™åˆ¶
æ‰¹é‡è¯»å–ï¼šé¡ºåºI&#x2F;Oè¯»å–å¤šä¸ªæ•°æ®é¡µå‡å°‘ç£ç›˜å¯»é“


ğŸ’¡ å®é™…å»ºè®®ï¼šé€šè¿‡EXPLAINåˆ†ææ‰§è¡Œè®¡åˆ’ï¼Œå…³æ³¨typeåˆ—ï¼ˆæ‰«ææ–¹å¼ï¼‰ã€Extraåˆ—ï¼ˆæ’åº&#x2F;ä¸´æ—¶è¡¨ï¼‰ã€rowsåˆ—ï¼ˆæ‰«æè¡Œæ•°ï¼‰ç­‰å…³é”®æŒ‡æ ‡è¿›è¡Œä¼˜åŒ–ã€‚



ä¸‰ã€å­˜å‚¨å¼•æ“æŸ¥çœ‹ç­”æ¡ˆ1ã€è®²ä¸€è®²mysqlçš„å¼•æ“å§ï¼Œä½ æœ‰ä»€ä¹ˆäº†è§£ï¼Ÿ
InnoDBï¼š
InnoDBæ˜¯MySQLçš„é»˜è®¤å­˜å‚¨å¼•æ“ã€‚
å…·æœ‰ACIDäº‹åŠ¡æ”¯æŒã€è¡Œçº§é”ã€å¤–é”®çº¦æŸç­‰ç‰¹æ€§ã€‚
å®ƒé€‚ç”¨äºé«˜å¹¶å‘çš„è¯»å†™æ“ä½œï¼Œæ”¯æŒè¾ƒå¥½çš„æ•°æ®å®Œæ•´æ€§å’Œå¹¶å‘æ§åˆ¶ã€‚


MyISAMï¼š
MyISAMæ˜¯MySQLçš„å¦ä¸€ç§å¸¸è§çš„å­˜å‚¨å¼•æ“ã€‚
å…·æœ‰è¾ƒä½çš„å­˜å‚¨ç©ºé—´å’Œå†…å­˜æ¶ˆè€—ï¼Œé€‚ç”¨äºå¤§é‡è¯»æ“ä½œçš„åœºæ™¯ã€‚
MyISAMä¸æ”¯æŒäº‹åŠ¡ã€è¡Œçº§é”å’Œå¤–é”®çº¦æŸï¼Œå› æ­¤åœ¨å¹¶å‘å†™å…¥å’Œæ•°æ®å®Œæ•´æ€§æ–¹é¢æœ‰ä¸€å®šçš„é™åˆ¶ã€‚


Memoryï¼š
Memoryå¼•æ“å°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œé€‚ç”¨äºå¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„è¯»æ“ä½œï¼Œä½†æ˜¯åœ¨æœåŠ¡å™¨é‡å¯æˆ–å´©æºƒæ—¶æ•°æ®ä¼šä¸¢å¤±ã€‚
ä¸æ”¯æŒäº‹åŠ¡ã€è¡Œçº§é”å’Œå¤–é”®çº¦æŸã€‚





å››ã€ç´¢å¼•1ã€ç´¢å¼•æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆå¥½å¤„ï¼ŸæŸ¥çœ‹ç­”æ¡ˆ
ç´¢å¼•ç±»ä¼¼äºä¹¦ç±çš„ç›®å½•ï¼Œå¯ä»¥å‡å°‘æ‰«æçš„æ•°æ®é‡ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚

å¦‚æœæŸ¥è¯¢çš„æ—¶å€™ï¼Œæ²¡æœ‰ç”¨åˆ°ç´¢å¼•å°±ä¼šå…¨è¡¨æ‰«æï¼Œè¿™æ—¶å€™æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦æ˜¯On

å¦‚æœç”¨åˆ°äº†ç´¢å¼•ï¼Œé‚£ä¹ˆæŸ¥è¯¢çš„æ—¶å€™ï¼Œå¯ä»¥åŸºäºäºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼Œé€šè¿‡ç´¢å¼•å¿«é€Ÿå®šä½åˆ°ç›®æ ‡æ•°æ®ï¼Œ mysql ç´¢å¼•çš„æ•°æ®ç»“æ„ä¸€èˆ¬æ˜¯ b+æ ‘ï¼Œå…¶æœç´¢å¤æ‚åº¦ä¸ºO(logdN)ï¼Œå…¶ä¸­ d è¡¨ç¤ºèŠ‚ç‚¹å…è®¸çš„æœ€å¤§å­èŠ‚ç‚¹ä¸ªæ•°ä¸º d ä¸ªã€‚




2ã€ç´¢å¼•éƒ½åˆ†ç±»æŸ¥çœ‹ç­”æ¡ˆ
ä»åŠŸèƒ½ä¸Šåˆ†
ä¸»é”®ç´¢å¼•
å”¯ä¸€ç´¢å¼•
æ™®é€šç´¢å¼•
è”åˆç´¢å¼•
å…¨æ–‡ç´¢å¼•
ç©ºé—´ç´¢å¼•


ä»å­˜å‚¨ç»“æ„ä¸Šåˆ†
èšç°‡ç´¢å¼•
äºŒçº§ç´¢å¼•ï¼ˆéèšç°‡ç´¢å¼•ï¼‰





3ã€ç´¢å¼•å¤±æ•ˆçš„å‡ ç§æƒ…å†µæŸ¥çœ‹ç­”æ¡ˆ
æŸ¥è¯¢æ¡ä»¶ä½¿ç”¨å‡½æ•°æˆ–è€…è®¡ç®—
ä¸ç¬¦åˆæœ€å·¦å‰ç¼€åŸåˆ™
éšå¼ç±»å‹è½¬æ¢ï¼ˆç±»å‹ä¸åŒ¹é…ï¼‰
likeé€šé…ç¬¦ä»¥â€œ%â€ å¼€å¤´
ä½¿ç”¨ or æ—¶ï¼Œä¸¤è¾¹æœ‰æ²¡æœ‰ç´¢å¼•çš„å­—æ®µ
ä½¿ç”¨is null æˆ– is not null
ä½¿ç”¨not in
ä½¿ç”¨èŒƒå›´(&gt; ,&lt;)æŸ¥è¯¢ 
ä½¿ç”¨ !&#x3D; æˆ–è€… &lt;&gt;







]]></content>
      <categories>
        <category>MySql</category>
      </categories>
      <tags>
        <tag>é¢è¯•é¢˜</tag>
      </tags>
  </entry>
  <entry>
    <title>windowsåŒæ—¶å®‰è£…ä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„Mysql</title>
    <url>/2025/06/23/RandomNotes/windows%E5%90%8C%E6%97%B6%E5%AE%89%E8%A3%85%E4%B8%A4%E4%B8%AA%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AC%E7%9A%84Mysql/</url>
    <content><![CDATA[windowsåŒæ—¶å®‰è£…ä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„Mysql
æœ¬åœ°å·²ç»å®‰è£…äº†mysql-5.7.11 ç‰ˆæœ¬ï¼Œç°åœ¨éœ€è¦å†å®‰è£…ä¸€ä¸ª8ç‰ˆæœ¬çš„MySQLï¼Œç”±æ­¤è®°å½•ä¸€ä¸‹ã€‚

æŸ¥çœ‹æœ¬åœ°mysqlç‰ˆæœ¬

1.ä¸‹è½½MySQL   å®˜ç½‘ä¸‹è½½å†å²ç‰ˆæœ¬åœ°å€ï¼šMySQL :: Download MySQL Community Server (Archived Versions)
   
   é€‰æ‹©ç‰ˆæœ¬åç‚¹å‡»ä¸‹è½½ã€‚
2.ä¸‹è½½å®Œæˆåï¼Œè§£å‹æ–‡ä»¶ã€‚ï¼ˆps:æ³¨æ„å°†å‹ç¼©åŒ…è§£å‹åˆ°å’Œä¹‹å‰ç‰ˆæœ¬ä¸åŒè·¯å¾„ï¼ˆè·¯å¾„è¯·å‹¿åŒ…å«ä¸­æ–‡æˆ–ç©ºæ ¼ï¼‰ï¼‰ã€‚   
3.åˆ›å»º my.ini é…ç½®æ–‡ä»¶ï¼ˆæ”¾åœ¨è§£å‹æ ¹ç›®å½•ï¼Œå¦‚ D:\mysql-8.0.28\my.iniï¼‰   [mysqld]# ç«¯å£ï¼ˆå¦‚ 3307ï¼Œä¸ 5.7 ä¸åŒï¼‰port=3307  # å®‰è£…ç›®å½•basedir=&quot;D:/Application/mysql-8.0.28&quot;# æ•°æ®ç›®å½•datadir=&quot;D:/Application/mysql-8.0.28/data&quot;# æœåŠ¡ç«¯ä½¿ç”¨çš„å­—ç¬¦é›†é»˜è®¤ä¸ºUTF8character-set-server=utf8mb4  # åˆ›å»ºæ–°è¡¨æ—¶å°†ä½¿ç”¨çš„é»˜è®¤å­˜å‚¨å¼•æ“default-storage-engine=INNODB  # MySQL 8.0 è®¤è¯æ’ä»¶ï¼ˆå…¼å®¹æ—§å®¢æˆ·ç«¯ï¼‰default_authentication_plugin=mysql_native_password  [mysql]# è®¾ç½®mysqlå®¢æˆ·ç«¯é»˜è®¤å­—ç¬¦é›†default-character-set=utf8[client]port=3307  default-character-set=utf8mb4  

4.é…ç½®ç¯å¢ƒå˜é‡(å¦‚æœä¹‹å‰é…ç½®äº†ï¼Œæœ‰ä¸¤ä¸ªMySQLç¯å¢ƒå˜é‡ï¼Œå¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œå¯ä»¥ä¸ç”¨é…ç½®)   
5.åˆå§‹åŒ–æ•°æ®åº“   ä»¥ ç®¡ç†å‘˜èº«ä»½ è¿è¡Œå‘½ä»¤æç¤ºç¬¦ï¼ˆCMDï¼‰ã€‚
   
   cd D:\Application\mysql-8.0.28\binmysqld --initialize --console

   
   è®°ä¸‹ root ä¸´æ—¶å¯†ç 
6.å®‰è£… Windows æœåŠ¡   mysqld --install MySQL80 --defaults-file=&quot;D:\Application\mysql-8.0.28\my.ini&quot;

   
7.å¯åŠ¨æœåŠ¡   net start MySQL80

   å¯èƒ½ä¼šå¯åŠ¨å¤±è´¥
   
   è§£å†³ï¼š

Winé”®+Rè¾“å…¥services.msc,æ‰“å¼€æœåŠ¡é¢æ¿ã€‚

å‘ç°å¯æ‰§è¡Œæ–‡ä»¶ç›®å½•æ˜¯5.7çš„åœ°å€ã€‚æœ‰å¯èƒ½æ˜¯å› ä¸ºå¤šä¸ªMySQLç¯å¢ƒå˜é‡å¯¼è‡´ã€‚

è·¯å¾„ä¸å¯¹ï¼Œå¦‚ä½•ä¿®æ”¹ï¼Ÿ
Winé”®+Rè¾“å…¥regeditæ‰“å¼€æ³¨å†Œè¡¨ï¼Œåœ¨HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\MySQL80 ç›®å½•ä¸‹ä¿®æ”¹ImagePathçš„è·¯å¾„ï¼ˆï¼‰ã€‚


é‡å¯å¯åŠ¨æœåŠ¡



8.ç™»å½•MySQL   å¯†ç æ˜¯ä¸Šé¢ç”Ÿæˆçš„ä¸´æ—¶å¯†ç 
   
9.ä¿®æ”¹å¯†ç    ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;å¯†ç &#x27;;

10.ç™»å½•å‡ºç°é”™è¯¯åœ¨ç³»ç»Ÿå‘½ä»¤è¡Œä¸‹

![image-20250623144004660](image-20250623144004660.png)

è§£å†³æ–¹å¼

- åˆ‡æ¢åˆ°å®‰è£…ç›®å½•

  ![image-20250623144053557](image-20250623144053557.png)

- è¿æ¥æ—¶æ·»åŠ  `--ssl-mode=DISABLED` ç¦ç”¨ SSL éªŒè¯ï¼ˆå› ä¸ºMySQL8é»˜è®¤å¼€å¯SSLåŠ å¯†ï¼‰

  mysql -uroot -p -P3307 --ssl-mode=DISABLED

  ![image-20250623144204196](image-20250623144204196.png)

]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>éšç¬”</tag>
      </tags>
  </entry>
  <entry>
    <title>ç³»ç»Ÿå‡çº§</title>
    <url>/2025/06/04/RandomNotes/%E7%B3%BB%E7%BB%9F%E5%8D%87%E7%BA%A7/</url>
    <content><![CDATA[SSHæ¡†æ¶å‡çº§ä¸ºSpringBootå‰è¨€å’Œå‡†å¤‡
å…¬å¸ç³»ç»Ÿä½¿ç”¨æ¡†æ¶ä¸ºSSHï¼ˆSpring + Spring MVC + Hibernate)ï¼Œç°åœ¨è¦æ±‚å‡çº§ä¸ºSpringBootã€‚  
åŸé¡¹ç›®ï¼šSpring 3.1.3 + Hibernate 4.2.21 ä½¿ç”¨jaråŒ…æ–¹å¼  
å‡†å¤‡å‡çº§ä¸ºï¼šSpringBoot2.7.6 +  ä½¿ç”¨mavneç®¡ç†jaråŒ…
Spring Boot 2.xéœ€è¦Spring 5å’ŒHibernate 5.2+ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å‡çº§è¿™äº›ä¾èµ–ã€‚

æ­¥éª¤1. åˆ›å»ºSpring Booté¡¹ç›®   ä½¿ç”¨é˜¿é‡Œäº‘åœ°å€ https://start.aliyun.com/ æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„Spring Boot é¡¹ç›®ã€‚é€‰æ‹© JDK8ã€Mavenã€Spring Boot ç‰ˆæœ¬2.7.6ã€‚
   ç›®å½•ç»“æ„ä¸ºï¼š
   
2. jaråŒ…ç”¨mavenæ›¿æ¢å°†åŸé¡¹ç›®srcä¸‹çš„ç›®å½•å¤åˆ¶åˆ°æ–°å»ºçš„é¡¹ç›®ä¸­ã€‚å…ˆè¿è¡Œä¸€ä¸‹@SpringBootApplication ç±»ï¼Œæ ¹æ®æŠ¥é”™å»æ·»åŠ ç›¸å…³ä¾èµ–ã€‚æ²¡æœ‰å»ç½‘ç«™[Maven Repository: Search/Browse/Explore (mvnrepository.com)](https://mvnrepository.com/)ä¸‹è½½ä¾èµ–ã€‚
1. é›†æˆlog4j
Spring Boot å·²å¼ƒç”¨ spring-boot-starter-log4jï¼š  Spring Boot ä» 1.2.x ç‰ˆæœ¬å¼€å§‹ï¼Œå®˜æ–¹æ¨èä½¿ç”¨ Logback æˆ– Log4j2ï¼Œä¸å†æ”¯æŒæ—§ç‰ˆçš„ Log4j 1.xã€‚  å› æ­¤ï¼Œspring-boot-starter-log4j åœ¨è¾ƒæ–°çš„ Spring Boot ç‰ˆæœ¬ä¸­å·²è¢«ç§»é™¤ã€‚

   å› ä¸ºä¹‹å‰ç³»ç»Ÿä½¿ç”¨log4jï¼Œä¸ºäº†ä¸ç”¨æ”¹é…ç½®å’Œä»£ç ï¼Œç¡®å®šç»§ç»­ä½¿ç”¨log4jã€‚ä¸‹è½½å¥½ä¾èµ–åå¯¼å…¥ pom.xml æ–‡ä»¶ä¸­ã€‚
   &lt;!--æ·»åŠ log4jä¾èµ–æ¨¡å—--&gt;&lt;dependency&gt;   &lt;groupId&gt;log4j&lt;/groupId&gt;   &lt;artifactId&gt;log4j&lt;/artifactId&gt;   &lt;version&gt;1.2.17&lt;/version&gt;&lt;/dependency&gt;

2. é›†æˆHibernate    åŸç³»ç»Ÿä½¿ç”¨çš„ hibernate  ç‰ˆæœ¬ 4.2.21ã€‚

å¯¼å…¥ä¾èµ–

   &lt;!-- åªéœ€æ·»åŠ  JPA Starter Spring Boot ä¼šè‡ªåŠ¨å¼•å…¥å…¼å®¹çš„ Hibernate ç‰ˆæœ¬ï¼ˆæ— éœ€æ‰‹åŠ¨æŒ‡å®šï¼‰--&gt;&lt;dependency&gt;   &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;   &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;&lt;/dependency&gt;

   spring-boot-starter-data-jpa å·²é›†æˆ Hibernate æ ¸å¿ƒä¾èµ–ï¼Œæ— éœ€å•ç‹¬å¼•å…¥ hibernate-core ç­‰åŒ…ã€‚  

é…ç½®æ–‡ä»¶

   ä»¥å‰éœ€è¦åœ¨application-context.xml æ–‡ä»¶ä¸­é…ç½®
   .jkusodkbgfuv{zoom:80%;}

   ç°åœ¨åªéœ€è¦åœ¨application.yaml æ–‡ä»¶ä¸­é…ç½®å³å¯ã€‚
   
3. å‰ç«¯ä»£ç ç§»æ¤
åŸç³»ç»Ÿä½¿ç”¨JSPï¼Œéœ€è¦å°†åŸé¡¹ç›®WebContent ç›®å½•ä¸‹çš„æ–‡ä»¶å¤åˆ¶åˆ°ï¼Œwebapp ç›®å½•ä¸‹ã€‚

åŸç³»ç»Ÿï¼š



ç°åœ¨ç³»ç»Ÿï¼š



é…ç½®è§†å›¾è§£æå™¨


mvc:   view:     prefix: /WEB-INF/jsp/ #é…ç½®è§†å›¾è§£æå™¨     suffix: .jsp web:   resources:     static-locations: classpath:/static/,classpath:/WEB-INF/userData/,classpath:/WEB-INF/temp/ #è®¾ç½®é™æ€èµ„æºè·¯å¾„


å¼•å…¥ä¾èµ–
&lt;!--SpringBootä¸æ¨èä½¿ç”¨jsp  åŠ å…¥ä¸€ä¸ªå¤„ç†jspçš„ä¾èµ–ã€‚ è´Ÿè´£ç¼–è¯‘jspæ–‡ä»¶--&gt;&lt;dependency&gt;    &lt;groupId&gt;org.apache.tomcat.embed&lt;/groupId&gt;    &lt;artifactId&gt;tomcat-embed-jasper&lt;/artifactId&gt;&lt;/dependency&gt;&lt;!--jstl ä¾èµ–--&gt;&lt;dependency&gt;    &lt;groupId&gt;javax.servlet&lt;/groupId&gt;    &lt;artifactId&gt;jstl&lt;/artifactId&gt;&lt;/dependency&gt;

]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>éšç¬”</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM åŸºç¡€ 1 - JVMä»‹ç»</title>
    <url>/2025/05/21/Java/JVM/JVM%20%E5%9F%BA%E7%A1%80%201%20-%20JVM%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[JVMä»€ä¹ˆæ˜¯JVMJVM å…¨ç§°æ˜¯ Java Virtual Machineï¼Œä¸­æ–‡è¯‘å Javaè™šæ‹Ÿæœºï¼Œæ˜¯ Java ç”Ÿæ€çš„æ ¸å¿ƒï¼Œå®ƒè´Ÿè´£æ‰§è¡Œå­—èŠ‚ç ï¼Œæä¾›å†…å­˜ç®¡ç†ã€åƒåœ¾å›æ”¶ã€çº¿ç¨‹ç®¡ç†ç­‰åŠŸèƒ½ï¼Œä½¿ Java ç¨‹åºèƒ½å¤Ÿå®ç° â€œä¸€æ¬¡ç¼–å†™ï¼Œåˆ°å¤„è¿è¡Œâ€ çš„è·¨å¹³å°ç‰¹æ€§ã€‚
JVMçš„ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½æ˜¯ä»€ä¹ˆï¼ŸJVM åŒ…å«å†…å­˜ç®¡ç†ã€è§£é‡Šæ‰§è¡Œè™šæ‹ŸæœºæŒ‡ä»¤ã€å³æ—¶ç¼–è¯‘ä¸‰å¤§åŠŸèƒ½ã€‚
å¸¸è§çš„JVMè™šæ‹Ÿæœºæœ‰å“ªäº›ï¼Ÿ
JVMçŸ¥è¯†ä½“ç³»
å­¦ä¹ æ–‡çŒ®

https://blog.csdn.net/weixin_50280576/article/details/113775575
https://lisxpq12rl7.feishu.cn/wiki/F2AFw0doOiW89Fkr8kGcCTyVnLh
https://pdai.tech/md/java/jvm/java-jvm-x-overview.html
https://javaguide.cn/java/jvm/jvm-garbage-collection.html
https://javabetter.cn/jvm/jit.html

]]></content>
      <categories>
        <category>JAVA</category>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Javaè¿›é˜¶ å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM åŸºç¡€ 2 - Java ç±»å­—èŠ‚ç </title>
    <url>/2025/05/22/Java/JVM/JVM%20%E5%9F%BA%E7%A1%80%202%20-%20Java%20%E7%B1%BB%E5%AD%97%E8%8A%82%E7%A0%81/</url>
    <content><![CDATA[Javaè™šæ‹Ÿæœºçš„ç»„æˆJavaè™šæ‹Ÿæœºä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªç»„æˆéƒ¨åˆ†ï¼š


ClassLoaderï¼šç±»åŠ è½½å­ç³»ç»Ÿï¼Œæ ¸å¿ƒç»„ä»¶ç±»åŠ è½½å™¨ï¼Œè´Ÿè´£å°†å­—èŠ‚ç æ–‡ä»¶ä¸­çš„å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­ã€‚
JVMå†…å­˜ç»“æ„ï¼šè¿è¡Œæ—¶æ•°æ®åŒºï¼ŒJVMç®¡ç†çš„å†…å­˜ï¼Œåˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ã€ç±»çš„ä¿¡æ¯ç­‰ç­‰å†…å®¹éƒ½ä¼šæ”¾åœ¨è¿™å—åŒºåŸŸä¸­ã€‚
æ‰§è¡Œå¼•æ“ï¼šåŒ…å«äº†å³æ—¶ç¼–è¯‘å™¨ã€è§£é‡Šå™¨ã€åƒåœ¾å›æ”¶å™¨ï¼Œæ‰§è¡Œå¼•æ“ä½¿ç”¨è§£é‡Šå™¨å°†å­—èŠ‚ç æŒ‡ä»¤è§£é‡Šæˆæœºå™¨ç ï¼Œä½¿ç”¨å³æ—¶ç¼–è¯‘å™¨ä¼˜åŒ–æ€§èƒ½ï¼Œä½¿ç”¨åƒåœ¾å›æ”¶å™¨å›æ”¶ä¸å†ä½¿ç”¨çš„å¯¹è±¡ã€‚
æœ¬åœ°æ¥å£ï¼šè°ƒç”¨æœ¬åœ°ä½¿ç”¨C&#x2F;C++ç¼–è¯‘å¥½çš„æ–¹æ³•ï¼Œæœ¬åœ°æ–¹æ³•åœ¨Javaä¸­å£°æ˜æ—¶ï¼Œéƒ½ä¼šå¸¦ä¸Šnativeå…³é”®å­—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

å­—èŠ‚ç æ–‡ä»¶çš„ç»„æˆ
å­—èŠ‚ç æ–‡ä»¶æ¯”è¾ƒéš¾è¯»ï¼Œæ›´åŠ è¯¦ç»†çš„è¯·å»å®˜ç½‘https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5é˜…è¯»ã€‚

å­—èŠ‚ç æ–‡ä»¶æ€»å…±å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

åŸºç¡€ä¿¡æ¯ï¼šé­”æ•°ã€å­—èŠ‚ç æ–‡ä»¶å¯¹åº”çš„Javaç‰ˆæœ¬å·ã€è®¿é—®æ ‡è¯†(public finalç­‰ç­‰)ã€çˆ¶ç±»å’Œæ¥å£ä¿¡æ¯
å¸¸é‡æ± ï¼šä¿å­˜äº†å­—ç¬¦ä¸²å¸¸é‡ã€ç±»æˆ–æ¥å£åã€å­—æ®µåï¼Œä¸»è¦åœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­ä½¿ç”¨
å­—æ®µï¼š å½“å‰ç±»æˆ–æ¥å£å£°æ˜çš„å­—æ®µä¿¡æ¯
æ–¹æ³•ï¼š å½“å‰ç±»æˆ–æ¥å£å£°æ˜çš„æ–¹æ³•ä¿¡æ¯ï¼Œæ ¸å¿ƒå†…å®¹ä¸ºæ–¹æ³•çš„å­—èŠ‚ç æŒ‡ä»¤
å±æ€§ï¼š ç±»çš„å±æ€§ï¼Œæ¯”å¦‚æºç çš„æ–‡ä»¶åã€å†…éƒ¨ç±»çš„åˆ—è¡¨ç­‰

é€šè¿‡ javac ç±»å.java ç¼–è¯‘ java æ–‡ä»¶åï¼Œä¼šç”Ÿæˆä¸€ä¸ª .class å­—èŠ‚ç æ–‡ä»¶ï¼
ä»¥ä¸‹æ˜¯å­—èŠ‚ç æ–‡ä»¶ï¼š
0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 09 0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b 07 0000040 00 1c 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29 0000060 56 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e 0000100 75 6d 62 65 72 54 61 62 6c 65 01 00 12 4c 6f 63 0000120 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65 01 0000140 00 04 74 68 69 73 01 00 1d 4c 63 6e 2f 69 74 63 0000160 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 6f 0000200 57 6f 72 6c 64 3b 01 00 04 6d 61 69 6e 01 00 16 0000220 28 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 0000240 69 6e 67 3b 29 56 01 00 04 61 72 67 73 01 00 13 0000260 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 0000300 6e 67 3b 01 00 10 4d 65 74 68 6f 64 50 61 72 61 0000320 6d 65 74 65 72 73 01 00 0a 53 6f 75 72 63 65 46 0000340 69 6c 65 01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 640000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d 0c 00 1e 0000400 00 1f 01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64 0000420 07 00 20 0c 00 21 00 22 01 00 1b 63 6e 2f 69 74 0000440 63 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 0000460 6f 57 6f 72 6c 64 01 00 10 6a 61 76 61 2f 6c 61 0000500 6e 67 2f 4f 62 6a 65 63 74 01 00 10 6a 61 76 61 0000520 2f 6c 61 6e 67 2f 53 79 73 74 65 6d 01 00 03 6f 0000540 75 74 01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72 0000560 69 6e 74 53 74 72 65 61 6d 3b 01 00 13 6a 61 76 0000600 61 2f 69 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d 0000620 01 00 07 70 72 69 6e 74 6c 6e 01 00 15 28 4c 6a 0000640 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b 0000660 29 56 00 21 00 05 00 06 00 00 00 00 00 02 00 01 0000700 00 07 00 08 00 01 00 09 00 00 00 2f 00 01 00 01 0000720 00 00 00 05 2a b7 00 01 b1 00 00 00 02 00 0a 00 0000740 00 00 06 00 01 00 00 00 04 00 0b 00 00 00 0c 00 0000760 01 00 00 00 05 00 0c 00 0d 00 00 00 09 00 0e 00 0001000 0f 00 02 00 09 00 00 00 37 00 02 00 01 00 00 00 0001020 09 b2 00 02 12 03 b6 00 04 b1 00 00 00 02 00 0a 0001040 00 00 00 0a 00 02 00 00 00 06 00 08 00 07 00 0b 0001060 00 00 00 0c 00 01 00 00 00 09 00 10 00 11 00 00 0001100 00 12 00 00 00 05 01 00 10 00 00 00 01 00 13 00 0001120 00 00 02 00 14

æ ¹æ® JVM è§„èŒƒï¼Œç±»æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š

é­”æ•°ç¬¬ä¸€è¡Œä¸­æœ‰ä¸€ä¸²ç‰¹æ®Šçš„å­—ç¬¦ cafebabeï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªé­”æ•°ï¼Œæ˜¯ JVM è¯†åˆ« class æ–‡ä»¶çš„æ ‡å¿—ï¼ŒJVM ä¼šåœ¨éªŒè¯é˜¶æ®µæ£€æŸ¥ class æ–‡ä»¶æ˜¯å¦ä»¥è¯¥é­”æ•°å¼€å¤´ï¼Œå¦‚æœä¸æ˜¯åˆ™ä¼šæŠ›å‡º ClassFormatErrorã€‚
ä¸Šé¢æˆªå›¾ä¸­
u4 magicå¯¹åº”å­—èŠ‚ç æ–‡ä»¶çš„ 0~3 ä¸ªå­—èŠ‚0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 09ca fe ba be ï¼šæ„æ€æ˜¯ .class æ–‡ä»¶ï¼Œä¸åŒçš„ä¸œè¥¿æœ‰ä¸åŒçš„é­”æ•°ï¼Œæ¯”å¦‚ jpgã€png å›¾ç‰‡ç­‰ï¼
ç‰ˆæœ¬ç´§è·Ÿç€é­”æ•°åé¢çš„å››ä¸ªå­—èŠ‚ 00 00 00 34 åˆ†åˆ«è¡¨ç¤ºå‰¯ç‰ˆæœ¬å·å’Œä¸»ç‰ˆæœ¬å·ã€‚
u2 minor_version;u2 major_version;0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 0900 00 00 34ï¼š34Hï¼ˆ16è¿›åˆ¶ï¼‰ &#x3D; 52ï¼ˆ10è¿›åˆ¶ï¼‰ï¼Œä»£è¡¨JDK8å¯¹åº”çš„ç‰ˆæœ¬å·ï¼Œå‰¯ç‰ˆæœ¬å·ä¸º 0ã€‚
å¸¸é‡æ± å‚è€ƒåœ°å€ï¼šÂ· The JavaÂ® Virtual Machine Specification (oracle.com) Â·
ç´§è·Ÿåœ¨ç‰ˆæœ¬å·ä¹‹åçš„æ˜¯å¸¸é‡æ± ï¼Œå®ƒåŒ…å«äº†ç±»ã€æ¥å£ã€å­—æ®µå’Œæ–¹æ³•çš„ç¬¦å·å¼•ç”¨ï¼Œä»¥åŠå­—ç¬¦ä¸²å­—é¢é‡å’Œæ•°å€¼å¸¸é‡ã€‚è¿™äº›ä¿¡æ¯åœ¨ç¼–è¯‘æ—¶è¢«åˆ›å»ºï¼Œå¹¶åœ¨è¿è¡Œæ—¶è¢«Javaè™šæ‹Ÿæœºï¼ˆJVMï¼‰ä½¿ç”¨ã€‚

å­¦ä¹ æ–‡çŒ®

https://blog.csdn.net/weixin_50280576/article/details/113775575
https://lisxpq12rl7.feishu.cn/wiki/F2AFw0doOiW89Fkr8kGcCTyVnLh
https://pdai.tech/md/java/jvm/java-jvm-x-overview.html
https://javaguide.cn/java/jvm/jvm-garbage-collection.html
https://javabetter.cn/jvm/jit.html

]]></content>
      <categories>
        <category>JAVA</category>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Javaè¿›é˜¶ å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM åŸºç¡€ 3 - Java ç±»åŠ è½½æœºåˆ¶</title>
    <url>/2025/05/23/Java/JVM/JVM%20%E5%9F%BA%E7%A1%80%203%20-%20Java%20%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[Java ç±»åŠ è½½æœºåˆ¶ç±»çš„ç”Ÿå‘½å‘¨æœŸç±»ä»è¢«åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­å¼€å§‹åˆ°å¸è½½å‡ºå†…å­˜ä¸ºæ­¢ï¼Œå®ƒçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå¯ä»¥ç®€å•æ¦‚æ‹¬ä¸º 7 ä¸ªé˜¶æ®µï¼šåŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æã€åˆå§‹åŒ–ã€ä½¿ç”¨å’Œå¸è½½ã€‚å…¶ä¸­ï¼ŒéªŒè¯ã€å‡†å¤‡å’Œè§£æè¿™ä¸‰ä¸ªé˜¶æ®µå¯ä»¥ç»Ÿç§°ä¸ºé“¾æ¥ã€‚

åŠ è½½ï¼ˆLoadingï¼‰
ç±»åŠ è½½å™¨æ ¹æ®ç±»çš„å…¨é™å®šåé€šè¿‡ä¸åŒçš„æ¸ é“ä»¥äºŒè¿›åˆ¶æµçš„æ–¹å¼è·å–å­—èŠ‚ç ä¿¡æ¯ï¼Œç¨‹åºå‘˜å¯ä»¥ä½¿ç”¨Javaä»£ç æ‹“å±•çš„ä¸åŒçš„æ¸ é“ã€‚

ä»æœ¬åœ°ç£ç›˜ä¸Šè·å–æ–‡ä»¶
è¿è¡Œæ—¶é€šè¿‡åŠ¨æ€ä»£ç†ç”Ÿæˆï¼Œæ¯”å¦‚Springæ¡†æ¶
AppletæŠ€æœ¯é€šè¿‡ç½‘ç»œè·å–å­—èŠ‚ç æ–‡ä»¶


ç±»åŠ è½½å™¨åœ¨åŠ è½½å®Œç±»ä¹‹åï¼ŒJavaè™šæ‹Ÿæœºä¼šå°†å­—èŠ‚ç ä¸­çš„ä¿¡æ¯ä¿å­˜åˆ°æ–¹æ³•åŒºä¸­ï¼Œæ–¹æ³•åŒºä¸­ç”Ÿæˆä¸€ä¸ªInstanceKlasså¯¹è±¡ï¼Œä¿å­˜ç±»çš„æ‰€æœ‰ä¿¡æ¯ï¼Œé‡Œè¾¹è¿˜åŒ…å«å®ç°ç‰¹å®šåŠŸèƒ½æ¯”å¦‚å¤šæ€çš„ä¿¡æ¯ã€‚
 

Javaè™šæ‹ŸæœºåŒæ—¶ä¼šåœ¨å †ä¸Šç”Ÿæˆä¸æ–¹æ³•åŒºä¸­æ•°æ®ç±»ä¼¼çš„java.lang.Classå¯¹è±¡ï¼Œä½œç”¨æ˜¯åœ¨Javaä»£ç ä¸­å»è·å–ç±»çš„ä¿¡æ¯ä»¥åŠå­˜å‚¨é™æ€å­—æ®µçš„æ•°æ®ï¼ˆJDK8åŠä¹‹åï¼‰ã€‚
 


é“¾æ¥ï¼ˆLinkingï¼‰é“¾æ¥é˜¶æ®µå°†åŠ è½½çš„ç±»å‡†å¤‡å¥½ä»¥ä¾›JVMä½¿ç”¨ï¼Œåˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªå­é˜¶æ®µï¼š
éªŒè¯ï¼ˆVerificationï¼‰æ­¤é˜¶æ®µä¼šå¯¹å­—èŠ‚ç è¿›è¡Œæ ¡éªŒï¼Œç¡®ä¿å…¶ç¬¦åˆ Java è™šæ‹Ÿæœºè§„èŒƒï¼Œä¸ä¼šå±å®³è™šæ‹Ÿæœºçš„å®‰å…¨ã€‚éªŒè¯è¿‡ç¨‹åŒ…æ‹¬ï¼š

æ–‡ä»¶æ ¼å¼éªŒè¯ï¼šæ£€æŸ¥ç±»æ–‡ä»¶çš„é­”æ•°ï¼ˆæ˜¯å¦ä»¥0xCAFEBABEå¼€å¤´ï¼‰ã€ç‰ˆæœ¬ç­‰åŸºæœ¬ç»“æ„ã€‚
å…ƒæ•°æ®éªŒè¯ï¼šæ£€æŸ¥ç±»çš„å†…éƒ¨ç»“æ„ï¼Œå¦‚å­—æ®µã€æ–¹æ³•çš„æè¿°ç¬¦ã€‚
å­—èŠ‚ç éªŒè¯ï¼šé€šè¿‡æ•°æ®æµå’Œæ§åˆ¶æµåˆ†æï¼Œç¡®å®šç¨‹åºè¯­ä¹‰æ˜¯åˆæ³•çš„ã€ç¬¦åˆé€»è¾‘çš„ã€‚
ç¬¦å·å¼•ç”¨éªŒè¯: ç¡®ä¿è§£æåŠ¨ä½œèƒ½æ­£ç¡®æ‰§è¡Œã€‚

å‡†å¤‡ï¼ˆPreparationï¼‰å‡†å¤‡é˜¶æ®µä¸»è¦ä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶è®¾ç½®å…¶åˆå§‹å€¼ï¼ˆé»˜è®¤å€¼ï¼‰ã€‚æ³¨æ„ä¸€ä¸‹å‡ ç‚¹ï¼š

static å˜é‡åˆ†é…ç©ºé—´å’Œèµ‹å€¼æ˜¯ä¸¤ä¸ªæ­¥éª¤ï¼Œåˆ†é…ç©ºé—´åœ¨å‡†å¤‡é˜¶æ®µå®Œæˆï¼Œèµ‹å€¼åœ¨åˆå§‹åŒ–é˜¶æ®µå®Œæˆã€‚
è¿™é‡Œæ‰€è®¾ç½®çš„åˆå§‹å€¼é€šå¸¸æƒ…å†µä¸‹æ˜¯æ•°æ®ç±»å‹é»˜è®¤çš„é›¶å€¼(å¦‚0ã€0Lã€nullã€falseç­‰)ã€‚
å¦‚æœ static å˜é‡æ˜¯ ï¬nal çš„åŸºæœ¬ç±»å‹ï¼Œä»¥åŠå­—ç¬¦ä¸²å¸¸é‡ï¼Œé‚£ä¹ˆç¼–è¯‘é˜¶æ®µå€¼å°±ç¡®å®šäº†ï¼Œèµ‹å€¼åœ¨å‡†å¤‡é˜¶æ®µå®Œæˆ
å¦‚æœ static å˜é‡æ˜¯ ï¬nal çš„ï¼Œä½†å±äºå¼•ç”¨ç±»å‹ï¼Œé‚£ä¹ˆèµ‹å€¼ä¹Ÿä¼šåœ¨åˆå§‹åŒ–é˜¶æ®µå®Œæˆ

è§£æï¼ˆResolutionï¼‰è§£æé˜¶æ®µæ˜¯è™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚
åˆå§‹åŒ–(Initialization)åˆå§‹åŒ–é˜¶æ®µæ˜¯ç±»åŠ è½½è¿‡ç¨‹çš„æœ€åä¸€æ­¥ï¼Œä¸»è¦ä»»åŠ¡æ˜¯æ‰§è¡Œç±»æ„é€ å™¨()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆï¼Œç”¨äºåˆå§‹åŒ–ç±»çš„é™æ€å˜é‡å’Œæ‰§è¡Œé™æ€å—ã€‚åˆå§‹åŒ–é˜¶æ®µåŒ…æ‹¬ï¼š

æ‰§è¡Œé™æ€å˜é‡çš„åˆå§‹åŒ–èµ‹å€¼ã€‚
æ‰§è¡Œé™æ€ä»£ç å—ã€‚

ç±»çš„åˆå§‹åŒ–çš„æ‡’æƒ°çš„

ä»¥ä¸‹æƒ…å†µä¼šåˆå§‹åŒ–

main æ–¹æ³•æ‰€åœ¨çš„ç±»ï¼Œæ€»ä¼šè¢«é¦–å…ˆåˆå§‹åŒ–
é¦–æ¬¡è®¿é—®è¿™ä¸ªç±»çš„é™æ€å˜é‡æˆ–é™æ€æ–¹æ³•æ—¶
å­ç±»åˆå§‹åŒ–ï¼Œå¦‚æœçˆ¶ç±»è¿˜æ²¡åˆå§‹åŒ–ï¼Œä¼šå¼•å‘
å­ç±»è®¿é—®çˆ¶ç±»çš„é™æ€å˜é‡ï¼Œåªä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–
åå°„(å¦‚Class.forName)
åˆ›å»ºç±»çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯newçš„æ–¹å¼


ä»¥ä¸‹æƒ…å†µä¸ä¼šåˆå§‹åŒ–

è®¿é—®ç±»çš„ static ï¬nal é™æ€å¸¸é‡ï¼ˆåŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²ï¼‰
ç±»å¯¹è±¡.class ä¸ä¼šè§¦å‘åˆå§‹åŒ–
åˆ›å»ºè¯¥ç±»å¯¹è±¡çš„æ•°ç»„
ç±»åŠ è½½å™¨çš„.loadClassæ–¹æ³•
Class.forNamedçš„å‚æ•°2ä¸ºfalseæ—¶




å¯¹ä¸Šè¿°å‡†åˆ™çš„éªŒè¯ï¼ˆæ³¨é‡Šä¸‹é€ä¸ªéªŒè¯ï¼‰

public class Load2 &#123;    public static void main(String[] args) &#123;        // ä¸èƒ½åˆå§‹åŒ–ï¼Œfinalåœ¨å‡†å¤‡é˜¶æ®µå°±å·²ç»èµ‹å€¼äº†        System.out.println(E.a);        // ä¸èƒ½åˆå§‹åŒ–ï¼Œfinalåœ¨å‡†å¤‡é˜¶æ®µå°±å·²ç»èµ‹å€¼äº†        System.out.println(E.b);        // ä¼šå¯¼è‡´ E ç±»åˆå§‹åŒ–ï¼Œå› ä¸º Integer æ˜¯åŒ…è£…ç±»        System.out.println(E.c);    &#125;&#125;class E &#123;    public static final int a = 10;    public static final String b = &quot;hello&quot;;    public static final Integer c = 20;    static &#123;        System.out.println(&quot;E cinit&quot;);    &#125;&#125;

public class Load3 &#123;    static &#123;        //åœ¨mainç±»å‰é¢çš„é™æ€ä»£ç å—ä¼šä¼˜å…ˆåˆå§‹åŒ–        System.out.println(&quot;main init&quot;);    &#125;    public static void main(String[] args) throws ClassNotFoundException &#123;        // 1. é™æ€å¸¸é‡ï¼ˆåŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²ï¼‰ä¸ä¼šè§¦å‘åˆå§‹åŒ–        System.out.println(B.b);        // 2. ç±»å¯¹è±¡.class ä¸ä¼šè§¦å‘åˆå§‹åŒ–        System.out.println(B.class);        // 3. åˆ›å»ºè¯¥ç±»çš„æ•°ç»„ä¸ä¼šè§¦å‘åˆå§‹åŒ–        System.out.println(new B[0]);        // 4. ä¸ä¼šåˆå§‹åŒ–ç±» Bï¼Œä½†ä¼šåŠ è½½ Bã€A        ClassLoader cl = Thread.currentThread().getContextClassLoader();        cl.loadClass(&quot;cn.itcast.jvm.t3.B&quot;);        // 5. ä¸ä¼šåˆå§‹åŒ–ç±» Bï¼Œä½†ä¼šåŠ è½½ Bã€A        ClassLoader c2 = Thread.currentThread().getContextClassLoader();        Class.forName(&quot;cn.itcast.jvm.t3.B&quot;, false, c2);        // 1. é¦–æ¬¡è®¿é—®è¿™ä¸ªç±»çš„é™æ€å˜é‡æˆ–é™æ€æ–¹æ³•æ—¶        System.out.println(A.a);        // 2. å­ç±»åˆå§‹åŒ–ï¼Œå¦‚æœçˆ¶ç±»è¿˜æ²¡åˆå§‹åŒ–ï¼Œä¼šå¼•å‘çˆ¶ç±»çš„åˆå§‹åŒ–        System.out.println(B.c);        // 3. å­ç±»è®¿é—®çˆ¶ç±»é™æ€å˜é‡ï¼Œåªè§¦å‘çˆ¶ç±»åˆå§‹åŒ–        System.out.println(B.a);        // 4. ä¼šåˆå§‹åŒ–ç±» Bï¼Œå¹¶å…ˆåˆå§‹åŒ–ç±» A        Class.forName(&quot;cn.itcast.jvm.t3.B&quot;);    &#125;&#125;class A &#123;    static int a = 0;    static &#123;        System.out.println(&quot;a init&quot;);    &#125;&#125;class B extends A &#123;    final static double b = 5.0;    static boolean c = false;    static &#123;        System.out.println(&quot;b init&quot;);    &#125;&#125;

ä½¿ç”¨ç±»è®¿é—®æ–¹æ³•åŒºå†…çš„æ•°æ®ç»“æ„çš„æ¥å£ï¼Œ å¯¹è±¡æ˜¯HeapåŒºçš„æ•°æ®ã€‚
å¸è½½Javaè™šæ‹Ÿæœºå°†ç»“æŸç”Ÿå‘½å‘¨æœŸçš„å‡ ç§æƒ…å†µï¼š

æ‰§è¡Œäº†System.exit()æ–¹æ³•
ç¨‹åºæ­£å¸¸æ‰§è¡Œç»“æŸ
ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸æˆ–é”™è¯¯è€Œå¼‚å¸¸ç»ˆæ­¢
ç”±äºæ“ä½œç³»ç»Ÿå‡ºç°é”™è¯¯è€Œå¯¼è‡´Javaè™šæ‹Ÿæœºè¿›ç¨‹ç»ˆæ­¢

ç±»åŠ è½½å™¨ç±»åŠ è½½å™¨ä» JDK 1.0 å°±å‡ºç°äº†ï¼Œæœ€åˆåªæ˜¯ä¸ºäº†æ»¡è¶³ Java Appletï¼ˆå·²ç»è¢«æ·˜æ±°ï¼‰ çš„éœ€è¦ã€‚åæ¥ï¼Œæ…¢æ…¢æˆä¸º Java ç¨‹åºä¸­çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œèµ‹äºˆäº† Java ç±»å¯ä»¥è¢«åŠ¨æ€åŠ è½½åˆ° JVM ä¸­å¹¶æ‰§è¡Œçš„èƒ½åŠ›ã€‚
æ ¹æ®å®˜æ–¹ API æ–‡æ¡£çš„ä»‹ç»:

ç±»åŠ è½½å™¨æ˜¯ä¸€ä¸ªè´Ÿè´£åŠ è½½ç±»çš„å¯¹è±¡ï¼Œç”¨äºå®ç°ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„åŠ è½½è¿™ä¸€æ­¥ã€‚
æ¯ä¸ª Java ç±»éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨æŒ‡å‘åŠ è½½å®ƒçš„ ClassLoaderã€‚
æ•°ç»„ç±»ä¸æ˜¯é€šè¿‡ ClassLoader åˆ›å»ºçš„ï¼ˆæ•°ç»„ç±»æ²¡æœ‰å¯¹åº”çš„äºŒè¿›åˆ¶å­—èŠ‚æµï¼‰ï¼Œæ˜¯ç”± JVM ç›´æ¥ç”Ÿæˆçš„ã€‚

ç®€å•æ¥è¯´ï¼Œç±»åŠ è½½å™¨çš„ä¸»è¦ä½œç”¨å°±æ˜¯åŠ¨æ€åŠ è½½ Java ç±»çš„å­—èŠ‚ç ï¼ˆ .class æ–‡ä»¶ï¼‰åˆ° JVM ä¸­ï¼ˆåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„ Class å¯¹è±¡ï¼‰ã€‚
åŠ è½½è§„åˆ™

åŠ¨æ€åŠ è½½æœºåˆ¶
æŒ‰éœ€åŠ è½½ï¼šJava ç±»åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶æ‰ä¼šè¢«åŠ è½½ï¼ˆå¦‚é€šè¿‡newå®ä¾‹åŒ–ã€è°ƒç”¨é™æ€æ–¹æ³• &#x2F; å­—æ®µç­‰ï¼‰ã€‚
è¿è¡Œæ—¶åŠ è½½ï¼šç±»åŠ è½½è¿‡ç¨‹åœ¨ç¨‹åºè¿è¡ŒæœŸé—´å®Œæˆï¼Œè€Œéç¼–è¯‘æ—¶ã€‚


ç±»çš„å”¯ä¸€æ€§
ç±»çš„å”¯ä¸€æ€§ç”± ç±»åŠ è½½å™¨ + ç±»çš„å…¨é™å®šåï¼ˆå¦‚java.lang.Stringï¼‰ å…±åŒç¡®å®šã€‚ä¸åŒç±»åŠ è½½å™¨åŠ è½½çš„åŒåç±»è¢«è§†ä¸ºä¸åŒçš„ç±»ã€‚



ç±»åŠ è½½å™¨ç±»å‹


åç§°
åŠ è½½çš„ç±»
è¯´æ˜



Bootstrap ClassLoaderï¼ˆå¯åŠ¨ç±»åŠ è½½å™¨ï¼‰
%JAVA_HOME%&#x2F;libç›®å½•ä¸‹çš„ rt.jarã€resources.jarã€charsets.jarç­‰ jar åŒ…å’Œç±»
ç”± JVM åº•å±‚ï¼ˆC++ï¼‰å®ç°ï¼ŒJava ä»£ç ä¸­æ— æ³•ç›´æ¥å¼•ç”¨ã€‚


Extension ClassLoader(æ‹“å±•ç±»åŠ è½½å™¨)
JAVA_HOME&#x2F;jre&#x2F;lib&#x2F;ext
ç”±sun.misc.Launcher$ExtClassLoaderå®ç°ã€‚


Application ClassLoader(åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨)
å½“å‰åº”ç”¨ classpath ä¸‹çš„æ‰€æœ‰ jar åŒ…å’Œç±»
ç”±sun.misc.Launcher$AppClassLoaderå®ç°ï¼Œæ˜¯ClassLoaderç±»çš„é»˜è®¤åŠ è½½å™¨ã€‚


è‡ªå®šä¹‰ç±»åŠ è½½å™¨
è‡ªå®šä¹‰
ç»§æ‰¿java.lang.ClassLoaderå¹¶é‡å†™å…³é”®æ–¹æ³•ï¼ˆå¦‚findClass()ï¼‰ã€‚


å¯»æ‰¾ç±»åŠ è½½å™¨æ¯ä¸ª ClassLoader å¯ä»¥é€šè¿‡getParent()è·å–å…¶çˆ¶ ClassLoaderï¼Œå¦‚æœè·å–åˆ° ClassLoader ä¸ºnullçš„è¯ï¼Œé‚£ä¹ˆè¯¥ç±»æ˜¯é€šè¿‡ BootstrapClassLoader åŠ è½½çš„ã€‚
å¯»æ‰¾ç±»åŠ è½½å™¨ä¾‹å­å¦‚ä¸‹:
 public class ClassLoaderTest &#123;    public static void main(String[] args) &#123;        ClassLoader loader = Thread.currentThread().getContextClassLoader();        System.out.println(loader);        System.out.println(loader.getParent());        System.out.println(loader.getParent().getParent());    &#125;&#125;   

ç»“æœå¦‚ä¸‹:
sun.misc.Launcher$AppClassLoader@18b4aac2sun.misc.Launcher$ExtClassLoader@1b6d3586null

ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œå¹¶æ²¡æœ‰è·å–åˆ°ExtClassLoaderçš„çˆ¶Loaderï¼ŒåŸå› æ˜¯BootstrapLoader(å¼•å¯¼ç±»åŠ è½½å™¨)æ˜¯ç”± C++ å®ç°ï¼Œç”±äºè¿™ä¸ª C++ å®ç°çš„ç±»åŠ è½½å™¨åœ¨ Java ä¸­æ˜¯æ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„ç±»çš„ï¼Œæ‰€ä»¥æ‹¿åˆ°çš„ç»“æœæ˜¯ nullã€‚
åŒäº²å§”æ´¾æ¨¡å‹Javaé‡‡ç”¨äº†åŒäº²å§”æ´¾æ¨¡å‹æ¥ç»„ç»‡ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„ã€‚å…·ä½“æ¥è¯´ï¼Œå½“ä¸€ä¸ªç±»åŠ è½½å™¨æ¥æ”¶åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼Œå®ƒä¼šé¦–å…ˆå°†è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å¤„ç†ï¼Œåªæœ‰åœ¨çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®ŒæˆåŠ è½½æ—¶ï¼Œå­ç±»åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±åŠ è½½ã€‚è¿™ç§æœºåˆ¶ç¡®ä¿äº†Javaæ ¸å¿ƒç±»åº“çš„å®‰å…¨æ€§å’Œä¸€è‡´æ€§ï¼Œé¿å…äº†ç±»çš„é‡å¤åŠ è½½å’Œå‘½åå†²çªã€‚
åŒäº²å§”æ´¾æœºåˆ¶è¿‡ç¨‹

å½“AppClassLoaderåŠ è½½ä¸€ä¸ªclassæ—¶ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠç±»åŠ è½½è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ExtClassLoaderå»å®Œæˆã€‚ 
å½“ExtClassLoaderåŠ è½½ä¸€ä¸ªclassæ—¶ï¼Œå®ƒé¦–å…ˆä¹Ÿä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠç±»åŠ è½½è¯·æ±‚å§”æ´¾ç»™BootStrapClassLoaderå»å®Œæˆã€‚
å¦‚æœBootStrapClassLoaderåŠ è½½å¤±è´¥(ä¾‹å¦‚åœ¨$JAVA_HOME&#x2F;jre&#x2F;libé‡ŒæœªæŸ¥æ‰¾åˆ°è¯¥class)ï¼Œä¼šä½¿ç”¨ExtClassLoaderæ¥å°è¯•åŠ è½½ã€‚
è‹¥ExtClassLoaderä¹ŸåŠ è½½å¤±è´¥ï¼Œåˆ™ä¼šä½¿ç”¨AppClassLoaderæ¥åŠ è½½ï¼Œå¦‚æœAppClassLoaderä¹ŸåŠ è½½å¤±è´¥ï¼Œåˆ™ä¼šæŠ¥å‡ºå¼‚å¸¸ClassNotFoundExceptionã€‚


loadClassæºç è§£æï¼šprotected Class&lt;?&gt; loadClass(String name, boolean resolve)        throws ClassNotFoundException    &#123;        synchronized (getClassLoadingLock(name)) &#123;            // First, check if the class has already been loaded            //é¦–å…ˆï¼Œæ£€æŸ¥ç±»æ˜¯å¦å·²ç»åŠ è½½            Class&lt;?&gt; c = findLoadedClass(name);            if (c == null) &#123;                //è¯´æ˜è¯¥ç±»æ²¡æœ‰è¢«åŠ è½½è¿‡                long t0 = System.nanoTime();                try &#123;                    //åˆ¤æ–­çˆ¶ç±»æ˜¯å¦ä¸ºç©º                    if (parent != null) &#123;                        //å½“çˆ¶ç±»çš„åŠ è½½å™¨ä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡çˆ¶ç±»çš„loadClassæ¥åŠ è½½è¯¥ç±»                        c = parent.loadClass(name, false);                    &#125; else &#123;                        //å½“çˆ¶ç±»çš„åŠ è½½å™¨ä¸ºç©ºï¼Œåˆ™è°ƒç”¨å¯åŠ¨ç±»åŠ è½½å™¨æ¥åŠ è½½è¯¥ç±»                        c = findBootstrapClassOrNull(name);                    &#125;                &#125; catch (ClassNotFoundException e) &#123;                    // ClassNotFoundException thrown if class not found                    // from the non-null parent class loader                    // æ•è·å¼‚å¸¸ä½†ä¸å¤„ç†ï¼Œè¡¨ç¤ºçˆ¶ç±»åŠ è½½å¤±è´¥                &#125;                if (c == null) &#123;                    long t1 = System.nanoTime();                    //å¦‚æœä»æœªæ‰¾åˆ°ï¼Œåˆ™è°ƒç”¨ findClass ä»¥æŸ¥æ‰¾è¯¥ç±»ã€‚                     //ç”¨æˆ·å¯é€šè¿‡è¦†å†™è¯¥æ–¹æ³•ï¼Œæ¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨                    c = findClass(name);                    // this is the defining class loader; record the stats                    sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);                    sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);                    sun.misc.PerfCounter.getFindClasses().increment();                &#125;            &#125;            if (resolve) &#123;                resolveClass(c);            &#125;            return c;        &#125;    &#125;

è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä½¿ç”¨åœºæ™¯
æƒ³åŠ è½½é classpath éšæ„è·¯å¾„ä¸­çš„ç±»æ–‡ä»¶
é€šè¿‡æ¥å£æ¥ä½¿ç”¨å®ç°ï¼Œå¸Œæœ›è§£è€¦æ—¶ï¼Œå¸¸ç”¨åœ¨æ¡†æ¶è®¾è®¡
è¿™äº›ç±»å¸Œæœ›äºˆä»¥éš”ç¦»ï¼Œä¸åŒåº”ç”¨çš„åŒåç±»éƒ½å¯ä»¥åŠ è½½ï¼Œä¸å†²çªï¼Œå¸¸è§äº tomcat å®¹å™¨

æ­¥éª¤
ç»§æ‰¿ClassLoaderçˆ¶ç±»
è¦éµä»åŒäº²å§”æ´¾æœºåˆ¶ï¼Œé‡å†™ ï¬ndClass æ–¹æ³•
ä¸æ˜¯é‡å†™loadClassæ–¹æ³•ï¼Œå¦åˆ™ä¸ä¼šèµ°åŒäº²å§”æ´¾æœºåˆ¶
è¯»å–ç±»æ–‡ä»¶çš„å­—èŠ‚ç 
è°ƒç”¨çˆ¶ç±»çš„ deï¬neClass æ–¹æ³•æ¥åŠ è½½ç±»
ä½¿ç”¨è€…è°ƒç”¨è¯¥ç±»åŠ è½½å™¨çš„ loadClass æ–¹æ³•


ClassLoader ç±»æœ‰ä¸¤ä¸ªå…³é”®çš„æ–¹æ³•ï¼š

protected Class loadClass(String name, boolean resolve)ï¼šåŠ è½½æŒ‡å®šäºŒè¿›åˆ¶åç§°çš„ç±»ï¼Œå®ç°äº†åŒäº²å§”æ´¾æœºåˆ¶ ã€‚name ä¸ºç±»çš„äºŒè¿›åˆ¶åç§°ï¼Œresolve å¦‚æœä¸º trueï¼Œåœ¨åŠ è½½æ—¶è°ƒç”¨ resolveClass(Class&lt;?&gt; c) æ–¹æ³•è§£æè¯¥ç±»ã€‚
protected Class findClass(String name)ï¼šæ ¹æ®ç±»çš„äºŒè¿›åˆ¶åç§°æ¥æŸ¥æ‰¾ç±»ï¼Œé»˜è®¤å®ç°æ˜¯ç©ºæ–¹æ³•ã€‚


å­¦ä¹ æ–‡çŒ®

https://blog.csdn.net/weixin_50280576/article/details/113775575
https://lisxpq12rl7.feishu.cn/wiki/F2AFw0doOiW89Fkr8kGcCTyVnLh
https://pdai.tech/md/java/jvm/java-jvm-x-overview.html
https://javaguide.cn/java/jvm/jvm-garbage-collection.html
https://javabetter.cn/jvm/jit.html

]]></content>
      <categories>
        <category>JAVA</category>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Javaè¿›é˜¶ å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM åŸºç¡€ 4 - JVM å†…å­˜ç»“æ„&#39;</title>
    <url>/2025/05/24/Java/JVM/JVM%20%E5%9F%BA%E7%A1%80%204%20-%20JVM%20%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/</url>
    <content><![CDATA[è¿è¡Œæ—¶æ•°æ®åŒºJavaè™šæ‹Ÿæœºåœ¨è¿è¡ŒJavaç¨‹åºè¿‡ç¨‹ä¸­ç®¡ç†çš„å†…å­˜åŒºåŸŸï¼Œç§°ä¹‹ä¸ºè¿è¡Œæ—¶æ•°æ®åŒºã€‚ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­è§„å®šäº†æ¯ä¸€éƒ¨åˆ†çš„ä½œç”¨ã€‚

æ ¹æ® Java è™šæ‹Ÿæœºè§„èŒƒçš„è§„å®šï¼Œè¿è¡Œæ—¶æ•°æ®åŒºå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰
Java è™šæ‹Ÿæœºæ ˆï¼ˆJava Virtual Machine Stacksï¼‰
æœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Method Stackï¼‰
å †ï¼ˆHeapï¼‰
æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰


ç¨‹åºè®¡æ•°å™¨å®šä¹‰|ä½œç”¨ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ä¹Ÿå«PCå¯„å­˜å™¨ï¼Œç”¨æ¥å­˜å‚¨æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ä»£ç ã€‚ç”±æ‰§è¡Œå¼•æ“è¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚
å½“æˆ‘ä»¬çš„javaç¨‹åºè¢«ç¼–è¯‘æˆäºŒè¿›åˆ¶å­—èŠ‚ç æ–‡ä»¶åï¼Œå¦‚ä¸‹å›¾ï¼š

å³é¢ï¼Œæ˜¯æˆ‘ä»¬å†™çš„ä»£ç ï¼Œå·¦é¢æ˜¯äºŒè¿›åˆ¶å­—èŠ‚ç å½¢å¼ï¼ˆ.classï¼‰
å®ƒä»¬å°†ç”±æˆ‘ä»¬çš„è§£é‡Šå™¨æ¥å°†ä»–ä»¬è½¬æ¢ä¸ºæœºæ¢°ç ï¼Œä»è€Œè®©æœºå™¨è¿è¡Œã€‚
ç»†å¿ƒçš„ä½ ä¼šå‘ç°ï¼Œæ¯ä¸ªäºŒè¿›åˆ¶å­—èŠ‚ç çš„å‰é¢éƒ½æœ‰ä¸€ä¸ªç±»ä¼¼äºç´¢å¼•çš„æ•°å­—ã€‚ä»–ä»¬çš„ä½œç”¨ä¹Ÿè·Ÿç´¢å¼•å·®ä¸å¤šï¼Œä¸ºå½“å‰ç¨‹åºæ ‡ä¸€ä¸ªåºå·ï¼Œè®°ä¸Šä»–ä»¬çš„åœ°å€ã€‚
å³ä½¿æœ‰äº†åœ°å€ï¼Œè§£é‡Šå™¨ä¹Ÿä¸çŸ¥é“ä»–ä»¬çš„é¡ºåºæ˜¯ä»€ä¹ˆæ ·çš„ï¼Œä»–åªè´Ÿè´£è¿è¡Œã€‚
äºæ˜¯ï¼Œä¾¿æœ‰äº†ç¨‹åºè®¡æ•°å™¨ï¼Œç¨‹åºè®¡æ•°å™¨è®°ä¸‹äº†å­—èŠ‚ç è¿è¡Œçš„é¡ºåºï¼Œæ¯å½“ä¸€è¡Œå­—èŠ‚ç èµ°å®Œï¼Œä»–å°±ä¼šç«‹å³å‘Šè¯‰è§£é‡Šå™¨ä¸‹ä¸€ä¸ªè¯¥èµ°å“ªé‡Œã€‚
åŒåŒé…åˆï¼Œæœ€ç»ˆå®ç°å…¨éƒ¨ä»£ç ã€‚
è¿™å°±æ˜¯ç¨‹åºè®¡æ•°å™¨çš„ä½œç”¨ï¼Œä¸æ–­ä¸ºè§£é‡Šå™¨å¯»æ‰¾ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„ç¨‹åºã€‚
ç‰¹ç‚¹
å®ƒæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨ JVM è§„èŒƒä¸­æ²¡æœ‰è§„å®šä»»ä½• OutOfMemoryError æƒ…å†µçš„åŒºåŸŸ

å†…å­˜æº¢å‡ºï¼ˆ OutOfMemoryError ï¼‰æŒ‡çš„æ˜¯ç¨‹åºåœ¨ä½¿ç”¨æŸä¸€å—å†…å­˜åŒºåŸŸæ—¶ï¼Œå­˜æ”¾çš„æ•°æ®éœ€è¦å ç”¨çš„å†…å­˜å¤§å°è¶…è¿‡äº†è™šæ‹Ÿæœºèƒ½æä¾›çš„å†…å­˜ä¸Šé™ã€‚


å®ƒæ˜¯ä¸€å—å¾ˆå°çš„å†…å­˜ç©ºé—´ï¼Œå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ä¹Ÿæ˜¯è¿è¡Œé€Ÿåº¦æœ€å¿«çš„å­˜å‚¨åŒºåŸŸ

åœ¨ JVM è§„èŒƒä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å®ƒè‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´

ä»»ä½•æ—¶é—´ä¸€ä¸ªçº¿ç¨‹éƒ½åªæœ‰ä¸€ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å½“å‰æ–¹æ³•ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ˜¯ Java æ–¹æ³•ï¼Œç¨‹åºè®¡æ•°å™¨è®°å½•çš„æ˜¯ JVM å­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼Œå¦‚æœæ˜¯æ‰§è¡Œ native æ–¹æ³•ï¼Œåˆ™æ˜¯æœªæŒ‡å®šå€¼ï¼ˆundefinedï¼‰

å®ƒæ˜¯ç¨‹åºæ§åˆ¶æµçš„æŒ‡ç¤ºå™¨ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆ

å­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤


Javaè™šæ‹Ÿæœºæ ˆå®šä¹‰|ä½œç”¨Javaè™šæ‹Ÿæœºæ ˆï¼ˆJava Virtual Machine Stackï¼‰é‡‡ç”¨æ ˆçš„æ•°æ®ç»“æ„æ¥ç®¡ç†æ–¹æ³•è°ƒç”¨ä¸­çš„åŸºæœ¬æ•°æ®ï¼Œå…ˆè¿›åå‡ºï¼ˆFirst In Last Outï¼‰,æ¯ä¸€ä¸ªæ–¹æ³•çš„è°ƒç”¨ä½¿ç”¨ä¸€ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰æ¥ä¿å­˜ã€‚
Javaè™šæ‹Ÿæœºæ ˆçš„æ ˆå¸§ï¼ˆFrameï¼‰ä¸­ä¸»è¦åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

å±€éƒ¨å˜é‡è¡¨ï¼ˆLocal Variablesï¼‰ï¼šå±€éƒ¨å˜é‡è¡¨çš„ä½œç”¨æ˜¯åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å­˜æ”¾æ‰€æœ‰çš„å±€éƒ¨å˜é‡
æ“ä½œæ•°æ ˆï¼ˆOperand Stackï¼‰ï¼šæ“ä½œæ•°æ ˆæ˜¯æ ˆå¸§ä¸­è™šæ‹Ÿæœºåœ¨æ‰§è¡ŒæŒ‡ä»¤è¿‡ç¨‹ä¸­ç”¨æ¥å­˜æ”¾ä¸´æ—¶æ•°æ®çš„ä¸€å—åŒºåŸŸ
å¸§æ•°æ®ï¼šå¸§æ•°æ®ä¸»è¦åŒ…å«åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ã€å¼‚å¸¸è¡¨çš„å¼•ç”¨
åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰ï¼šæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨
æ–¹æ³•è¿”å›åœ°å€ï¼ˆReturn Addressï¼‰ï¼šæ–¹æ³•æ­£å¸¸é€€å‡ºæˆ–å¼‚å¸¸é€€å‡ºçš„åœ°å€
å¼‚å¸¸è¡¨



æ ˆå¸§çš„å†…éƒ¨ç»“æ„å±€éƒ¨å˜é‡è¡¨
å­˜å‚¨åŸºæœ¬æ•°æ®ç±»å‹ + å¯¹è±¡å¼•ç”¨ + returnAddress ç±»å‹ï¼ˆæŒ‡å‘äº†ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼Œå·²è¢«å¼‚å¸¸è¡¨å–ä»£ï¼‰
ä»¥**å˜é‡æ§½(Slot)**ä¸ºæœ€å°å•ä½ï¼ˆ32ä½ï¼Œ64ä½æ•°æ®å 2ä¸ªSlotï¼‰
ç¼–è¯‘æœŸç¡®å®šå¤§å°ï¼Œè¿è¡ŒæœŸä¸æ”¹å˜

ä¸¾ä¸ªæ —å­ï¼š
ä»¥ä¸‹ä»£ç çš„å±€éƒ¨å˜é‡è¡¨ä¸­ä¼šå ç”¨å‡ ä¸ªæ§½ï¼Ÿ
public void test4(int k,int m)&#123;    &#123;        int a = 1;        int b = 2;    &#125;    &#123;        int c = 1;    &#125;    int i = 0;    long j = 1;&#125;

åˆ†æï¼š

ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œå±€éƒ¨å˜é‡è¡¨ä¸­çš„æ§½æ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œä¸€æ—¦æŸä¸ªå±€éƒ¨å˜é‡ä¸å†ç”Ÿæ•ˆï¼Œå½“å‰æ§½å°±å¯ä»¥å†æ¬¡è¢«ä½¿ç”¨ã€‚


æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œå®ä¾‹å¯¹è±¡thisã€kã€m ä¼šè¢«æ”¾å…¥å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œå ç”¨3ä¸ªæ§½



å°†1çš„å€¼æ”¾å…¥å±€éƒ¨å˜é‡è¡¨ä¸‹æ ‡ä¸º3çš„ä½ç½®ä¸Šï¼Œç›¸å½“äºç»™aè¿›è¡Œèµ‹å€¼ã€‚



å°†2æ”¾å…¥å±€éƒ¨å˜é‡è¡¨ä¸‹æ ‡ä¸º4çš„ä½ç½®ï¼Œç»™bèµ‹å€¼ä¸º2ã€‚



abå·²ç»è„±ç¦»äº†ç”Ÿæ•ˆèŒƒå›´ï¼Œæ‰€ä»¥ä¸‹æ ‡ä¸º3å’Œ4çš„è¿™ä¸¤ä¸ªä½ç½®å¯ä»¥å¤ç”¨ã€‚æ­¤æ—¶cçš„å€¼1å°±å¯ä»¥æ”¾å…¥ä¸‹æ ‡ä¸º3çš„ä½ç½®ã€‚



è„±ç¦»cçš„ç”Ÿæ•ˆèŒƒå›´ä¹‹åï¼Œç»™ièµ‹å€¼å°±å¯ä»¥å¤ç”¨cçš„ä½ç½®ã€‚



æœ€åæ”¾å…¥jï¼Œjæ˜¯ä¸€ä¸ªlongç±»å‹ï¼Œå ç”¨ä¸¤ä¸ªæ§½ã€‚ä½†æ˜¯å¯ä»¥å¤ç”¨bæ‰€åœ¨çš„ä½ç½®ï¼Œæ‰€ä»¥å ç”¨4å’Œ5è¿™ä¸¤ä¸ªä½ç½®


æ‰€ä»¥ï¼Œå±€éƒ¨å˜é‡è¡¨æ•°å€¼çš„é•¿åº¦ä¸º6ã€‚è¿™ä¸€ç‚¹åœ¨ç¼–è¯‘æœŸé—´å°±å¯ä»¥ç¡®å®šäº†ï¼Œè¿è¡Œè¿‡ç¨‹ä¸­åªéœ€è¦åœ¨æ ˆå¸§ä¸­åˆ›å»ºé•¿åº¦ä¸º6çš„æ•°ç»„å³å¯ã€‚

æ“ä½œæ•°æ ˆ
æ–¹æ³•æ‰§è¡Œçš„å·¥ä½œåŒºï¼ˆç±»ä¼¼CPUå¯„å­˜å™¨ï¼‰
å­˜å‚¨è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´ç»“æœ

ä¸¾ä¸ªæ —å­ï¼š
public int calculate() &#123;    int a = 5;    int b = 3;    int c = a + b;  // æ“ä½œè¿‡ç¨‹ï¼š                   // 1. iload_0 (å‹å…¥a [å°†å±€éƒ¨å˜é‡è¡¨ä¸­ä¸‹æ ‡ä¸º 0 çš„ int ç±»å‹å˜é‡åŠ è½½åˆ°æ“ä½œæ•°æ ˆä¸Š])                   // 2. iload_1 (å‹å…¥b [å°†å±€éƒ¨å˜é‡è¡¨ä¸­ä¸‹æ ‡ä¸º 1 çš„ int ç±»å‹å˜é‡åŠ è½½åˆ°æ“ä½œæ•°æ ˆä¸Š])                   // 3. iadd   (å¼¹å‡ºä¸¤ä¸ªå€¼ï¼Œç›¸åŠ åå‹å›)                   // 4. istore_2(å­˜å‚¨ç»“æœ)    return c;&#125;

psï¼šæ“ä½œæ•°ä¸­çš„æ•°æ®ç±»å‹å¿…é¡»ä¸å­—èŠ‚ç æŒ‡ä»¤åŒ¹é…ï¼Œä»¥ä¸Šé¢çš„ iadd æŒ‡ä»¤ä¸ºä¾‹ï¼Œè¯¥æŒ‡ä»¤åªèƒ½ç”¨äºæ•´å‹æ•°æ®çš„åŠ æ³•è¿ç®—ï¼Œå®ƒåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œæ ˆé¡¶çš„ä¸¤ä¸ªæ•°æ®å¿…é¡»æ˜¯ int ç±»å‹çš„ï¼Œä¸èƒ½å‡ºç°ä¸€ä¸ª long å‹å’Œä¸€ä¸ª double å‹çš„æ•°æ®è¿›è¡Œ iadd å‘½ä»¤ç›¸åŠ çš„æƒ…å†µã€‚
å¸§æ•°æ®å¸§æ•°æ®ä¸»è¦åŒ…å«åŠ¨æ€é“¾æ¥ã€æ–¹æ³•è¿”å›åœ°å€ã€å¼‚å¸¸è¡¨çš„å¼•ç”¨ã€‚
åŠ¨æ€é“¾æ¥(Dynamic Linking)å½“å‰ç±»çš„å­—èŠ‚ç æŒ‡ä»¤å¼•ç”¨äº†å…¶ä»–ç±»çš„å±æ€§æˆ–è€…æ–¹æ³•æ—¶ï¼Œéœ€è¦å°†ç¬¦å·å¼•ç”¨ï¼ˆç¼–å·ï¼‰è½¬æ¢æˆå¯¹åº”çš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­çš„å†…å­˜åœ°å€ã€‚åŠ¨æ€é“¾æ¥å°±ä¿å­˜äº†ç¼–å·åˆ°è¿è¡Œæ—¶å¸¸é‡æ± çš„å†…å­˜åœ°å€çš„æ˜ å°„å…³ç³»ã€‚

æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨
æ”¯æŒå¤šæ€ç‰¹æ€§ï¼ˆåæœŸç»‘å®šï¼‰

æ–¹æ³•è¿”å›åœ°å€(Return Address)æ–¹æ³•å‡ºå£æŒ‡çš„æ˜¯æ–¹æ³•åœ¨æ­£ç¡®æˆ–è€…å¼‚å¸¸ç»“æŸæ—¶ï¼Œå½“å‰æ ˆå¸§ä¼šè¢«å¼¹å‡ºï¼ŒåŒæ—¶ç¨‹åºè®¡æ•°å™¨åº”è¯¥æŒ‡å‘ä¸Šä¸€ä¸ªæ ˆå¸§ä¸­çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚æ‰€ä»¥åœ¨å½“å‰æ ˆå¸§ä¸­ï¼Œéœ€è¦å­˜å‚¨æ­¤æ–¹æ³•å‡ºå£çš„åœ°å€ã€‚

å­˜å‚¨è°ƒç”¨è€…çš„ç¨‹åºè®¡æ•°å™¨å€¼
åŒ…å«æ­£å¸¸è¿”å›å’Œå¼‚å¸¸è¿”å›ä¸¤ç§è·¯å¾„

å¼‚å¸¸è¡¨å¼‚å¸¸è¡¨å­˜æ”¾çš„æ˜¯ä»£ç ä¸­å¼‚å¸¸çš„å¤„ç†ä¿¡æ¯ï¼ŒåŒ…å«äº†å¼‚å¸¸æ•è·çš„ç”Ÿæ•ˆèŒƒå›´ä»¥åŠå¼‚å¸¸å‘ç”Ÿåè·³è½¬åˆ°çš„å­—èŠ‚ç æŒ‡ä»¤ä½ç½®ã€‚
æ ˆå†…å­˜å¼‚å¸¸StackOverflowError
åŸå› ï¼šæ ˆæ·±åº¦è¶…è¿‡è™šæ‹Ÿæœºé™åˆ¶ï¼ˆé€šå¸¸ç”±æ— é™é€’å½’å¼•èµ·ï¼‰
// å…¸å‹ç¤ºä¾‹ï¼šæ— é™é€’å½’public void infiniteRecursion() &#123;    infiniteRecursion();&#125;

è°ƒèŠ‚æ ˆå¤§å°
-Xss256k-XX:ThreadStackSize=1024Windowsï¼ˆ64ä½ï¼‰ä¸‹çš„JDK8æµ‹è¯•æœ€å°å€¼ä¸º180kï¼Œæœ€å¤§å€¼ä¸º1024mã€‚

OutOfMemoryError
åŸå› ï¼šçº¿ç¨‹åˆ›å»ºè¿‡å¤šå¯¼è‡´æ ˆç©ºé—´è€—å°½
åœºæ™¯ï¼šå¤§é‡çº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼ˆé€šå¸¸éœ€æ•°åƒçº¿ç¨‹ï¼‰

æœ¬åœ°æ–¹æ³•æ ˆJavaè™šæ‹Ÿæœºæ ˆå­˜å‚¨äº†Javaæ–¹æ³•è°ƒç”¨æ—¶çš„æ ˆå¸§ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆå­˜å‚¨çš„æ˜¯nativeæœ¬åœ°æ–¹æ³•çš„æ ˆå¸§ã€‚
åœ¨Hotspotè™šæ‹Ÿæœºä¸­ï¼ŒJavaè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆå®ç°ä¸Šä½¿ç”¨äº†åŒä¸€ä¸ªæ ˆç©ºé—´ã€‚æœ¬åœ°æ–¹æ³•æ ˆä¼šåœ¨æ ˆå†…å­˜ä¸Šç”Ÿæˆä¸€ä¸ªæ ˆå¸§ï¼Œä¸´æ—¶ä¿å­˜æ–¹æ³•çš„å‚æ•°åŒæ—¶æ–¹ä¾¿å‡ºç°å¼‚å¸¸æ—¶ä¹ŸæŠŠæœ¬åœ°æ–¹æ³•çš„æ ˆä¿¡æ¯æ‰“å°å‡ºæ¥ã€‚

å †å¯¹äºå¤§å¤šæ•°åº”ç”¨ï¼ŒJava å †æ˜¯ Java è™šæ‹Ÿæœºç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ï¼Œè¢«æ‰€æœ‰çº¿ç¨‹å…±äº«ã€‚æ­¤å†…å­˜åŒºåŸŸçš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°æ®éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚
ä¸ºäº†è¿›è¡Œé«˜æ•ˆçš„åƒåœ¾å›æ”¶ï¼Œè™šæ‹ŸæœºæŠŠå †å†…å­˜é€»è¾‘ä¸Šåˆ’åˆ†æˆä¸‰å—åŒºåŸŸï¼ˆåˆ†ä»£çš„å”¯ä¸€ç†ç”±å°±æ˜¯ä¼˜åŒ– GC æ€§èƒ½ï¼‰ï¼š

æ–°ç”Ÿå¸¦ï¼ˆå¹´è½»ä»£ï¼‰ï¼šæ–°å¯¹è±¡å’Œæ²¡è¾¾åˆ°ä¸€å®šå¹´é¾„çš„å¯¹è±¡éƒ½åœ¨æ–°ç”Ÿä»£
è€å¹´ä»£ï¼ˆå…»è€åŒºï¼‰ï¼šè¢«é•¿æ—¶é—´ä½¿ç”¨çš„å¯¹è±¡ï¼Œè€å¹´ä»£çš„å†…å­˜ç©ºé—´åº”è¯¥è¦æ¯”å¹´è½»ä»£æ›´å¤§
å…ƒç©ºé—´ï¼ˆJDK1.8 ä¹‹å‰å«æ°¸ä¹…ä»£ï¼‰ï¼šåƒä¸€äº›æ–¹æ³•ä¸­çš„æ“ä½œä¸´æ—¶å¯¹è±¡ç­‰ï¼ŒJDK1.8 ä¹‹å‰æ˜¯å ç”¨ JVM å†…å­˜ï¼ŒJDK1.8 ä¹‹åç›´æ¥ä½¿ç”¨ç‰©ç†å†…å­˜

å †å†…å­˜æº¢å‡º
**java.lang.OutOfMemoryError: GC Overhead Limit Exceeded**ï¼šå½“ JVM èŠ±å¤ªå¤šæ—¶é—´æ‰§è¡Œåƒåœ¾å›æ”¶å¹¶ä¸”åªèƒ½å›æ”¶å¾ˆå°‘çš„å †ç©ºé—´æ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ­¤é”™è¯¯ã€‚
java.lang.OutOfMemoryError: Java heap space :å‡å¦‚åœ¨åˆ›å»ºæ–°çš„å¯¹è±¡æ—¶, å †å†…å­˜ä¸­çš„ç©ºé—´ä¸è¶³ä»¥å­˜æ”¾æ–°åˆ›å»ºçš„å¯¹è±¡, å°±ä¼šå¼•å‘æ­¤é”™è¯¯ã€‚å’Œæœ¬æœºçš„ç‰©ç†å†…å­˜æ— å…³ï¼Œå’Œæˆ‘ä»¬é…ç½®çš„è™šæ‹Ÿæœºå†…å­˜å¤§å°æœ‰å…³ï¼

è®¾ç½®å †çš„å¤§å°è¦ä¿®æ”¹å †çš„å¤§å°ï¼Œå¯ä»¥ä½¿ç”¨è™šæ‹Ÿæœºå‚æ•° â€“Xmxï¼ˆmaxæœ€å¤§å€¼ï¼‰å’Œ-Xms (åˆå§‹çš„total)ã€‚
è¯­æ³•ï¼š-Xmxå€¼ -Xmså€¼
å•ä½ï¼šå­—èŠ‚ï¼ˆé»˜è®¤ï¼Œå¿…é¡»æ˜¯ 1024 çš„å€æ•°ï¼‰ã€kæˆ–è€…K(KB)ã€mæˆ–è€…M(MB)ã€gæˆ–è€…G(GB)
é™åˆ¶ï¼šXmxå¿…é¡»å¤§äº 2 MBï¼ŒXmså¿…é¡»å¤§äº1MB
å †å†…å­˜è¯Šæ–­
jps å·¥å…·æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­æœ‰å“ªäº› java è¿›ç¨‹
jmap å·¥å…·æŸ¥çœ‹å †å†…å­˜å ç”¨æƒ…å†µ jmap - heap è¿›ç¨‹id
jconsole å·¥å…·å›¾å½¢ç•Œé¢çš„ï¼Œå¤šåŠŸèƒ½çš„ç›‘æµ‹å·¥å…·ï¼Œå¯ä»¥è¿ç»­ç›‘æµ‹
jvisualvm å·¥å…·

æ–¹æ³•åŒºæ–¹æ³•åŒºå±äºæ˜¯ JVM è¿è¡Œæ—¶æ•°æ®åŒºåŸŸçš„ä¸€å—é€»è¾‘åŒºåŸŸï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸã€‚åœ¨ä¸åŒçš„ JDK ç‰ˆæœ¬ä¸Šæœ‰ç€ä¸åŒçš„å®ç°ã€‚åœ¨ JDK 7 çš„æ—¶å€™ï¼Œæ–¹æ³•åŒºè¢«ç§°ä¸ºæ°¸ä¹…ä»£ï¼ˆPermGenï¼‰ï¼Œè€Œåœ¨ JDK 8 çš„æ—¶å€™ï¼Œæ°¸ä¹…ä»£è¢«å½»åº•ç§»é™¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å…ƒç©ºé—´ã€‚
å®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š

æ–¹æ³•åŒºå†…å­˜æº¢å‡º
JDK 1.8 ä¹‹å‰æ°¸ä¹…ä»£è¿˜æ²¡è¢«å½»åº•ç§»é™¤çš„æ—¶å€™é€šå¸¸é€šè¿‡ä¸‹é¢è¿™äº›å‚æ•°æ¥è°ƒèŠ‚æ–¹æ³•åŒºå¤§å°ã€‚

-XX:PermSize=N &#x2F;&#x2F;æ–¹æ³•åŒº (æ°¸ä¹…ä»£) åˆå§‹å¤§å°

-XX:MaxPermSize=N &#x2F;&#x2F;æ–¹æ³•åŒº (æ°¸ä¹…ä»£) æœ€å¤§å¤§å°,è¶…è¿‡è¿™ä¸ªå€¼å°†ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸:java.lang.OutOfMemoryError: PermGen



JDK 1.8 çš„æ—¶å€™ï¼Œæ–¹æ³•åŒºï¼ˆHotSpot çš„æ°¸ä¹…ä»£ï¼‰è¢«å½»åº•ç§»é™¤äº†ï¼ˆJDK1.7 å°±å·²ç»å¼€å§‹äº†ï¼‰ï¼Œå–è€Œä»£ä¹‹æ˜¯å…ƒç©ºé—´ï¼Œå…ƒç©ºé—´ä½¿ç”¨çš„æ˜¯æœ¬åœ°å†…å­˜ã€‚

-XX:MetaspaceSize=N &#x2F;&#x2F;è®¾ç½® Metaspace çš„åˆå§‹ï¼ˆå’Œæœ€å°å¤§å°ï¼‰
-XX:MaxMetaspaceSize=N &#x2F;&#x2F;è®¾ç½® Metaspace çš„æœ€å¤§å¤§å°



è¿è¡Œæ—¶å¸¸é‡æ± å¸¸é‡æ± å°±æ˜¯ä¸€å¼ è¡¨ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤æ ¹æ®è¿™å¼ å¸¸é‡è¡¨æ‰¾åˆ°è¦æ‰§è¡Œçš„ç±»åã€æ–¹æ³•åã€å‚æ•°ç±»å‹ã€å­—é¢é‡ä¿¡æ¯ã€‚å­˜åœ¨.class æ–‡ä»¶ä¸­çš„ Constant_Pool è¡¨ã€‚
ä¸¾ä¸ªæ —å­ï¼š
public class Test &#123;    public static void main(String[] args) &#123;        System.out.println(&quot;Hello World!&quot;);    &#125;&#125;

ç„¶åä½¿ç”¨ javap -v Test.class å‘½ä»¤åç¼–è¯‘æŸ¥çœ‹ç»“æœã€‚

è¿è¡Œæ—¶å¸¸é‡æ± 
ç±»åŠ è½½æ—¶åˆ›å»ºï¼šJVM åŠ è½½ç±»æ—¶ï¼Œå°† .class æ–‡ä»¶çš„å¸¸é‡æ± è½¬æ¢åæ”¾å…¥æ–¹æ³•åŒº
åŠ¨æ€æ€§ï¼šè¿è¡Œæ—¶å¯ä»¥æ·»åŠ æ–°å¸¸é‡ï¼ˆå¦‚ String.intern()ï¼‰
çœŸå®åœ°å€ï¼šå°†ç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨ï¼ˆå†…å­˜çœŸå®åœ°å€ï¼‰

åŠ¨æ€æ·»åŠ æ —å­ï¼š
String s1 = new String(&quot;Hello&quot;);  // å †ä¸­åˆ›å»ºå¯¹è±¡String s2 = s1.intern();           // å°†&quot;Hello&quot;æ·»åŠ åˆ°è¿è¡Œæ—¶å¸¸é‡æ± System.out.println(s1 == s2);       // falseï¼ˆä¸åŒå¯¹è±¡ï¼‰System.out.println(&quot;Hello&quot; == s2);  // trueï¼ˆæŒ‡å‘å¸¸é‡æ± åŒä¸€å¯¹è±¡ï¼‰

å¸¸é‡æ±  vs è¿è¡Œæ—¶å¸¸é‡æ± 


ç‰¹æ€§
å¸¸é‡æ±  (Constant Pool)
è¿è¡Œæ—¶å¸¸é‡æ±  (Runtime Constant Pool)



å­˜åœ¨ä½ç½®
.class æ–‡ä»¶ä¸­
JVM æ–¹æ³•åŒºä¸­ï¼ˆJDK8+ çš„å…ƒç©ºé—´ï¼‰


åˆ›å»ºæ—¶æœº
ç¼–è¯‘æœŸç”Ÿæˆ
ç±»åŠ è½½æ—¶åˆ›å»º


å†…å®¹æ˜¯å¦å¯å˜
é™æ€ä¸å¯å˜
åŠ¨æ€å¯å˜ï¼ˆè¿è¡Œæ—¶æ·»åŠ æ–°å¸¸é‡ï¼‰


å­˜å‚¨å†…å®¹
ç¬¦å·å¼•ç”¨ + å­—é¢é‡
ç±»åŠ è½½åçš„çœŸå®å¼•ç”¨ + åŠ¨æ€å¸¸é‡


ç”Ÿå‘½å‘¨æœŸ
æ–‡ä»¶å­˜åœ¨å³å­˜åœ¨
ç±»å¸è½½æ—¶é”€æ¯


å­—ç¬¦ä¸²å¸¸é‡æ± å­—ç¬¦ä¸²å¸¸é‡æ±  æ˜¯ JVM ä¸ºäº†æå‡æ€§èƒ½å’Œå‡å°‘å†…å­˜æ¶ˆè€—é’ˆå¯¹å­—ç¬¦ä¸²ï¼ˆString ç±»ï¼‰ä¸“é—¨å¼€è¾Ÿçš„ä¸€å—åŒºåŸŸï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†é¿å…å­—ç¬¦ä¸²çš„é‡å¤åˆ›å»ºã€‚
ç‰¹ç‚¹
å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²ä»…æ˜¯ç¬¦å·ï¼Œåªæœ‰åœ¨è¢«ç”¨åˆ°æ—¶æ‰ä¼šè½¬åŒ–ä¸ºå¯¹è±¡
åˆ©ç”¨å­—ç¬¦ä¸²å¸¸é‡æ± çš„æœºåˆ¶ï¼Œæ¥é¿å…é‡å¤åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡
å­—ç¬¦ä¸²å˜é‡æ‹¼æ¥çš„åŸç†æ˜¯StringBuilder
å­—ç¬¦ä¸²å¸¸é‡æ‹¼æ¥çš„åŸç†æ˜¯ç¼–è¯‘å™¨ä¼˜åŒ–
å¯ä»¥ä½¿ç”¨internæ–¹æ³•ï¼Œä¸»åŠ¨å°†ä¸²æ± ä¸­è¿˜æ²¡æœ‰çš„å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥ä¸²æ± ä¸­

å­˜æ”¾ä½ç½®


JDKç‰ˆæœ¬
å­—ç¬¦ä¸²å¸¸é‡æ± ä½ç½®
å½±å“



JDK â‰¤ 6
è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆæ°¸ä¹…ä»£ï¼‰
å®¹æ˜“å¼•å‘ PermGen OOM


JDK 7+
å †å†…å­˜ ä¸­å•ç‹¬åˆ’åˆ†åŒºåŸŸ
å‡å°‘ OOM é£é™©ï¼Œæ”¯æŒæ›´å¤§å­—ç¬¦ä¸²æ± 


å­—ç¬¦ä¸²åˆ›å»ºæµç¨‹ï¼šgraph TD
    A[&quot;new String &#x27;hello&#x27;&quot;] --&gt; B&#123;&quot;æ± ä¸­æ˜¯å¦å­˜åœ¨ï¼Ÿ&quot;&#125;
    B --&gt;|å¦| C[&quot;åœ¨å †åˆ›å»ºæ–°å¯¹è±¡&quot;]
    B --&gt;|æ˜¯| D[&quot;è¿”å›æ± ä¸­å¼•ç”¨&quot;]
    C --&gt; E&#123;&quot;è°ƒç”¨ intern?&quot;&#125;
    E --&gt;|æ˜¯| F[&quot;å°†å¼•ç”¨åŠ å…¥å­—ç¬¦ä¸²æ± &quot;]
    E --&gt;|å¦| G[&quot;ç›´æ¥ä½¿ç”¨å †å¯¹è±¡&quot;]


internæ–¹æ³•
JDK1.8
è°ƒç”¨å­—ç¬¦ä¸²å¯¹è±¡çš„intern()æ–¹æ³•ï¼Œä¼šå°†è¯¥å­—ç¬¦ä¸²å¯¹è±¡å°è¯•æ”¾å…¥åˆ°ä¸²æ± ä¸­ã€‚

å¦‚æœä¸²æ± ä¸­æ²¡æœ‰è¯¥å­—ç¬¦ä¸²å¯¹è±¡ï¼Œåˆ™æ”¾å…¥æˆåŠŸï¼Œè¿”å›å¼•ç”¨çš„å¯¹è±¡
å¦‚æœæœ‰è¯¥å­—ç¬¦ä¸²å¯¹è±¡ï¼Œåˆ™æ”¾å…¥å¤±è´¥,è¿”å›å­—ç¬¦ä¸²é‡Œæœ‰çš„è¯¥å¯¹è±¡

æ— è®ºæ”¾å…¥æ˜¯å¦æˆåŠŸï¼Œéƒ½ä¼šè¿”å›ä¸²æ± ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚
æ³¨æ„ï¼šæ­¤æ—¶å¦‚æœè°ƒç”¨internæ–¹æ³•æˆåŠŸï¼Œå †å†…å­˜ä¸ä¸²æ± ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼›å¦‚æœå¤±è´¥ï¼Œåˆ™ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡

JDK1.6
è°ƒç”¨å­—ç¬¦ä¸²å¯¹è±¡çš„internæ–¹æ³•ï¼Œä¼šå°†è¯¥å­—ç¬¦ä¸²å¯¹è±¡å°è¯•æ”¾å…¥åˆ°ä¸²æ± ä¸­

å¦‚æœä¸²æ± ä¸­æ²¡æœ‰è¯¥å­—ç¬¦ä¸²å¯¹è±¡ï¼Œä¼šå°†è¯¥å­—ç¬¦ä¸²å¯¹è±¡å¤åˆ¶ä¸€ä»½ï¼Œå†æ”¾å…¥åˆ°ä¸²æ± ä¸­ï¼Œè¿”å›çš„æ˜¯å¤åˆ¶çš„å¯¹è±¡
å¦‚æœæœ‰è¯¥å­—ç¬¦ä¸²å¯¹è±¡ï¼Œåˆ™æ”¾å…¥å¤±è´¥ï¼Œè¿”å›ä¸²æ± åŸæœ‰çš„è¯¥å­—ç¬¦ä¸²çš„å¯¹è±¡

æ³¨æ„ï¼šæ­¤æ—¶æ— è®ºè°ƒç”¨internæ–¹æ³•æˆåŠŸä¸å¦ï¼Œä¸²æ± ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡å’Œå †å†…å­˜ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡éƒ½ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡


å­—ç¬¦ä¸²å¸¸é‡æ± å’Œè¿è¡Œæ—¶å¸¸é‡æ± æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿæ—©æœŸè®¾è®¡æ—¶ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± æ˜¯å±äºè¿è¡Œæ—¶å¸¸é‡æ± çš„ä¸€éƒ¨åˆ†ï¼Œä»–ä»¬å­˜å‚¨çš„ä½ç½®ä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚åç»­åšå‡ºäº†è°ƒæ•´ï¼Œå°†å­—ç¬¦ä¸²å¸¸é‡æ± å’Œè¿è¡Œæ—¶å¸¸é‡æ± åšäº†æ‹†åˆ†ã€‚

é™æ€å˜é‡å­˜å‚¨åœ¨å“ªé‡Œå‘¢ï¼Ÿ
JDK6åŠä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œé™æ€å˜é‡æ˜¯å­˜æ”¾åœ¨æ–¹æ³•åŒºä¸­çš„ï¼Œä¹Ÿå°±æ˜¯æ°¸ä¹…ä»£ã€‚
JDK7åŠä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œé™æ€å˜é‡æ˜¯å­˜æ”¾åœ¨å †ä¸­çš„Classå¯¹è±¡ä¸­ï¼Œè„±ç¦»äº†æ°¸ä¹…ä»£ã€‚å…·ä½“æºç å¯å‚è€ƒè™šæ‹Ÿæœºæºç ï¼šBytecodeInterpreteré’ˆå¯¹putstaticæŒ‡ä»¤çš„å¤„ç†ã€‚


ç›´æ¥å†…å­˜ç›´æ¥å†…å­˜æŒ‡çš„å°±æ˜¯Direct Memoryï¼Œå¸¸è§äºNioæ“ä½œï¼ŒåŒºåˆ«äºioï¼Œåœ¨è¯»å†™æ“ä½œæ—¶æœ‰ç€æ›´é«˜çš„æ•ˆç‡ã€‚ç›´æ¥å†…å­˜å¹¶ä¸åœ¨ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å­˜åœ¨ï¼Œæ‰€ä»¥å¹¶ä¸å±äºJavaè¿è¡Œæ—¶çš„å†…å­˜åŒºåŸŸã€‚
ç‰¹ç‚¹ï¼š
å¸¸è§äº NIO æ“ä½œæ—¶ï¼Œç”¨äºæ•°æ®ç¼“å†²åŒº
åˆ†é…å›æ”¶æˆæœ¬è¾ƒé«˜ï¼Œä½†è¯»å†™æ€§èƒ½é«˜
ä¸å— JVM å†…å­˜å›æ”¶ç®¡ç†




å­¦ä¹ æ–‡çŒ®

https://blog.csdn.net/weixin_50280576/article/details/113775575
https://lisxpq12rl7.feishu.cn/wiki/F2AFw0doOiW89Fkr8kGcCTyVnLh
https://pdai.tech/md/java/jvm/java-jvm-x-overview.html
https://javaguide.cn/java/jvm/jvm-garbage-collection.html
https://javabetter.cn/jvm/jit.html

]]></content>
      <categories>
        <category>JAVA</category>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Javaè¿›é˜¶ å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>MySqlè¿›é˜¶</title>
    <url>/2025/06/10/MySQL/MySql%E8%BF%9B%E9%98%B6/</url>
    <content><![CDATA[MySqlè¿›é˜¶
æ­¤ç¬”è®°ç”±æœ¬äººå­¦ä¹  B ç«™é»‘é©¬ç¨‹åºå‘˜ MySQL æ•°æ®åº“è§†é¢‘è¿›é˜¶ç¯‡å†…å®¹åï¼Œæ€»ç»“æå–æ‘˜è¦åˆ¶æˆã€‚è§†é¢‘åœ°å€ï¼šé»‘é©¬ç¨‹åºå‘˜ MySQLæ•°æ®åº“å…¥é—¨åˆ°ç²¾é€šï¼Œä»mysqlå®‰è£…åˆ°mysqlé«˜çº§ã€mysqlä¼˜åŒ–å…¨å›Šæ‹¬

MySQLä½“ç³»ç»“æ„MySQLä½“ç³»ç»“æ„ï¼šè¿æ¥å±‚ï¼ŒæœåŠ¡å±‚ï¼Œå¼•æ“å±‚ï¼Œå­˜å‚¨å±‚ã€‚


è¿æ¥å±‚ï¼šå¤„ç†å®¢æˆ·ç«¯è¿æ¥ã€è®¤è¯å’Œçº¿ç¨‹ç®¡ç†ã€‚
è¿æ¥å™¨ï¼ˆConnectorï¼‰ï¼š
å¤„ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ï¼Œæ”¯æŒ TCP&#x2F;IPã€Unix Socketã€å‘½åç®¡é“ç­‰è¿æ¥æ–¹å¼ã€‚
éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆç”¨æˆ·åã€å¯†ç ã€ä¸»æœºæƒé™ï¼‰ã€‚
ä¸ºæ¯ä¸ªè¿æ¥åˆ†é…çº¿ç¨‹ï¼ˆæˆ–ä»çº¿ç¨‹æ± è·å–ï¼‰ã€‚


çº¿ç¨‹æ± ï¼ˆThread Poolï¼‰ï¼š
ç®¡ç†æ•°æ®åº“è¿æ¥çº¿ç¨‹ï¼Œå‡å°‘é¢‘ç¹åˆ›å»º &#x2F; é”€æ¯çº¿ç¨‹çš„å¼€é”€ã€‚
é€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯ï¼ˆå¦‚ MySQL Enterprise Editionï¼‰ã€‚




æœåŠ¡å±‚ï¼šåŒ…æ‹¬è¿æ¥å™¨ã€æŸ¥è¯¢ç¼“å­˜ã€åˆ†æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œå™¨ç­‰ï¼Œæ¶µç›– MySQL çš„å¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡åŠŸèƒ½ï¼Œä»¥åŠæ‰€æœ‰çš„å†…ç½®å‡½æ•°ï¼ˆå¦‚æ—¥æœŸã€æ—¶é—´ã€æ•°å­¦å’ŒåŠ å¯†å‡½æ•°ç­‰ï¼‰ï¼Œæ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½éƒ½åœ¨è¿™ä¸€å±‚å®ç°ï¼Œæ¯”å¦‚å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ã€‚
SQL æ¥å£ï¼ˆSQL Interfaceï¼‰ï¼š
æ¥æ”¶ SQL è¯·æ±‚ï¼ˆSELECTã€INSERT ç­‰ï¼‰ï¼Œè¿”å›æŸ¥è¯¢ç»“æœã€‚


æŸ¥è¯¢è§£æå™¨ï¼ˆParserï¼‰ï¼š
å¯¹ SQL è¯­å¥è¿›è¡Œè¯æ³•å’Œè¯­æ³•åˆ†æï¼Œç”Ÿæˆè§£ææ ‘ï¼ˆParse Treeï¼‰ã€‚
éªŒè¯è¯­å¥è¯­æ³•æ­£ç¡®æ€§ï¼ˆå¦‚å…³é”®å­—æ‹¼å†™ã€è¡¨å &#x2F; åˆ—åæ˜¯å¦å­˜åœ¨ï¼‰ã€‚


é¢„å¤„ç†å™¨ï¼ˆPreprocessorï¼‰ï¼š
è¿›ä¸€æ­¥æ£€æŸ¥è§£ææ ‘çš„åˆæ³•æ€§ï¼ˆå¦‚æƒé™æ£€æŸ¥ã€å¤–é”®çº¦æŸéªŒè¯ï¼‰ã€‚
æ›¿æ¢åˆ«åã€å±•å¼€è§†å›¾ç­‰æ“ä½œã€‚


æŸ¥è¯¢ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰ï¼š
ç”Ÿæˆæœ€ä¼˜æ‰§è¡Œè®¡åˆ’ï¼ˆå¦‚é€‰æ‹©ç´¢å¼•ã€è¡¨è¿æ¥é¡ºåºï¼‰ã€‚
æ”¯æŒæˆæœ¬ä¼˜åŒ–ï¼ˆCost-Based Optimization, CBOï¼‰å’Œè§„åˆ™ä¼˜åŒ–ï¼ˆRule-Based Optimization, RBOï¼‰ã€‚


æŸ¥è¯¢æ‰§è¡Œå¼•æ“ï¼ˆExecution Engineï¼‰ï¼š
æ ¹æ®æ‰§è¡Œè®¡åˆ’è°ƒç”¨å­˜å‚¨å¼•æ“ API æ‰§è¡ŒæŸ¥è¯¢ã€‚


ç¼“å­˜ï¼ˆQuery Cacheï¼‰ï¼š
ç¼“å­˜ SQL è¯­å¥åŠå…¶ç»“æœï¼ˆ5.7 ç‰ˆæœ¬åé€æ¸å¼ƒç”¨ï¼Œ8.0 ç‰ˆæœ¬ç§»é™¤ï¼‰ã€‚
å½“æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œç›¸å…³ç¼“å­˜ä¼šè¢«è‡ªåŠ¨æ¸…é™¤ã€‚




å¼•æ“å±‚ï¼šè´Ÿè´£æ•°æ®çš„å­˜å‚¨å’Œæ£€ç´¢ã€‚æ¶æ„æ¨¡å¼æ˜¯æ’ä»¶å¼ï¼ŒæœåŠ¡å™¨é€šè¿‡APIå’Œå­˜å‚¨å¼•æ“è¿›è¡Œé€šä¿¡ã€‚æ”¯æŒ InnoDBã€MyISAMã€Memory ç­‰å¤šä¸ªå­˜å‚¨å¼•æ“ã€‚
æ’ä»¶å¼æ¶æ„ï¼šæ”¯æŒå¤šç§å­˜å‚¨å¼•æ“ï¼Œé€šè¿‡ç»Ÿä¸€æ¥å£ä¸ä¸Šå±‚äº¤äº’ã€‚
å¸¸è§å¼•æ“ï¼š
InnoDBï¼šé»˜è®¤å¼•æ“ï¼Œæ”¯æŒäº‹åŠ¡ã€å¤–é”®ã€è¡Œçº§é”ã€‚
MyISAMï¼šä¸æ”¯æŒäº‹åŠ¡ï¼Œè¡¨çº§é”ï¼Œé€‚åˆè¯»å¤šå†™å°‘åœºæ™¯ã€‚
Memoryï¼šæ•°æ®å­˜å‚¨åœ¨å†…å­˜ï¼Œè¯»å†™æå¿«ï¼Œé‡å¯ä¸¢å¤±æ•°æ®ã€‚
Archiveï¼šé«˜åº¦å‹ç¼©ï¼Œä»…æ”¯æŒ INSERT&#x2F;SELECTï¼Œé€‚åˆå†å²æ•°æ®å½’æ¡£ã€‚


æ ¸å¿ƒåŠŸèƒ½ï¼š
æ•°æ®å­˜å‚¨ä¸æ£€ç´¢ï¼ˆå¦‚ B + æ ‘ç´¢å¼•ã€å“ˆå¸Œç´¢å¼•ï¼‰ã€‚
äº‹åŠ¡å¤„ç†ï¼ˆInnoDBï¼‰ã€‚
é”æœºåˆ¶ï¼ˆè¡Œé”ã€è¡¨é”ï¼‰ã€‚




å­˜å‚¨å±‚ï¼šMYSQLçš„ç‰©ç†å­˜å‚¨éƒ¨åˆ†ï¼Œè´Ÿè´£å°†æ•°æ®(å¦‚: redologã€undologã€æ•°æ®ã€ç´¢å¼•ã€äºŒè¿›åˆ¶æ—¥å¿—ã€é”™è¯¯æ—¥å¿—ã€æŸ¥è¯¢ æ—¥å¿—ã€æ…¢æŸ¥è¯¢æ—¥å¿—ç­‰)å­˜å‚¨åœ¨ç£ç›˜ä¸Šã€‚
æ•°æ®æ–‡ä»¶ï¼š
.frmï¼šå­˜å‚¨è¡¨ç»“æ„å®šä¹‰ã€‚
.ibdï¼šInnoDB ç‹¬ç«‹è¡¨ç©ºé—´æ–‡ä»¶ï¼ˆå­˜å‚¨æ•°æ®å’Œç´¢å¼•ï¼‰ã€‚
.MYD&#x2F;.MYIï¼šMyISAM æ•°æ®æ–‡ä»¶å’Œç´¢å¼•æ–‡ä»¶ã€‚


æ—¥å¿—æ–‡ä»¶ï¼š
äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBinlogï¼‰ï¼šè®°å½•æ•°æ®å˜æ›´ï¼Œç”¨äºä¸»ä»å¤åˆ¶å’Œæ¢å¤ã€‚
é‡åšæ—¥å¿—ï¼ˆRedo Logï¼‰ï¼šç¡®ä¿äº‹åŠ¡æŒä¹…æ€§ï¼Œå´©æºƒæ¢å¤ã€‚
å›æ»šæ—¥å¿—ï¼ˆUndo Logï¼‰ï¼šæ”¯æŒäº‹åŠ¡å›æ»šå’Œ MVCCã€‚
é”™è¯¯æ—¥å¿—ï¼ˆError Logï¼‰ï¼šè®°å½•å¯åŠ¨ã€è¿è¡Œæ—¶é”™è¯¯ä¿¡æ¯ã€‚
æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆSlow Query Logï¼‰ï¼šè®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡é˜ˆå€¼çš„ SQLã€‚


é…ç½®æ–‡ä»¶ï¼š
my.cnf&#x2F;my.iniï¼šå­˜å‚¨ MySQL é…ç½®å‚æ•°ï¼ˆå¦‚å†…å­˜åˆ†é…ã€å­—ç¬¦é›†ï¼‰ã€‚





å­˜å‚¨å¼•æ“ä»–æ˜¯mysqlæ•°æ®åº“çš„æ ¸å¿ƒï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦åœ¨åˆé€‚çš„åœºæ™¯é€‰æ‹©åˆé€‚çš„å­˜å‚¨å¼•æ“ã€‚å­˜å‚¨å¼•æ“æ˜¯å­˜å‚¨æ•°æ®ã€å»ºç«‹ç´¢å¼•ã€æ›´æ–°&#x2F;æŸ¥è¯¢æ•°æ®ç­‰æŠ€æœ¯çš„å®ç°æ–¹å¼ ã€‚å­˜å‚¨å¼•æ“æ˜¯åŸºäºè¡¨çš„ï¼Œè€Œä¸æ˜¯ åŸºäºåº“çš„ï¼Œæ‰€ä»¥å­˜å‚¨å¼•æ“ä¹Ÿå¯è¢«ç§°ä¸ºè¡¨ç±»å‹ã€‚å¯ä»¥åœ¨åˆ›å»ºè¡¨çš„æ—¶æŒ‡å®šé€‰æ‹©çš„å­˜å‚¨å¼•æ“ï¼Œæ²¡æœ‰æŒ‡å®šå°†è‡ªåŠ¨é€‰æ‹©é»˜è®¤çš„å­˜å‚¨å¼•æ“ã€‚

å»ºè¡¨æ—¶æŒ‡å®šå­˜å‚¨å¼•æ“

CREATE TABLE è¡¨å(å­—æ®µ1 å­—æ®µ1ç±»å‹ [ COMMENT å­—æ®µ1æ³¨é‡Š ] ,......å­—æ®µn å­—æ®µnç±»å‹ [COMMENT å­—æ®µnæ³¨é‡Š ]) ENGINE = INNODB [ COMMENT è¡¨æ³¨é‡Š ] ;


æŸ¥è¯¢å½“å‰æ•°æ®åº“æ”¯æŒçš„å­˜å‚¨å¼•æ“

show engines;

MySQL æ”¯æŒå¤šç§å­˜å‚¨å¼•æ“ï¼Œæ¯ç§å¼•æ“éƒ½æœ‰å…¶ç‹¬ç‰¹çš„ç‰¹æ€§å’Œé€‚ç”¨åœºæ™¯ã€‚ä»¥ä¸‹æ˜¯å¸¸è§å­˜å‚¨å¼•æ“çš„å¯¹æ¯”åŠé€‰æ‹©å»ºè®®ã€‚
InnoDBä»‹ç»InnoDBæ˜¯ä¸€ç§å…¼é¡¾é«˜å¯é æ€§å’Œé«˜æ€§èƒ½çš„é€šç”¨å­˜å‚¨å¼•æ“ï¼Œåœ¨ MySQL 5.5 ä¹‹åï¼ŒInnoDBæ˜¯é»˜è®¤çš„ MySQL å­˜å‚¨å¼•æ“ã€‚
ç‰¹ç‚¹
DMLæ“ä½œéµå¾ªACIDæ¨¡å‹ï¼Œæ”¯æŒäº‹åŠ¡ï¼›
è¡Œçº§é”ï¼Œæé«˜å¹¶å‘è®¿é—®æ€§èƒ½ï¼›
æ”¯æŒå¤–é”®FOREIGN KEYçº¦æŸï¼Œä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ï¼›

æ–‡ä»¶ç»“æ„
xxx.ibdï¼šxxxä»£è¡¨çš„æ˜¯è¡¨åï¼ŒinnoDBå¼•æ“çš„æ¯å¼ è¡¨éƒ½ä¼šå¯¹åº”è¿™æ ·ä¸€ä¸ªè¡¨ç©ºé—´æ–‡ä»¶ï¼Œå­˜å‚¨è¯¥è¡¨çš„è¡¨ç»“æ„ï¼ˆfrm-æ—©æœŸçš„ ã€sdi-æ–°ç‰ˆçš„ï¼‰ã€æ•°æ®å’Œç´¢å¼•ã€‚

å‚æ•°ï¼šinnodb_file_per_table


  show variables like &#x27;innodb_file_per_table&#x27;


  å¦‚æœè¯¥å‚æ•°å¼€å¯ï¼Œä»£è¡¨å¯¹äºInnoDBå¼•æ“çš„è¡¨ï¼Œæ¯ä¸€å¼ è¡¨éƒ½å¯¹åº”ä¸€ä¸ªibdæ–‡ä»¶ã€‚ibdæ–‡ä»¶ä¸­ä¸ä»…å­˜æ”¾è¡¨ç»“æ„ã€æ•°æ®è¿˜ä¼šå­˜æ”¾è¯¥è¡¨å¯¹åº”çš„ç´¢å¼•ä¿¡æ¯ã€‚ è€Œè¯¥æ–‡ä»¶æ˜¯åŸºäºäºŒè¿›åˆ¶å­˜å‚¨çš„ï¼Œä¸èƒ½ç›´æ¥åŸºäºè®°äº‹æœ¬æ‰“å¼€ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨mysqlæä¾›çš„ä¸€ä¸ªæŒ‡ä»¤ ibd2sdi ï¼Œé€šè¿‡è¯¥æŒ‡ä»¤å°±å¯ä»¥ä»ibdæ–‡ä»¶ä¸­æå–sdiä¿¡æ¯ï¼Œè€Œsdiæ•°æ®å­—å…¸ä¿¡æ¯ä¸­å°±åŒ…å«è¯¥è¡¨çš„è¡¨ç»“æ„ã€‚
é€»è¾‘å­˜å‚¨ç»“æ„

è¡¨ç©ºé—´ : InnoDBå­˜å‚¨å¼•æ“é€»è¾‘ç»“æ„çš„æœ€é«˜å±‚ï¼Œibdæ–‡ä»¶å…¶å®å°±æ˜¯è¡¨ç©ºé—´æ–‡ä»¶ï¼Œåœ¨è¡¨ç©ºé—´ä¸­å¯ä»¥åŒ…å«å¤šä¸ªSegmentæ®µã€‚
æ®µ : è¡¨ç©ºé—´æ˜¯ç”±å„ä¸ªæ®µç»„æˆçš„ï¼Œ å¸¸è§çš„æ®µæœ‰æ•°æ®æ®µã€ç´¢å¼•æ®µã€å›æ»šæ®µç­‰ã€‚InnoDBä¸­å¯¹äºæ®µçš„ç®¡ç†ï¼Œéƒ½æ˜¯å¼•æ“è‡ªèº«å®Œæˆï¼Œä¸éœ€è¦äººä¸ºå¯¹å…¶æ§åˆ¶ï¼Œä¸€ä¸ªæ®µä¸­åŒ…å«å¤šä¸ªåŒºã€‚
åŒº : åŒºæ˜¯è¡¨ç©ºé—´çš„å•å…ƒç»“æ„ï¼Œæ¯ä¸ªåŒºçš„å¤§å°ä¸º1Mã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œ InnoDBå­˜å‚¨å¼•æ“é¡µå¤§å°ä¸º16Kï¼Œ å³ä¸€ä¸ªåŒºä¸­ä¸€å…±æœ‰64ä¸ªè¿ç»­çš„é¡µã€‚
é¡µ : é¡µæ˜¯ç»„æˆåŒºçš„æœ€å°å•å…ƒï¼Œé¡µä¹Ÿæ˜¯InnoDB å­˜å‚¨å¼•æ“ç£ç›˜ç®¡ç†çš„æœ€å°å•å…ƒï¼Œæ¯ä¸ªé¡µçš„å¤§å°é»˜è®¤ä¸º 16KBã€‚ä¸ºäº†ä¿è¯é¡µçš„è¿ç»­æ€§ï¼ŒInnoDB å­˜å‚¨å¼•æ“æ¯æ¬¡ä»ç£ç›˜ç”³è¯· 4-5 ä¸ªåŒºã€‚
è¡Œ : InnoDB å­˜å‚¨å¼•æ“æ˜¯é¢å‘è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®æ˜¯æŒ‰è¡Œè¿›è¡Œå­˜æ”¾çš„ï¼Œåœ¨æ¯ä¸€è¡Œä¸­é™¤äº†å®šä¹‰è¡¨æ—¶æ‰€æŒ‡å®šçš„å­—æ®µä»¥å¤–ï¼Œè¿˜åŒ…å«ä¸¤ä¸ªéšè—å­—æ®µ(åé¢ä¼šè¯¦ç»†ä»‹ç»)ã€‚

é€‚ç”¨åœºæ™¯
äº‹åŠ¡æ€§åº”ç”¨ï¼ˆå¦‚ç”µå•†ã€é‡‘èç³»ç»Ÿï¼‰ã€‚
é«˜å¹¶å‘è¯»å†™åœºæ™¯ã€‚
éœ€è¦å¤–é”®çº¦æŸçš„è¡¨ã€‚

MyISAMä»‹ç»MyISAMæ˜¯MySQLæ—©æœŸçš„é»˜è®¤å­˜å‚¨å¼•æ“ã€‚
ç‰¹ç‚¹
ä¸æ”¯æŒäº‹åŠ¡ï¼Œä¸æ”¯æŒå¤–é”®
æ”¯æŒè¡¨é”ï¼Œä¸æ”¯æŒè¡Œé”
ä¼˜ç‚¹ï¼šæ›´å°‘çš„å­˜å‚¨ç©ºé—´ï¼Œæ”¯æŒå…¨æ–‡ç´¢å¼•ï¼Œé€‚ç”¨äºè¯»å–é¢‘ç‡è¾ƒé«˜ã€å†™å…¥é¢‘ç‡è¾ƒä½çš„åº”ç”¨åœºæ™¯

æ–‡ä»¶ç»“æ„
xxx.sdiï¼šå­˜å‚¨è¡¨ç»“æ„ä¿¡æ¯

xxx.MYD: å­˜å‚¨æ•°æ®

xxx.MYI: å­˜å‚¨ç´¢å¼•



é€‚ç”¨åœºæ™¯
åªè¯»æˆ–å†™å…¥å°‘ã€æŸ¥è¯¢å¤šçš„åœºæ™¯ï¼ˆå¦‚æ—¥å¿—è¡¨ã€ç»Ÿè®¡æ•°æ®ï¼‰ã€‚
ä¸éœ€è¦äº‹åŠ¡æ”¯æŒçš„åœºæ™¯ã€‚

Memoryä»‹ç»Memoryå¼•æ“çš„è¡¨æ•°æ®æ—¶å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œç”±äºå—åˆ°ç¡¬ä»¶é—®é¢˜ã€æˆ–æ–­ç”µé—®é¢˜çš„å½±å“ï¼Œåªèƒ½å°†è¿™äº›è¡¨ä½œä¸ºä¸´æ—¶è¡¨æˆ–ç¼“å­˜ä½¿ç”¨ã€‚
ç‰¹ç‚¹
æ•°æ®å­˜å‚¨åœ¨å†…å­˜ï¼šè¯»å†™é€Ÿåº¦æå¿«ï¼Œä½†é‡å¯åæ•°æ®ä¸¢å¤±ã€‚
æ”¯æŒå“ˆå¸Œç´¢å¼•ï¼šé€‚åˆå¿«é€ŸæŸ¥æ‰¾ã€‚
è¡¨çº§é”ï¼šå¹¶å‘æ€§èƒ½æœ‰é™ã€‚

æ–‡ä»¶ç»“æ„
xxx.sdiï¼šå­˜å‚¨è¡¨ç»“æ„ä¿¡æ¯
æ•°æ®ï¼Œ éƒ½åœ¨å†…å­˜ä¸­

é€‚ç”¨åœºæ™¯
ä¸´æ—¶è¡¨&#x2F;ä¸­é—´ç»“æœé›†ï¼š MySQL å†…éƒ¨è‡ªåŠ¨ä½¿ç”¨ã€‚
é«˜é€Ÿç¼“å­˜ï¼š å­˜å‚¨é¢‘ç¹è®¿é—®çš„å°å‹ã€éå…³é”®ã€å¯ä¸¢å¤±çš„åªè¯»&#x2F;ä½é¢‘å†™æ•°æ®ï¼ˆå¦‚ä¼šè¯ä¿¡æ¯ã€é…ç½®ï¼‰ã€‚
éœ€è¦æä½å»¶è¿Ÿè®¿é—®çš„åªè¯»æŸ¥è¯¢ã€‚

é‡è¦è­¦å‘Šï¼š ç»å¯¹ä¸è¦ç”¨äºå­˜å‚¨é‡è¦æˆ–æŒä¹…åŒ–æ•°æ®ã€‚å†…å­˜æœ‰é™ï¼Œå¤§è¡¨æ˜“å¯¼è‡´ OOMã€‚
InnoDB, MyISAM, Memoryçš„åŒºåˆ«ï¼Œä½¿ç”¨åœºæ™¯

é¢è¯•é¢˜:InnoDBå¼•æ“ä¸MyISAMå¼•æ“çš„åŒºåˆ« ?â‘ . InnoDBå¼•æ“, æ”¯æŒäº‹åŠ¡, è€ŒMyISAMä¸æ”¯æŒã€‚â‘¡. InnoDBå¼•æ“, æ”¯æŒè¡Œé”å’Œè¡¨é”, è€ŒMyISAMä»…æ”¯æŒè¡¨é”, ä¸æ”¯æŒè¡Œé”ã€‚â‘¢. InnoDBå¼•æ“, æ”¯æŒå¤–é”®, è€ŒMyISAMæ˜¯ä¸æ”¯æŒçš„ã€‚

ç´¢å¼•ä»‹ç»ç´¢å¼•ï¼ˆindexï¼‰æ˜¯å¸®åŠ©MySQLé«˜æ•ˆè·å–æ•°æ®çš„æ•°æ®ç»“æ„(æœ‰åº)ã€‚åœ¨æ•°æ®ä¹‹å¤–ï¼Œæ•°æ®åº“ç³»ç»Ÿè¿˜ç»´æŠ¤ç€æ»¡è¶³ ç‰¹å®šæŸ¥æ‰¾ç®—æ³•çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„ä»¥æŸç§æ–¹å¼å¼•ç”¨ï¼ˆæŒ‡å‘ï¼‰æ•°æ®ï¼Œ è¿™æ ·å°±å¯ä»¥åœ¨è¿™äº›æ•°æ®ç»“æ„ ä¸Šå®ç°é«˜çº§æŸ¥æ‰¾ç®—æ³•ï¼Œè¿™ç§æ•°æ®ç»“æ„å°±æ˜¯ç´¢å¼•ã€‚å®ƒç±»ä¼¼äºä¹¦ç±çš„ç›®å½•ï¼Œå…è®¸æ•°æ®åº“å¿«é€Ÿå®šä½ç‰¹å®šæ•°æ®ï¼Œé¿å…å…¨è¡¨æ‰«æã€‚

ç‰¹ç‚¹


ä¼˜åŠ¿
åŠ£åŠ¿



æé«˜æ•°æ®æ£€ç´¢çš„æ•ˆç‡ï¼Œé™ä½æ•°æ®åº“ çš„IOæˆæœ¬
ç´¢å¼•åˆ—ä¹Ÿæ˜¯è¦å ç”¨ç©ºé—´çš„ã€‚


é€šè¿‡ç´¢å¼•åˆ—å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œé™ä½ æ•°æ®æ’åºçš„æˆæœ¬ï¼Œé™ä½CPUçš„æ¶ˆè€—ã€‚
ç´¢å¼•å¤§å¤§æé«˜äº†æŸ¥è¯¢æ•ˆç‡ï¼ŒåŒæ—¶å´ä¹Ÿé™ä½æ›´æ–°è¡¨çš„é€Ÿåº¦ï¼Œ å¦‚å¯¹è¡¨è¿›è¡ŒINSERTã€UPDATEã€DELETEæ—¶ï¼Œæ•ˆç‡é™ä½ã€‚






ç´¢å¼•ç»“æ„æ¦‚è¿°MySQLçš„ç´¢å¼•æ˜¯åœ¨å­˜å‚¨å¼•æ“å±‚å®ç°çš„ï¼Œä¸åŒçš„å­˜å‚¨å¼•æ“æœ‰ä¸åŒçš„ç´¢å¼•ç»“æ„ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ç§ï¼š

ä¸Šè¿°æ˜¯MySQLä¸­æ‰€æ”¯æŒçš„æ‰€æœ‰çš„ç´¢å¼•ç»“æ„ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ä¸åŒçš„å­˜å‚¨å¼•æ“å¯¹äºç´¢å¼•ç»“æ„çš„æ”¯æŒ æƒ…å†µã€‚


æ³¨æ„ï¼š æˆ‘ä»¬å¹³å¸¸æ‰€è¯´çš„ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰ç‰¹åˆ«æŒ‡æ˜ï¼Œéƒ½æ˜¯æŒ‡B+æ ‘ç»“æ„ç»„ç»‡çš„ç´¢å¼•ã€‚

äºŒå‰æ ‘å‡å¦‚è¯´MySQLçš„ç´¢å¼•ç»“æ„é‡‡ç”¨äºŒå‰æ ‘çš„æ•°æ®ç»“æ„ï¼Œæ¯”è¾ƒç†æƒ³çš„ç»“æ„å¦‚ä¸‹ï¼š

å¦‚æœä¸»é”®æ˜¯é¡ºåºæ’å…¥çš„ï¼Œåˆ™ä¼šå½¢æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œç»“æ„å¦‚ä¸‹ï¼š

æ‰€ä»¥ï¼Œå¦‚æœé€‰æ‹©äºŒå‰æ ‘ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œä¼šå­˜åœ¨ä»¥ä¸‹ç¼ºç‚¹ï¼š

é¡ºåºæ’å…¥æ—¶ï¼Œä¼šå½¢æˆä¸€ä¸ªé“¾è¡¨ï¼ŒæŸ¥è¯¢æ€§èƒ½å¤§å¤§é™ä½ã€‚
å¤§æ•°æ®é‡æƒ…å†µä¸‹ï¼Œå±‚çº§è¾ƒæ·±ï¼Œæ£€ç´¢é€Ÿåº¦æ…¢ã€‚

æ­¤æ—¶å¤§å®¶å¯èƒ½ä¼šæƒ³åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©çº¢é»‘æ ‘ï¼Œçº¢é»‘æ ‘æ˜¯ä¸€é¢—è‡ªå¹³è¡¡äºŒå‰æ ‘ï¼Œé‚£è¿™æ ·å³ä½¿æ˜¯é¡ºåºæ’å…¥æ•° æ®ï¼Œæœ€ç»ˆå½¢æˆçš„æ•°æ®ç»“æ„ä¹Ÿæ˜¯ä¸€é¢—å¹³è¡¡çš„äºŒå‰æ ‘,ç»“æ„å¦‚ä¸‹:

ä½†æ˜¯ï¼Œå³ä½¿å¦‚æ­¤ï¼Œç”±äºçº¢é»‘æ ‘ä¹Ÿæ˜¯ä¸€é¢—äºŒå‰æ ‘ï¼Œæ‰€ä»¥ä¹Ÿä¼šå­˜åœ¨ä¸€ä¸ªç¼ºç‚¹ï¼š

è§£å†³äºŒå‰æ ‘çš„é¡ºåºæ’å…¥åï¼Œæ ‘ä¸å¹³è¡¡çš„é—®é¢˜ã€‚
å¤§æ•°æ®é‡æƒ…å†µä¸‹ï¼Œå±‚çº§è¾ƒæ·±ï¼Œæ£€ç´¢é€Ÿåº¦æ…¢ã€‚

B-TreeB-Treeï¼ŒBæ ‘æ˜¯ä¸€ç§å¤šå‰è·¯è¡¡æŸ¥æ‰¾æ ‘ï¼Œç›¸å¯¹äºäºŒå‰æ ‘ï¼ŒBæ ‘æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªåˆ†æ”¯ï¼Œå³å¤šå‰ã€‚ ä»¥ä¸€é¢—æœ€å¤§åº¦æ•°ï¼ˆmax-degreeï¼‰ä¸º5(5é˜¶)çš„b-treeä¸ºä¾‹ï¼Œé‚£è¿™ä¸ªBæ ‘æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šå­˜å‚¨4ä¸ªkeyï¼Œ5 ä¸ªæŒ‡é’ˆï¼š


çŸ¥è¯†å°è´´å£«: æ ‘çš„åº¦æ•°æŒ‡çš„æ˜¯ä¸€ä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ªæ•°ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªæ•°æ®ç»“æ„å¯è§†åŒ–çš„ç½‘ç«™æ¥ç®€å•æ¼”ç¤ºä¸€ä¸‹ã€‚B-Tree Visualization (usfca.edu)

æ’å…¥ä¸€ç»„æ•°æ®ï¼š 100 65 169 368 900 556 780 35 215 1200 234 888 158 90 1000 88 120 268 250 ã€‚ç„¶åè§‚å¯Ÿä¸€äº›æ•°æ®æ’å…¥è¿‡ç¨‹ä¸­ï¼ŒèŠ‚ç‚¹çš„å˜åŒ–æƒ…å†µã€‚

ç‰¹ç‚¹ï¼š

5é˜¶çš„Bæ ‘ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹æœ€å¤šå­˜å‚¨4ä¸ªkeyï¼Œå¯¹åº”5ä¸ªæŒ‡é’ˆã€‚
ä¸€æ—¦èŠ‚ç‚¹å­˜å‚¨çš„keyæ•°é‡åˆ°è¾¾5ï¼Œå°±ä¼šè£‚å˜ï¼Œä¸­é—´å…ƒç´ å‘ä¸Šåˆ†è£‚ã€‚
åœ¨Bæ ‘ä¸­ï¼Œéå¶å­èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹éƒ½ä¼šå­˜æ”¾æ•°æ®ã€‚

B+TreeB+Treeæ˜¯B-Treeçš„å˜ç§ï¼Œæˆ‘ä»¬ä»¥ä¸€é¢—æœ€å¤§åº¦æ•°ï¼ˆmax-degreeï¼‰ä¸º4ï¼ˆ4é˜¶ï¼‰çš„b+treeä¸ºä¾‹ï¼Œæ¥çœ‹ä¸€ ä¸‹å…¶ç»“æ„ç¤ºæ„å›¾ï¼š

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸¤éƒ¨åˆ†ï¼š 

ç»¿è‰²æ¡†æ¡†èµ·æ¥çš„éƒ¨åˆ†ï¼Œæ˜¯ç´¢å¼•éƒ¨åˆ†ï¼Œä»…ä»…èµ·åˆ°ç´¢å¼•æ•°æ®çš„ä½œç”¨ï¼Œä¸å­˜å‚¨æ•°æ®ã€‚ 
çº¢è‰²æ¡†æ¡†èµ·æ¥çš„éƒ¨åˆ†ï¼Œæ˜¯æ•°æ®å­˜å‚¨éƒ¨åˆ†ï¼Œåœ¨å…¶å¶å­èŠ‚ç‚¹ä¸­è¦å­˜å‚¨å…·ä½“çš„æ•°æ®ã€‚

é€šè¿‡ä¸€ä¸ªæ•°æ®ç»“æ„å¯è§†åŒ–çš„ç½‘ç«™æ¥ç®€å•æ¼”ç¤ºä¸€ä¸‹ã€‚[B+ Tree Visualization (usfca.edu)

æ’å…¥ä¸€ç»„æ•°æ®ï¼š 100 65 169 368 900 556 780 35 215 1200 234 888 158 90 1000 88 120 268 250 ã€‚ç„¶åè§‚å¯Ÿä¸€äº›æ•°æ®æ’å…¥è¿‡ç¨‹ä¸­ï¼ŒèŠ‚ç‚¹çš„å˜åŒ–æƒ…å†µã€‚

æœ€ç»ˆæˆ‘ä»¬çœ‹åˆ°ï¼ŒB+Tree ä¸ B-Treeç›¸æ¯”ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç‚¹åŒºåˆ«ï¼š 

æ‰€æœ‰çš„æ•°æ®éƒ½ä¼šå‡ºç°åœ¨å¶å­èŠ‚ç‚¹ã€‚ 
å¶å­èŠ‚ç‚¹å½¢æˆä¸€ä¸ªå•å‘é“¾è¡¨ã€‚
éå¶å­èŠ‚ç‚¹ä»…ä»…èµ·åˆ°ç´¢å¼•æ•°æ®ä½œç”¨ï¼Œå…·ä½“çš„æ•°æ®éƒ½æ˜¯åœ¨å¶å­èŠ‚ç‚¹å­˜æ”¾çš„ã€‚

MySQLä¼˜åŒ–åçš„B+ Treeï¼š
ä¸Šè¿°æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ç»“æ„æ˜¯æ ‡å‡†çš„B+Treeçš„æ•°æ®ç»“æ„ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹MySQLä¸­ä¼˜åŒ–ä¹‹åçš„ B+Treeã€‚ MySQLç´¢å¼•æ•°æ®ç»“æ„å¯¹ç»å…¸çš„B+Treeè¿›è¡Œäº†ä¼˜åŒ–ã€‚åœ¨åŸB+Treeçš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€ä¸ªæŒ‡å‘ç›¸é‚»å¶å­èŠ‚ç‚¹ çš„é“¾è¡¨æŒ‡é’ˆï¼Œå°±å½¢æˆäº†å¸¦æœ‰é¡ºåºæŒ‡é’ˆçš„B+Treeï¼Œæé«˜åŒºé—´è®¿é—®çš„æ€§èƒ½ï¼Œåˆ©äºæ’åºã€‚

Hashå“ˆå¸Œç´¢å¼•å°±æ˜¯é‡‡ç”¨ä¸€å®šçš„hashç®—æ³•ï¼Œå°†é”®å€¼æ¢ç®—æˆæ–°çš„hashå€¼ï¼Œæ˜ å°„åˆ°å¯¹åº”çš„æ§½ä½ä¸Šï¼Œç„¶åå­˜å‚¨åœ¨hashè¡¨ä¸­ã€‚

å¦‚æœä¸¤ä¸ª(æˆ–å¤šä¸ª)é”®å€¼ï¼Œæ˜ å°„åˆ°ä¸€ä¸ªç›¸åŒçš„æ§½ä½ä¸Šï¼Œä»–ä»¬å°±äº§ç”Ÿäº†hashå†²çªï¼ˆä¹Ÿç§°ä¸ºhashç¢°æ’ï¼‰ï¼Œå¯ ä»¥é€šè¿‡é“¾è¡¨æ¥è§£å†³ã€‚

ç‰¹ç‚¹ï¼š

Hashç´¢å¼•åªèƒ½ç”¨äºå¯¹ç­‰æ¯”è¾ƒ(&#x3D;ï¼Œin)ï¼Œä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼ˆbetweenï¼Œ&gt;ï¼Œ&lt; ï¼Œâ€¦ï¼‰ã€‚
æ— æ³•åˆ©ç”¨ç´¢å¼•å®Œæˆæ’åºæ“ä½œã€‚
æŸ¥è¯¢æ•ˆç‡é«˜ï¼Œé€šå¸¸(ä¸å­˜åœ¨hashå†²çªçš„æƒ…å†µ)åªéœ€è¦ä¸€æ¬¡æ£€ç´¢å°±å¯ä»¥äº†ï¼Œæ•ˆç‡é€šå¸¸è¦é«˜äºB+treeç´¢å¼•ã€‚

åœ¨MySQLä¸­ï¼Œæ”¯æŒhashç´¢å¼•çš„æ˜¯Memoryå­˜å‚¨å¼•æ“ã€‚ è€ŒInnoDBä¸­å…·æœ‰è‡ªé€‚åº”hashåŠŸèƒ½ï¼Œhashç´¢å¼•æ˜¯ InnoDBå­˜å‚¨å¼•æ“æ ¹æ®B+Treeç´¢å¼•åœ¨æŒ‡å®šæ¡ä»¶ä¸‹è‡ªåŠ¨æ„å»ºçš„ã€‚

ä¸ºä»€ä¹ˆ InnoDB å­˜å‚¨å¼•æ“é€‰æ‹©ä½¿ç”¨ B+tree ç´¢å¼•ç»“æ„?

ç›¸å¯¹äºäºŒå‰æ ‘ï¼Œå±‚çº§æ›´å°‘ï¼Œæœç´¢æ•ˆç‡é«˜ï¼›
å¯¹äºB-treeï¼Œæ— è®ºæ˜¯å¶å­èŠ‚ç‚¹è¿˜æ˜¯éå¶å­èŠ‚ç‚¹ï¼Œéƒ½ä¼šä¿å­˜æ•°æ®ï¼Œè¿™æ ·å¯¼è‡´ä¸€é¡µä¸­å­˜å‚¨ çš„é”®å€¼å‡å°‘ï¼ŒæŒ‡é’ˆè·Ÿç€å‡å°‘ï¼Œè¦åŒæ ·ä¿å­˜å¤§é‡æ•°æ®ï¼Œåªèƒ½å¢åŠ æ ‘çš„é«˜åº¦ï¼Œå¯¼è‡´æ€§èƒ½é™ä½ï¼›
ç›¸å¯¹Hashç´¢å¼•ï¼ŒB+treeæ”¯æŒèŒƒå›´åŒ¹é…åŠæ’åºæ“ä½œï¼›


ç´¢å¼•åˆ†ç±»åœ¨MySQLæ•°æ®åº“ï¼Œå°†ç´¢å¼•çš„å…·ä½“ç±»å‹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼šä¸»é”®ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ã€å¸¸è§„ç´¢å¼•ã€å…¨æ–‡ç´¢å¼•ã€‚

è€Œåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œæ ¹æ®ç´¢å¼•çš„å­˜å‚¨å½¢å¼ï¼Œåˆå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š

èšé›†ç´¢å¼•é€‰å–è§„åˆ™ï¼š

å¦‚æœå­˜åœ¨ä¸»é”®ï¼Œä¸»é”®ç´¢å¼•å°±æ˜¯èšé›†ç´¢å¼•ã€‚ 
å¦‚æœä¸å­˜åœ¨ä¸»é”®ï¼Œå°†ä½¿ç”¨ç¬¬ä¸€ä¸ªå”¯ä¸€ï¼ˆUNIQUEï¼‰ç´¢å¼•ä½œä¸ºèšé›†ç´¢å¼•ã€‚
å¦‚æœè¡¨æ²¡æœ‰ä¸»é”®ï¼Œæˆ–æ²¡æœ‰åˆé€‚çš„å”¯ä¸€ç´¢å¼•ï¼Œåˆ™InnoDBä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªrowidä½œä¸ºéšè—çš„èšé›†ç´¢å¼•ã€‚

èšé›†ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•çš„å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š


èšé›†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸‹æŒ‚çš„æ˜¯è¿™ä¸€è¡Œçš„æ•°æ® ã€‚
äºŒçº§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸‹æŒ‚çš„æ˜¯è¯¥å­—æ®µå€¼å¯¹åº”çš„ä¸»é”®å€¼ã€‚

å›è¡¨æŸ¥è¯¢å…ˆåˆ°äºŒçº§ç´¢å¼•ä¸­æŸ¥æ‰¾æ•°æ®ï¼Œæ‰¾åˆ°ä¸»é”®å€¼ï¼Œç„¶åå†åˆ°èšé›†ç´¢å¼•ä¸­æ ¹æ®ä¸»é”®å€¼ï¼Œè·å– æ•°æ®çš„æ–¹å¼ï¼Œå°±ç§°ä¹‹ä¸ºå›è¡¨æŸ¥è¯¢ã€‚
å½“æˆ‘ä»¬æ‰§è¡Œå¦‚ä¸‹çš„SQLè¯­å¥æ—¶ï¼Œå…·ä½“çš„æŸ¥æ‰¾è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚

å…·ä½“è¿‡ç¨‹å¦‚ä¸‹:
â‘ . ç”±äºæ˜¯æ ¹æ®nameå­—æ®µè¿›è¡ŒæŸ¥è¯¢ï¼Œæ‰€ä»¥å…ˆæ ¹æ®name&#x3D;â€™Armâ€™åˆ°nameå­—æ®µçš„äºŒçº§ç´¢å¼•ä¸­è¿›è¡ŒåŒ¹é…æŸ¥ æ‰¾ã€‚ä½†æ˜¯åœ¨äºŒçº§ç´¢å¼•ä¸­åªèƒ½æŸ¥æ‰¾åˆ° Arm å¯¹åº”çš„ä¸»é”®å€¼ 10ã€‚
â‘¡. ç”±äºæŸ¥è¯¢è¿”å›çš„æ•°æ®æ˜¯*ï¼Œæ‰€ä»¥æ­¤æ—¶ï¼Œè¿˜éœ€è¦æ ¹æ®ä¸»é”®å€¼10ï¼Œåˆ°èšé›†ç´¢å¼•ä¸­æŸ¥æ‰¾10å¯¹åº”çš„è®°å½•ï¼Œæœ€ ç»ˆæ‰¾åˆ°10å¯¹åº”çš„è¡Œrowã€‚
â‘¢. æœ€ç»ˆæ‹¿åˆ°è¿™ä¸€è¡Œçš„æ•°æ®ï¼Œç›´æ¥è¿”å›å³å¯ã€‚
æ€è€ƒé¢˜
ä»¥ä¸‹ä¸¤æ¡SQLè¯­å¥ï¼Œé‚£ä¸ªæ‰§è¡Œæ•ˆç‡é«˜? ä¸ºä»€ä¹ˆ?

â€‹	A. select * from user where id &#x3D; 10 ;â€‹	B. select * from user where name &#x3D; â€˜Armâ€™ ; å¤‡æ³¨: idä¸ºä¸»é”®ï¼Œnameå­—æ®µåˆ›å»ºçš„æœ‰ç´¢å¼•ï¼›
è§£ç­”ï¼š A è¯­å¥çš„æ‰§è¡Œæ€§èƒ½è¦é«˜äºB è¯­å¥ã€‚ å› ä¸ºAè¯­å¥ç›´æ¥èµ°èšé›†ç´¢å¼•ï¼Œç›´æ¥è¿”å›æ•°æ®ã€‚ è€ŒBè¯­å¥éœ€è¦å…ˆæŸ¥è¯¢nameå­—æ®µçš„äºŒçº§ç´¢å¼•ï¼Œç„¶ åå†æŸ¥è¯¢èšé›†ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯éœ€è¦è¿›è¡Œå›è¡¨æŸ¥è¯¢ã€‚

InnoDBä¸»é”®ç´¢å¼•çš„B+treeé«˜åº¦ä¸ºå¤šé«˜å‘¢?

å‡è®¾: ä¸€è¡Œæ•°æ®å¤§å°ä¸º1kï¼Œä¸€é¡µä¸­å¯ä»¥å­˜å‚¨16è¡Œè¿™æ ·çš„æ•°æ®ã€‚InnoDBçš„æŒ‡é’ˆå ç”¨6ä¸ªå­—èŠ‚çš„ç©º é—´ï¼Œä¸»é”®å³ä½¿ä¸ºbigintï¼Œå ç”¨å­—èŠ‚æ•°ä¸º8ã€‚ 
å…³é”®å…¬å¼ï¼šæ¯ä¸ªéå¶å­èŠ‚ç‚¹çš„ç´¢å¼•æ¡ç›®æ•° n éœ€æ»¡è¶³ï¼šn Ã— ä¸»é”®å¤§å° + (n + 1) Ã— æŒ‡é’ˆå¤§å° â‰¤ é¡µå¤§å°ã€‚

n Ã— 8 ï¼šn ä¸ªä¸»é”®å€¼çš„æ€»å­—èŠ‚æ•°ï¼›
(n + 1) Ã— 6 ï¼šn+1 ä¸ªæŒ‡é’ˆçš„æ€»å­—èŠ‚æ•°ï¼ˆæ¯ä¸ªèŠ‚ç‚¹è‡³å°‘æœ‰ n+1 ä¸ªæŒ‡é’ˆæŒ‡å‘å­èŠ‚ç‚¹ï¼‰ã€‚
ç®—å‡ºnçº¦ä¸º 1170ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªéå¶å­èŠ‚ç‚¹æœ€å¤šå­˜å‚¨ 1170 ä¸ªç´¢å¼•æ¡ç›®ï¼Œå¯¹åº” 1171 ä¸ªå­èŠ‚ç‚¹ï¼ˆn+1ï¼‰ã€‚

B + æ ‘é«˜åº¦ä¸º 2 æ—¶çš„æœ€å¤§æ•°æ®é‡ï¼š

æ ‘ç»“æ„ï¼šéå¶å­èŠ‚ç‚¹ï¼ˆæ ¹èŠ‚ç‚¹ï¼‰+ å¶å­èŠ‚ç‚¹ã€‚
å¶å­èŠ‚ç‚¹æ•°é‡ï¼šæ ¹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ•° &#x3D; 1171 ä¸ªã€‚
æ¯ä¸ªå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®é‡ï¼š16 è¡Œï¼ˆç”±é¡µå¤§å°å†³å®šï¼‰ã€‚
æ€»æ•°æ®é‡ï¼š1170 Ã— 16 = 18,720æ¡ã€‚å¯ä»¥å­˜å‚¨ 18000 å¤šæ¡è®°å½•ã€‚

B + æ ‘é«˜åº¦ä¸º 3 æ—¶çš„æœ€å¤§æ•°æ®é‡ï¼š

æ ‘ç»“æ„ï¼šæ ¹èŠ‚ç‚¹ + ä¸­é—´å±‚ + å¶å­å±‚ã€‚
å¶å­èŠ‚ç‚¹æ•°é‡ï¼šæ ¹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ•° &#x3D; 1171 ä¸ªã€‚
æ¯ä¸ªå¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®é‡ï¼š16 è¡Œï¼ˆç”±é¡µå¤§å°å†³å®šï¼‰ã€‚
æ€»æ•°æ®é‡ï¼š1170 Ã— 1170 Ã— 16 = 21,902,400æ¡ã€‚å¯ä»¥å­˜å‚¨ 2190w å¤šæ¡è®°å½•ã€‚

ç´¢å¼•è¯­æ³•
åˆ›å»ºç´¢å¼•

CREATE [ UNIQUE | FULLTEXT ] INDEX index_name ON table_name (index_col_name,... ) ;


æŸ¥çœ‹ç´¢å¼•

SHOW INDEX FROM table_name ;


åˆ é™¤ç´¢å¼•

DROP INDEX index_name ON table_name ;

SQLæ€§èƒ½åˆ†æSQLæ‰§è¡Œé¢‘ç‡MySQL å®¢æˆ·ç«¯è¿æ¥æˆåŠŸåï¼Œé€šè¿‡ show [session|global] status å‘½ä»¤å¯ä»¥æä¾›æœåŠ¡å™¨çŠ¶æ€ä¿¡ æ¯ã€‚é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹å½“å‰æ•°æ®åº“çš„INSERTã€UPDATEã€DELETEã€SELECTçš„è®¿é—®é¢‘æ¬¡ï¼š

â€“ session æ˜¯æŸ¥çœ‹å½“å‰ä¼šè¯ ; 
â€“ global æ˜¯æŸ¥è¯¢å…¨å±€æ•°æ® ; 
SHOW GLOBAL STATUS LIKE â€˜Com_______â€™

é€šè¿‡æŸ¥è¯¢SQLçš„æ‰§è¡Œé¢‘æ¬¡ï¼Œæˆ‘ä»¬å°±èƒ½å¤ŸçŸ¥é“å½“å‰æ•°æ®åº“åˆ°åº•æ˜¯å¢åˆ æ”¹ä¸ºä¸»ï¼Œè¿˜æ˜¯æŸ¥è¯¢ä¸ºä¸»ã€‚ é‚£å‡ å¦‚è¯´æ˜¯ä»¥æŸ¥è¯¢ä¸ºä¸»ï¼Œæˆ‘ä»¬åˆè¯¥å¦‚ä½•å®šä½é’ˆå¯¹äºé‚£äº›æŸ¥è¯¢è¯­å¥è¿›è¡Œä¼˜åŒ–å‘¢ï¼Ÿ æ¬¡æ•°æˆ‘ä»¬å¯ä»¥å€ŸåŠ©äºæ…¢æŸ¥è¯¢ æ—¥å¿—ã€‚
æ…¢æŸ¥è¯¢æ—¥å¿—æ…¢æŸ¥è¯¢æ—¥å¿—è®°å½•äº†æ‰€æœ‰æ‰§è¡Œæ—¶é—´è¶…è¿‡æŒ‡å®šå‚æ•°ï¼ˆlong_query_timeï¼Œå•ä½ï¼šç§’ï¼Œé»˜è®¤10ç§’ï¼‰çš„æ‰€æœ‰ SQLè¯­å¥çš„æ—¥å¿—ã€‚
MySQLçš„æ…¢æŸ¥è¯¢æ—¥å¿—é»˜è®¤æ²¡æœ‰å¼€å¯ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹ç³»ç»Ÿå˜é‡ slow_query_logã€‚ï¼ˆé»˜è®¤æ˜¯å…³é—­çš„ï¼‰ã€‚
show variables like &#x27;slow_query_log&#x27;;

å¦‚æœè¦å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œéœ€è¦åœ¨MySQLçš„é…ç½®æ–‡ä»¶ä¸­é…ç½®å¦‚ä¸‹ä¿¡æ¯ï¼š

Windows ä¸‹é€šå¸¸ä½äº MySQL å®‰è£…ç›®å½•æˆ– C:\ProgramData\MySQL\MySQL Server X.Yã€‚
Linux ä¸‹ï¼ˆ&#x2F;etc&#x2F;my.cnfï¼‰ã€‚

[mysqld]# å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—slow_query_log = 1# æŒ‡å®šæ…¢æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶è·¯å¾„slow_query_log_file = &quot;C:/ProgramData/MySQL/MySQL Server 8.0/slow_query.log&quot;# è®¾ç½®æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆå•ä½ï¼šç§’ï¼‰long_query_time = 10# å¯é€‰ï¼šè®°å½•æœªä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢# log_queries_not_using_indexes = 1# å¯é€‰ï¼šè®°å½•ç®¡ç†è¯­å¥ï¼ˆå¦‚ OPTIMIZE TABLEï¼‰# log_slow_admin_statements = 1

é‡å¯MySQL æœåŠ¡ï¼Œç„¶åï¼Œå†æ¬¡æŸ¥çœ‹å¼€å…³æƒ…å†µï¼Œæ…¢æŸ¥è¯¢æ—¥å¿—å°±å·²ç»æ‰“å¼€äº†ã€‚
æµ‹è¯•ï¼š

æ‰§è¡Œå¦‚ä¸‹SQLè¯­å¥ ï¼š
SELECT SLEEP(11);

æ‰“å¼€æ…¢æ—¥å¿—æ–‡ä»¶ï¼Œæ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿— ï¼š
# Time: 2025-06-16T08:26:30.451314Z# User@Host: root[root] @ localhost [::1]  Id:     4# Query_time: 11.007434  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0use huanyuan2;SET timestamp=1750062390;SELECT SLEEP(11);

é‚£è¿™æ ·ï¼Œé€šè¿‡æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå°±å¯ä»¥å®šä½å‡ºæ‰§è¡Œæ•ˆç‡æ¯”è¾ƒä½çš„SQLï¼Œä»è€Œæœ‰é’ˆå¯¹æ€§çš„è¿›è¡Œä¼˜åŒ–ã€‚


profileè¯¦æƒ…show profiles èƒ½å¤Ÿåœ¨åšSQLä¼˜åŒ–æ—¶å¸®åŠ©æˆ‘ä»¬äº†è§£æ—¶é—´éƒ½è€—è´¹åˆ°å“ªé‡Œå»äº†ã€‚

é€šè¿‡have_profiling å‚æ•°ï¼Œèƒ½å¤Ÿçœ‹åˆ°å½“å‰MySQLæ˜¯å¦æ”¯æŒprofileæ“ä½œï¼š
SELECT @@have_profiling ;



æŸ¥çœ‹å½“å‰æ•°æ®åº“æ˜¯å¦æ‰“å¼€äº† profiling ï¼š
select @@profiling;




å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰MySQLæ˜¯æ”¯æŒ profileæ“ä½œçš„ï¼Œä½†æ˜¯å¼€å…³æ˜¯å…³é—­çš„ã€‚å¯ä»¥é€šè¿‡setè¯­å¥åœ¨ session/globalçº§åˆ«å¼€å¯profilingï¼š
SET profiling = 1;

profile å¼€å…³æ‰“å¼€åï¼Œæˆ‘ä»¬æ‰€æ‰§è¡Œçš„SQLè¯­å¥ï¼Œéƒ½ä¼šè¢«MySQLè®°å½•ï¼Œå¹¶è®°å½•æ‰§è¡Œæ—¶é—´æ¶ˆè€—åˆ°å“ªå„¿å» äº†ã€‚
å¯ä»¥é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤æŸ¥çœ‹æŒ‡ä»¤çš„æ‰§è¡Œè€—æ—¶ï¼š
-- æŸ¥çœ‹æ¯ä¸€æ¡SQLçš„è€—æ—¶åŸºæœ¬æƒ…å†µshow profiles;-- æŸ¥çœ‹æŒ‡å®šquery_idçš„SQLè¯­å¥å„ä¸ªé˜¶æ®µçš„è€—æ—¶æƒ…å†µshow profile for query query_id;-- æŸ¥çœ‹æŒ‡å®šquery_idçš„SQLè¯­å¥CPUçš„ä½¿ç”¨æƒ…å†µshow profile cpu for query query_id;

explainEXPLAIN æˆ–è€… DESCå‘½ä»¤è·å– MySQL å¦‚ä½•æ‰§è¡Œ SELECT è¯­å¥çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬åœ¨ SELECT è¯­å¥æ‰§è¡Œ è¿‡ç¨‹ä¸­è¡¨å¦‚ä½•è¿æ¥å’Œè¿æ¥çš„é¡ºåºã€‚
-- ç›´æ¥åœ¨selectè¯­å¥ä¹‹å‰åŠ ä¸Šå…³é”®å­— explain / descEXPLAIN SELECT å­—æ®µåˆ—è¡¨ FROM è¡¨å WHERE æ¡ä»¶ ;


Explain æ‰§è¡Œè®¡åˆ’ä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰:



å­—æ®µ
å«ä¹‰



id
selectæŸ¥è¯¢çš„åºåˆ—å·ï¼Œè¡¨ç¤ºæŸ¥è¯¢ä¸­æ‰§è¡Œselectå­å¥æˆ–è€…æ˜¯æ“ä½œè¡¨çš„é¡ºåº (idç›¸åŒï¼Œæ‰§è¡Œé¡ºåºä»ä¸Šåˆ°ä¸‹ï¼›idä¸åŒï¼Œå€¼è¶Šå¤§ï¼Œè¶Šå…ˆæ‰§è¡Œ)ã€‚


select_type
è¡¨ç¤º SELECT çš„ç±»å‹ï¼Œå¸¸è§çš„å–å€¼æœ‰ SIMPLEï¼ˆç®€å•è¡¨ï¼Œå³ä¸ä½¿ç”¨è¡¨è¿æ¥ æˆ–è€…å­æŸ¥è¯¢ï¼‰ã€PRIMARYï¼ˆä¸»æŸ¥è¯¢ï¼Œå³å¤–å±‚çš„æŸ¥è¯¢ï¼‰ã€ UNIONï¼ˆUNION ä¸­çš„ç¬¬äºŒä¸ªæˆ–è€…åé¢çš„æŸ¥è¯¢è¯­å¥ï¼‰ã€ SUBQUERYï¼ˆSELECT&#x2F;WHEREä¹‹ååŒ…å«äº†å­æŸ¥è¯¢ï¼‰ç­‰


type
è¡¨ç¤ºè¿æ¥ç±»å‹ï¼Œæ€§èƒ½ç”±å¥½åˆ°å·®çš„è¿æ¥ç±»å‹ä¸ºNULLã€systemã€constã€ eq_refã€refã€rangeã€ indexã€all ã€‚


possible_key
æ˜¾ç¤ºå¯èƒ½åº”ç”¨åœ¨è¿™å¼ è¡¨ä¸Šçš„ç´¢å¼•ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªã€‚


key
å®é™…ä½¿ç”¨çš„ç´¢å¼•ï¼Œå¦‚æœä¸ºNULLï¼Œåˆ™æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚


key_len
è¡¨ç¤ºç´¢å¼•ä¸­ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œ è¯¥å€¼ä¸ºç´¢å¼•å­—æ®µæœ€å¤§å¯èƒ½é•¿åº¦ï¼Œå¹¶éå®é™…ä½¿ç”¨é•¿ åº¦ï¼Œåœ¨ä¸æŸå¤±ç²¾ç¡®æ€§çš„å‰æä¸‹ï¼Œ é•¿åº¦è¶ŠçŸ­è¶Šå¥½ ã€‚


rows
MySQLè®¤ä¸ºå¿…é¡»è¦æ‰§è¡ŒæŸ¥è¯¢çš„è¡Œæ•°ï¼Œåœ¨innodbå¼•æ“çš„è¡¨ä¸­ï¼Œæ˜¯ä¸€ä¸ªä¼°è®¡å€¼ï¼Œ å¯èƒ½å¹¶ä¸æ€»æ˜¯å‡†ç¡®çš„ã€‚


filtered
è¡¨ç¤ºè¿”å›ç»“æœçš„è¡Œæ•°å éœ€è¯»å–è¡Œæ•°çš„ç™¾åˆ†æ¯”ï¼Œ filtered çš„å€¼è¶Šå¤§è¶Šå¥½ã€‚


ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–å•åˆ—ç´¢å¼•ä¸è”åˆç´¢å¼•å•åˆ—ç´¢å¼•ï¼šå³ä¸€ä¸ªç´¢å¼•åªåŒ…å«å•ä¸ªåˆ—ã€‚
è”åˆç´¢å¼•ï¼šå³ä¸€ä¸ªç´¢å¼•åŒ…å«äº†å¤šä¸ªåˆ—ã€‚
æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ tb_user è¡¨ä¸­ç›®å‰çš„ç´¢å¼•æƒ…å†µ:

åœ¨æŸ¥è¯¢å‡ºæ¥çš„ç´¢å¼•ä¸­ï¼Œæ—¢æœ‰å•åˆ—ç´¢å¼•ï¼Œåˆæœ‰è”åˆç´¢å¼•ã€‚
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥æ‰§è¡Œä¸€æ¡SQLè¯­å¥ï¼Œçœ‹çœ‹å…¶æ‰§è¡Œè®¡åˆ’ï¼š

é€šè¿‡ä¸Šè¿°æ‰§è¡Œè®¡åˆ’æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨andè¿æ¥çš„ä¸¤ä¸ªå­—æ®µ phoneã€nameä¸Šéƒ½æ˜¯æœ‰å•åˆ—ç´¢å¼•çš„ï¼Œä½†æ˜¯æœ€ç»ˆmysqlåªä¼šé€‰æ‹©ä¸€ä¸ªç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªèƒ½èµ°ä¸€ä¸ªå­—æ®µçš„ç´¢å¼•ï¼Œæ­¤æ—¶æ˜¯ä¼šå›è¡¨æŸ¥è¯¢çš„ã€‚
æ¥ç€ï¼Œæˆ‘ä»¬å†æ¥åˆ›å»ºä¸€ä¸ªphoneå’Œnameå­—æ®µçš„è”åˆç´¢å¼•æ¥æŸ¥è¯¢ä¸€ä¸‹æ‰§è¡Œè®¡åˆ’ã€‚
create unique index idx_user_phone_name on tb_user(phone,name);


æ­¤æ—¶ï¼ŒæŸ¥è¯¢æ—¶ï¼Œå°±èµ°äº†è”åˆç´¢å¼•ï¼Œè€Œåœ¨è”åˆç´¢å¼•ä¸­åŒ…å« phoneã€nameçš„ä¿¡æ¯ï¼Œåœ¨å¶å­èŠ‚ç‚¹ä¸‹æŒ‚çš„æ˜¯å¯¹ åº”çš„ä¸»é”®idï¼Œæ‰€ä»¥æŸ¥è¯¢æ˜¯æ— éœ€å›è¡¨æŸ¥è¯¢çš„ã€‚

åœ¨ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ï¼Œè€ƒè™‘é’ˆå¯¹äºæŸ¥è¯¢å­—æ®µå»ºç«‹ç´¢å¼•æ—¶ï¼Œå»ºè®®å»ºç«‹è”åˆç´¢å¼•ï¼Œ è€Œéå•åˆ—ç´¢å¼•ã€‚

.cnjunexevqdn{zoom:67%;}

å‰ç¼€ç´¢å¼•å½“å­—æ®µç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼ˆvarcharï¼Œtextï¼Œlongtextç­‰ï¼‰æ—¶ï¼Œæœ‰æ—¶å€™éœ€è¦ç´¢å¼•å¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œè¿™ä¼šè®© ç´¢å¼•å˜å¾—å¾ˆå¤§ï¼ŒæŸ¥è¯¢æ—¶ï¼Œæµªè´¹å¤§é‡çš„ç£ç›˜IOï¼Œ å½±å“æŸ¥è¯¢æ•ˆç‡ã€‚æ­¤æ—¶å¯ä»¥åªå°†å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†å‰ç¼€ï¼Œå»ºç«‹ç´¢å¼•ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§èŠ‚çº¦ç´¢å¼•ç©ºé—´ï¼Œä»è€Œæé«˜ç´¢å¼•æ•ˆç‡ã€‚

è¯­æ³•
create index idx_xxxx on table_name(column(n)) ;

å‰ç¼€é•¿åº¦
å¯ä»¥æ ¹æ®ç´¢å¼•çš„é€‰æ‹©æ€§æ¥å†³å®šï¼Œè€Œé€‰æ‹©æ€§æ˜¯æŒ‡ä¸é‡å¤çš„ç´¢å¼•å€¼ï¼ˆåŸºæ•°ï¼‰å’Œæ•°æ®è¡¨çš„è®°å½•æ€»æ•°çš„æ¯”å€¼ï¼Œ ç´¢å¼•é€‰æ‹©æ€§è¶Šé«˜åˆ™æŸ¥è¯¢æ•ˆç‡è¶Šé«˜ï¼Œ å”¯ä¸€ç´¢å¼•çš„é€‰æ‹©æ€§æ˜¯1ï¼Œè¿™æ˜¯æœ€å¥½çš„ç´¢å¼•é€‰æ‹©æ€§ï¼Œæ€§èƒ½ä¹Ÿæ˜¯æœ€å¥½çš„ã€‚
# æŸ¥è¯¢ä½¿ç”¨emailæ•´ä¸ªå­—ç¬¦ä¸²çš„ç´¢å¼•é€‰æ‹©æ¯”   1.0000select count(distinct email) / count(*) from tb_user;# æŸ¥è¯¢ä½¿ç”¨email ä½¿ç”¨å‰ç¼€5ä¸ªå­—ç¬¦ä¸²çš„ç´¢å¼•é€‰æ‹©æ¯”  0.9583select count(distinct substring(email,1,5)) / count(*) from tb_user ;# æŸ¥è¯¢ä½¿ç”¨email ä½¿ç”¨å‰ç¼€2ä¸ªå­—ç¬¦ä¸²çš„ç´¢å¼•é€‰æ‹©æ¯”   0.9167select count(distinct substring(email,1,2)) / count(*) from tb_user ;# å¯¹å­—æ®µemailå»ºç«‹å‰ç¼€ç´¢å¼•ï¼Œå‰ç¼€é•¿åº¦ä¸º5  create index email_idx on tb_user(email(5));# æŸ¥çœ‹ä½¿ç”¨emailå‰ç¼€ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢çš„æ‰§è¡Œç»“æ„explain select * from tb_user where email = &#x27;xiaoyu666@qq.com&#x27;; 

å‰ç¼€ç´¢å¼•çš„æŸ¥è¯¢æµç¨‹



æœ€å·¦å‰ç¼€æ³•åˆ™å¦‚æœç´¢å¼•äº†å¤šåˆ—ï¼ˆè”åˆç´¢å¼•ï¼‰ï¼Œè¦éµå®ˆæœ€å·¦å‰ç¼€æ³•åˆ™ã€‚æœ€å·¦å‰ç¼€æ³•åˆ™æŒ‡çš„æ˜¯æŸ¥è¯¢æ¡ä»¶å¿…é¡»ä»å¤åˆç´¢å¼•çš„æœ€å·¦åˆ—å¼€å§‹ï¼Œå¹¶ä¸”ä¸èƒ½è·³è¿‡ä¸­é—´åˆ—ã€‚å¦‚æœè·³è·ƒæŸä¸€åˆ—ï¼Œç´¢å¼•å°†ä¼šéƒ¨åˆ†å¤±æ•ˆ(åé¢çš„å­—æ®µç´¢å¼•å¤±æ•ˆ)ã€‚
ğŸ§© å››ç§å…¸å‹ä½¿ç”¨åœºæ™¯åˆ†æCREATE INDEX idx_name_age_city ON users (    last_name,  -- æœ€å·¦åˆ—    age,        -- ä¸­é—´åˆ—    city        -- æœ€å³åˆ—);

âœ… åœºæ™¯ 1ï¼šå®Œæ•´ä½¿ç”¨ç´¢å¼• (æœ€ä½³)SELECT * FROM users WHERE last_name = &#x27;Smith&#x27;   AND age = 30   AND city = &#x27;New York&#x27;;

ç´¢å¼•ä½¿ç”¨ï¼š(last_name, age, city) ä¸‰åˆ—å…¨ä½¿ç”¨ğŸ‘‰ æŸ¥è¯¢æ•ˆç‡æœ€é«˜
âœ… åœºæ™¯ 2ï¼šä½¿ç”¨æœ€å·¦è¿ç»­åˆ—SELECT * FROM users WHERE last_name = &#x27;Smith&#x27;   AND age = 30;

ç´¢å¼•ä½¿ç”¨ï¼š(last_name, age) ä¸¤åˆ—ğŸ‘‰ æœ‰æ•ˆä½¿ç”¨ç´¢å¼•
âœ… åœºæ™¯ 3ï¼šä»…ä½¿ç”¨æœ€å·¦åˆ—SELECT * FROM users WHERE last_name = &#x27;Smith&#x27;;

ç´¢å¼•ä½¿ç”¨ï¼š(last_name) å•åˆ—ğŸ‘‰ æœ‰æ•ˆä½†éæœ€ä¼˜
âŒ åœºæ™¯ 4ï¼šè¿åæœ€å·¦å‰ç¼€ï¼ˆå¸¸è§é”™è¯¯ï¼‰-- é”™è¯¯1ï¼šè·³è¿‡æœ€å·¦åˆ—SELECT * FROM users WHERE age = 30;-- é”™è¯¯2ï¼šç¼ºå°‘ä¸­é—´åˆ—SELECT * FROM users WHERE last_name = &#x27;Smith&#x27;   AND city = &#x27;New York&#x27;; -- è·³è¿‡ageåˆ—

ç´¢å¼•ä½¿ç”¨ï¼šæ— æ³•ä½¿ç”¨ç´¢å¼•æˆ–ä»…éƒ¨åˆ†ä½¿ç”¨ğŸ‘‰ å…¨è¡¨æ‰«æé£é™©
âœ… åœºæ™¯ 5ï¼šæ¡ä»¶ç¼–å†™çš„å…ˆåé¡ºåºä»¥ä¸‹ä»£ç ç´¢å¼•ä¼šå¤±æ•ˆå—ï¼Ÿ
SELECT * FROM users WHERE  age = 30  AND  city = &#x27;New York&#x27;  AND  last_name = &#x27;Smith&#x27;;

ç­”æ¡ˆï¼šä¸ä¼šï¼ŒMySQL ä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨é‡æ’æ¡ä»¶é¡ºåºï¼š
-- ä¼˜åŒ–å™¨é‡å†™åçš„ç­‰æ•ˆæŸ¥è¯¢SELECT * FROM users WHERE last_name = &#x27;Smith&#x27;  -- æœ€å·¦åˆ—  AND age = 30            -- ç¬¬äºŒåˆ—  AND city = &#x27;New York&#x27;;  -- ç¬¬ä¸‰åˆ—


æ³¨æ„ ï¼š æœ€å·¦å‰ç¼€æ³•åˆ™ä¸­æŒ‡çš„æœ€å·¦è¾¹çš„åˆ—ï¼Œæ˜¯æŒ‡åœ¨æŸ¥è¯¢æ—¶ï¼Œè”åˆç´¢å¼•çš„æœ€å·¦è¾¹çš„å­—æ®µ(å³æ˜¯ ç¬¬ä¸€ä¸ªå­—æ®µ)å¿…é¡»å­˜åœ¨ï¼Œä¸æˆ‘ä»¬ç¼–å†™SQLæ—¶ï¼Œæ¡ä»¶ç¼–å†™çš„å…ˆåé¡ºåºæ— å…³ã€‚

ç´¢å¼•å¤±æ•ˆæƒ…å†µğŸš« 1. è¿åæœ€å·¦å‰ç¼€æ³•åˆ™ï¼ˆå¤åˆç´¢å¼•ï¼‰-- å¤åˆç´¢å¼•: (last_name, age, city)SELECT * FROM users WHERE age = 30; -- ç¼ºå°‘æœ€å·¦åˆ—SELECT * FROM users WHERE city = &#x27;New York&#x27;; -- ç¼ºå°‘æœ€å·¦åˆ—SELECT * FROM users WHERE last_name = &#x27;Smith&#x27; AND city = &#x27;New York&#x27;; -- è·³è¿‡ä¸­é—´åˆ—

âœ… è§£å†³æ–¹æ¡ˆï¼š

è°ƒæ•´æŸ¥è¯¢æ¡ä»¶é¡ºåº
åˆ›å»ºæ–°ç´¢å¼•ï¼šCREATE INDEX idx_age_city ON users(age, city)

ğŸš« 2. åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°æˆ–è®¡ç®—-- ç´¢å¼•: created_atSELECT * FROM orders WHERE YEAR(created_at) = 2023; -- å‡½æ•°æ“ä½œSELECT * FROM products WHERE price * 1.1 &gt; 100; -- è®¡ç®—æ“ä½œ

âœ… è§£å†³æ–¹æ¡ˆï¼š

ä½¿ç”¨èŒƒå›´æŸ¥è¯¢æ›¿ä»£ï¼š
SELECT * FROM orders WHERE created_at BETWEEN &#x27;2023-01-01&#x27; AND &#x27;2023-12-31&#x27;;

é¢„å…ˆè®¡ç®—å­˜å‚¨ï¼š
ALTER TABLE products ADD COLUMN price_with_tax DECIMAL(10,2) AS (price * 1.1);CREATE INDEX idx_price_tax ON products(price_with_tax);

ğŸš« 3. éšå¼ç±»å‹è½¬æ¢-- phone æ˜¯ VARCHAR ç´¢å¼•åˆ—SELECT * FROM customers WHERE phone = 13800138000; -- æ•°å­— vs å­—ç¬¦ä¸²

âœ… è§£å†³æ–¹æ¡ˆï¼š
SELECT * FROM customers WHERE phone = &#x27;13800138000&#x27;; -- ä¿æŒç±»å‹ä¸€è‡´

ğŸš« 4. ä½¿ç”¨ OR è¿æ¥éç´¢å¼•åˆ—-- åªæœ‰ name æœ‰ç´¢å¼•SELECT * FROM users WHERE name = &#x27;John&#x27; OR email = &#x27;john@example.com&#x27;; -- email æ— ç´¢å¼•

ç”¨oråˆ†å‰²å¼€çš„æ¡ä»¶ï¼Œ å¦‚æœorå‰çš„æ¡ä»¶ä¸­çš„åˆ—æœ‰ç´¢å¼•ï¼Œè€Œåé¢çš„åˆ—ä¸­æ²¡æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆæ¶‰åŠçš„ç´¢å¼•éƒ½ä¸ä¼š è¢«ç”¨åˆ°ã€‚
âœ… è§£å†³æ–¹æ¡ˆï¼š

åˆ›å»ºè”åˆç´¢å¼•

æ‹†åˆ†ä¸ºä¸¤ä¸ªæŸ¥è¯¢ UNIONï¼š
SELECT * FROM users WHERE name = &#x27;John&#x27;UNIONSELECT * FROM users WHERE email = &#x27;john@example.com&#x27;;

ğŸš« 5. LIKE ä»¥é€šé…ç¬¦å¼€å¤´å¦‚æœä»…ä»…æ˜¯å°¾éƒ¨æ¨¡ç³ŠåŒ¹é…ï¼Œç´¢å¼•ä¸ä¼šå¤±æ•ˆã€‚å¦‚æœæ˜¯å¤´éƒ¨æ¨¡ç³ŠåŒ¹é…ï¼Œç´¢å¼•å¤±æ•ˆã€‚
-- ç´¢å¼•: emailSELECT * FROM users WHERE email LIKE &#x27;@gmail.com%&#x27;; -- åå¯¼é€šé…ç¬¦SELECT * FROM users WHERE email LIKE &#x27;%@gmail.com&#x27;; -- å‰å¯¼é€šé…ç¬¦ ç´¢å¼•å¤±æ•ˆ

ğŸš« 6. èŒƒå›´æŸ¥è¯¢åçš„åˆ—å¤±æ•ˆè”åˆç´¢å¼•ä¸­ï¼Œå‡ºç°èŒƒå›´æŸ¥è¯¢(&gt;,&lt;)ï¼ŒèŒƒå›´æŸ¥è¯¢å³ä¾§çš„åˆ—ç´¢å¼•å¤±æ•ˆã€‚
-- å¤åˆç´¢å¼•: (category, price, rating)SELECT * FROM products WHERE category = &#x27;Electronics&#x27;   AND price &gt; 1000   AND rating &gt; 4; -- rating æ— æ³•ä½¿ç”¨ç´¢å¼•

âœ… è§£å†³æ–¹æ¡ˆï¼š

è°ƒæ•´ç´¢å¼•åˆ—é¡ºåºï¼š
CREATE INDEX idx_category_rating_price ON products(category, rating, price); -- è®©ç­‰å€¼æ¡ä»¶å’Œé«˜é€‰æ‹©æ€§èŒƒå›´æŸ¥è¯¢ä¼˜å…ˆä½¿ç”¨ç´¢å¼•

ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼š
CREATE INDEX idx_cover ON products(category, price, rating, product_id);

ä½¿ç”¨ &gt;&#x3D;ï¼š
SELECT * FROM products WHERE category = &#x27;Electronics&#x27;   AND price &gt;= 1000   AND rating &gt; 4; -- åœ¨ä¸šåŠ¡å…è®¸çš„æƒ…å†µä¸‹ï¼Œå°½å¯èƒ½çš„ä½¿ç”¨ç±»ä¼¼äº &gt;= æˆ– &lt;= è¿™ç±»çš„èŒƒå›´æŸ¥è¯¢ï¼Œè€Œé¿å…ä½¿ç”¨ &gt; æˆ– &lt; ã€‚

ğŸš« 7. ä½¿ç”¨ != æˆ– &lt;&gt;-- ç´¢å¼•: statusSELECT * FROM orders WHERE status != &#x27;completed&#x27;;

âœ… è§£å†³æ–¹æ¡ˆï¼š

æ”¹ä¸ºèŒƒå›´æŸ¥è¯¢ï¼š
SELECT * FROM orders WHERE status &lt; &#x27;completed&#x27; OR status &gt; &#x27;completed&#x27;;

ä½¿ç”¨ç‰¹å®šå€¼åˆ—è¡¨ï¼š
SELECT * FROM orders WHERE status IN (&#x27;pending&#x27;, &#x27;processing&#x27;, &#x27;cancelled&#x27;);

ğŸš« 8. ç´¢å¼•åˆ—ä½¿ç”¨ IS NULL&#x2F;IS NOT NULL-- ç´¢å¼•: phoneSELECT * FROM customers WHERE phone IS NOT NULL; -- å¯èƒ½å¤±æ•ˆ

âœ… è§£å†³æ–¹æ¡ˆï¼š

æ·»åŠ æ¡ä»¶é™åˆ¶ï¼š
SELECT * FROM customers WHERE phone IS NOT NULL AND phone &gt; &#x27;&#x27;; -- åˆ©ç”¨ç´¢å¼•æ‰«æ

ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼š
CREATE INDEX idx_phone_cover ON customers(phone) INCLUDE (name, email);

ğŸš« 9. æ•°æ®åˆ†å¸ƒä¸å‡å¯¼è‡´ä¼˜åŒ–å™¨æ”¾å¼ƒç´¢å¼•-- ç´¢å¼•: status (90% å€¼ä¸º &#x27;active&#x27;)SELECT * FROM products WHERE status = &#x27;active&#x27;; -- å¯èƒ½å…¨è¡¨æ‰«æ

âœ… è§£å†³æ–¹æ¡ˆï¼š

å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•ï¼š
SELECT * FROM products FORCE INDEX(idx_status) WHERE status = &#x27;active&#x27;;

è°ƒæ•´ä¼˜åŒ–å™¨è®¾ç½®ï¼š
SET optimizer_switch=&#x27;index_condition_pushdown=off&#x27;;

ğŸš« 10. ä½¿ç”¨ NOT IN-- ç´¢å¼•: categorySELECT * FROM products WHERE category NOT IN (&#x27;Books&#x27;, &#x27;Clothing&#x27;);

âœ… è§£å†³æ–¹æ¡ˆï¼š

æ”¹ç”¨ NOT EXISTSï¼š
SELECT * FROM products pWHERE NOT EXISTS (  SELECT 1 FROM excluded_categories e   WHERE e.category = p.category);

ä½¿ç”¨å·¦è¿æ¥ï¼š
SELECT p.* FROM products pLEFT JOIN excluded_categories e ON p.category = e.categoryWHERE e.category IS NULL;

SQLæç¤ºSQLæç¤ºï¼Œæ˜¯ä¼˜åŒ–æ•°æ®åº“çš„ä¸€ä¸ªé‡è¦æ‰‹æ®µï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯åœ¨SQLè¯­å¥ä¸­åŠ å…¥ä¸€äº›äººä¸ºçš„æç¤ºæ¥è¾¾åˆ°ä¼˜åŒ–æ“ä½œçš„ç›®çš„ã€‚

use index ï¼š å»ºè®®MySQLä½¿ç”¨å“ªä¸€ä¸ªç´¢å¼•å®Œæˆæ­¤æ¬¡æŸ¥è¯¢ï¼ˆä»…ä»…æ˜¯å»ºè®®ï¼Œmysqlå†…éƒ¨è¿˜ä¼šå†æ¬¡è¿› è¡Œè¯„ä¼°ï¼‰ã€‚

   explain select * from tb_user use index(idx_user_pro) where profession = &#x27;è½¯ä»¶å·¥ç¨‹&#x27;;


ignore index ï¼š å¿½ç•¥æŒ‡å®šçš„ç´¢å¼•ã€‚

   explain select * from tb_user ignore index(idx_user_pro) where profession = &#x27;è½¯ä»¶å·¥ç¨‹&#x27;;


force index ï¼š å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•ã€‚
explain select * from tb_user force index(idx_user_pro) where profession = &#x27;è½¯ä»¶å·¥ç¨‹&#x27;;

è¦†ç›–ç´¢å¼•å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå‡å°‘select *ã€‚ é‚£ä¹ˆä»€ä¹ˆæ˜¯è¦†ç›–ç´¢å¼•å‘¢ï¼Ÿ è¦†ç›–ç´¢å¼•æ˜¯æŒ‡æŸ¥è¯¢ä½¿ç”¨äº†ç´¢å¼•ï¼Œå¹¶ä¸”éœ€è¦è¿”å›çš„åˆ—ï¼Œåœ¨è¯¥ç´¢å¼•ä¸­å·²ç»å…¨éƒ¨èƒ½å¤Ÿæ‰¾åˆ° ã€‚
æ‰§è¡Œè®¡åˆ’ EXPLAIN SELECT å­—æ®µåˆ—è¡¨ FROM è¡¨å WHERE æ¡ä»¶  æŸ¥è¯¢ç»“æœä¸­ Extra çš„å«ä¹‰ï¼š



Extra
å«ä¹‰



Using where; Using Index
æŸ¥æ‰¾ä½¿ç”¨äº†ç´¢å¼•ï¼Œä½†æ˜¯éœ€è¦çš„æ•°æ®éƒ½åœ¨ç´¢å¼•åˆ—ä¸­èƒ½æ‰¾åˆ°ï¼Œæ‰€ä»¥ä¸éœ€è¦å›è¡¨æŸ¥è¯¢æ•°æ®


Using index condition
æŸ¥æ‰¾ä½¿ç”¨äº†ç´¢å¼•ï¼Œä½†æ˜¯éœ€è¦å›è¡¨æŸ¥è¯¢æ•°æ®


ä¸ºäº†æ›´æ¸…æ¥šç†è§£ï¼Œä»€ä¹ˆæ˜¯è¦†ç›–ç´¢å¼•ï¼Œä»€ä¹ˆæ˜¯å›è¡¨æŸ¥è¯¢ï¼Œæˆ‘ä»¬ä¸€èµ·å†æ¥çœ‹ä¸‹é¢çš„è¿™ç»„SQLçš„æ‰§è¡Œè¿‡ç¨‹ã€‚





æ€è€ƒé¢˜ï¼š
â€‹	ä¸€å¼ è¡¨, æœ‰å››ä¸ªå­—æ®µ(id, username, password, status), ç”±äºæ•°æ®é‡å¤§, éœ€è¦å¯¹ä»¥ä¸‹SQLè¯­å¥è¿›è¡Œä¼˜åŒ–, è¯¥å¦‚ä½•è¿›è¡Œæ‰æ˜¯æœ€ä¼˜æ–¹æ¡ˆ?
â€‹	select id,username,password from tb_user where username &#x3D; â€˜itcastâ€™
â€‹	ç­”æ¡ˆ: 
â€‹		é’ˆå¯¹äº username, passwordå»ºç«‹è”åˆç´¢å¼•, sqlä¸º: create index idx_user_name_pass on tb_user(username,password);
â€‹	è¿™æ ·å¯ä»¥é¿å…ä¸Šè¿°çš„SQLè¯­å¥ï¼Œåœ¨æŸ¥è¯¢çš„è¿‡ç¨‹ä¸­ï¼Œå‡ºç°å›è¡¨æŸ¥è¯¢ã€‚

ç´¢å¼•è®¾è®¡åŸåˆ™
é’ˆå¯¹äºæ•°æ®é‡è¾ƒå¤§ï¼Œä¸”æŸ¥è¯¢æ¯”è¾ƒé¢‘ç¹çš„è¡¨å»ºç«‹ç´¢å¼•ã€‚
é’ˆå¯¹äºå¸¸ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼ˆwhereï¼‰ã€æ’åºï¼ˆorder byï¼‰ã€åˆ†ç»„ï¼ˆgroup byï¼‰æ“ä½œçš„å­—æ®µå»ºç«‹ç´¢å¼•ã€‚
å°½é‡é€‰æ‹©åŒºåˆ†åº¦é«˜çš„åˆ—ä½œä¸ºç´¢å¼•ï¼Œå°½é‡å»ºç«‹å”¯ä¸€ç´¢å¼•ï¼ŒåŒºåˆ†åº¦è¶Šé«˜ï¼Œä½¿ç”¨ç´¢å¼•çš„æ•ˆç‡è¶Šé«˜ã€‚
å¦‚æœæ˜¯å­—ç¬¦ä¸²ç±»å‹çš„å­—æ®µï¼Œå­—æ®µçš„é•¿åº¦è¾ƒé•¿ï¼Œå¯ä»¥é’ˆå¯¹äºå­—æ®µçš„ç‰¹ç‚¹ï¼Œå»ºç«‹å‰ç¼€ç´¢å¼•ã€‚
å°½é‡ä½¿ç”¨è”åˆç´¢å¼•ï¼Œå‡å°‘å•åˆ—ç´¢å¼•ï¼ŒæŸ¥è¯¢æ—¶ï¼Œè”åˆç´¢å¼•å¾ˆå¤šæ—¶å€™å¯ä»¥è¦†ç›–ç´¢å¼•ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œ é¿å…å›è¡¨ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚
è¦æ§åˆ¶ç´¢å¼•çš„æ•°é‡ï¼Œç´¢å¼•å¹¶ä¸æ˜¯å¤šå¤šç›Šå–„ï¼Œç´¢å¼•è¶Šå¤šï¼Œç»´æŠ¤ç´¢å¼•ç»“æ„çš„ä»£ä»·ä¹Ÿå°±è¶Šå¤§ï¼Œä¼šå½±å“å¢ åˆ æ”¹çš„æ•ˆç‡ã€‚
å¦‚æœç´¢å¼•åˆ—ä¸èƒ½å­˜å‚¨NULLå€¼ï¼Œè¯·åœ¨åˆ›å»ºè¡¨æ—¶ä½¿ç”¨NOT NULLçº¦æŸå®ƒã€‚å½“ä¼˜åŒ–å™¨çŸ¥é“æ¯åˆ—æ˜¯å¦åŒ…å« NULLå€¼æ—¶ï¼Œå®ƒå¯ä»¥æ›´å¥½åœ°ç¡®å®šå“ªä¸ªç´¢å¼•æœ€æœ‰æ•ˆåœ°ç”¨äºæŸ¥è¯¢ã€‚

SQLä¼˜åŒ–ï¼ˆåé¢åœ¨åšï¼‰è§†å›¾&#x2F;å­˜å‚¨è¿‡ç¨‹&#x2F;è§¦å‘å™¨è§†å›¾è§†å›¾ï¼ˆViewï¼‰æ˜¯ä¸€ç§è™šæ‹Ÿå­˜åœ¨çš„è¡¨ã€‚è§†å›¾ä¸­çš„æ•°æ®å¹¶ä¸åœ¨æ•°æ®åº“ä¸­å®é™…å­˜åœ¨ï¼Œè¡Œå’Œåˆ—æ•°æ®æ¥è‡ªå®šä¹‰è§† å›¾çš„æŸ¥è¯¢ä¸­ä½¿ç”¨çš„è¡¨ï¼Œå¹¶ä¸”æ˜¯åœ¨ä½¿ç”¨è§†å›¾æ—¶åŠ¨æ€ç”Ÿæˆçš„ã€‚ é€šä¿—çš„è®²ï¼Œè§†å›¾åªä¿å­˜äº†æŸ¥è¯¢çš„SQLé€»è¾‘ï¼Œä¸ä¿å­˜æŸ¥è¯¢ç»“æœã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨åˆ›å»ºè§†å›¾çš„æ—¶å€™ï¼Œä¸»è¦çš„å·¥ä½œ å°±è½åœ¨åˆ›å»ºè¿™æ¡SQLæŸ¥è¯¢è¯­å¥ä¸Šã€‚
åŸºæœ¬è¯­æ³•
åˆ›å»º
CREATE [OR REPLACE] VIEW è§†å›¾åç§°[(åˆ—ååˆ—è¡¨)] AS SELECTè¯­å¥ [ WITH [CASCADED | LOCAL ] CHECK OPTION ]

æŸ¥è¯¢
æŸ¥çœ‹åˆ›å»ºè§†å›¾è¯­å¥ï¼šSHOW CREATE VIEW è§†å›¾åç§°;æŸ¥çœ‹è§†å›¾æ•°æ®ï¼šSELECT * FROM è§†å›¾åç§° ...... ;

ä¿®æ”¹
æ–¹å¼ä¸€ï¼šCREATE [OR REPLACE] VIEW è§†å›¾åç§°[(åˆ—ååˆ—è¡¨)] AS SELECTè¯­å¥ [ WITH [ CASCADED | LOCAL ] CHECK OPTION ]æ–¹å¼äºŒï¼šALTER VIEW è§†å›¾åç§°[(åˆ—ååˆ—è¡¨)] AS SELECTè¯­å¥ [ WITH [ CASCADED | LOCAL ] CHECK OPTION ]

åˆ é™¤
DROP VIEW [IF EXISTS] è§†å›¾åç§° [,è§†å›¾åç§°] ...

æ£€æŸ¥é€‰é¡¹å½“ä½¿ç”¨WITH CHECK OPTIONå­å¥åˆ›å»ºè§†å›¾æ—¶ï¼ŒMySQLä¼šé€šè¿‡è§†å›¾æ£€æŸ¥æ­£åœ¨æ›´æ”¹çš„æ¯ä¸ªè¡Œï¼Œä¾‹å¦‚æ’ å…¥ï¼Œæ›´æ–°ï¼Œåˆ é™¤ï¼Œä»¥ä½¿å…¶ç¬¦åˆè§†å›¾çš„å®šä¹‰ã€‚ MySQLå…è®¸åŸºäºå¦ä¸€ä¸ªè§†å›¾åˆ›å»ºè§†å›¾ï¼Œå®ƒè¿˜ä¼šæ£€æŸ¥ä¾èµ–è§† å›¾ä¸­çš„è§„åˆ™ä»¥ä¿æŒä¸€è‡´æ€§ã€‚ä¸ºäº†ç¡®å®šæ£€æŸ¥çš„èŒƒå›´ï¼Œmysqlæä¾›äº†ä¸¤ä¸ªé€‰é¡¹ï¼š CASCADED å’Œ LOCAL ï¼Œé»˜è®¤å€¼ä¸º CASCADED ã€‚

CASCADED çº§è”

   æ¯”å¦‚ï¼Œv2è§†å›¾æ˜¯åŸºäºv1è§†å›¾çš„ï¼Œå¦‚æœåœ¨v2è§†å›¾åˆ›å»ºçš„æ—¶å€™æŒ‡å®šäº†æ£€æŸ¥é€‰é¡¹ä¸º cascadedï¼Œä½†æ˜¯v1è§†å›¾ åˆ›å»ºæ—¶æœªæŒ‡å®šæ£€æŸ¥é€‰é¡¹ã€‚ åˆ™åœ¨æ‰§è¡Œæ£€æŸ¥æ—¶ï¼Œä¸ä»…ä¼šæ£€æŸ¥v2ï¼Œè¿˜ä¼šçº§è”æ£€æŸ¥v2çš„å…³è”è§†å›¾v1ã€‚
   

LOCAL æœ¬åœ°
æ¯”å¦‚ï¼Œv2è§†å›¾æ˜¯åŸºäºv1è§†å›¾çš„ï¼Œå¦‚æœåœ¨v2è§†å›¾åˆ›å»ºçš„æ—¶å€™æŒ‡å®šäº†æ£€æŸ¥é€‰é¡¹ä¸º local ï¼Œä½†æ˜¯v1è§†å›¾åˆ› å»ºæ—¶æœªæŒ‡å®šæ£€æŸ¥é€‰é¡¹ã€‚ åˆ™åœ¨æ‰§è¡Œæ£€æŸ¥æ—¶ï¼Œåªä¼šæ£€æŸ¥v2ï¼Œä¸ä¼šæ£€æŸ¥v2çš„å…³è”è§†å›¾v1ã€‚



è§†å›¾çš„æ›´æ–°è¦ä½¿è§†å›¾å¯æ›´æ–°ï¼Œè§†å›¾ä¸­çš„è¡Œä¸åŸºç¡€è¡¨ä¸­çš„è¡Œä¹‹é—´å¿…é¡»å­˜åœ¨ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚å¦‚æœè§†å›¾åŒ…å«ä»¥ä¸‹ä»»ä½•ä¸€ é¡¹ï¼Œåˆ™è¯¥è§†å›¾ä¸å¯æ›´æ–°ï¼š

èšåˆå‡½æ•°æˆ–çª—å£å‡½æ•°ï¼ˆSUM()ã€ MIN()ã€ MAX()ã€ COUNT()ç­‰ï¼‰

DISTINCT

GROUP BY

HAVING

UNION æˆ–è€… UNION ALL



è§†å›¾çš„ä½œç”¨
ç®€å•ï¼šè§†å›¾ä¸ä»…å¯ä»¥ç®€åŒ–ç”¨æˆ·å¯¹æ•°æ®çš„ç†è§£ï¼Œä¹Ÿå¯ä»¥ç®€åŒ–ä»–ä»¬çš„æ“ä½œã€‚é‚£äº›è¢«ç»å¸¸ä½¿ç”¨çš„æŸ¥è¯¢å¯ä»¥è¢«å®šä¹‰ä¸ºè§†å›¾ï¼Œä»è€Œä½¿å¾—ç”¨æˆ·ä¸å¿…ä¸ºä»¥åçš„æ“ä½œæ¯æ¬¡æŒ‡å®šå…¨éƒ¨çš„æ¡ä»¶ã€‚
å®‰å…¨ï¼šæ•°æ®åº“å¯ä»¥æˆæƒï¼Œä½†ä¸èƒ½æˆæƒåˆ°æ•°æ®åº“ç‰¹å®šè¡Œå’Œç‰¹å®šçš„åˆ—ä¸Šã€‚é€šè¿‡è§†å›¾ç”¨æˆ·åªèƒ½æŸ¥è¯¢å’Œä¿®æ”¹ä»–ä»¬æ‰€èƒ½è§åˆ°çš„æ•°æ®ã€‚
æ•°æ®ç‹¬ç«‹ï¼šè§†å›¾å¯å¸®åŠ©ç”¨æˆ·å±è”½çœŸå®è¡¨ç»“æ„å˜åŒ–å¸¦æ¥çš„å½±å“ã€‚

å­˜å‚¨è¿‡ç¨‹å­˜å‚¨è¿‡ç¨‹æ˜¯äº‹å…ˆç»è¿‡ç¼–è¯‘å¹¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„ä¸€æ®µ SQL è¯­å¥çš„é›†åˆï¼Œè°ƒç”¨å­˜å‚¨è¿‡ç¨‹å¯ä»¥ç®€åŒ–åº”ç”¨å¼€å‘ äººå‘˜çš„å¾ˆå¤šå·¥ä½œï¼Œå‡å°‘æ•°æ®åœ¨æ•°æ®åº“å’Œåº”ç”¨æœåŠ¡å™¨ä¹‹é—´çš„ä¼ è¾“ï¼Œå¯¹äºæé«˜æ•°æ®å¤„ç†çš„æ•ˆç‡æ˜¯æœ‰å¥½å¤„çš„ã€‚ å­˜å‚¨è¿‡ç¨‹æ€æƒ³ä¸Šå¾ˆç®€å•ï¼Œå°±æ˜¯æ•°æ®åº“ SQL è¯­è¨€å±‚é¢çš„ä»£ç å°è£…ä¸é‡ç”¨ã€‚
ç‰¹ç‚¹
å°è£…ï¼Œå¤ç”¨ï¼šå¯ä»¥æŠŠæŸä¸€ä¸šåŠ¡SQLå°è£…åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦ç”¨åˆ° çš„æ—¶å€™ç›´æ¥è°ƒç”¨å³å¯ã€‚
å¯ä»¥æ¥æ”¶å‚æ•°ï¼Œä¹Ÿå¯ä»¥è¿”å›æ•°æ®ï¼šåœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ä¼ é€’å‚æ•°ï¼Œä¹Ÿå¯ä»¥æ¥æ”¶è¿”å›å€¼ã€‚
å‡å°‘ç½‘ç»œäº¤äº’ï¼Œæ•ˆç‡æå‡ï¼šå¦‚æœæ¶‰åŠåˆ°å¤šæ¡SQLï¼Œæ¯æ‰§è¡Œä¸€æ¬¡éƒ½æ˜¯ä¸€æ¬¡ç½‘ç»œä¼ è¾“ã€‚ è€Œå¦‚æœå°è£…åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦ç½‘ç»œäº¤äº’ä¸€æ¬¡å¯èƒ½å°±å¯ä»¥äº†ã€‚

åŸºæœ¬è¯­æ³•
åˆ›å»º
CREATE PROCEDURE å­˜å‚¨è¿‡ç¨‹åç§° ([ å‚æ•°åˆ—è¡¨ ])BEGIN-- SQLè¯­å¥END ;

è°ƒç”¨
CALL åç§° ([ å‚æ•° ]);

æŸ¥çœ‹
SELECT * FROM INFORMATION_SCHEMA.ROUTINES WHERE ROUTINE_SCHEMA = &#x27;xxx&#x27;; -- æŸ¥è¯¢æŒ‡å®šæ•°æ®åº“çš„å­˜å‚¨è¿‡ç¨‹åŠçŠ¶æ€ä¿¡æ¯SHOW CREATE PROCEDURE å­˜å‚¨è¿‡ç¨‹åç§° ; -- æŸ¥è¯¢æŸä¸ªå­˜å‚¨è¿‡ç¨‹çš„å®šä¹‰

åˆ é™¤
1 DROP PROCEDURE [ IF EXISTS ] å­˜å‚¨è¿‡ç¨‹åç§° ï¼›

æ¡ˆä¾‹

æ³¨æ„: åœ¨å‘½ä»¤è¡Œä¸­ï¼Œæ‰§è¡Œåˆ›å»ºå­˜å‚¨è¿‡ç¨‹çš„SQLæ—¶ï¼Œéœ€è¦é€šè¿‡å…³é”®å­— delimiter æŒ‡å®šSQLè¯­å¥çš„ ç»“æŸç¬¦ã€‚

-- å­˜å‚¨è¿‡ç¨‹åŸºæœ¬è¯­æ³•-- åˆ›å»ºcreate procedure p1()beginselect count(*) from student;end;-- è°ƒç”¨call p1();-- æŸ¥çœ‹select * from information_schema.ROUTINES where ROUTINE_SCHEMA = &#x27;itcast&#x27;;show create procedure p1;-- åˆ é™¤drop procedure if exists p1;

å˜é‡åœ¨MySQLä¸­å˜é‡åˆ†ä¸ºä¸‰ç§ç±»å‹: ç³»ç»Ÿå˜é‡ã€ç”¨æˆ·å®šä¹‰å˜é‡ã€å±€éƒ¨å˜é‡ã€‚

ç³»ç»Ÿå˜é‡
ç³»ç»Ÿå˜é‡æ˜¯MySQLæœåŠ¡å™¨æä¾›ï¼Œä¸æ˜¯ç”¨æˆ·å®šä¹‰çš„ï¼Œå±äºæœåŠ¡å™¨å±‚é¢ã€‚åˆ†ä¸ºå…¨å±€å˜é‡ï¼ˆGLOBALï¼‰ã€ä¼šè¯å˜é‡ï¼ˆSESSIONï¼‰ã€‚

å…¨å±€å˜é‡(GLOBAL): å…¨å±€å˜é‡é’ˆå¯¹äºæ‰€æœ‰çš„ä¼šè¯ã€‚

ä¼šè¯å˜é‡(SESSION): ä¼šè¯å˜é‡é’ˆå¯¹äºå•ä¸ªä¼šè¯ï¼Œåœ¨å¦å¤–ä¸€ä¸ªä¼šè¯çª—å£å°±ä¸ç”Ÿæ•ˆäº†ã€‚

å¦‚æœæ²¡æœ‰æŒ‡å®šSESSION&#x2F;GLOBALï¼Œé»˜è®¤æ˜¯SESSIONä¼šè¯å˜é‡ã€‚

mysqlæœåŠ¡é‡æ–°å¯åŠ¨ä¹‹åï¼Œæ‰€è®¾ç½®çš„å…¨å±€å‚æ•°ä¼šå¤±æ•ˆï¼Œè¦æƒ³ä¸å¤±æ•ˆï¼Œå¯ä»¥åœ¨ &#x2F;etc&#x2F;my.cnf ä¸­é…ç½®ã€‚



æŸ¥çœ‹&amp;è®¾ç½® ç³»ç»Ÿå˜é‡
# æŸ¥çœ‹ç³»ç»Ÿå˜é‡SHOW [ SESSION | GLOBAL ] VARIABLES ; -- æŸ¥çœ‹æ‰€æœ‰ç³»ç»Ÿå˜é‡SHOW [ SESSION | GLOBAL ] VARIABLES LIKE &#x27;......&#x27;; -- å¯ä»¥é€šè¿‡LIKEæ¨¡ç³ŠåŒ¹é…æ–¹å¼æŸ¥æ‰¾å˜é‡SELECT @@[SESSION | GLOBAL] ç³»ç»Ÿå˜é‡å; -- æŸ¥çœ‹æŒ‡å®šå˜é‡çš„å€¼# è®¾ç½®ç³»ç»Ÿå˜é‡SET [ SESSION | GLOBAL ] ç³»ç»Ÿå˜é‡å = å€¼ ;SET @@[SESSION | GLOBAL]ç³»ç»Ÿå˜é‡å = å€¼ ;

ç”¨æˆ·å®šä¹‰å˜é‡
ç”¨æˆ·å®šä¹‰å˜é‡æ˜¯ç”¨æˆ·æ ¹æ®éœ€è¦è‡ªå·±å®šä¹‰çš„å˜é‡ï¼Œç”¨æˆ·å˜é‡ä¸ç”¨æå‰å£°æ˜ï¼Œåœ¨ç”¨çš„æ—¶å€™ç›´æ¥ç”¨ â€œ@å˜é‡ åâ€ ä½¿ç”¨å°±å¯ä»¥ã€‚å…¶ä½œç”¨åŸŸä¸ºå½“å‰è¿æ¥ã€‚

èµ‹å€¼ï¼Œå¯ä»¥ä½¿ç”¨ &#x3D; ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ :&#x3D; ã€‚
æ–¹å¼ä¸€:	SET @var_name = expr [, @var_name = expr] ... ;	SET @var_name := expr [, @var_name := expr] ... ;æ–¹å¼ä¸€:	SELECT @var_name := expr [, @var_name := expr] ... ;	SELECT å­—æ®µå INTO @var_name FROM è¡¨å;

ä½¿ç”¨
SELECT @var_name ;


æ³¨æ„: ç”¨æˆ·å®šä¹‰çš„å˜é‡æ— éœ€å¯¹å…¶è¿›è¡Œå£°æ˜æˆ–åˆå§‹åŒ–ï¼Œåªä¸è¿‡è·å–åˆ°çš„å€¼ä¸ºNULLã€‚


å±€éƒ¨å˜é‡
å±€éƒ¨å˜é‡ æ˜¯æ ¹æ®éœ€è¦å®šä¹‰çš„åœ¨å±€éƒ¨ç”Ÿæ•ˆçš„å˜é‡ï¼Œè®¿é—®ä¹‹å‰ï¼Œéœ€è¦DECLAREå£°æ˜ã€‚å¯ç”¨ä½œå­˜å‚¨è¿‡ç¨‹å†…çš„å±€éƒ¨å˜é‡å’Œè¾“å…¥å‚æ•°ï¼Œå±€éƒ¨å˜é‡çš„èŒƒå›´æ˜¯åœ¨å…¶å†…å£°æ˜çš„BEGIN â€¦ ENDå—ã€‚

å£°æ˜
DECLARE å˜é‡å å˜é‡ç±»å‹ [DEFAULT ... ] ;-- å˜é‡ç±»å‹å°±æ˜¯æ•°æ®åº“å­—æ®µç±»å‹ï¼šINTã€BIGINTã€CHARã€VARCHARã€DATEã€TIMEç­‰ã€‚

èµ‹å€¼
SET å˜é‡å = å€¼ ;SET å˜é‡å := å€¼ ;SELECT å­—æ®µå INTO å˜é‡å FROM è¡¨å ... ;

ä½¿ç”¨
select å˜é‡å;



ifif ç”¨äºåšæ¡ä»¶åˆ¤æ–­ï¼Œå…·ä½“çš„è¯­æ³•ç»“æ„ä¸ºï¼š
IF æ¡ä»¶1 THEN.....ELSEIF æ¡ä»¶2 THEN -- å¯é€‰.....ELSE -- å¯é€‰.....END IF;# ---------------------ä¸¾ä¾‹ï¼šæ ¹æ®å®šä¹‰å‚æ•°scoreï¼Œåˆ¤å®šå½“å‰åˆ†æ•°å¯¹åº”ç­‰çº§--------------------drop procedure if exists p3;create procedure p3()begin    declare score int default 58; #å£°æ˜å˜é‡scoreä¸º58ï¼Œåˆ¤æ–­å…¶åˆ†æ•°ç­‰çº§    declare grade varchar(10); #ç”¨äºæ¥æ”¶ç­‰çº§    if score &gt;= 85 then        set grade := &#x27;ä¼˜ç§€&#x27;;    elseif score &gt;= 60 then        set grade := &#x27;åŠæ ¼&#x27;;    else        set grade := &#x27;ä¸åŠæ ¼&#x27;;    end if;    select grade;end;call p3; # ä¸åŠæ ¼


åœ¨ifæ¡ä»¶åˆ¤æ–­çš„ç»“æ„ä¸­ï¼ŒELSE IF ç»“æ„å¯ä»¥æœ‰å¤šä¸ªï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰ã€‚ ELSEç»“æ„å¯ä»¥æœ‰ï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰ã€‚

å‚æ•°å‚æ•°çš„ç±»å‹ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼šINã€OUTã€INOUTã€‚ å…·ä½“çš„å«ä¹‰å¦‚ä¸‹ï¼š



ç±»å‹
å«ä¹‰
å¤‡æ³¨



IN
è¯¥ç±»å‚æ•°ä½œä¸ºè¾“å…¥ï¼Œä¹Ÿå°±æ˜¯éœ€è¦è°ƒç”¨æ—¶ä¼ å…¥å€¼
é»˜è®¤


OUT
è¯¥ç±»å‚æ•°ä½œä¸ºè¾“å‡ºï¼Œä¹Ÿå°±æ˜¯è¯¥å‚æ•°å¯ä»¥ä½œä¸ºè¿”å›å€¼



INOUT
æ—¢å¯ä»¥ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºè¾“å‡ºå‚æ•°



ç”¨æ³•ï¼š
CREATE PROCEDURE å­˜å‚¨è¿‡ç¨‹åç§° ([ IN/OUT/INOUT å‚æ•°å å‚æ•°ç±»å‹ ])BEGIN	-- SQLè¯­å¥END ;

æ¡ˆä¾‹
-- æ¡ˆä¾‹ä¸€ æ ¹æ®ä¼ å…¥å‚æ•°scoreï¼Œåˆ¤å®šå½“å‰åˆ†æ•°å¯¹åº”çš„åˆ†æ•°ç­‰çº§ï¼Œå¹¶è¿”å›ã€‚-- score &gt;= 85åˆ†ï¼Œç­‰çº§ä¸ºä¼˜ç§€ã€‚-- score &gt;= 60åˆ† ä¸” score &lt; 85åˆ†ï¼Œç­‰çº§ä¸ºåŠæ ¼ã€‚-- score &lt; 60åˆ†ï¼Œç­‰çº§ä¸ºä¸åŠæ ¼ã€‚DROP PROCEDURE if EXISTS p1;CREATE PROCEDURE p1(IN score INT,OUT result VARCHAR(10))BEGIN		if score &gt;= 85 THEN		SET result = &#x27;ä¼˜ç§€&#x27;;	ELSEIF score &gt; 60 THEN		SET result := &#x27;åŠæ ¼&#x27;;	ELSE 		SET result = &#x27;ä¸åŠæ ¼&#x27;;	END if;END;-- å®šä¹‰ç”¨æˆ·å˜é‡ @resultæ¥æ¥æ”¶è¿”å›çš„æ•°æ®, ç”¨æˆ·å˜é‡å¯ä»¥ä¸ç”¨å£°æ˜call p1(99, @result);select @result; -- ä¼˜ç§€-- æ¡ˆä¾‹äºŒ å°†ä¼ å…¥çš„200åˆ†åˆ¶çš„åˆ†æ•°ï¼Œè¿›è¡Œæ¢ç®—ï¼Œæ¢ç®—æˆç™¾åˆ†åˆ¶ï¼Œç„¶åè¿”å›ã€‚DROP PROCEDURE if EXISTS p2;CREATE PROCEDURE p2(INOUT score DOUBLE)BEGIN	set score := score * 0.5;END;SET @score = 60;call p2(@score);SELECT @score; -- 30

casecaseç»“æ„åŠä½œç”¨ï¼Œå’Œæˆ‘ä»¬åœ¨åŸºç¡€ç¯‡ä¸­æ‰€è®²è§£çš„æµç¨‹æ§åˆ¶å‡½æ•°å¾ˆç±»ä¼¼ã€‚æœ‰ä¸¤ç§è¯­æ³•æ ¼å¼ï¼š

è¯­æ³•1ï¼š
-- å«ä¹‰ï¼š å½“case_valueçš„å€¼ä¸º when_value1æ—¶ï¼Œæ‰§è¡Œstatement_list1ï¼Œå½“å€¼ä¸º when_value2æ—¶ï¼Œæ‰§è¡Œstatement_list2ï¼Œ å¦åˆ™å°±æ‰§è¡Œ statement_listCASE case_value	WHEN when_value1 THEN statement_list1	[ WHEN when_value2 THEN statement_list2] ...	[ ELSE statement_list ]END CASE;

è¯­æ³•2ï¼š
-- å«ä¹‰ï¼š å½“æ¡ä»¶search_condition1æˆç«‹æ—¶ï¼Œæ‰§è¡Œstatement_list1ï¼Œå½“æ¡ä»¶search_condition2æˆç«‹æ—¶ï¼Œæ‰§è¡Œstatement_list2ï¼Œ å¦åˆ™å°±æ‰§è¡Œ statement_listCASE	WHEN search_condition1 THEN statement_list1	[WHEN search_condition2 THEN statement_list2] ...	[ELSE statement_list]END CASE;

æ¡ˆä¾‹ï¼š
# æ ¹æ®ä¼ å…¥çš„æœˆä»½ï¼Œåˆ¤å®šæœˆä»½æ‰€å±çš„å­£èŠ‚ï¼ˆè¦æ±‚é‡‡ç”¨caseç»“æ„ï¼‰ã€‚# 1-3æœˆä»½ï¼Œä¸ºç¬¬ä¸€å­£åº¦# 4-6æœˆä»½ï¼Œä¸ºç¬¬äºŒå­£åº¦# 7-9æœˆä»½ï¼Œä¸ºç¬¬ä¸‰å­£åº¦# 10-12æœˆä»½ï¼Œä¸ºç¬¬å››å­£åº¦DROP PROCEDURE if EXISTS p3;CREATE PROCEDURE p3(IN month INT)BEGIN	DECLARE season VARCHAR(10);	CASE 		WHEN month &gt;= 1 and month &lt;= 3 THEN			SET season := &#x27;ç¬¬ä¸€å­£åº¦&#x27;;		WHEN month &gt;= 4 and month &lt;= 6 THEN			SET season := &#x27;ç¬¬äºŒå­£åº¦&#x27;;		WHEN month &gt;= 7 and month &lt;= 9 THEN			SET season := &#x27;ç¬¬ä¸‰å­£åº¦&#x27;;		WHEN month &gt;= 10 and month &lt;= 12 THEN			SET season := &#x27;ç¬¬å››å­£åº¦&#x27;;		ELSE			SET season := &#x27;éæ³•å‚æ•°&#x27;;	END CASE;	select concat(&#x27;æ‚¨è¾“å…¥çš„æœˆä»½ä¸º: &#x27;,month, &#x27;, æ‰€å±çš„å­£åº¦ä¸º: &#x27;,season);END;call p3(10);# æ‚¨è¾“å…¥çš„æœˆä»½ä¸º: 10, æ‰€å±çš„å­£åº¦ä¸º: ç¬¬å››å­£åº¦


æ³¨æ„ï¼šå¦‚æœåˆ¤å®šæ¡ä»¶æœ‰å¤šä¸ªï¼Œå¤šä¸ªæ¡ä»¶ä¹‹é—´ï¼Œå¯ä»¥ä½¿ç”¨ and æˆ– or è¿›è¡Œè¿æ¥ã€‚

whilewhile å¾ªç¯æ˜¯æœ‰æ¡ä»¶çš„å¾ªç¯æ§åˆ¶è¯­å¥ã€‚æ»¡è¶³æ¡ä»¶åï¼Œå†æ‰§è¡Œå¾ªç¯ä½“ä¸­çš„SQLè¯­å¥ã€‚å…·ä½“è¯­æ³•ä¸ºï¼š
-- å…ˆåˆ¤å®šæ¡ä»¶ï¼Œå¦‚æœæ¡ä»¶ä¸ºtrueï¼Œåˆ™æ‰§è¡Œé€»è¾‘ï¼Œå¦åˆ™ï¼Œä¸æ‰§è¡Œé€»è¾‘WHILE æ¡ä»¶ DO	SQLé€»è¾‘...END WHILE;

æ¡ˆä¾‹
# è®¡ç®—ä»1ç´¯åŠ åˆ°nçš„å€¼ï¼Œnä¸ºä¼ å…¥çš„å‚æ•°å€¼ã€‚-- A. å®šä¹‰å±€éƒ¨å˜é‡, è®°å½•ç´¯åŠ ä¹‹åçš„å€¼;-- B. æ¯å¾ªç¯ä¸€æ¬¡, å°±ä¼šå¯¹nè¿›è¡Œå‡1 , å¦‚æœnå‡åˆ°0, åˆ™é€€å‡ºå¾ªç¯DROP PROCEDURE if EXISTS p4;CREATE PROCEDURE p4(IN num INT)BEGIN	declare result INT DEFAULT 0; 	WHILE num &gt; 0 DO		set result := result + num;		set num := num - 1;	END WHILE;	SELECT result;END;call p4(10); # 55

repeatrepeatæ˜¯æœ‰æ¡ä»¶çš„å¾ªç¯æ§åˆ¶è¯­å¥, å½“æ»¡è¶³untilå£°æ˜çš„æ¡ä»¶çš„æ—¶å€™ï¼Œåˆ™é€€å‡ºå¾ªç¯ ã€‚å…·ä½“è¯­æ³•ä¸ºï¼š
-- å…ˆæ‰§è¡Œä¸€æ¬¡é€»è¾‘ï¼Œç„¶ååˆ¤å®šUNTILæ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œå¦‚æœæ»¡è¶³ï¼Œåˆ™é€€å‡ºã€‚å¦‚æœä¸æ»¡è¶³ï¼Œåˆ™ç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯REPEAT	SQLé€»è¾‘...	UNTIL æ¡ä»¶END REPEAT;

æ¡ˆä¾‹
# è®¡ç®—ä»1ç´¯åŠ åˆ°nçš„å€¼ï¼Œnä¸ºä¼ å…¥çš„å‚æ•°å€¼ã€‚(ä½¿ç”¨repeatå®ç°)-- A. å®šä¹‰å±€éƒ¨å˜é‡, è®°å½•ç´¯åŠ ä¹‹åçš„å€¼;-- B. æ¯å¾ªç¯ä¸€æ¬¡, å°±ä¼šå¯¹nè¿›è¡Œå‡1 , å¦‚æœnå‡åˆ°0, åˆ™é€€å‡ºå¾ªç¯DROP PROCEDURE if EXISTS p5;CREATE PROCEDURE p5(IN num INT)BEGIN	declare result INT DEFAULT 0; 	REPEAT		set result := result + num;		set num := num - 1;		UNTIL num &lt;= 0	END REPEAT;	SELECT result;END;call p5(10); # 

loopLOOP å®ç°ç®€å•çš„å¾ªç¯ï¼Œå¦‚æœä¸åœ¨SQLé€»è¾‘ä¸­å¢åŠ é€€å‡ºå¾ªç¯çš„æ¡ä»¶ï¼Œå¯ä»¥ç”¨å…¶æ¥å®ç°ç®€å•çš„æ­»å¾ªç¯ã€‚ LOOPå¯ä»¥é…åˆä¸€ä¸‹ä¸¤ä¸ªè¯­å¥ä½¿ç”¨ï¼š

LEAVE ï¼šé…åˆå¾ªç¯ä½¿ç”¨ï¼Œé€€å‡ºå¾ªç¯ã€‚
ITERATEï¼šå¿…é¡»ç”¨åœ¨å¾ªç¯ä¸­ï¼Œä½œç”¨æ˜¯è·³è¿‡å½“å‰å¾ªç¯å‰©ä¸‹çš„è¯­å¥ï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ã€‚

[begin_label:] LOOP	SQLé€»è¾‘...END LOOP [end_label];LEAVE label; -- é€€å‡ºæŒ‡å®šæ ‡è®°çš„å¾ªç¯ä½“ITERATE label; -- ç›´æ¥è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯-- ä¸Šè¿°è¯­æ³•ä¸­å‡ºç°çš„ begin_labelï¼Œend_labelï¼Œlabel æŒ‡çš„éƒ½æ˜¯æˆ‘ä»¬æ‰€è‡ªå®šä¹‰çš„æ ‡è®°ã€‚

æ¡ˆä¾‹
#  æ¡ˆä¾‹ä¸€# è®¡ç®—ä»1ç´¯åŠ åˆ°nçš„å€¼ï¼Œnä¸ºä¼ å…¥çš„å‚æ•°å€¼ã€‚-- A. å®šä¹‰å±€éƒ¨å˜é‡, è®°å½•ç´¯åŠ ä¹‹åçš„å€¼;-- B. æ¯å¾ªç¯ä¸€æ¬¡, å°±ä¼šå¯¹nè¿›è¡Œ-1 , å¦‚æœnå‡åˆ°0, åˆ™é€€å‡ºå¾ªç¯ ----&gt; leave xxDROP PROCEDURE if EXISTS p6;CREATE PROCEDURE p6(IN num INT)BEGIN	DECLARE result INT DEFAULT 0; 	getSum: LOOP		IF num &lt;= 0 THEN			LEAVE getSum; 		END IF; 		set result := result + num;		set num := num - 1;	END LOOP getSum;	SELECT result;END;call p6(10); # 55#  æ¡ˆä¾‹äºŒ# è®¡ç®—ä»1åˆ°nä¹‹é—´çš„å¶æ•°ç´¯åŠ çš„å€¼ï¼Œnä¸ºä¼ å…¥çš„å‚æ•°å€¼ã€‚-- A. å®šä¹‰å±€éƒ¨å˜é‡, è®°å½•ç´¯åŠ ä¹‹åçš„å€¼;-- B. æ¯å¾ªç¯ä¸€æ¬¡, å°±ä¼šå¯¹nè¿›è¡Œ-1 , å¦‚æœnå‡åˆ°0, åˆ™é€€å‡ºå¾ªç¯ ----&gt; leave xx-- C. å¦‚æœå½“æ¬¡ç´¯åŠ çš„æ•°æ®æ˜¯å¥‡æ•°, åˆ™ç›´æ¥è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯. --------&gt; iterate xxDROP PROCEDURE if EXISTS p7;CREATE PROCEDURE p7(IN num INT)BEGIN	DECLARE result INT DEFAULT 0; 	getSum: LOOP		IF num &lt;= 0 THEN			LEAVE getSum; 		END IF; 				if num%2 = 1 then			set num := num - 1;			iterate getSum;		end if;		set result := result + num;		set num := num - 1;			END LOOP getSum;	SELECT result;END;call p7(10); # 30

æ¸¸æ ‡æ¸¸æ ‡ï¼ˆCURSORï¼‰æ˜¯ç”¨æ¥å­˜å‚¨æŸ¥è¯¢ç»“æœé›†çš„æ•°æ®ç±»å‹ , åœ¨å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ä¸­å¯ä»¥ä½¿ç”¨æ¸¸æ ‡å¯¹ç»“æœé›†è¿›è¡Œå¾ªç¯çš„å¤„ç†ã€‚æ¸¸æ ‡çš„ä½¿ç”¨åŒ…æ‹¬æ¸¸æ ‡çš„å£°æ˜ã€OPENã€FETCH å’Œ CLOSEï¼Œå…¶è¯­æ³•åˆ†åˆ«å¦‚ä¸‹ã€‚
# å£°æ˜æ¸¸æ ‡DECLARE æ¸¸æ ‡åç§° CURSOR FOR æŸ¥è¯¢è¯­å¥ ;# æ‰“å¼€æ¸¸æ ‡OPEN æ¸¸æ ‡åç§° ;# è·å–æ¸¸æ ‡è®°å½•FETCH æ¸¸æ ‡åç§° INTO å˜é‡ [, å˜é‡ ] ;# å…³é—­æ¸¸æ ‡CLOSE æ¸¸æ ‡åç§° ;

æ¡ˆä¾‹
#  æ ¹æ®ä¼ å…¥çš„å‚æ•°uageï¼Œæ¥æŸ¥è¯¢ç”¨æˆ·è¡¨tb_userä¸­ï¼Œæ‰€æœ‰çš„ç”¨æˆ·å¹´é¾„å°äºç­‰äºuageçš„ç”¨æˆ·å§“å#ï¼ˆnameï¼‰å’Œä¸“ä¸šï¼ˆprofessionï¼‰ï¼Œå¹¶å°†ç”¨æˆ·çš„å§“åå’Œä¸“ä¸šæ’å…¥åˆ°æ‰€åˆ›å»ºçš„ä¸€å¼ æ–°è¡¨# (id,name,profession)ä¸­ã€‚-- é€»è¾‘:-- A. å£°æ˜æ¸¸æ ‡, å­˜å‚¨æŸ¥è¯¢ç»“æœé›†-- B. å‡†å¤‡: åˆ›å»ºè¡¨ç»“æ„-- C. å¼€å¯æ¸¸æ ‡-- D. è·å–æ¸¸æ ‡ä¸­çš„è®°å½•-- E. æ’å…¥æ•°æ®åˆ°æ–°è¡¨ä¸­-- F. å…³é—­æ¸¸æ ‡DROP PROCEDURE if EXISTS p8;CREATE PROCEDURE p8(IN iage INT)BEGIN	# æœ‰å…ˆåé¡ºåºï¼šå…ˆå£°æ˜æ™®é€šå˜é‡ï¼Œå†å£°æ˜æ¸¸æ ‡	declare uname varchar(100);	declare upro varchar(100);	# 1.å£°æ˜æ¸¸æ ‡ å­˜å‚¨æŸ¥è¯¢ç»“æœé›†	DECLARE u_cursor CURSOR FOR SELECT `name`,profession FROM tb_user WHERE age &lt;= iage;	# 2.åˆ›å»ºæ–°è¡¨çš„ è¡¨ç»“æ„	drop table if exists tb_user_pro;	create table if not exists tb_user_pro(		id int primary key auto_increment,		name varchar(100),		profession varchar(100)	);	# 3.å¼€å¯æ¸¸æ ‡	OPEN u_cursor;	# 4.è·å–æ¸¸æ ‡ä¸­çš„è®°å½•	while true do		fetch u_cursor into uname,upro;		# 5.æ’å…¥æ•°æ®åˆ°æ–°è¡¨ä¸­		insert into tb_user_pro values (null, uname, upro);	end while;	# 6.å…³é—­æ¸¸æ ‡	CLOSE u_cursor;END;call p8(30);

ä¸Šè¿°çš„å­˜å‚¨è¿‡ç¨‹ï¼Œæœ€ç»ˆæˆ‘ä»¬åœ¨è°ƒç”¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæŠ¥é”™ï¼Œä¹‹æ‰€ä»¥æŠ¥é”™æ˜¯å› ä¸ºä¸Šé¢çš„whileå¾ªç¯ä¸­ï¼Œå¹¶æ²¡æœ‰ é€€å‡ºæ¡ä»¶ã€‚å½“æ¸¸æ ‡çš„æ•°æ®é›†è·å–å®Œæ¯•ä¹‹åï¼Œå†æ¬¡è·å–æ•°æ®ï¼Œå°±ä¼šæŠ¥é”™ï¼Œä»è€Œç»ˆæ­¢äº†ç¨‹åºçš„æ‰§è¡Œã€‚

ä½†æ˜¯æ­¤æ—¶ï¼Œtb_user_proè¡¨ç»“æ„åŠå…¶æ•°æ®éƒ½å·²ç»æ’å…¥æˆåŠŸäº†ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ·æ–°è¡¨ç»“æ„ï¼Œæ£€æŸ¥è¡¨ç»“æ„ä¸­çš„æ•°æ®ã€‚ä¸Šè¿°çš„åŠŸèƒ½ï¼Œè™½ç„¶æˆ‘ä»¬å®ç°äº†ï¼Œä½†æ˜¯é€»è¾‘å¹¶ä¸å®Œå–„ï¼Œè€Œä¸”ç¨‹åºæ‰§è¡Œå®Œæ¯•ï¼Œè·å–ä¸åˆ°æ•°æ®ï¼Œæ•°æ®åº“è¿˜æŠ¥ é”™ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±éœ€è¦æ¥å®Œæˆè¿™ä¸ªå­˜å‚¨è¿‡ç¨‹ï¼Œå¹¶ä¸”è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ è¦æƒ³è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±éœ€è¦é€šè¿‡MySQLä¸­æä¾›çš„æ¡ä»¶å¤„ç†ç¨‹åº Handler æ¥è§£å†³ã€‚
æ¡ä»¶å¤„ç†ç¨‹åºæ¡ä»¶å¤„ç†ç¨‹åºï¼ˆHandlerï¼‰å¯ä»¥ç”¨æ¥å®šä¹‰åœ¨æµç¨‹æ§åˆ¶ç»“æ„æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜æ—¶ç›¸åº”çš„å¤„ç†æ­¥éª¤ã€‚å…·ä½“è¯­æ³•ä¸ºï¼š
DECLARE handler_action HANDLER FOR condition_value [, condition_value] ... statement ;handler_action çš„å–å€¼ï¼š    CONTINUE: ç»§ç»­æ‰§è¡Œå½“å‰ç¨‹åº    EXIT: ç»ˆæ­¢æ‰§è¡Œå½“å‰ç¨‹åºcondition_value çš„å–å€¼ï¼š    SQLSTATE sqlstate_value: çŠ¶æ€ç ï¼Œå¦‚ 02000    SQLWARNING: æ‰€æœ‰ä»¥01å¼€å¤´çš„SQLSTATEä»£ç çš„ç®€å†™    NOT FOUND: æ‰€æœ‰ä»¥02å¼€å¤´çš„SQLSTATEä»£ç çš„ç®€å†™    SQLEXCEPTION: æ‰€æœ‰æ²¡æœ‰è¢«SQLWARNING æˆ– NOT FOUNDæ•è·çš„SQLSTATEä»£ç çš„ç®€å†™

æ¡ˆä¾‹

é€šè¿‡SQLSTATEæŒ‡å®šå…·ä½“çš„çŠ¶æ€ç 
# æˆ‘ä»¬ç»§ç»­æ¥å®Œæˆåœ¨ä¸Šä¸€å°èŠ‚æå‡ºçš„è¿™ä¸ªéœ€æ±‚ï¼Œå¹¶è§£å†³å…¶ä¸­çš„é—®é¢˜ã€‚#  æ ¹æ®ä¼ å…¥çš„å‚æ•°uageï¼Œæ¥æŸ¥è¯¢ç”¨æˆ·è¡¨tb_userä¸­ï¼Œæ‰€æœ‰çš„ç”¨æˆ·å¹´é¾„å°äºç­‰äºuageçš„ç”¨æˆ·å§“å#ï¼ˆnameï¼‰å’Œä¸“ä¸šï¼ˆprofessionï¼‰ï¼Œå¹¶å°†ç”¨æˆ·çš„å§“åå’Œä¸“ä¸šæ’å…¥åˆ°æ‰€åˆ›å»ºçš„ä¸€å¼ æ–°è¡¨# (id,name,profession)ä¸­ã€‚-- é€»è¾‘:-- A. å£°æ˜æ¸¸æ ‡, å­˜å‚¨æŸ¥è¯¢ç»“æœé›†-- B. å‡†å¤‡: åˆ›å»ºè¡¨ç»“æ„-- C. å¼€å¯æ¸¸æ ‡-- D. è·å–æ¸¸æ ‡ä¸­çš„è®°å½•-- E. æ’å…¥æ•°æ®åˆ°æ–°è¡¨ä¸­-- F. å…³é—­æ¸¸æ ‡DROP PROCEDURE if EXISTS p8;CREATE PROCEDURE p8(IN iage INT)BEGIN	# æœ‰å…ˆåé¡ºåºï¼šå…ˆå£°æ˜æ™®é€šå˜é‡ï¼Œå†å£°æ˜æ¸¸æ ‡	declare uname varchar(100);	declare upro varchar(100);	# 1.å£°æ˜æ¸¸æ ‡ å­˜å‚¨æŸ¥è¯¢ç»“æœé›†	DECLARE u_cursor CURSOR FOR SELECT `name`,profession FROM tb_user WHERE age &lt;= iage;		-- å£°æ˜æ¡ä»¶å¤„ç†ç¨‹åº ï¼š å½“SQLè¯­å¥æ‰§è¡ŒæŠ›å‡ºçš„çŠ¶æ€ç ä¸º02000æ—¶ï¼Œå°†å…³é—­æ¸¸æ ‡u_cursorï¼Œå¹¶é€€å‡º	declare exit handler for SQLSTATE &#x27;02000&#x27; close u_cursor;		# 2.åˆ›å»ºæ–°è¡¨çš„ è¡¨ç»“æ„	drop table if exists tb_user_pro;	create table if not exists tb_user_pro(		id int primary key auto_increment,		name varchar(100),		profession varchar(100)	);	# 3.å¼€å¯æ¸¸æ ‡	OPEN u_cursor;	# 4.è·å–æ¸¸æ ‡ä¸­çš„è®°å½•	while true do		fetch u_cursor into uname,upro;		# 5.æ’å…¥æ•°æ®åˆ°æ–°è¡¨ä¸­		insert into tb_user_pro values (null, uname, upro);	end while;	# 6.å…³é—­æ¸¸æ ‡	CLOSE u_cursor;END;call p8(30);

é€šè¿‡SQLSTATEçš„ä»£ç ç®€å†™æ–¹å¼ NOT FOUNDã€‚02 å¼€å¤´çš„çŠ¶æ€ç ï¼Œä»£ç ç®€å†™ä¸º NOT FOUND
# æˆ‘ä»¬ç»§ç»­æ¥å®Œæˆåœ¨ä¸Šä¸€å°èŠ‚æå‡ºçš„è¿™ä¸ªéœ€æ±‚ï¼Œå¹¶è§£å†³å…¶ä¸­çš„é—®é¢˜ã€‚#  æ ¹æ®ä¼ å…¥çš„å‚æ•°uageï¼Œæ¥æŸ¥è¯¢ç”¨æˆ·è¡¨tb_userä¸­ï¼Œæ‰€æœ‰çš„ç”¨æˆ·å¹´é¾„å°äºç­‰äºuageçš„ç”¨æˆ·å§“å#ï¼ˆnameï¼‰å’Œä¸“ä¸šï¼ˆprofessionï¼‰ï¼Œå¹¶å°†ç”¨æˆ·çš„å§“åå’Œä¸“ä¸šæ’å…¥åˆ°æ‰€åˆ›å»ºçš„ä¸€å¼ æ–°è¡¨# (id,name,profession)ä¸­ã€‚-- é€»è¾‘:-- A. å£°æ˜æ¸¸æ ‡, å­˜å‚¨æŸ¥è¯¢ç»“æœé›†-- B. å‡†å¤‡: åˆ›å»ºè¡¨ç»“æ„-- C. å¼€å¯æ¸¸æ ‡-- D. è·å–æ¸¸æ ‡ä¸­çš„è®°å½•-- E. æ’å…¥æ•°æ®åˆ°æ–°è¡¨ä¸­-- F. å…³é—­æ¸¸æ ‡DROP PROCEDURE if EXISTS p8;CREATE PROCEDURE p8(IN iage INT)BEGIN	# æœ‰å…ˆåé¡ºåºï¼šå…ˆå£°æ˜æ™®é€šå˜é‡ï¼Œå†å£°æ˜æ¸¸æ ‡	declare uname varchar(100);	declare upro varchar(100);	# 1.å£°æ˜æ¸¸æ ‡ å­˜å‚¨æŸ¥è¯¢ç»“æœé›†	DECLARE u_cursor CURSOR FOR SELECT `name`,profession FROM tb_user WHERE age &lt;= iage;		-- å£°æ˜æ¡ä»¶å¤„ç†ç¨‹åº ï¼š å½“SQLè¯­å¥æ‰§è¡ŒæŠ›å‡ºçš„çŠ¶æ€ç ä¸º02å¼€å¤´æ—¶ï¼Œå°†å…³é—­æ¸¸æ ‡u_cursorï¼Œå¹¶é€€å‡º	declare exit handler for not found close u_cursor;		# 2.åˆ›å»ºæ–°è¡¨çš„ è¡¨ç»“æ„	drop table if exists tb_user_pro;	create table if not exists tb_user_pro(		id int primary key auto_increment,		name varchar(100),		profession varchar(100)	);	# 3.å¼€å¯æ¸¸æ ‡	OPEN u_cursor;	# 4.è·å–æ¸¸æ ‡ä¸­çš„è®°å½•	while true do		fetch u_cursor into uname,upro;		# 5.æ’å…¥æ•°æ®åˆ°æ–°è¡¨ä¸­		insert into tb_user_pro values (null, uname, upro);	end while;	# 6.å…³é—­æ¸¸æ ‡	CLOSE u_cursor;END;call p8(30);


å…·ä½“çš„é”™è¯¯çŠ¶æ€ç ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://dev.mysql.com/doc/refman/8.0/en/declare-handler.htmlhttps://dev.mysql.com/doc/mysql-errors/8.0/en/server-error-reference.html

å­˜å‚¨å‡½æ•°å­˜å‚¨å‡½æ•°æ˜¯æœ‰è¿”å›å€¼çš„å­˜å‚¨è¿‡ç¨‹ï¼Œå­˜å‚¨å‡½æ•°çš„å‚æ•°åªèƒ½æ˜¯INç±»å‹çš„ã€‚å…·ä½“è¯­æ³•å¦‚ä¸‹ï¼š
CREATE FUNCTION å­˜å‚¨å‡½æ•°åç§° ([ å‚æ•°åˆ—è¡¨ ])RETURNS type [characteristic ...]BEGIN    -- SQLè¯­å¥    RETURN ...;END ;

characteristicè¯´æ˜ï¼š

DETERMINISTICï¼šç›¸åŒçš„è¾“å…¥å‚æ•°æ€»æ˜¯äº§ç”Ÿç›¸åŒçš„ç»“æœ
NO SQL ï¼šä¸åŒ…å« SQL è¯­å¥
READS SQL DATAï¼šåŒ…å«è¯»å–æ•°æ®çš„è¯­å¥ï¼Œä½†ä¸åŒ…å«å†™å…¥æ•°æ®çš„è¯­å¥

æ¡ˆä¾‹
# è®¡ç®—ä»1ç´¯åŠ åˆ°nçš„å€¼ï¼Œnä¸ºä¼ å…¥çš„å‚æ•°å€¼ã€‚CREATE FUNCTION fun1 (n INT)RETURNS INT DETERMINISTICBEGIN    declare sum int default 0;    while n &gt; 0 do        set sum := sum + n;        set n := n - 1;    end while;    return sum;END ;select fun1(100); # 5050

è§¦å‘å™¨è§¦å‘å™¨æ˜¯ä¸è¡¨æœ‰å…³çš„æ•°æ®åº“å¯¹è±¡ï¼ŒæŒ‡åœ¨insert&#x2F;update&#x2F;deleteä¹‹å‰(BEFORE)æˆ–ä¹‹å(AFTER)ï¼Œè§¦å‘å¹¶æ‰§è¡Œè§¦å‘å™¨ä¸­å®šä¹‰çš„SQLè¯­å¥é›†åˆã€‚è§¦å‘å™¨çš„è¿™ç§ç‰¹æ€§å¯ä»¥ååŠ©åº”ç”¨åœ¨æ•°æ®åº“ç«¯ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ , æ—¥å¿—è®°å½• , æ•°æ®æ ¡éªŒç­‰æ“ä½œ ã€‚
ä½¿ç”¨åˆ«åOLDå’ŒNEWæ¥å¼•ç”¨è§¦å‘å™¨ä¸­å‘ç”Ÿå˜åŒ–çš„è®°å½•å†…å®¹ï¼Œè¿™ä¸å…¶ä»–çš„æ•°æ®åº“æ˜¯ç›¸ä¼¼çš„ã€‚ç°åœ¨è§¦å‘å™¨è¿˜ åªæ”¯æŒè¡Œçº§è§¦å‘ï¼Œä¸æ”¯æŒè¯­å¥çº§è§¦å‘ã€‚



è§¦å‘å™¨ç±»å‹
NEW å’Œ OLD



INSERT å‹è§¦å‘å™¨
NEW è¡¨ç¤ºå°†è¦æˆ–è€…å·²ç»æ–°å¢çš„æ•°æ®


UPDATE å‹è§¦å‘å™¨
OLD è¡¨ç¤ºä¿®æ”¹ä¹‹å‰çš„æ•°æ® , NEW è¡¨ç¤ºå°†è¦æˆ–å·²ç»ä¿®æ”¹åçš„æ•°æ®


DELETE å‹è§¦å‘å™¨
OLD è¡¨ç¤ºå°†è¦æˆ–è€…å·²ç»åˆ é™¤çš„æ•°æ®


åŸºæœ¬è¯­æ³•
åˆ›å»º
CREATE TRIGGER trigger_nameBEFORE/AFTER INSERT/UPDATE/DELETEON tbl_name FOR EACH ROW -- è¡Œçº§è§¦å‘å™¨BEGIN	trigger_stmt ;END;

æŸ¥çœ‹
SHOW TRIGGERS ;

åˆ é™¤
DROP TRIGGER [schema_name.]trigger_name ; -- å¦‚æœæ²¡æœ‰æŒ‡å®š schema_nameï¼Œé»˜è®¤ä¸ºå½“å‰æ•°æ®åº“ã€‚

æ¡ˆä¾‹
é€šè¿‡è§¦å‘å™¨è®°å½• tb_user è¡¨çš„æ•°æ®å˜æ›´æ—¥å¿—ï¼Œå°†å˜æ›´æ—¥å¿—æ’å…¥åˆ°æ—¥å¿—è¡¨user_logsä¸­, åŒ…å«å¢åŠ , ä¿®æ”¹ , åˆ é™¤ ã€‚
è¡¨ç»“æ„å‡†å¤‡:
-- å‡†å¤‡å·¥ä½œ : æ—¥å¿—è¡¨ user_logscreate table user_logs(    id int(11) not null auto_increment,    operation varchar(20) not null comment &#x27;æ“ä½œç±»å‹, insert/update/delete&#x27;,    operate_time datetime not null comment &#x27;æ“ä½œæ—¶é—´&#x27;,    operate_id int(11) not null comment &#x27;æ“ä½œçš„ID&#x27;,    operate_params varchar(500) comment &#x27;æ“ä½œå‚æ•°&#x27;,    primary key(`id`))engine=innodb default charset=utf8;


æ’å…¥æ•°æ®è§¦å‘å™¨
-- åˆ›å»ºæ’å…¥è§¦å‘å™¨CREATE TRIGGER tb_user_insert_trigger AFTER INSERT ON tb_user FOR EACH ROWBEGIN		INSERT INTO user_logs ( id, operation, operate_time, operate_id, operate_params )	VALUES		(NULL,&#x27;insert&#x27;,now(),new.id,		concat(&#x27;æ’å…¥çš„æ•°æ®å†…å®¹ä¸º:id=&#x27;,new.id,&#x27;name=&#x27;,new.NAME,&#x27;, phone=&#x27;,NEW.phone,&#x27;, email=&#x27;,NEW.email,&#x27;,profession=&#x27;,NEW.profession ));END;-- æŸ¥çœ‹è§¦å‘å™¨SHOW TRIGGERS;-- æ’å…¥æ•°æ®åˆ°tb_userinsert into tb_user(id, name, phone, email, profession, age, gender, status,createtime) VALUES (26,&#x27;ä¸‰çš‡å­&#x27;,&#x27;18809091212&#x27;,&#x27;erhuangzi@163.com&#x27;,&#x27;è½¯ä»¶å·¥ç¨‹&#x27;,23,&#x27;1&#x27;,&#x27;1&#x27;,now());-- æŸ¥è¯¢æ’å…¥è§¦å‘å™¨SELECT * FROM user_logs;

ä¿®æ”¹æ•°æ®è§¦å‘å™¨
-- åˆ›å»ºæ›´æ–°è§¦å‘å™¨CREATE TRIGGER tb_user_update_trigger AFTER UPDATE ON tb_user FOR EACH ROWBEGIN		INSERT INTO user_logs ( id, operation, operate_time, operate_id, operate_params )	VALUES		(NULL,&#x27;update&#x27;,now(),new.id,		concat(&#x27;æ›´æ–°å‰çš„æ•°æ®å†…å®¹ä¸º:id=&#x27;,old.id,&#x27;name=&#x27;,old.NAME,&#x27;, phone=&#x27;,old.phone,&#x27;, email=&#x27;,old.email,&#x27;,profession=&#x27;,old.profession,					&#x27;,æ›´æ–°åçš„æ•°æ®å†…å®¹ä¸º:id=&#x27;,new.id,&#x27;name=&#x27;,new.NAME,&#x27;, phone=&#x27;,new.phone,&#x27;, email=&#x27;,new.email,&#x27;,profession=&#x27;,new.profession));END;-- æŸ¥çœ‹è§¦å‘å™¨SHOW TRIGGERS;-- æ›´æ–°tb_useræ•°æ®update tb_user set profession = &#x27;ä¼šè®¡&#x27; where id = 23;-- æŸ¥è¯¢æ›´æ–°è§¦å‘å™¨SELECT * FROM user_logs;

åˆ é™¤æ•°æ®è§¦å‘å™¨
-- åˆ›å»ºåˆ é™¤è§¦å‘å™¨CREATE TRIGGER tb_user_delete_trigger AFTER DELETE ON tb_user FOR EACH ROWBEGIN		INSERT INTO user_logs ( id, operation, operate_time, operate_id, operate_params )	VALUES		(NULL,&#x27;delete&#x27;,now(),old.id,		concat(&#x27;åˆ é™¤çš„æ•°æ®å†…å®¹ä¸º:id=&#x27;,old.id,&#x27;name=&#x27;,old.NAME,&#x27;, phone=&#x27;,old.phone,&#x27;, email=&#x27;,old.email,&#x27;,profession=&#x27;,old.profession));END;-- æŸ¥çœ‹è§¦å‘å™¨SHOW TRIGGERS;-- åˆ é™¤tb_useræ•°æ®delete from tb_user WHERE id=26;-- æŸ¥è¯¢åˆ é™¤è§¦å‘å™¨SELECT * FROM user_logs;

é”é”æ˜¯è®¡ç®—æœºåè°ƒå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å¹¶å‘è®¿é—®æŸä¸€èµ„æºçš„æœºåˆ¶ã€‚åœ¨æ•°æ®åº“ä¸­ï¼Œé™¤ä¼ ç»Ÿçš„è®¡ç®—èµ„æºï¼ˆCPUã€ RAMã€I&#x2F;Oï¼‰çš„äº‰ç”¨ä»¥å¤–ï¼Œæ•°æ®ä¹Ÿæ˜¯ä¸€ç§ä¾›è®¸å¤šç”¨æˆ·å…±äº«çš„èµ„æºã€‚å¦‚ä½•ä¿è¯æ•°æ®å¹¶å‘è®¿é—®çš„ä¸€è‡´æ€§ã€æœ‰æ•ˆæ€§æ˜¯æ‰€æœ‰æ•°æ®åº“å¿…é¡»è§£å†³çš„ä¸€ä¸ªé—®é¢˜ï¼Œé”å†²çªä¹Ÿæ˜¯å½±å“æ•°æ®åº“å¹¶å‘è®¿é—®æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚ä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œé”å¯¹æ•°æ®åº“è€Œè¨€æ˜¾å¾—å°¤å…¶é‡è¦ï¼Œä¹Ÿæ›´åŠ å¤æ‚ã€‚
MySQLä¸­çš„ä½“ç³»å…¨æ™¯å›¾
graph TD
    A[MySQL é”ä½“ç³»] --&gt; B[æŒ‰ç²’åº¦åˆ’åˆ†]
    A --&gt; C[æŒ‰åŠŸèƒ½åˆ’åˆ†]
    A --&gt; D[æŒ‰æ¨¡å¼åˆ’åˆ†]
    
    B --&gt; B1[å…¨å±€é”]
    B --&gt; B2[è¡¨çº§é”]
    B --&gt; B3[è¡Œçº§é”]
    B --&gt; B4[é¡µçº§é”]
    
    C --&gt; C1[å…±äº«é” S]
    C --&gt; C2[æ’ä»–é” X]
    C --&gt; C3[æ„å‘å…±äº«é” IS]
    C --&gt; C4[æ„å‘æ’ä»–é” IX]
    
    D --&gt; D1[æ‚²è§‚é”]
    D --&gt; D2[ä¹è§‚é”]

å…±äº«é” (S Lock)ä¸€ä¸ªäº‹åŠ¡å·²è·å–å…±äº«é”ï¼Œå½“å¦ä¸€ä¸ªäº‹åŠ¡å°è¯•å¯¹å…·å¤‡å…±äº«é”çš„æ•°æ®è¿›è¡Œè¯»æ“ä½œæ—¶ï¼Œå¯æ­£å¸¸è¯»ï¼›è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œä¼šè¢«å…±äº«é”æ’æ–¥ã€‚

ç‰¹æ€§ï¼šå…è®¸å¤šäº‹åŠ¡å¹¶å‘è¯»å–

å…¼å®¹æ€§ï¼šå…¼å®¹å…¶ä»– S é”ï¼Œæ’æ–¥ X é”

ä½¿ç”¨åœºæ™¯ï¼š
-- ä¿è¯è¯»å–æœŸé—´æ•°æ®ä¸å˜SELECT * FROM table WHERE ... LOCK IN SHARE MODE;-- MySQL8.0ä¹‹åä¹Ÿä¼˜åŒ–äº†å†™æ³•ï¼Œå¦‚ä¸‹ï¼šSELECT ... FOR SHARE;

æ’ä»–é” (X Lock)å½“ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°ç‹¬å é”åï¼Œä¼šæ’æ–¥å…¶ä»–çº¿ç¨‹ï¼ˆè¿›è¡Œè¯»å†™æ“ä½œï¼‰ï¼Œå¦‚è‹¥å…¶ä»–çº¿ç¨‹ä¹Ÿæƒ³å¯¹å…±äº«èµ„æº&#x2F;åŒä¸€æ•°æ®è¿›è¡Œæ“ä½œï¼Œå¿…é¡»ç­‰åˆ°å½“å‰çº¿ç¨‹é‡Šæ”¾é”å¹¶ç«äº‰åˆ°é”èµ„æºæ‰è¡Œã€‚

ç‰¹æ€§ï¼šç‹¬å èµ„æºï¼Œç¦æ­¢å…¶ä»–æ“ä½œ

å…¼å®¹æ€§ï¼šæ’æ–¥æ‰€æœ‰å…¶ä»–é”

ä½¿ç”¨åœºæ™¯ï¼š
SELECT * FROM table WHERE ... FOR UPTATE;

å…¨å±€é” (Global Lock)å…¨å±€é”å°±æ˜¯å¯¹æ•´ä¸ªæ•°æ®åº“å®ä¾‹åŠ é”ï¼ŒåŠ é”åæ•´ä¸ªå®ä¾‹å°±å¤„äºåªè¯»çŠ¶æ€ï¼Œåç»­çš„DMLçš„å†™è¯­å¥ï¼ŒDDLè¯­å¥ï¼Œå·²ç»æ›´æ–°æ“ä½œçš„äº‹åŠ¡æäº¤è¯­å¥éƒ½å°†è¢«é˜»å¡ã€‚
å…¸å‹çš„ä½¿ç”¨åœºæ™¯æ˜¯åšå…¨åº“çš„é€»è¾‘å¤‡ä»½ã€‚

ä¸åŠ å…¨å±€é”ï¼šè¿›è¡Œæ•°æ®å¤‡ä»½æ—¶ï¼Œå¯¹æ•°æ®è¿›è¡ŒDMLè¯­å¥ï¼Œä¼šå¯¼è‡´å¤‡ä»½å‰åæ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚
åŠ äº†å…¨å±€é”ï¼šå¯¹æ•°æ®åº“è¿›è¡Œè¿›è¡Œé€»è¾‘å¤‡ä»½ä¹‹å‰ï¼Œå…ˆå¯¹æ•´ä¸ªæ•°æ®åº“åŠ ä¸Šå…¨å±€é”ï¼Œä¸€æ—¦åŠ äº†å…¨å±€é”ä¹‹åï¼Œå…¶ä»–çš„DDLã€ DMLå…¨éƒ¨éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä½†æ˜¯å¯ä»¥æ‰§è¡ŒDQLè¯­å¥ï¼Œä¹Ÿå°±æ˜¯å¤„äºåªè¯»çŠ¶æ€ï¼Œè€Œæ•°æ®å¤‡ä»½å°±æ˜¯æŸ¥è¯¢æ“ä½œã€‚ é‚£ä¹ˆæ•°æ®åœ¨è¿›è¡Œé€»è¾‘å¤‡ä»½çš„è¿‡ç¨‹ä¸­ï¼Œæ•°æ®åº“ä¸­çš„æ•°æ®å°±æ˜¯ä¸ä¼šå‘ç”Ÿå˜åŒ–çš„ï¼Œè¿™æ ·å°±ä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚

åŸºæœ¬è¯­æ³•åŠ å…¨å±€é”
flush tables with read lock;

æ•°æ®å¤‡ä»½
mysqldump -u username -p database_name &gt; backup.sql -- ï¼ˆå¤‡ä»½æŒ‡å®šæ•°æ®åº“åˆ° backup.sqlï¼Œæ‰§è¡Œåè¾“å…¥å¯†ç  ï¼‰

é‡Šæ”¾å…¨å±€é”
unlock tables;

ç‰¹ç‚¹æ•°æ®åº“ä¸­åŠ å…¨å±€é”ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡çš„æ“ä½œï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

å¦‚æœåœ¨ä¸»åº“ä¸Šå¤‡ä»½ï¼Œé‚£ä¹ˆåœ¨å¤‡ä»½æœŸé—´éƒ½ä¸èƒ½æ‰§è¡Œæ›´æ–°ï¼Œä¸šåŠ¡åŸºæœ¬ä¸Šå°±å¾—åœæ‘†ã€‚
å¦‚æœåœ¨ä»åº“ä¸Šå¤‡ä»½ï¼Œé‚£ä¹ˆåœ¨å¤‡ä»½æœŸé—´ä»åº“ä¸èƒ½æ‰§è¡Œä¸»åº“åŒæ­¥è¿‡æ¥çš„äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinlogï¼‰ï¼Œä¼šå¯¼è‡´ä¸»ä»å»¶è¿Ÿã€‚


åœ¨InnoDBå¼•æ“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤‡ä»½æ—¶åŠ ä¸Šå‚æ•° â€“single-transaction å‚æ•°æ¥å®Œæˆä¸åŠ é”çš„ä¸€è‡´ æ€§æ•°æ®å¤‡ä»½ã€‚
mysqldump â€“single-transaction -u username -p database_name &gt; backup.sql

è¡¨çº§é” (Table Lock)è¡¨çº§é”ï¼Œæ¯æ¬¡æ“ä½œé”ä½æ•´å¼ è¡¨ã€‚é”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚åº”ç”¨åœ¨MyISAMã€InnoDBã€BDBç­‰å­˜å‚¨å¼•æ“ä¸­ã€‚
ä½¿ç”¨è¡¨é”çš„å¼€é”€ç›¸å¯¹è¾ƒå°ï¼ŒåŠ é”å¿«ï¼Œä¸ä¼šäº§ç”Ÿæ­»é”ï¼›ä½†æ˜¯åŠ é”ç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æ›´é«˜ï¼Œå¹¶å‘åº¦æ›´ä½ã€‚åœ¨innoDBå­˜å‚¨å¼•æ“ä¸­ä¸æ¨èä½¿ç”¨è¡¨é”ï¼Œåªæœ‰åœ¨æ²¡æœ‰äº‹åŠ¡æ”¯æŒçš„å­˜å‚¨å¼•æ“ä¸­æ‰ä¼šä½¿ç”¨ï¼Œå¦‚MyISAM
å¯¹äºè¡¨çº§é”ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š

è¡¨é”
å…ƒæ•°æ®é”
æ„å‘é”

è¡¨é”å¯¹äºè¡¨é”ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š

è¡¨å…±äº«è¯»é”ï¼ˆread lockï¼‰
è¡¨ç‹¬å å†™é”ï¼ˆwrite lockï¼‰

åŸºæœ¬è¯­æ³•
åŠ é”
lock tables è¡¨å... read/writeã€‚

é‡Šæ”¾é”
unlock tables / å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ ã€‚

ç‰¹ç‚¹
è¯»é”ï¼š


å†™é”ï¼š



ç»“è®º: è¯»é”ä¸ä¼šé˜»å¡å…¶ä»–å®¢æˆ·ç«¯çš„è¯»ï¼Œä½†æ˜¯ä¼šé˜»å¡å†™ã€‚å†™é”æ—¢ä¼šé˜»å¡å…¶ä»–å®¢æˆ·ç«¯çš„è¯»ï¼Œåˆä¼šé˜»å¡å…¶ä»–å®¢æˆ·ç«¯çš„å†™ã€‚
å…ƒæ•°æ®é”ï¼ˆmeta data lock, MDLï¼‰MDLåŠ é”è¿‡ç¨‹æ˜¯ç³»ç»Ÿè‡ªåŠ¨æ§åˆ¶ï¼Œæ— éœ€æ˜¾å¼ä½¿ç”¨ï¼Œåœ¨è®¿é—®ä¸€å¼ è¡¨çš„æ—¶å€™ä¼šè‡ªåŠ¨åŠ ä¸Šã€‚MDLé”ä¸»è¦ä½œç”¨æ˜¯ç»´æŠ¤è¡¨å…ƒæ•°æ®çš„æ•°æ®ä¸€è‡´æ€§ï¼Œåœ¨è¡¨ä¸Šæœ‰æ´»åŠ¨äº‹åŠ¡çš„æ—¶å€™ï¼Œä¸å¯ä»¥å¯¹å…ƒæ•°æ®è¿›è¡Œå†™å…¥æ“ä½œã€‚ä¸ºäº†é¿å…DMLä¸ DDLå†²çªï¼Œä¿è¯è¯»å†™çš„æ­£ç¡®æ€§ã€‚
è¿™é‡Œçš„å…ƒæ•°æ®ï¼Œå¤§å®¶å¯ä»¥ç®€å•ç†è§£ä¸ºå°±æ˜¯ä¸€å¼ è¡¨çš„è¡¨ç»“æ„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼ŒæŸä¸€å¼ è¡¨æ¶‰åŠåˆ°æœªæäº¤çš„äº‹åŠ¡æ—¶ï¼Œæ˜¯ä¸èƒ½å¤Ÿä¿®æ”¹è¿™å¼ è¡¨çš„è¡¨ç»“æ„çš„ã€‚
åœ¨MySQL5.5ä¸­å¼•å…¥äº†MDLï¼Œå½“å¯¹ä¸€å¼ è¡¨è¿›è¡Œå¢åˆ æ”¹æŸ¥çš„æ—¶å€™ï¼ŒåŠ MDLè¯»é”(å…±äº«)ï¼›å½“å¯¹è¡¨ç»“æ„è¿›è¡Œå˜æ›´æ“ä½œçš„æ—¶å€™ï¼ŒåŠ MDLå†™é”(æ’ä»–)ã€‚
å¸¸è§çš„SQLæ“ä½œæ—¶ï¼Œæ‰€æ·»åŠ çš„å…ƒæ•°æ®é”ï¼š



å¯¹åº”SQL
é”ç±»å‹
è¯´æ˜



lock tables xxx read &#x2F; writeï¼ˆè¡¨é”ï¼‰
SHARED_READ_ONLY &#x2F; SHARED_NO_READ_WRITE



select ã€select â€¦ lock in share modeï¼ˆæ™®é€šè¯»ã€å…±äº«é”ï¼‰
SHARED_READï¼ˆå…ƒæ•°æ®å…±äº«é”ï¼‰
ä¸SHARED_READã€ SHARED_WRITEå…¼å®¹ï¼Œä¸ EXCLUSIVEäº’æ–¥


insert ã€updateã€ deleteã€select â€¦ for updateï¼ˆå¢ã€æ”¹ã€åˆ ã€æ’ä»–é”ï¼‰
SHARED_WRITEï¼ˆå…ƒæ•°æ®å…±äº«é”ï¼‰
ä¸SHARED_READã€ SHARED_WRITEå…¼å®¹ï¼Œä¸ EXCLUSIVEäº’æ–¥


alter table â€¦ï¼ˆä¿®æ”¹è¡¨ç»“æ„ï¼‰
EXCLUSIVEï¼ˆå…ƒæ•°æ®æ’ä»–é”ï¼‰
ä¸å…¶ä»–çš„MDLéƒ½äº’æ–¥


æ¡ˆä¾‹
å½“æ‰§è¡ŒSELECTã€INSERTã€UPDATEã€DELETEç­‰è¯­å¥æ—¶ï¼Œæ·»åŠ çš„æ˜¯å…ƒæ•°æ®å…±äº«é”ï¼ˆSHARED_READ &#x2F; SHARED_WRITEï¼‰ï¼Œä¹‹é—´æ˜¯å…¼å®¹çš„ã€‚

å½“æ‰§è¡ŒSELECTè¯­å¥æ—¶ï¼Œæ·»åŠ çš„æ˜¯å…ƒæ•°æ®å…±äº«é”ï¼ˆSHARED_READï¼‰ï¼Œä¼šé˜»å¡å…ƒæ•°æ®æ’ä»–é” ï¼ˆEXCLUSIVEï¼‰ï¼Œä¹‹é—´æ˜¯äº’æ–¥çš„ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„SQLï¼Œæ¥æŸ¥çœ‹æ•°æ®åº“ä¸­çš„å…ƒæ•°æ®é”çš„æƒ…å†µï¼š
select object_type,object_schema,object_name,lock_type,lock_duration from performance_schema.metadata_locks ;

æˆ‘ä»¬åœ¨æ“ä½œè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡ä¸Šè¿°çš„SQLè¯­å¥ï¼Œæ¥æŸ¥çœ‹å…ƒæ•°æ®é”çš„åŠ é”æƒ…å†µã€‚

æ„å‘é”ï¼ˆIntention Lockï¼‰ä¸ºäº†é¿å…DMLåœ¨æ‰§è¡Œæ—¶ï¼ŒåŠ çš„è¡Œé”ä¸è¡¨é”çš„å†²çªï¼Œåœ¨InnoDBä¸­å¼•å…¥äº†æ„å‘é”ï¼Œä½¿å¾—è¡¨é”ä¸ç”¨æ£€æŸ¥æ¯è¡Œæ•°æ®æ˜¯å¦åŠ é”ï¼Œä½¿ç”¨æ„å‘é”æ¥å‡å°‘è¡¨é”çš„æ£€æŸ¥ã€‚

.mopodhhyudfm{zoom: 75%;}
.ujwtckhqzlyo{zoom:102%;}

åˆ†ç±»

æ„å‘å…±äº«é”ï¼ˆISï¼‰ï¼šç”±è¯­å¥select â€¦ lock in share modeæ·»åŠ ï¼Œä¸è¡¨é”å…±äº«é”ï¼ˆreadï¼‰å…¼å®¹ï¼Œä¸è¡¨é”æ’ä»–é”ï¼ˆwriteï¼‰äº’æ–¥ã€‚åœ¨å‡†å¤‡ç»™è¡¨æ•°æ®æ·»åŠ ä¸€ä¸ªSé”æ—¶ï¼Œéœ€è¦å…ˆè·å¾—è¯¥è¡¨çš„ISé”
æ„å‘æ’ä»–é”ï¼ˆIXï¼‰ï¼šç”±insertã€updateã€deleteã€selectâ€¦for updateæ·»åŠ  ã€‚ä¸è¡¨é”å…±äº«é”(read)åŠæ’ä»–é”(write)éƒ½äº’æ–¥ï¼Œæ„å‘é”ä¹‹é—´ä¸ä¼šäº’æ–¥ã€‚åœ¨å‡†å¤‡ç»™è¡¨æ•°æ®æ·»åŠ ä¸€ä¸ªXé”æ—¶ï¼Œéœ€è¦å…ˆè·å¾—è¯¥è¡¨çš„IXé”


ä¸€æ—¦äº‹åŠ¡æäº¤äº†ï¼Œæ„å‘å…±äº«é”ã€æ„å‘æ’ä»–é”ï¼Œéƒ½ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚

å¯ä»¥é€šè¿‡ä»¥ä¸‹SQLï¼ŒæŸ¥çœ‹æ„å‘é”åŠè¡Œé”çš„åŠ é”æƒ…å†µï¼š
select object_schema,object_name,index_name,lock_type,lock_mode,lock_data from performance_schema.data_locks;

æ¡ˆä¾‹
A.æ„å‘å…±äº«é”ä¸è¡¨è¯»é”æ˜¯å…¼å®¹çš„

B.æ„å‘æ’ä»–é”ä¸è¡¨è¯»é”ã€å†™é”éƒ½æ˜¯äº’æ–¥çš„

å…¼å®¹çŸ©é˜µï¼š



è¯·æ±‚\æŒæœ‰
X
IX
S
IS



Xï¼ˆå…±äº«é”ï¼‰
âŒ
âŒ
âŒ
âŒ


IXï¼ˆæ„å‘æ’ä»–é”ï¼‰
âŒ
âœ…
âŒ
âœ…


Sï¼ˆæ’ä»–é”ï¼‰
âŒ
âŒ
âœ…
âœ…


ISï¼ˆæ„å‘å…±äº«é”ï¼‰
âŒ
âœ…
âœ…
âœ…


è¡Œçº§é” (Row Lock)è¡Œçº§é”ï¼Œæ¯æ¬¡æ“ä½œé”ä½å¯¹åº”çš„è¡Œæ•°æ®ã€‚é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦æœ€é«˜ã€‚åº”ç”¨åœ¨ InnoDBå­˜å‚¨å¼•æ“ä¸­ã€‚InnoDBçš„æ•°æ®æ˜¯åŸºäºç´¢å¼•ç»„ç»‡çš„ï¼Œè¡Œé”æ˜¯é€šè¿‡å¯¹ç´¢å¼•ä¸Šçš„ç´¢å¼•é¡¹åŠ é”æ¥å®ç°çš„ï¼Œè€Œä¸æ˜¯å¯¹è®°å½•åŠ çš„é”ã€‚å¯¹äºè¡Œçº§é”ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š

è¡Œé”ï¼ˆRecord Lockï¼‰

é—´éš™é”ï¼ˆGap Lockï¼‰

ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰


è¡Œé” &#x2F; è®°å½•é”ï¼ˆRecord Lockï¼‰é”å®šå•ä¸ªè¡Œè®°å½•çš„é”ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡å¯¹æ­¤è¡Œè¿›è¡Œupdateå’Œdeleteã€‚åœ¨RCã€RRéš”ç¦»çº§åˆ«ä¸‹éƒ½æ”¯æŒã€‚

InnoDBå®ç°äº†ä»¥ä¸‹ä¸¤ç§ç±»å‹çš„è¡Œé”ï¼š

å…±äº«é”ï¼ˆSï¼‰ï¼šå…è®¸ä¸€ä¸ªäº‹åŠ¡å»è¯»ä¸€è¡Œï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡è·å¾—ç›¸åŒæ•°æ®é›†çš„æ’å®ƒé”ã€‚
æ’ä»–é”ï¼ˆXï¼‰ï¼šå…è®¸è·å–æ’ä»–é”çš„äº‹åŠ¡æ›´æ–°æ•°æ®ï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡è·å¾—ç›¸åŒæ•°æ®é›†çš„å…±äº«é”å’Œæ’ä»–é”ã€‚

ä¸¤ç§è¡Œé”çš„å…¼å®¹æƒ…å†µå¦‚ä¸‹:

å¸¸è§çš„SQLè¯­å¥ï¼Œåœ¨æ‰§è¡Œæ—¶ï¼Œæ‰€åŠ çš„è¡Œé”å¦‚ä¸‹ï¼š

æ¡ˆä¾‹
é»˜è®¤æƒ…å†µä¸‹ï¼ŒInnoDBåœ¨ REPEATABLE READäº‹åŠ¡éš”ç¦»çº§åˆ«è¿è¡Œï¼ŒInnoDBä½¿ç”¨ next-key é”è¿›è¡Œæœç´¢å’Œç´¢å¼•æ‰«æï¼Œä»¥é˜²æ­¢å¹»è¯»ã€‚

é’ˆå¯¹å”¯ä¸€ç´¢å¼•è¿›è¡Œæ£€ç´¢æ—¶ï¼Œå¯¹å·²å­˜åœ¨çš„è®°å½•è¿›è¡Œç­‰å€¼åŒ¹é…æ—¶ï¼Œå°†ä¼šè‡ªåŠ¨ä¼˜åŒ–ä¸ºè¡Œé”ã€‚
InnoDBçš„è¡Œé”æ˜¯é’ˆå¯¹äºç´¢å¼•åŠ çš„é”ï¼Œä¸é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢æ•°æ®ï¼Œé‚£ä¹ˆInnoDBå°†å¯¹è¡¨ä¸­çš„æ‰€æœ‰è®°å½•åŠ é”ï¼Œæ­¤æ—¶å°±ä¼šå‡çº§ä¸ºè¡¨é”ã€‚

å¯ä»¥é€šè¿‡ä»¥ä¸‹SQLï¼ŒæŸ¥çœ‹æ„å‘é”åŠè¡Œé”çš„åŠ é”æƒ…å†µï¼š
select object_schema,object_name,index_name,lock_type,lock_mode,lock_data from performance_schema.data_locks;

é—´éš™é”ï¼ˆGap Lockï¼‰é”å®šç´¢å¼•è®°å½•é—´éš™ï¼ˆä¸å«è¯¥è®°å½•ï¼‰ï¼Œå·¦å³å¼€åŒºé—´ï¼Œç¡®ä¿ç´¢å¼•è®°å½•é—´éš™ä¸å˜ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¿™ä¸ªé—´éš™è¿›è¡Œinsertï¼Œäº§ç”Ÿå¹»è¯»ã€‚åœ¨RRéš”ç¦»çº§åˆ«ä¸‹éƒ½æ”¯æŒã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒInnoDBåœ¨ REPEATABLE READäº‹åŠ¡éš”ç¦»çº§åˆ«è¿è¡Œï¼ŒInnoDBä½¿ç”¨ next-key é”è¿›è¡Œæœç´¢å’Œç´¢å¼•æ‰«æï¼Œä»¥é˜²æ­¢å¹»è¯»ã€‚
åŠ é—´éš™é”çš„è§„åˆ™

ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢(å”¯ä¸€ç´¢å¼•)ï¼Œç»™ä¸å­˜åœ¨çš„è®°å½•åŠ é”æ—¶, ä¼˜åŒ–ä¸ºé—´éš™é” ã€‚
ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢(éå”¯ä¸€æ™®é€šç´¢å¼•)ï¼Œå‘å³éå†æ—¶æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³æŸ¥è¯¢éœ€æ±‚æ—¶ï¼Œnext-key lock é€€åŒ–ä¸ºé—´éš™é”ã€‚
ç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢(å”¯ä¸€ç´¢å¼•)â€“ä¼šè®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢ã€‚


æ³¨æ„ï¼šé—´éš™é”å”¯ä¸€ç›®çš„æ˜¯é˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥é—´éš™ã€‚é—´éš™é”å¯ä»¥å…±å­˜ï¼Œä¸€ä¸ªäº‹åŠ¡é‡‡ç”¨çš„é—´éš™é”ä¸ä¼šé˜»æ­¢å¦ä¸€ä¸ªäº‹åŠ¡åœ¨åŒä¸€é—´éš™ä¸Šé‡‡ç”¨é—´éš™é”ã€‚

ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰è¡Œé”å’Œé—´éš™é”ç»„åˆï¼ŒåŒæ—¶é”ä½æ•°æ®ï¼Œå¹¶é”ä½æ•°æ®å‰é¢çš„é—´éš™Gapï¼Œå·¦å¼€å³é—­ã€‚ åœ¨RRéš”ç¦»çº§åˆ«ä¸‹æ”¯æŒã€‚
 
æ¡ˆä¾‹
A. ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢(å”¯ä¸€ç´¢å¼•)ï¼Œç»™ä¸å­˜åœ¨çš„è®°å½•åŠ é”æ—¶, ä¼˜åŒ–ä¸ºé—´éš™é” 

B. ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢(éå”¯ä¸€æ™®é€šç´¢å¼•)ï¼Œå‘å³éå†æ—¶æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³æŸ¥è¯¢éœ€æ±‚æ—¶ï¼Œnext-key lock é€€åŒ–ä¸ºé—´éš™é”ã€‚ 
åˆ†æï¼š InnoDBçš„B+æ ‘ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹æ˜¯æœ‰åºçš„åŒå‘é“¾è¡¨ã€‚ å‡å¦‚ï¼Œæˆ‘ä»¬è¦æ ¹æ®è¿™ä¸ªäºŒçº§ç´¢å¼•æŸ¥è¯¢å€¼ä¸º18çš„æ•°æ®ï¼Œå¹¶åŠ ä¸Šå…±äº«é”ï¼Œæˆ‘ä»¬æ˜¯åªé”å®š18è¿™ä¸€è¡Œå°±å¯ä»¥äº†å—ï¼Ÿ å¹¶ä¸æ˜¯ï¼Œå› ä¸ºæ˜¯éå”¯ä¸€ç´¢å¼•ï¼Œè¿™ä¸ªç»“æ„ä¸­å¯èƒ½æœ‰å¤šä¸ª18çš„å­˜åœ¨ï¼Œæ‰€ä»¥ï¼Œåœ¨åŠ é”æ—¶ä¼šç»§ç»­å¾€åæ‰¾ï¼Œæ‰¾åˆ°ä¸€ä¸ªä¸æ»¡è¶³æ¡ä»¶çš„å€¼ï¼ˆå½“å‰æ¡ˆä¾‹ä¸­ä¹Ÿ å°±æ˜¯29ï¼‰ã€‚æ­¤æ—¶ä¼šå¯¹18åŠ ä¸´é”®é”ï¼Œå¹¶å¯¹29ä¹‹å‰çš„é—´éš™åŠ é”ã€‚

C. ç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢(å”¯ä¸€ç´¢å¼•)â€“ä¼šè®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢ã€‚

æŸ¥è¯¢çš„æ¡ä»¶ä¸ºid&gt;&#x3D;19ï¼Œå¹¶æ·»åŠ å…±äº«é”ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥æ ¹æ®æ•°æ®åº“è¡¨ä¸­ç°æœ‰çš„æ•°æ®ï¼Œå°†æ•°æ®åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š [19] (19,25] (25,+âˆ] æ‰€ä»¥æ•°æ®åº“æ•°æ®åœ¨åŠ é”æ˜¯ï¼Œå°±æ˜¯å°†19åŠ äº†è¡Œé”ï¼Œ25çš„ä¸´é”®é”ï¼ˆåŒ…å«25åŠ25ä¹‹å‰çš„é—´éš™ï¼‰ï¼Œæ­£æ— ç©·çš„ä¸´é”®é”(æ­£æ— ç©·åŠä¹‹å‰çš„é—´éš™)ã€‚
ä¹è§‚é”&#x2F;æ‚²è§‚é”æ‚²è§‚é”ï¼ˆPessimistic Lockingï¼‰
å‡è®¾å†²çªå¿…ç„¶å‘ç”Ÿï¼Œå› æ­¤åœ¨è®¿é—®æ•°æ®å‰å…ˆåŠ é”ï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡åŒæ—¶ä¿®æ”¹ã€‚
é€‚ç”¨åœºæ™¯ï¼šå†™æ“ä½œé¢‘ç¹ã€å¹¶å‘å†²çªæ¦‚ç‡é«˜çš„åœºæ™¯ï¼ˆå¦‚åº“å­˜æ‰£å‡ã€é‡‘èè½¬è´¦ï¼‰ã€‚

å®ç°æ–¹å¼ï¼š
-- è¡Œçº§é”-- å…±äº«é”ï¼ˆSé”ï¼‰ï¼šå…è®¸å¤šäº‹åŠ¡åŒæ—¶è¯»SELECT * FROM products WHERE id = 1 LOCK IN SHARE MODE;-- æ’ä»–é”ï¼ˆXé”ï¼‰ï¼šé˜»æ­¢å…¶ä»–äº‹åŠ¡è¯»å†™SELECT * FROM products WHERE id = 1 FOR UPDATE;-- è¡¨çº§é”LOCK TABLES products WRITE;  -- å†™é”ï¼ˆæ’ä»–ï¼‰UNLOCK TABLES;


ä¼˜ç‚¹ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œé¿å…è„å†™ã€‚
ç¼ºç‚¹ï¼š
å¢åŠ é”ç­‰å¾…æ—¶é—´ï¼Œé™ä½å¹¶å‘æ€§èƒ½ã€‚
å¯èƒ½å¯¼è‡´æ­»é”ï¼ˆå¦‚äº‹åŠ¡å¾ªç¯ç­‰å¾…é”ï¼‰ã€‚



ä¹è§‚é”ï¼ˆOptimistic Lockingï¼‰
å‡è®¾å†²çªå¾ˆå°‘å‘ç”Ÿï¼Œä¸æå‰åŠ é”ï¼Œè€Œæ˜¯åœ¨æäº¤æ—¶æ£€æŸ¥æ•°æ®æ˜¯å¦è¢«ä¿®æ”¹ã€‚
é€‚ç”¨åœºæ™¯ï¼šè¯»æ“ä½œé¢‘ç¹ã€å†²çªæ¦‚ç‡ä½çš„åœºæ™¯ï¼ˆå¦‚å•†å“æµè§ˆé‡ç»Ÿè®¡ï¼‰ã€‚

å®ç°æ–¹å¼ï¼š

ç‰ˆæœ¬å·ï¼ˆVersionï¼‰ï¼š
-- è¡¨ç»“æ„å¢åŠ  version å­—æ®µCREATE TABLE products (  id INT PRIMARY KEY,  stock INT,  version INT DEFAULT 0);-- äº‹åŠ¡1ï¼šè¯»å–æ•°æ®SELECT stock, version FROM products WHERE id = 1;-- äº‹åŠ¡1ï¼šæ›´æ–°æ—¶æ ¡éªŒ versionUPDATE products SET stock = stock - 1, version = version + 1 WHERE id = 1 AND version = ä¸Šæ¬¡è¯»å–çš„version;

æ—¶é—´æˆ³ï¼ˆTimestampï¼‰ï¼šç±»ä¼¼ç‰ˆæœ¬å·ï¼Œä½¿ç”¨æ—¶é—´æˆ³å­—æ®µè®°å½•æ•°æ®ä¿®æ”¹æ—¶é—´ã€‚

ä¼˜ç‚¹ï¼š

æ— éœ€åŠ é”ï¼Œæå‡å¹¶å‘æ€§èƒ½ã€‚
é¿å…æ­»é”ã€‚


ç¼ºç‚¹ï¼š

éœ€è¦åº”ç”¨å±‚å¤„ç†å†²çªï¼ˆå¦‚é‡è¯•æœºåˆ¶ï¼‰ã€‚
ä¸é€‚åˆé«˜å†²çªåœºæ™¯ï¼ˆé‡è¯•é¢‘ç¹ä¼šé™ä½æ•ˆç‡ï¼‰ã€‚



InnoDBå¼•æ“InnoDBçš„é€»è¾‘å­˜å‚¨ç»“æ„

è¡¨ç©ºé—´
è¡¨ç©ºé—´æ˜¯InnoDBå­˜å‚¨å¼•æ“é€»è¾‘ç»“æ„çš„æœ€é«˜å±‚ï¼Œ å¦‚æœç”¨æˆ·å¯ç”¨äº†å‚æ•° innodb_file_per_table(åœ¨ 8.0ç‰ˆæœ¬ä¸­é»˜è®¤å¼€å¯) ï¼Œåˆ™æ¯å¼ è¡¨éƒ½ä¼šæœ‰ä¸€ä¸ªè¡¨ç©ºé—´ï¼ˆxxx.ibdï¼‰ï¼Œä¸€ä¸ªmysqlå®ä¾‹å¯ä»¥å¯¹åº”å¤šä¸ªè¡¨ç©ºé—´ï¼Œç”¨äºå­˜å‚¨è®°å½•ã€ç´¢å¼•ç­‰æ•°æ®ã€‚

æ®µ
æ®µï¼Œåˆ†ä¸ºæ•°æ®æ®µï¼ˆLeaf node segmentï¼‰ã€ç´¢å¼•æ®µï¼ˆNon-leaf node segmentï¼‰ã€å›æ»šæ®µ ï¼ˆRollback segmentï¼‰ï¼ŒInnoDBæ˜¯ç´¢å¼•ç»„ç»‡è¡¨ï¼Œæ•°æ®æ®µå°±æ˜¯B+æ ‘çš„å¶å­èŠ‚ç‚¹ï¼Œ ç´¢å¼•æ®µå³ä¸ºB+æ ‘çš„ éå¶å­èŠ‚ç‚¹ã€‚æ®µç”¨æ¥ç®¡ç†å¤šä¸ªExtentï¼ˆåŒºï¼‰ã€‚

åŒº
åŒºï¼Œè¡¨ç©ºé—´çš„å•å…ƒç»“æ„ï¼Œæ¯ä¸ªåŒºçš„å¤§å°ä¸º1Mã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒInnoDBå­˜å‚¨å¼•æ“é¡µå¤§å°ä¸º16Kï¼Œ å³ä¸€ ä¸ªåŒºä¸­ä¸€å…±æœ‰64ä¸ªè¿ç»­çš„é¡µã€‚

é¡µ
é¡µï¼Œæ˜¯InnoDB å­˜å‚¨å¼•æ“ç£ç›˜ç®¡ç†çš„æœ€å°å•å…ƒï¼Œæ¯ä¸ªé¡µçš„å¤§å°é»˜è®¤ä¸º 16KBã€‚ä¸ºäº†ä¿è¯é¡µçš„è¿ç»­æ€§ï¼ŒInnoDB å­˜å‚¨å¼•æ“æ¯æ¬¡ä»ç£ç›˜ç”³è¯· 4-5 ä¸ªåŒºã€‚

è¡Œ
è¡Œï¼ŒInnoDB å­˜å‚¨å¼•æ“æ•°æ®æ˜¯æŒ‰è¡Œè¿›è¡Œå­˜æ”¾çš„ã€‚ 
åœ¨è¡Œä¸­ï¼Œé»˜è®¤æœ‰ä¸¤ä¸ªéšè—å­—æ®µï¼š

Trx_idï¼šæ¯æ¬¡å¯¹æŸæ¡è®°å½•è¿›è¡Œæ”¹åŠ¨æ—¶ï¼Œéƒ½ä¼šæŠŠå¯¹åº”çš„äº‹åŠ¡idèµ‹å€¼ç»™trx_idéšè—åˆ—ã€‚
Roll_pointerï¼šæ¯æ¬¡å¯¹æŸæ¡å¼•è®°å½•è¿›è¡Œæ”¹åŠ¨æ—¶ï¼Œéƒ½ä¼šæŠŠæ—§çš„ç‰ˆæœ¬å†™å…¥åˆ°undoæ—¥å¿—ä¸­ï¼Œç„¶åè¿™ä¸ªéšè—åˆ—å°±ç›¸å½“äºä¸€ä¸ªæŒ‡é’ˆï¼Œå¯ä»¥é€šè¿‡å®ƒæ¥æ‰¾åˆ°è¯¥è®°å½•ä¿®æ”¹å‰çš„ä¿¡æ¯ã€‚



æ¶æ„MySQL5.5 ç‰ˆæœ¬å¼€å§‹ï¼Œé»˜è®¤ä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“ï¼Œå®ƒæ“…é•¿äº‹åŠ¡å¤„ç†ï¼Œå…·æœ‰å´©æºƒæ¢å¤ç‰¹æ€§ï¼Œåœ¨æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨éå¸¸å¹¿æ³›ã€‚ä¸‹é¢æ˜¯InnoDBæ¶æ„å›¾ï¼Œå·¦ä¾§ä¸ºå†…å­˜ç»“æ„ï¼Œå³ä¾§ä¸ºç£ç›˜ç»“æ„ã€‚

å†…å­˜ç»“æ„åœ¨å·¦ä¾§çš„å†…å­˜ç»“æ„ä¸­ï¼Œä¸»è¦åˆ†ä¸ºè¿™ä¹ˆå››å¤§å—å„¿ï¼š Buffer Poolã€Change Bufferã€Adaptive Hash Indexã€Log Bufferã€‚ æ¥ä¸‹æ¥ä»‹ç»ä¸€ä¸‹è¿™å››ä¸ªéƒ¨åˆ†ã€‚

Buffer Pool
InnoDBå­˜å‚¨å¼•æ“åŸºäºç£ç›˜æ–‡ä»¶å­˜å‚¨ï¼Œè®¿é—®ç‰©ç†ç¡¬ç›˜å’Œåœ¨å†…å­˜ä¸­è¿›è¡Œè®¿é—®ï¼Œé€Ÿåº¦ç›¸å·®å¾ˆå¤§ï¼Œä¸ºäº†å°½å¯èƒ½å¼¥è¡¥è¿™ä¸¤è€…ä¹‹é—´çš„I&#x2F;Oæ•ˆç‡çš„å·®å€¼ï¼Œå°±éœ€è¦æŠŠç»å¸¸ä½¿ç”¨çš„æ•°æ®åŠ è½½åˆ°ç¼“å†²æ± ä¸­ï¼Œé¿å…æ¯æ¬¡è®¿é—®éƒ½è¿›è¡Œç£ç›˜I&#x2F;Oã€‚
åœ¨InnoDBçš„ç¼“å†²æ± ä¸­ä¸ä»…ç¼“å­˜äº†ç´¢å¼•é¡µå’Œæ•°æ®é¡µï¼Œè¿˜åŒ…å«äº†undoé¡µã€æ’å…¥ç¼“å­˜ã€è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ä»¥åŠ InnoDBçš„é”ä¿¡æ¯ç­‰ç­‰ã€‚
ç¼“å†²æ±  Buffer Poolï¼Œæ˜¯ä¸»å†…å­˜ä¸­çš„ä¸€ä¸ªåŒºåŸŸï¼Œé‡Œé¢å¯ä»¥ç¼“å­˜ç£ç›˜ä¸Šç»å¸¸æ“ä½œçš„çœŸå®æ•°æ®ï¼Œåœ¨æ‰§è¡Œå¢ã€åˆ ã€æ”¹ã€æŸ¥æ“ä½œæ—¶ï¼Œå…ˆæ“ä½œç¼“å†²æ± ä¸­çš„æ•°æ®ï¼ˆè‹¥ç¼“å†²æ± æ²¡æœ‰æ•°æ®ï¼Œåˆ™ä»ç£ç›˜åŠ è½½å¹¶ç¼“å­˜ï¼‰ï¼Œç„¶åå†ä»¥ä¸€å®šé¢‘ç‡åˆ·æ–°åˆ°ç£ç›˜ï¼Œä»è€Œå‡å°‘ç£ç›˜IOï¼ŒåŠ å¿«å¤„ç†é€Ÿåº¦ã€‚
ç¼“å†²æ± ä»¥Pageé¡µä¸ºå•ä½ï¼Œåº•å±‚é‡‡ç”¨é“¾è¡¨æ•°æ®ç»“æ„ç®¡ç†Pageã€‚æ ¹æ®çŠ¶æ€ï¼Œå°†Pageåˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š

free pageï¼šç©ºé—²pageï¼Œæœªè¢«ä½¿ç”¨
clean pageï¼šè¢«ä½¿ç”¨pageï¼Œæ•°æ®æ²¡æœ‰è¢«ä¿®æ”¹è¿‡
dirty pageï¼šè„é¡µï¼Œè¢«ä½¿ç”¨pageï¼Œæ•°æ®è¢«ä¿®æ”¹è¿‡ï¼Œé¡µä¸­æ•°æ®ä¸ç£ç›˜çš„æ•°æ®äº§ç”Ÿäº†ä¸ä¸€è‡´


åœ¨ä¸“ç”¨æœåŠ¡å™¨ä¸Šï¼Œé€šå¸¸å°†å¤šè¾¾80ï¼…çš„ç‰©ç†å†…å­˜åˆ†é…ç»™ç¼“å†²æ±  ã€‚å‚æ•°è®¾ç½®ï¼š show variables like â€˜innodb_buffer_pool_sizeâ€™;


Change Buffer
Change Bufferï¼Œæ›´æ”¹ç¼“å†²åŒºï¼ˆé’ˆå¯¹äºéå”¯ä¸€äºŒçº§ç´¢å¼•é¡µï¼‰ï¼Œåœ¨æ‰§è¡ŒDMLè¯­å¥æ—¶ï¼Œå¦‚æœè¿™äº›æ•°æ®Page æ²¡æœ‰åœ¨Buffer Poolä¸­ï¼Œæ˜¯ä¸ä¼šç›´æ¥æ“ä½œç£ç›˜ï¼Œè€Œæ˜¯ä¼šå°†æ•°æ®å˜æ›´å­˜åœ¨æ›´æ”¹ç¼“å†²åŒº Change Buffer ä¸­ï¼Œåœ¨ä»¥åæ•°æ®è¢«è¯»å–æ—¶ï¼Œå†å°†æ•°æ®åˆå¹¶æ¢å¤åˆ°Buffer Poolä¸­ï¼Œå†å°†åˆå¹¶åçš„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ä¸­ã€‚
æ„ä¹‰ï¼šä¸èšé›†ç´¢å¼•ä¸åŒï¼ŒäºŒçº§ç´¢å¼•é€šå¸¸æ˜¯éå”¯ä¸€çš„ï¼Œå¹¶ä¸”ä»¥ç›¸å¯¹éšæœºçš„é¡ºåºæ’å…¥äºŒçº§ç´¢å¼•ã€‚åŒæ ·ï¼Œåˆ é™¤å’Œæ›´æ–°å¯èƒ½ä¼šå½±å“ç´¢å¼•æ ‘ä¸­ä¸ç›¸é‚»çš„äºŒçº§ç´¢å¼•é¡µï¼Œå¦‚æœæ¯ä¸€æ¬¡éƒ½æ“ä½œç£ç›˜ï¼Œä¼šé€ æˆå¤§é‡çš„ç£ç›˜IOã€‚æœ‰äº† ChangeBuffer ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¼“å†²æ± ä¸­è¿›è¡Œåˆå¹¶å¤„ç†ï¼Œå‡å°‘ç£ç›˜IOã€‚

Adaptive Hash Index


   è‡ªé€‚åº”hashç´¢å¼•ï¼Œç”¨äºä¼˜åŒ–å¯¹Buffer Poolæ•°æ®çš„æŸ¥è¯¢ã€‚MySQLçš„innoDBå¼•æ“ä¸­è™½ç„¶æ²¡æœ‰ç›´æ¥æ”¯æŒ hashç´¢å¼•ï¼Œä½†æ˜¯ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯è¿™ä¸ªè‡ªé€‚åº”hashç´¢å¼•ã€‚hashç´¢å¼•åœ¨ è¿›è¡Œç­‰å€¼åŒ¹é…æ—¶ï¼Œä¸€èˆ¬æ€§èƒ½æ˜¯è¦é«˜äºB+æ ‘çš„ï¼Œå› ä¸ºhashç´¢å¼•ä¸€èˆ¬åªéœ€è¦ä¸€æ¬¡IOå³å¯ï¼Œè€ŒB+æ ‘ï¼Œå¯èƒ½éœ€è¦å‡ æ¬¡åŒ¹é…ï¼Œæ‰€ä»¥hashç´¢å¼•çš„æ•ˆç‡è¦é«˜ï¼Œä½†æ˜¯hashç´¢å¼•åˆä¸é€‚åˆåšèŒƒå›´æŸ¥è¯¢ã€æ¨¡ç³ŠåŒ¹é…ç­‰ã€‚
   InnoDBå­˜å‚¨å¼•æ“ä¼šç›‘æ§å¯¹è¡¨ä¸Šå„ç´¢å¼•é¡µçš„æŸ¥è¯¢ï¼Œå¦‚æœè§‚å¯Ÿåˆ°åœ¨ç‰¹å®šçš„æ¡ä»¶ä¸‹hashç´¢å¼•å¯ä»¥æå‡é€Ÿåº¦ï¼Œ åˆ™å»ºç«‹hashç´¢å¼•ï¼Œç§°ä¹‹ä¸ºè‡ªé€‚åº”hashç´¢å¼•ã€‚è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ï¼Œæ— éœ€äººå·¥å¹²é¢„ï¼Œæ˜¯ç³»ç»Ÿæ ¹æ®æƒ…å†µè‡ªåŠ¨å®Œæˆã€‚
   å‚æ•°ï¼š adaptive_hash_index


Log Buffer
æ—¥å¿—ç¼“å†²åŒºï¼Œç”¨æ¥ä¿å­˜è¦å†™å…¥åˆ°ç£ç›˜ä¸­çš„logæ—¥å¿—æ•°æ®ï¼ˆredo log ã€undo logï¼‰ï¼Œ é»˜è®¤å¤§å°ä¸º 16MBï¼Œæ—¥å¿—ç¼“å†²åŒºçš„æ—¥å¿—ä¼šå®šæœŸåˆ·æ–°åˆ°ç£ç›˜ä¸­ã€‚å¦‚æœéœ€è¦æ›´æ–°ã€æ’å…¥æˆ–åˆ é™¤è®¸å¤šè¡Œçš„äº‹åŠ¡ï¼Œå¢åŠ æ—¥å¿—ç¼“å†²åŒºçš„å¤§å°å¯ä»¥èŠ‚çœç£ç›˜ I&#x2F;Oã€‚
å‚æ•°

innodb_log_buffer_sizeï¼šç¼“å†²åŒºå¤§å°
innodb_flush_log_at_trx_commitï¼šæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜æ—¶æœºï¼Œå–å€¼ä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªï¼š
1ï¼šæ—¥å¿—åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤æ—¶å†™å…¥å¹¶åˆ·æ–°åˆ°ç£ç›˜ï¼Œé»˜è®¤å€¼
0: æ¯ç§’å°†æ—¥å¿—å†™å…¥å¹¶åˆ·æ–°åˆ°ç£ç›˜ä¸€æ¬¡
2: æ—¥å¿—åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤åå†™å…¥ï¼Œå¹¶æ¯ç§’åˆ·æ–°åˆ°ç£ç›˜ä¸€æ¬¡





ç£ç›˜ç»“æ„

System Tablespace
ç³»ç»Ÿè¡¨ç©ºé—´æ˜¯æ›´æ”¹ç¼“å†²åŒºçš„å­˜å‚¨åŒºåŸŸã€‚å¦‚æœè¡¨æ˜¯åœ¨ç³»ç»Ÿè¡¨ç©ºé—´è€Œä¸æ˜¯æ¯ä¸ªè¡¨æ–‡ä»¶æˆ–é€šç”¨è¡¨ç©ºé—´ä¸­åˆ›å»ºçš„ï¼Œå®ƒä¹Ÿå¯èƒ½åŒ…å«è¡¨å’Œç´¢å¼•æ•°æ®ã€‚(åœ¨MySQL5.xç‰ˆæœ¬ä¸­è¿˜åŒ…å«InnoDBæ•°æ®å­—å…¸ã€undologç­‰)ã€‚å‚æ•°ï¼šinnodb_data_file_pathã€‚ç³»ç»Ÿè¡¨ç©ºé—´ï¼Œé»˜è®¤çš„æ–‡ä»¶åå« ibdata1ã€‚

File-Per-Table Tablespaces
å¦‚æœå¼€å¯äº†innodb_file_per_tableå¼€å…³ ï¼Œåˆ™æ¯ä¸ªè¡¨çš„æ–‡ä»¶è¡¨ç©ºé—´åŒ…å«å•ä¸ªInnoDBè¡¨çš„æ•°æ®å’Œç´¢ å¼• ï¼Œå¹¶å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šçš„å•ä¸ªæ•°æ®æ–‡ä»¶ä¸­ã€‚ å¼€å…³å‚æ•°ï¼šinnodb_file_per_table ï¼Œè¯¥å‚æ•°é»˜è®¤å¼€å¯ã€‚æˆ‘ä»¬æ¯åˆ›å»ºä¸€ä¸ªè¡¨ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªè¡¨ç©ºé—´æ–‡ä»¶ï¼ˆ.ibdï¼‰ã€‚

General Tablespaces


   é€šç”¨è¡¨ç©ºé—´ï¼Œéœ€è¦é€šè¿‡ CREATE TABLESPACE è¯­æ³•åˆ›å»ºé€šç”¨è¡¨ç©ºé—´ï¼Œåœ¨åˆ›å»ºè¡¨æ—¶ï¼Œå¯ä»¥æŒ‡å®šè¯¥è¡¨ç©ºé—´ã€‚

åˆ›å»ºè¡¨ç©ºé—´
CREATE TABLESPACE ts_name ADD DATAFILE &#x27;file_name&#x27; ENGINE = engine_name;

åˆ›å»ºè¡¨æ—¶æŒ‡å®šè¡¨ç©ºé—´
CREATE TABLE xxx ... TABLESPACE ts_name;


Undo Tablespaces
æ’¤é”€è¡¨ç©ºé—´ï¼ŒMySQLå®ä¾‹åœ¨åˆå§‹åŒ–æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºä¸¤ä¸ªé»˜è®¤çš„undoè¡¨ç©ºé—´ï¼ˆåˆå§‹å¤§å°16Mï¼‰ï¼Œç”¨äºå­˜å‚¨ undo logæ—¥å¿—ã€‚

Temporary Tablespaces
InnoDB ä½¿ç”¨ä¼šè¯ä¸´æ—¶è¡¨ç©ºé—´å’Œå…¨å±€ä¸´æ—¶è¡¨ç©ºé—´ã€‚å­˜å‚¨ç”¨æˆ·åˆ›å»ºçš„ä¸´æ—¶è¡¨ç­‰æ•°æ®ã€‚

Doublewrite Buffer Files
åŒå†™ç¼“å†²åŒºï¼ŒinnoDBå¼•æ“å°†æ•°æ®é¡µä»Buffer Poolåˆ·æ–°åˆ°ç£ç›˜å‰ï¼Œå…ˆå°†æ•°æ®é¡µå†™å…¥åŒå†™ç¼“å†²åŒºæ–‡ä»¶ ä¸­ï¼Œä¾¿äºç³»ç»Ÿå¼‚å¸¸æ—¶æ¢å¤æ•°æ®ã€‚


Redo Log
é‡åšæ—¥å¿—ï¼Œæ˜¯ç”¨æ¥å®ç°äº‹åŠ¡çš„æŒä¹…æ€§ã€‚è¯¥æ—¥å¿—æ–‡ä»¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šé‡åšæ—¥å¿—ç¼“å†²ï¼ˆredo log bufferï¼‰ä»¥åŠé‡åšæ—¥å¿—æ–‡ä»¶ï¼ˆredo logï¼‰,å‰è€…æ˜¯åœ¨å†…å­˜ä¸­ï¼Œåè€…åœ¨ç£ç›˜ä¸­ã€‚å½“äº‹åŠ¡æäº¤ä¹‹åä¼šæŠŠæ‰€æœ‰ä¿®æ”¹ä¿¡æ¯éƒ½ä¼šå­˜åˆ°è¯¥æ—¥å¿—ä¸­, ç”¨äºåœ¨åˆ·æ–°è„é¡µåˆ°ç£ç›˜æ—¶,å‘ç”Ÿé”™è¯¯æ—¶, è¿›è¡Œæ•°æ®æ¢å¤ä½¿ç”¨ã€‚ä»¥å¾ªç¯æ–¹å¼å†™å…¥é‡åšæ—¥å¿—æ–‡ä»¶ï¼Œæ¶‰åŠä¸¤ä¸ªæ–‡ä»¶ï¼š



åå°çº¿ç¨‹åœ¨Innodbå­˜å‚¨å¼•æ“ä¸­ï¼Œåå°çº¿ç¨‹çš„ä¸»è¦ä½œç”¨æ˜¯è´Ÿè´£åˆ·æ–°å†…å­˜æ± ä¸­çš„æ•°æ®ï¼Œä¿è¯ç¼“å†²æ± ä¸­çš„å†…å­˜ç¼“å­˜çš„æ˜¯æœ€è¿‘çš„æ•°æ®ã€‚æ­¤å¤–å®ƒä¼šå°†å·²ç»ä¿®æ”¹çš„æ•°æ®æ–‡ä»¶åˆ·æ–°åˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼Œä¿è¯åœ¨ä¸å‘ç”Ÿå¼‚å¸¸çš„æƒ…å†µä¸‹ï¼ŒInnodbèƒ½å¤Ÿæ¢å¤åˆ°æ­£å¸¸çš„è¿è¡ŒçŠ¶æ€ã€‚
.mmvmuykeitnf{zoom:80%;}

Master Threadæ ¸å¿ƒåå°çº¿ç¨‹ï¼Œè´Ÿè´£è°ƒåº¦å…¶ä»–çº¿ç¨‹ï¼Œè¿˜è´Ÿè´£å°†ç¼“å†²æ± ä¸­çš„æ•°æ®å¼‚æ­¥åˆ·æ–°åˆ°ç£ç›˜ä¸­, ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ï¼Œ è¿˜åŒ…æ‹¬è„é¡µçš„åˆ·æ–°ã€åˆå¹¶æ’å…¥ç¼“å­˜ã€undoé¡µçš„å›æ”¶ ã€‚
IO Threadåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­å¤§é‡ä½¿ç”¨äº†AIOæ¥å¤„ç†IOè¯·æ±‚, è¿™æ ·å¯ä»¥æå¤§åœ°æé«˜æ•°æ®åº“çš„æ€§èƒ½ï¼Œè€ŒIO Threadä¸»è¦è´Ÿè´£è¿™äº›IOè¯·æ±‚çš„å›è°ƒã€‚



çº¿ç¨‹ç±»å‹
é»˜è®¤ä¸ªæ•°
èŒè´£



Read thread
4
è´Ÿè´£è¯»æ“ä½œ


Write thread
4
è´Ÿè´£å†™æ“ä½œ


Log thread
1
è´Ÿè´£å°†æ—¥å¿—ç¼“å†²åŒºåˆ·æ–°åˆ°ç£ç›˜


Insert buffer thread
1
è´Ÿè´£å°†å†™ç¼“å†²åŒºå†…å®¹åˆ·æ–°åˆ°ç£ç›˜


æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹çš„è¿™æ¡æŒ‡ä»¤ï¼ŒæŸ¥çœ‹åˆ°InnoDBçš„çŠ¶æ€ä¿¡æ¯ï¼Œå…¶ä¸­å°±åŒ…å«IO Threadä¿¡æ¯ã€‚
show engine innodb status \G;


Purge Threadä¸»è¦ç”¨äºå›æ”¶äº‹åŠ¡å·²ç»æäº¤äº†çš„undo logï¼Œåœ¨äº‹åŠ¡æäº¤ä¹‹åï¼Œundo logå¯èƒ½ä¸ç”¨äº†ï¼Œå°±ç”¨å®ƒæ¥å›æ”¶ã€‚
Page Cleaner ThreadååŠ© Master Thread åˆ·æ–°è„é¡µåˆ°ç£ç›˜çš„çº¿ç¨‹ï¼Œå®ƒå¯ä»¥å‡è½» Master Thread çš„å·¥ä½œå‹åŠ›ï¼Œå‡å°‘é˜»å¡ã€‚
äº‹åŠ¡åŸç†äº‹åŠ¡ï¼šæ˜¯ä¸€ç»„æ“ä½œçš„é›†åˆï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œäº‹åŠ¡ä¼šæŠŠæ‰€æœ‰çš„æ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“ä¸€èµ·å‘ç³»ç»Ÿæäº¤æˆ–æ’¤é”€æ“ä½œè¯·æ±‚ï¼Œå³è¿™äº›æ“ä½œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚
äº‹åŠ¡ç‰¹æ€§ï¼š

åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡æ˜¯ä¸å¯åˆ†å‰²çš„æœ€å°æ“ä½œå•å…ƒï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚ 
ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡å®Œæˆæ—¶ï¼Œå¿…é¡»ä½¿æ‰€æœ‰çš„æ•°æ®éƒ½ä¿æŒä¸€è‡´çŠ¶æ€ã€‚
éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šæ•°æ®åº“ç³»ç»Ÿæä¾›çš„éš”ç¦»æœºåˆ¶ï¼Œä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„ç‹¬ç«‹ç¯å¢ƒä¸‹è¿è¡Œã€‚
æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šäº‹åŠ¡ä¸€æ—¦æäº¤æˆ–å›æ»šï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­çš„æ•°æ®çš„æ”¹å˜å°±æ˜¯æ°¸ä¹…çš„ã€‚



redo logé‡åšæ—¥å¿—ï¼Œè®°å½•çš„æ˜¯äº‹åŠ¡æäº¤æ—¶æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹ï¼Œæ˜¯ç”¨æ¥å®ç°äº‹åŠ¡çš„æŒä¹…æ€§ã€‚
è¯¥æ—¥å¿—æ–‡ä»¶ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šé‡åšæ—¥å¿—ç¼“å†²ï¼ˆredo log bufferï¼‰ä»¥åŠé‡åšæ—¥å¿—æ–‡ä»¶ï¼ˆredo log fileï¼‰,å‰è€…æ˜¯åœ¨å†…å­˜ä¸­ï¼Œåè€…åœ¨ç£ç›˜ä¸­ã€‚å½“äº‹åŠ¡æäº¤ä¹‹åä¼šæŠŠæ‰€æœ‰ä¿®æ”¹ä¿¡æ¯éƒ½å­˜åˆ°è¯¥æ—¥å¿—æ–‡ä»¶ä¸­,ç”¨äºåœ¨åˆ·æ–°è„é¡µåˆ°ç£ç›˜,å‘ç”Ÿé”™è¯¯æ—¶,è¿›è¡Œæ•°æ®æ¢å¤ä½¿ç”¨ã€‚

æ²¡æœ‰redo logï¼Œå¯èƒ½ä¼šå­˜åœ¨ä»€ä¹ˆé—®é¢˜

åœ¨InnoDBå¼•æ“ä¸­çš„å†…å­˜ç»“æ„ä¸­ï¼Œä¸»è¦çš„å†…å­˜åŒºåŸŸå°±æ˜¯ç¼“å†²æ± ï¼Œåœ¨ç¼“å†²æ± ä¸­ç¼“å­˜äº†å¾ˆå¤šçš„æ•°æ®é¡µã€‚ 

å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œæ‰§è¡Œå¤šä¸ªå¢åˆ æ”¹çš„æ“ä½œæ—¶ï¼ŒInnoDBå¼•æ“ä¼šå…ˆæ“ä½œç¼“å†²æ± ä¸­çš„æ•°æ®ï¼Œå¦‚æœç¼“å†²åŒºæ²¡æœ‰å¯¹åº”çš„æ•°æ®ï¼Œä¼šé€šè¿‡åå°çº¿ç¨‹å°†ç£ç›˜ä¸­çš„æ•°æ®åŠ è½½å‡ºæ¥ï¼Œå­˜æ”¾åœ¨ç¼“å†²åŒºä¸­ã€‚

ç„¶åå°†ç¼“å†²æ± ä¸­çš„æ•°æ®ä¿®æ”¹ï¼Œä¿®æ”¹åçš„æ•°æ®é¡µæˆ‘ä»¬ç§°ä¸ºè„é¡µã€‚

è„é¡µä¼šåœ¨ä¸€å®šçš„æ—¶æœºï¼Œé€šè¿‡åå°çº¿ç¨‹å°†ç¼“å†²åŒºçš„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œä»è€Œä¿è¯ç¼“å†²åŒºä¸ç£ç›˜çš„æ•°æ®ä¸€è‡´ã€‚ 

ä½†æ˜¯ç¼“å†²åŒºçš„è„é¡µæ•°æ®å¹¶ä¸æ˜¯å®æ—¶åˆ·æ–°çš„ï¼Œè€Œæ˜¯ä¸€æ®µæ—¶é—´ä¹‹åå°†ç¼“å†²åŒºçš„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œå‡å¦‚åˆ·æ–°åˆ°ç£ç›˜çš„è¿‡ç¨‹å‡ºé”™äº†ï¼Œè€Œæç¤ºç»™ç”¨æˆ·äº‹åŠ¡æäº¤æˆåŠŸï¼Œè€Œæ•°æ®å´æ²¡æœ‰æŒä¹…åŒ–ä¸‹æ¥ï¼Œè¿™å°±å‡ºç°é—®é¢˜äº†ï¼Œæ²¡æœ‰ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ã€‚




InnoDBä¸­æä¾›äº†ä¸€ä»½æ—¥å¿— redo log

æœ‰äº†redologä¹‹åï¼Œå½“å¯¹ç¼“å†²åŒºçš„æ•°æ®è¿›è¡Œå¢åˆ æ”¹ä¹‹åï¼Œä¼šé¦–å…ˆå°†æ“ä½œçš„æ•°æ®é¡µçš„å˜åŒ–ï¼Œè®°å½•åœ¨redo log bufferä¸­ã€‚

åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œä¼šå°†redo log bufferä¸­çš„æ•°æ®åˆ·æ–°åˆ°redo logç£ç›˜æ–‡ä»¶ä¸­ã€‚

è¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼Œå¦‚æœåˆ·æ–°ç¼“å†²åŒºçš„è„é¡µåˆ°ç£ç›˜æ—¶ï¼Œå‘ç”Ÿé”™è¯¯ï¼Œæ­¤æ—¶å°±å¯ä»¥å€ŸåŠ©äºredo logè¿›è¡Œæ•°æ®æ¢å¤ï¼Œè¿™æ ·å°±ä¿è¯äº†äº‹åŠ¡çš„æŒä¹…æ€§ã€‚

è€Œå¦‚æœè„é¡µæˆåŠŸåˆ·æ–°åˆ°ç£ç›˜æˆ–è€…æ¶‰åŠåˆ°çš„æ•°æ®å·²ç»è½ç›˜ï¼Œæ­¤æ—¶redologå°±æ²¡æœ‰ä½œç”¨äº†ï¼Œå°±å¯ä»¥åˆ é™¤äº†ï¼Œæ‰€ä»¥å­˜åœ¨çš„ä¸¤ä¸ªredologæ–‡ä»¶æ˜¯å¾ªç¯å†™çš„ã€‚

ä¸ºä»€ä¹ˆæ¯ä¸€æ¬¡æäº¤äº‹åŠ¡ï¼Œè¦åˆ·æ–°redo log åˆ°ç£ç›˜ä¸­å‘¢ï¼Œè€Œä¸æ˜¯ç›´æ¥å°†buffer poolä¸­çš„è„é¡µåˆ·æ–°åˆ°ç£ç›˜å‘¢ ?
å› ä¸ºåœ¨ä¸šåŠ¡æ“ä½œä¸­ï¼Œæˆ‘ä»¬æ“ä½œæ•°æ®ä¸€èˆ¬éƒ½æ˜¯éšæœºè¯»å†™ç£ç›˜çš„ï¼Œè€Œä¸æ˜¯é¡ºåºè¯»å†™ç£ç›˜ã€‚ è€Œredo logåœ¨å¾€ç£ç›˜æ–‡ä»¶ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œç”±äºæ˜¯æ—¥å¿—æ–‡ä»¶ï¼Œæ‰€ä»¥éƒ½æ˜¯é¡ºåºå†™çš„ã€‚é¡ºåºå†™çš„æ•ˆç‡ï¼Œè¦è¿œå¤§äºéšæœºå†™ã€‚ è¿™ç§å…ˆå†™æ—¥å¿—çš„æ–¹å¼ï¼Œç§°ä¹‹ä¸º WALï¼ˆWrite-Ahead Loggingï¼‰ã€‚






undo logå›æ»šæ—¥å¿—ï¼Œç”¨äºè®°å½•æ•°æ®è¢«ä¿®æ”¹å‰çš„ä¿¡æ¯ , ä½œç”¨åŒ…å«ä¸¤ä¸ª : æä¾›å›æ»š(ä¿è¯äº‹åŠ¡çš„åŸå­æ€§) å’Œ MVCC(å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶) ã€‚
undo logå’Œredo logè®°å½•ç‰©ç†æ—¥å¿—ä¸ä¸€æ ·ï¼Œå®ƒæ˜¯é€»è¾‘æ—¥å¿—ã€‚å¯ä»¥è®¤ä¸ºå½“deleteä¸€æ¡è®°å½•æ—¶ï¼Œundo logä¸­ä¼šè®°å½•ä¸€æ¡å¯¹åº”çš„insertè®°å½•ï¼Œåä¹‹äº¦ç„¶ï¼Œå½“updateä¸€æ¡è®°å½•æ—¶ï¼Œå®ƒè®°å½•ä¸€æ¡å¯¹åº”ç›¸åçš„ updateè®°å½•ã€‚å½“æ‰§è¡Œrollbackæ—¶ï¼Œå°±å¯ä»¥ä»undo logä¸­çš„é€»è¾‘è®°å½•è¯»å–åˆ°ç›¸åº”çš„å†…å®¹å¹¶è¿›è¡Œå›æ»šã€‚

Undo logå­˜å‚¨ï¼šundo logé‡‡ç”¨æ®µçš„æ–¹å¼è¿›è¡Œç®¡ç†å’Œè®°å½•ï¼Œå­˜æ”¾åœ¨å‰é¢ä»‹ç»çš„ rollback segment å›æ»šæ®µä¸­ï¼Œå†…éƒ¨åŒ…å«1024ä¸ªundo log segmentã€‚
Undo logé”€æ¯ï¼šundo logåœ¨äº‹åŠ¡æ‰§è¡Œæ—¶äº§ç”Ÿï¼Œäº‹åŠ¡æäº¤æ—¶ï¼Œå¹¶ä¸ä¼šç«‹å³åˆ é™¤undo logï¼Œå› ä¸ºè¿™äº›æ—¥å¿—å¯èƒ½è¿˜ç”¨äºMVCCã€‚

MVCCåŸºæœ¬æ¦‚å¿µ
å½“å‰è¯»
è¯»å–çš„æ˜¯è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè¯»å–æ—¶è¿˜è¦ä¿è¯å…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½ä¿®æ”¹å½“å‰è®°å½•ï¼Œä¼šå¯¹è¯»å–çš„è®°å½•è¿›è¡ŒåŠ é”ã€‚å¯¹äºæˆ‘ä»¬æ—¥å¸¸çš„æ“ä½œï¼Œå¦‚ï¼šselect â€¦ lock in share mode(å…±äº«é”)ï¼Œselect â€¦ for updateã€updateã€insertã€delete(æ’ä»–é”)éƒ½æ˜¯ä¸€ç§å½“å‰è¯»ã€‚
æ¡ˆä¾‹


ä¸Šé¢æ¡ˆä¾‹ä¸­å½“å‰éš”ç¦»çº§åˆ«æ˜¯RCï¼ˆå¯é‡å¤è¯»ï¼‰ä¸­ï¼ŒåŒæ—¶å¼€å¯ä¸¤ä¸ªäº‹åŠ¡ã€‚åœ¨äº‹åŠ¡Aä¸­ï¼Œä½¿ç”¨æ™®é€šselect æŸ¥è¯¢è¯­å¥æ— æ³•æŸ¥è¯¢äº‹åŠ¡Bä¸­ä¿®æ”¹çš„æ•°æ®ã€‚
ä½†æ˜¯åœ¨æŸ¥è¯¢è¯­å¥åé¢åŠ ä¸Šäº† lock in share mode å…±äº«é”ï¼Œæ­¤æ—¶æ˜¯å½“å‰è¯»æ“ä½œã€‚å½“ç„¶ï¼Œæˆ‘ä»¬åŠ æ’ä»–é”çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å½“å‰è¯»æ“ä½œã€‚å¯ä»¥è¯»å–åˆ°äº‹åŠ¡Bæœ€æ–°æäº¤çš„å†…å®¹ã€‚


å¿«ç…§è¯»
ç®€å•çš„selectï¼ˆä¸åŠ é”ï¼‰å°±æ˜¯å¿«ç…§è¯»ï¼Œå¿«ç…§è¯»ï¼Œè¯»å–çš„æ˜¯è®°å½•æ•°æ®çš„å¯è§ç‰ˆæœ¬ï¼Œæœ‰å¯èƒ½æ˜¯å†å²æ•°æ®ï¼Œä¸åŠ é”ï¼Œæ˜¯éé˜»å¡è¯»ã€‚

Read Committed è¯»å·²æäº¤ï¼šæ¯æ¬¡selectï¼Œéƒ½ç”Ÿæˆä¸€ä¸ªå¿«ç…§è¯»
Repeatable Read å¯é‡å¤é«˜è¯»ï¼šå¼€å¯äº‹åŠ¡åç¬¬ä¸€ä¸ªselectè¯­å¥æ‰æ˜¯å¿«ç…§è¯»çš„åœ°æ–¹ã€‚å³ç¬¬ä¸€æ¬¡selectæŸ¥è¯¢äº§ç”Ÿå¿«ç…§è¯»ï¼Œåé¢çš„selectæŸ¥è¯¢ç›´æ¥ä½¿ç”¨å‰é¢çš„å¿«ç…§æ•°æ®
Serializable ä¸²è¡ŒåŒ–ï¼šå¿«ç…§è¯»ä¼šé€€åŒ–ä¸ºå½“å‰è¯»ï¼Œæ¯æ¬¡è¯»å–éƒ½éœ€è¦åŠ é”

æ¡ˆä¾‹

åœ¨æµ‹è¯•ä¸­,æˆ‘ä»¬çœ‹åˆ°å³ä½¿äº‹åŠ¡Bæäº¤äº†æ•°æ®,äº‹åŠ¡Aä¸­ä¹ŸæŸ¥è¯¢ä¸åˆ°ã€‚åŸå› å°±æ˜¯å› ä¸ºæ™®é€šçš„selectæ˜¯å¿«ç…§è¯»ï¼Œè€Œåœ¨å½“å‰é»˜è®¤çš„RRéš”ç¦»çº§åˆ«ä¸‹ï¼Œå¼€å¯äº‹åŠ¡åç¬¬ä¸€ä¸ªselectè¯­å¥æ‰æ˜¯å¿«ç…§è¯»çš„åœ°æ–¹ï¼Œåé¢æ‰§è¡Œç›¸åŒçš„selectè¯­å¥éƒ½æ˜¯ä»å¿«ç…§ä¸­è·å–æ•°æ®ï¼Œå¯èƒ½ä¸æ˜¯å½“å‰çš„æœ€æ–°æ•°æ®ï¼Œè¿™æ ·ä¹Ÿå°±ä¿è¯äº†å¯é‡å¤è¯»ã€‚

MVCC


   å…¨ç§° Multi-Version Concurrency Controlï¼Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ã€‚æŒ‡ç»´æŠ¤ä¸€ä¸ªæ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œ ä½¿å¾—è¯»å†™æ“ä½œæ²¡æœ‰å†²çªï¼Œå¿«ç…§è¯»ä¸ºMySQLå®ç°MVCCæä¾›äº†ä¸€ä¸ªéé˜»å¡è¯»åŠŸèƒ½ã€‚MVCCçš„å…·ä½“å®ç°ï¼Œè¿˜éœ€è¦ä¾èµ–äºæ•°æ®åº“è®°å½•ä¸­çš„ä¸‰ä¸ªéšå¼å­—æ®µã€undo logæ—¥å¿—ã€readViewã€‚
éšè—å­—æ®µå½“æˆ‘ä»¬åˆ›å»ºè¡¨çš„æ—¶å€™ï¼Œé™¤äº†æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å­—æ®µä»¥ä¸ºï¼ŒInnoDBè¿˜ä¼šè‡ªåŠ¨çš„ç»™æˆ‘ä»¬æ·»åŠ ä¸‰ä¸ªéšè—å­—æ®µã€‚


 å‰ä¸¤ä¸ªå­—æ®µæ˜¯è‚¯å®šä¼šæ·»åŠ çš„ï¼Œæ˜¯å¦æ·»åŠ æœ€åä¸€ä¸ªå­—æ®µDB_ROW_IDï¼Œå¾—çœ‹å½“å‰è¡¨æœ‰æ²¡æœ‰ä¸»é”®ï¼Œå¦‚æœæœ‰ä¸»é”®ï¼Œåˆ™ä¸ä¼šæ·»åŠ è¯¥éšè—å­—æ®µã€‚

undo log
å›æ»šæ—¥å¿—ï¼Œåœ¨insertã€updateã€deleteçš„æ—¶å€™äº§ç”Ÿçš„ä¾¿äºæ•°æ®å›æ»šçš„æ—¥å¿—ã€‚
å½“insertçš„æ—¶å€™ï¼Œäº§ç”Ÿçš„undo logæ—¥å¿—åªåœ¨å›æ»šæ—¶éœ€è¦ï¼Œåœ¨äº‹åŠ¡æäº¤åï¼Œå¯è¢«ç«‹å³åˆ é™¤ã€‚
è€Œupdateã€deleteçš„æ—¶å€™ï¼Œäº§ç”Ÿçš„undo logæ—¥å¿—ä¸ä»…åœ¨å›æ»šæ—¶éœ€è¦ï¼Œåœ¨å¿«ç…§è¯»æ—¶ä¹Ÿéœ€è¦ï¼Œä¸ä¼šç«‹å³è¢«åˆ é™¤ã€‚

undo log ç‰ˆæœ¬é“¾
æ¼”ç¤ºï¼šå¦‚æœå››ä¸ªäº‹åŠ¡éœ€è¦åŒæ—¶è®¿é—®åŒä¸€æ¡è®°å½•æ—¶ã€‚


DB_TRX_ID : ä»£è¡¨æœ€è¿‘ä¿®æ”¹äº‹åŠ¡IDï¼Œè®°å½•æ’å…¥è¿™æ¡è®°å½•æˆ–æœ€åä¸€æ¬¡ä¿®æ”¹è¯¥è®°å½•çš„äº‹åŠ¡IDï¼Œæ˜¯è‡ªå¢çš„ã€‚ DB_ROLL_PTR ï¼š ç”±äºè¿™æ¡æ•°æ®æ˜¯æ‰æ’å…¥çš„ï¼Œæ²¡æœ‰è¢«æ›´æ–°è¿‡ï¼Œæ‰€ä»¥è¯¥å­—æ®µå€¼ä¸ºnullã€‚



ä¸åŒäº‹åŠ¡æˆ–ç›¸åŒäº‹åŠ¡å¯¹åŒä¸€æ¡è®°å½•è¿›è¡Œä¿®æ”¹ï¼Œä¼šå¯¼è‡´è¯¥è®°å½•çš„undologç”Ÿæˆä¸€æ¡ è®°å½•ç‰ˆæœ¬é“¾è¡¨ï¼Œé“¾è¡¨çš„å¤´éƒ¨æ˜¯æœ€æ–°çš„æ—§è®°å½•ï¼Œé“¾è¡¨å°¾éƒ¨æ˜¯æœ€æ—©çš„æ—§è®°å½•ã€‚

readviewReadViewï¼ˆè¯»è§†å›¾ï¼‰æ˜¯ å¿«ç…§è¯» SQLæ‰§è¡Œæ—¶MVCCæå–æ•°æ®çš„ä¾æ®ï¼Œè®°å½•å¹¶ç»´æŠ¤ç³»ç»Ÿå½“å‰æ´»è·ƒçš„äº‹åŠ¡ï¼ˆæœªæäº¤çš„ï¼‰idã€‚


ä¸åŒçš„éš”ç¦»çº§åˆ«ï¼Œç”ŸæˆReadViewçš„æ—¶æœºä¸åŒï¼š 

READ COMMITTEDï¼šåœ¨äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewã€‚ 
REPEATABLE READï¼šä»…åœ¨äº‹åŠ¡ä¸­ç¬¬ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewï¼Œåç»­å¤ç”¨è¯¥ReadViewã€‚

åŸç†åˆ†æ
RCéš”ç¦»çº§åˆ«
RCéš”ç¦»çº§åˆ«ä¸‹ï¼Œåœ¨äº‹åŠ¡ä¸­æ¯ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewã€‚

åˆ†æï¼š

å°†å·¦ä¸‹è®°å½•æ ¹æ® DB_TRX_ID ï¼ˆå½“å‰äº‹åŠ¡id  ä¸º4ï¼‰å¸¦å…¥å³ä¸‹ç‰ˆæœ¬é“¾è§„åˆ™ â‘ â‘¡â‘¢â‘£ ä¸­ï¼Œå‘ç°éƒ½ä¸æˆç«‹ã€‚è¯´æ˜æœ¬æ¬¡å¿«ç…§è¯»æŸ¥æ‰¾çš„æ•°æ®ä¸æ˜¯äº‹åŠ¡idä¸º4çš„è®°å½•ã€‚
æŒ‰ç…§ç‰ˆæœ¬é“¾å¾€ä¸‹æ‰¾ï¼ˆæ ¹æ®è¡¨å°¾åœ°å€æŸ¥æ‰¾ï¼‰ä¸‹ä¸€æ¡è®°å½•ï¼Œæ‰¾åˆ°äº‹åŠ¡idä¸º3çš„è®°å½•ï¼Œåœ¨ â‘ â‘¡â‘¢â‘£ éƒ½ä¸æˆç«‹ï¼Œç»§ç»­å‘ä¸‹å¯»æ‰¾ã€‚
æ‰¾åˆ°ä¸€æ¡äº‹åŠ¡idä¸º2çš„è®°å½•ï¼Œå‘ç°â‘¡æˆç«‹ã€‚è¯´æ˜æœ¬æ¬¡å¿«ç…§è¯»æŸ¥æ‰¾çš„æ•°æ®&#x3D;æ˜¯äº‹åŠ¡idä¸º2çš„è®°å½•ã€‚


RRéš”ç¦»çº§åˆ«
RRéš”ç¦»çº§åˆ«ä¸‹ï¼Œä»…åœ¨äº‹åŠ¡ä¸­ç¬¬ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆReadViewï¼Œåç»­å¤ç”¨è¯¥ReadViewã€‚ è€ŒRR æ˜¯å¯é‡å¤è¯»ï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œæ‰§è¡Œä¸¤æ¬¡ç›¸åŒçš„selectè¯­å¥ï¼ŒæŸ¥è¯¢åˆ°çš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚

åœ¨RRéš”ç¦»çº§åˆ«ä¸‹ï¼Œåªæ˜¯åœ¨äº‹åŠ¡ä¸­ç¬¬ä¸€æ¬¡å¿«ç…§è¯»æ—¶ç”ŸæˆReadViewï¼Œåç»­éƒ½æ˜¯å¤ç”¨è¯¥ ReadViewï¼Œé‚£ä¹ˆæ—¢ç„¶ReadViewéƒ½ä¸€æ ·ï¼Œ ReadViewçš„ç‰ˆæœ¬é“¾åŒ¹é…è§„åˆ™ä¹Ÿä¸€æ ·ï¼Œ é‚£ä¹ˆæœ€ç»ˆå¿«ç…§è¯»è¿”å›çš„ç»“æœä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚


ç»“è®ºï¼šMVCCçš„å®ç°åŸç†å°±æ˜¯é€šè¿‡ InnoDBè¡¨çš„éšè—å­—æ®µã€UndoLog ç‰ˆæœ¬é“¾ã€ReadViewæ¥å®ç°çš„ã€‚ è€ŒMVCC + é”ï¼Œåˆ™å®ç°äº†äº‹åŠ¡çš„éš”ç¦»æ€§ã€‚ è€Œä¸€è‡´æ€§åˆ™æ˜¯ç”±redolog ä¸ undologä¿è¯ã€‚

]]></content>
      <categories>
        <category>MySql</category>
        <category>MySqlè¿›é˜¶</category>
      </categories>
      <tags>
        <tag>MySqlè¿›é˜¶ å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM åŸºç¡€ 5 - GC åƒåœ¾å›æ”¶</title>
    <url>/2025/05/25/Java/JVM/JVM%20%E5%9F%BA%E7%A1%80%205%20-%20%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/</url>
    <content><![CDATA[åƒåœ¾å›æ”¶JVM åƒåœ¾å›æ”¶ (Garbage Collection, GC) æ˜¯ Java è™šæ‹Ÿæœºè‡ªåŠ¨ç®¡ç†å †å†…å­˜çš„æ ¸å¿ƒæœºåˆ¶ã€‚å®ƒè´Ÿè´£è¯†åˆ«å¹¶å›æ”¶ç¨‹åºä¸­ä¸å†ä½¿ç”¨çš„å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼Œæå¤§åœ°ç®€åŒ–äº†å¼€å‘äººå‘˜çš„å†…å­˜ç®¡ç†å·¥ä½œã€‚  
åƒåœ¾å›æ”¶å™¨å¦‚æœå‘ç°æŸä¸ªå¯¹è±¡ä¸å†ä½¿ç”¨ï¼Œå°±å¯ä»¥å›æ”¶è¯¥å¯¹è±¡ã€‚
.cfafpsfmcguw{zoom: 67%;}

.uqmblncjoway{zoom:67%;}


è‡ªåŠ¨åƒåœ¾å›æ”¶ï¼Œè‡ªåŠ¨æ ¹æ®å¯¹è±¡æ˜¯å¦ä½¿ç”¨ç”±è™šæ‹Ÿæœºæ¥å›æ”¶å¯¹è±¡

ä¼˜ç‚¹ï¼šé™ä½ç¨‹åºå‘˜å®ç°éš¾åº¦ã€é™ä½å¯¹è±¡å›æ”¶bugçš„å¯èƒ½æ€§
ç¼ºç‚¹ï¼šç¨‹åºå‘˜æ— æ³•æ§åˆ¶å†…å­˜å›æ”¶çš„åŠæ—¶æ€§


æ‰‹åŠ¨åƒåœ¾å›æ”¶ï¼Œç”±ç¨‹åºå‘˜ç¼–ç¨‹å®ç°å¯¹è±¡çš„åˆ é™¤

ä¼˜ç‚¹ï¼šå›æ”¶åŠæ—¶æ€§é«˜ï¼Œç”±ç¨‹åºå‘˜æŠŠæ§å›æ”¶çš„æ—¶æœº
ç¼ºç‚¹ï¼šç¼–å†™ä¸å½“å®¹æ˜“å‡ºç°æ‚¬ç©ºæŒ‡é’ˆã€é‡å¤é‡Šæ”¾ã€å†…å­˜æ³„æ¼ç­‰é—®é¢˜




å¦‚æœéœ€è¦æ‰‹åŠ¨è§¦å‘åƒåœ¾å›æ”¶ï¼Œå¯ä»¥è°ƒç”¨System.gc()æ–¹æ³•ã€‚è¯­æ³•ï¼š System.gc()æ³¨æ„äº‹é¡¹ï¼š   è°ƒç”¨System.gc()æ–¹æ³•å¹¶ä¸ä¸€å®šä¼šç«‹å³å›æ”¶åƒåœ¾ï¼Œä»…ä»…æ˜¯å‘Javaè™šæ‹Ÿæœºå‘é€ä¸€ä¸ªåƒåœ¾å›æ”¶çš„è¯·æ±‚ï¼Œå…·ä½“æ˜¯å¦éœ€è¦æ‰§è¡Œåƒåœ¾å›æ”¶Javaè™šæ‹Ÿæœºä¼šè‡ªè¡Œåˆ¤æ–­ã€‚

å¦‚ä½•åˆ¤æ–­å¯¹è±¡å¯ä»¥å›æ”¶å¼•ç”¨è®¡æ•°æ³•å¼•ç”¨è®¡æ•°æ³•ä¼šä¸ºæ¯ä¸ªå¯¹è±¡ç»´æŠ¤ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œå½“å¯¹è±¡è¢«å¼•ç”¨æ—¶åŠ 1ï¼Œå–æ¶ˆå¼•ç”¨æ—¶å‡1ã€‚å½“å€¼ä¸º 0 æ—¶ï¼Œå°±è¡¨ç¤ºè¯¥å¯¹è±¡ä¸è¢«å¼•ç”¨ï¼Œå¯ä»¥è¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶ã€‚
ç¼ºç‚¹ï¼š  

æ¯æ¬¡å¼•ç”¨å’Œå–æ¶ˆå¼•ç”¨éƒ½éœ€è¦ç»´æŠ¤è®¡æ•°å™¨ï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½ä¼šæœ‰ä¸€å®šçš„å½±å“
å­˜åœ¨å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œæ‰€è°“å¾ªç¯å¼•ç”¨å°±æ˜¯å½“Aå¼•ç”¨Bï¼ŒBåŒæ—¶å¼•ç”¨Aæ—¶ä¼šå‡ºç°å¯¹è±¡æ— æ³•å›æ”¶çš„é—®é¢˜ã€‚å¦‚ä¸‹å›¾ï¼š

.drrzjypiqcxd{zoom:80%;}

å¯è¾¾æ€§åˆ†ææ³•é€šè¿‡ GC Roots ä½œä¸ºèµ·å§‹ç‚¹è¿›è¡Œæœç´¢ï¼Œèƒ½å¤Ÿåˆ°è¾¾åˆ°çš„å¯¹è±¡éƒ½æ˜¯å­˜æ´»çš„ï¼Œä¸å¯è¾¾çš„å¯¹è±¡å¯è¢«å›æ”¶ã€‚


JVM ä¸­çš„åƒåœ¾å›æ”¶å™¨é€šè¿‡å¯è¾¾æ€§åˆ†ææ¥æ¢ç´¢æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡
æ‰«æå †ä¸­çš„å¯¹è±¡ï¼Œçœ‹èƒ½å¦æ²¿ç€ GC Root å¯¹è±¡ä¸ºèµ·ç‚¹çš„å¼•ç”¨é“¾æ‰¾åˆ°è¯¥å¯¹è±¡ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥å›æ”¶
Java ä¸­å¯ä»¥ä½œä¸º GC Root çš„å¯¹è±¡ï¼š
è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡ã€‚
æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡
æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡
æœ¬åœ°æ–¹æ³•æ ˆä¸­ JNIï¼ˆå³ä¸€èˆ¬è¯´çš„Nativeæ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡

å¼•ç”¨å¯¹è±¡.rwtlfcxjtcvx{zoom:80%;}

1. å¼ºå¼•ç”¨ï¼ˆStrongReferenceï¼‰è¢«å¼ºå¼•ç”¨å…³è”çš„å¯¹è±¡ä¸ä¼šè¢«å›æ”¶ã€‚åªæœ‰GC Rootéƒ½ä¸å¼•ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œæ‰ä¼šå›æ”¶å¼ºå¼•ç”¨å¯¹è±¡
2. è½¯å¼•ç”¨ï¼ˆSoftReferenceï¼‰å¦‚æœä¸€ä¸ªå¯¹è±¡åªæœ‰è½¯å¼•ç”¨å¼•å¯¹è±¡æ—¶ï¼Œå½“ç¨‹åºå†…å­˜ä¸è¶³æ—¶ï¼Œå°±ä¼šå°†è½¯å¼•ç”¨ä¸­çš„æ•°æ®è¿›è¡Œå›æ”¶ã€‚åœ¨JDK 1.2ç‰ˆä¹‹åæä¾›äº†SoftReferenceç±»æ¥å®ç°è½¯å¼•ç”¨ï¼Œè½¯å¼•ç”¨å¸¸ç”¨äºç¼“å­˜ä¸­ã€‚
3. å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰å¦‚æœä¸€ä¸ªå¯¹è±¡åªæœ‰å¼±å¼•ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œæ— è®ºå†…å­˜æ˜¯å¦å……è¶³ï¼Œå°±ä¼šå°†å¼±å¼•ç”¨ä¸­çš„æ•°æ®è¿›è¡Œå›æ”¶ã€‚åœ¨JDK 1.2ç‰ˆä¹‹åæä¾›äº†WeakReferenceç±»æ¥å®ç°å¼±å¼•ç”¨ï¼Œå¼±å¼•ç”¨ä¸»è¦åœ¨ThreadLocalä¸­ä½¿ç”¨ã€‚
4. è™šå¼•ç”¨ï¼ˆPhantomReferenceï¼‰ï¼ˆä¸å¸¸è§ï¼‰è™šå¼•ç”¨ä¹Ÿå«å¹½çµå¼•ç”¨&#x2F;å¹»å½±å¼•ç”¨ï¼Œä¸èƒ½é€šè¿‡è™šå¼•ç”¨å¯¹è±¡è·å–åˆ°åŒ…å«çš„å¯¹è±¡ã€‚è™šå¼•ç”¨å”¯ä¸€çš„ç”¨é€”æ˜¯å½“å¯¹è±¡è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶æ—¶å¯ä»¥æ¥æ”¶åˆ°å¯¹åº”çš„é€šçŸ¥ã€‚Javaä¸­ä½¿ç”¨PhantomReferenceå®ç°äº†è™šå¼•ç”¨ï¼Œç›´æ¥å†…å­˜ä¸­ä¸ºäº†åŠæ—¶çŸ¥é“ç›´æ¥å†…å­˜å¯¹è±¡ä¸å†ä½¿ç”¨ï¼Œä»è€Œå›æ”¶å†…å­˜ï¼Œä½¿ç”¨äº†è™šå¼•ç”¨æ¥å®ç°ã€‚
5. ç»ˆç»“å™¨å¼•ç”¨ï¼ˆFinalReferenceï¼‰ï¼ˆä¸å¸¸è§ï¼‰ç»ˆç»“å™¨å¼•ç”¨æŒ‡çš„æ˜¯åœ¨å¯¹è±¡éœ€è¦è¢«å›æ”¶æ—¶ï¼Œç»ˆç»“å™¨å¼•ç”¨ä¼šå…³è”å¯¹è±¡å¹¶æ”¾ç½®åœ¨Finalizerç±»ä¸­çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ï¼Œåœ¨ç¨åç”±ä¸€æ¡ç”±FinalizerThreadçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­è·å–å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œå¯¹è±¡çš„finalizeæ–¹æ³•ï¼Œåœ¨å¯¹è±¡ç¬¬äºŒæ¬¡è¢«å›æ”¶æ—¶ï¼Œè¯¥å¯¹è±¡æ‰çœŸæ­£çš„è¢«å›æ”¶ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯ä»¥åœ¨finalizeæ–¹æ³•ä¸­å†å°†è‡ªèº«å¯¹è±¡ä½¿ç”¨å¼ºå¼•ç”¨å…³è”ä¸Šï¼Œä½†æ˜¯ä¸å»ºè®®è¿™æ ·åšã€‚
åƒåœ¾å›æ”¶ç®—æ³•1. æ ‡è®°-æ¸…é™¤ç®—æ³•
è™šæ‹Ÿæœºæ‰§è¡Œåƒåœ¾å›æ”¶çš„è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•ï¼Œä»GC Rootå¼€å§‹é€šè¿‡å¼•ç”¨é“¾éå†å‡ºæ‰€æœ‰å­˜æ´»å¯¹è±¡ã€‚å°†æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ ‡è®°ã€‚
ç„¶ååƒåœ¾æ”¶é›†å™¨æ ¹æ®æ ‡è¯†æ¸…é™¤æ²¡æœ‰è¢«æ ‡è®°ä¹Ÿå°±æ˜¯éå­˜æ´»å¯¹è±¡ï¼Œç»™å †å†…å­˜è…¾å‡ºç›¸åº”çš„ç©ºé—´


ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œåªéœ€è¦åœ¨ç¬¬ä¸€é˜¶æ®µç»™æ¯ä¸ªå¯¹è±¡ç»´æŠ¤æ ‡å¿—ä½ï¼Œç¬¬äºŒé˜¶æ®µåˆ é™¤å¯¹è±¡å³å¯ã€‚
ç¼ºç‚¹ï¼š

ä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç¢ç‰‡ï¼Œå¯¼è‡´æ— æ³•ç»™å¤§å¯¹è±¡åˆ†é…å†…å­˜ã€‚ç”±äºå†…å­˜æ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥åœ¨å¯¹è±¡è¢«åˆ é™¤ä¹‹åï¼Œå†…å­˜ä¸­ä¼šå‡ºç°å¾ˆå¤šç»†å°çš„å¯ç”¨å†…å­˜å•å…ƒã€‚å¦‚æœæˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ç©ºé—´ï¼Œå¾ˆæœ‰å¯èƒ½è¿™äº›å†…å­˜å•å…ƒçš„å¤§å°è¿‡å°æ— æ³•è¿›è¡Œåˆ†é…ã€‚
åˆ†é…é€Ÿåº¦æ…¢ã€‚ç”±äºå†…å­˜ç¢ç‰‡çš„å­˜åœ¨ï¼Œéœ€è¦ç»´æŠ¤ä¸€ä¸ªç©ºé—²é“¾è¡¨ï¼Œææœ‰å¯èƒ½å‘ç”Ÿæ¯æ¬¡éœ€è¦éå†åˆ°é“¾è¡¨çš„æœ€åæ‰èƒ½è·å¾—åˆé€‚çš„å†…å­˜ç©ºé—´ã€‚
æ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹æ•ˆç‡éƒ½ä¸é«˜ã€‚

2. æ ‡è®°-æ•´ç†ç®—æ³•æ ‡è®°æ•´ç†ç®—æ³•ä¹Ÿå«æ ‡è®°å‹ç¼©ç®—æ³•ï¼Œæ˜¯å¯¹æ ‡è®°æ¸…ç†ç®—æ³•ä¸­å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡é—®é¢˜çš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚

æ ‡è®°é˜¶æ®µï¼Œå°†æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ ‡è®°ã€‚Javaä¸­ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•ï¼Œä»GC Rootå¼€å§‹é€šè¿‡å¼•ç”¨é“¾éå†å‡ºæ‰€æœ‰å­˜æ´»å¯¹è±¡ã€‚
æ•´ç†é˜¶æ®µï¼Œå°†å­˜æ´»å¯¹è±¡ç§»åŠ¨åˆ°å †çš„ä¸€ç«¯ã€‚æ¸…ç†æ‰å­˜æ´»å¯¹è±¡çš„å†…å­˜ç©ºé—´ã€‚


ä¼˜ç‚¹ï¼šä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚
ç¼ºç‚¹ï¼šå†…å­˜å˜åŠ¨æ›´é¢‘ç¹ï¼Œéœ€è¦æ•´ç†æ‰€æœ‰å­˜æ´»å¯¹è±¡çš„å¼•ç”¨åœ°å€ï¼Œæ•ˆç‡ä¸é«˜ã€‚
3. å¤åˆ¶ç®—æ³•å°†å†…å­˜åˆ’åˆ†ä¸ºå¤§å°ç›¸ç­‰çš„ä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ï¼Œå½“è¿™ä¸€å—å†…å­˜ç”¨å®Œäº†å°±å°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—ä¸Šé¢ï¼Œç„¶åå†æŠŠä½¿ç”¨è¿‡çš„å†…å­˜ç©ºé—´è¿›è¡Œä¸€æ¬¡æ¸…ç†ï¼Œæœ€åä¼šæŠŠä½ç½®äº’æ¢ã€‚

ä¼˜ç‚¹ï¼šä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼›ååé‡é«˜ï¼Œå¤åˆ¶ç®—æ³•åªéœ€è¦éå†ä¸€æ¬¡å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°Toç©ºé—´å³å¯ï¼Œæ¯”æ ‡è®°-æ•´ç†ç®—æ³•å°‘äº†ä¸€æ¬¡éå†çš„è¿‡ç¨‹ï¼Œå› è€Œæ€§èƒ½è¾ƒå¥½ï¼Œä½†æ˜¯ä¸å¦‚æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œå› ä¸ºæ ‡è®°æ¸…é™¤ç®—æ³•ä¸éœ€è¦è¿›è¡Œå¯¹è±¡çš„ç§»åŠ¨
ç¼ºç‚¹ï¼šå†…å­˜ä½¿ç”¨æ•ˆç‡ä½ï¼Œæ¯æ¬¡åªèƒ½è®©ä¸€åŠçš„å†…å­˜ç©ºé—´æ¥ä¸ºåˆ›å»ºå¯¹è±¡ä½¿ç”¨ã€‚
4. åˆ†ä»£åƒåœ¾å›æ”¶ç®—æ³•ç°ä»£ä¼˜ç§€çš„åƒåœ¾å›æ”¶ç®—æ³•ï¼Œä¼šå°†ä¸Šè¿°æè¿°çš„åƒåœ¾å›æ”¶ç®—æ³•ç»„åˆè¿›è¡Œä½¿ç”¨ï¼Œå…¶ä¸­åº”ç”¨æœ€å¹¿çš„å°±æ˜¯åˆ†ä»£åƒåœ¾å›æ”¶ç®—æ³•(Generational GC)ã€‚  
åˆ†ä»£åƒåœ¾å›æ”¶å°†æ•´ä¸ªå†…å­˜åŒºåŸŸåˆ’åˆ†ä¸ºå¹´è½»ä»£ï¼ˆå¤åˆ¶ç®—æ³•ï¼‰å’Œè€å¹´ä»£ï¼ˆæ ‡è®° - æ¸…é™¤ æˆ–è€… æ ‡è®° - æ•´ç† ç®—æ³•ï¼‰ï¼š
.hmqqyblaooat{zoom: 80%;}


åˆ†ä»£å›æ”¶æ—¶ï¼Œåˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ï¼Œé¦–å…ˆä¼šè¢«æ”¾å…¥Edenä¼Šç”¸å›­åŒºã€‚

éšç€å¯¹è±¡åœ¨EdenåŒºè¶Šæ¥è¶Šå¤šï¼Œå¦‚æœEdenåŒºæ»¡ï¼Œæ–°åˆ›å»ºçš„å¯¹è±¡å·²ç»æ— æ³•æ”¾å…¥ï¼Œå°±ä¼šè§¦å‘å¹´è½»ä»£çš„GCï¼Œç§°ä¸ºMinor GCæˆ–è€…Young GCã€‚  
Minor GCä¼šæŠŠéœ€è¦edenä¸­å’ŒFroméœ€è¦å›æ”¶çš„å¯¹è±¡å›æ”¶ï¼ŒæŠŠæ²¡æœ‰å›æ”¶çš„å¯¹è±¡æ”¾å…¥ToåŒºã€‚

æ¥ä¸‹æ¥ï¼ŒS0ä¼šå˜æˆToåŒºï¼ŒS1å˜æˆFromåŒºã€‚å½“edenåŒºæ»¡æ—¶å†å¾€é‡Œæ”¾å…¥å¯¹è±¡ï¼Œä¾ç„¶ä¼šå‘ç”ŸMinor GCã€‚  
æ­¤æ—¶ä¼šå›æ”¶edenåŒºå’ŒS1(from)ä¸­çš„å¯¹è±¡ï¼Œå¹¶æŠŠedenå’ŒfromåŒºä¸­å‰©ä½™çš„å¯¹è±¡æ”¾å…¥S0ã€‚æ³¨æ„ï¼šæ¯æ¬¡Minor GCä¸­éƒ½ä¼šä¸ºå¯¹è±¡è®°å½•ä»–çš„å¹´é¾„ï¼Œåˆå§‹å€¼ä¸º0ï¼Œæ¯æ¬¡GCå®ŒåŠ 1ã€‚

å¦‚æœMinor GCåå¯¹è±¡çš„å¹´é¾„è¾¾åˆ°é˜ˆå€¼ï¼ˆæœ€å¤§15ï¼Œé»˜è®¤å€¼å’Œåƒåœ¾å›æ”¶å™¨æœ‰å…³ï¼‰ï¼Œå¯¹è±¡å°±ä¼šè¢«æ™‹å‡è‡³è€å¹´ä»£ã€‚

å½“è€å¹´ä»£ä¸­ç©ºé—´ä¸è¶³ï¼Œæ— æ³•æ”¾å…¥æ–°çš„å¯¹è±¡æ—¶ï¼Œå…ˆå°è¯•minor gcå¦‚æœè¿˜æ˜¯ä¸è¶³ï¼Œå°±ä¼šè§¦å‘Full GCï¼ŒFull GCä¼šå¯¹æ•´ä¸ªå †è¿›è¡Œåƒåœ¾å›æ”¶ã€‚
å¦‚æœFull GCä¾ç„¶æ— æ³•å›æ”¶æ‰è€å¹´ä»£çš„å¯¹è±¡ï¼Œé‚£ä¹ˆå½“å¯¹è±¡ç»§ç»­æ”¾å…¥è€å¹´ä»£æ—¶ï¼Œå°±ä¼šæŠ›å‡ºOut Of Memoryå¼‚å¸¸ã€‚

ç‰¹æ®Šæƒ…å†µï¼šå½“é‡åˆ°ä¸€ä¸ªè¾ƒå¤§çš„å¯¹è±¡æ—¶ï¼Œå°±ç®—æ–°ç”Ÿä»£çš„ä¼Šç”¸å›­ä¸ºç©ºï¼Œä¹Ÿæ— æ³•å®¹çº³è¯¥å¯¹è±¡æ—¶ï¼Œä¼šå°†è¯¥å¯¹è±¡ç›´æ¥æ™‹å‡ä¸ºè€å¹´ä»£ã€‚


ç›¸å…³ JVM å‚æ•°


å«ä¹‰
å‚æ•°



å †åˆå§‹å¤§å°å¿…é¡»æ˜¯1024å€æ•°ä¸”å¤§äº1MB
-Xms


å †æœ€å¤§å¤§å°å¿…é¡»æ˜¯1024å€æ•°ä¸”å¤§äº1MB
-Xmx æˆ– -XX:MaxHeapSize&#x3D;size


æ–°ç”Ÿä»£å¤§å°
-Xmn æˆ– (-XX:NewSize&#x3D;size + -XX:MaxNewSize&#x3D;size )


å¹¸å­˜åŒºæ¯”ä¾‹ï¼ˆåŠ¨æ€ï¼‰
-XX:InitialSurvivorRatio&#x3D;ratio å’Œ -XX:+UseAdaptiveSizePolicy


ä¼Šç”¸å›­åŒºå’Œå¹¸å­˜åŒºçš„æ¯”ä¾‹ï¼Œé»˜è®¤8ï¼Œæ–°ç”Ÿä»£1Gï¼Œä¼Šç”¸å›­åŒº800MB,S0å’ŒS1å„100MB
-XX:SurvivorRatio&#x3D;ratio


æ™‹å‡é˜ˆå€¼
-XX:MaxTenuringThreshold&#x3D;threshold


æ™‹å‡è¯¦æƒ…
-XX:+PrintTenuringDistribution


æ‰“å°GCæ—¥å¿—
-XX:+PrintGCDetails -verbose:gc


FullGC å‰ MinorGC
-XX:+ScavengeBeforeFullGC


åƒåœ¾å›æ”¶å™¨ä¸ºä»€ä¹ˆåˆ†ä»£GCç®—æ³•è¦æŠŠå †åˆ†æˆå¹´è½»ä»£å’Œè€å¹´ä»£ï¼Ÿé¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“å †å†…å­˜ä¸­å¯¹è±¡çš„ç‰¹æ€§ï¼š

ç³»ç»Ÿä¸­çš„å¤§éƒ¨åˆ†å¯¹è±¡ï¼Œéƒ½æ˜¯åˆ›å»ºå‡ºæ¥ä¹‹åå¾ˆå¿«å°±ä¸å†ä½¿ç”¨å¯ä»¥è¢«å›æ”¶ï¼Œæ¯”å¦‚ç”¨æˆ·è·å–è®¢å•æ•°æ®ï¼Œè®¢å•æ•°æ®è¿”å›ç»™ç”¨æˆ·ä¹‹åå°±å¯ä»¥é‡Šæ”¾äº†ã€‚
è€å¹´ä»£ä¸­ä¼šå­˜æ”¾é•¿æœŸå­˜æ´»çš„å¯¹è±¡ï¼Œæ¯”å¦‚Springçš„å¤§éƒ¨åˆ†beanå¯¹è±¡ï¼Œåœ¨ç¨‹åºå¯åŠ¨ä¹‹åå°±ä¸ä¼šè¢«å›æ”¶äº†ã€‚
åœ¨è™šæ‹Ÿæœºçš„é»˜è®¤è®¾ç½®ä¸­ï¼Œæ–°ç”Ÿä»£å¤§å°è¦è¿œå°äºè€å¹´ä»£çš„å¤§å°ã€‚

åˆ†ä»£GCç®—æ³•å°†å †åˆ†æˆå¹´è½»ä»£å’Œè€å¹´ä»£ä¸»è¦åŸå› æœ‰ï¼š

å¯ä»¥é€šè¿‡è°ƒæ•´å¹´è½»ä»£å’Œè€å¹´ä»£çš„æ¯”ä¾‹æ¥é€‚åº”ä¸åŒç±»å‹çš„åº”ç”¨ç¨‹åºï¼Œæé«˜å†…å­˜çš„åˆ©ç”¨ç‡å’Œæ€§èƒ½ã€‚

æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä½¿ç”¨ä¸åŒçš„åƒåœ¾å›æ”¶ç®—æ³•ï¼Œæ–°ç”Ÿä»£ä¸€èˆ¬é€‰æ‹©å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£å¯ä»¥é€‰æ‹©æ ‡è®°-æ¸…é™¤å’Œæ ‡è®°-æ•´ç†ç®—æ³•ï¼Œç”±ç¨‹åºå‘˜æ¥é€‰æ‹©çµæ´»åº¦è¾ƒé«˜ã€‚

åˆ†ä»£çš„è®¾è®¡ä¸­å…è®¸åªå›æ”¶æ–°ç”Ÿä»£ï¼ˆminor gcï¼‰ï¼Œå¦‚æœèƒ½æ»¡è¶³å¯¹è±¡åˆ†é…çš„è¦æ±‚å°±ä¸éœ€è¦å¯¹æ•´ä¸ªå †è¿›è¡Œå›æ”¶(full gc),STWæ—¶é—´å°±ä¼šå‡å°‘ã€‚


åƒåœ¾å›æ”¶å™¨æ˜¯åƒåœ¾å›æ”¶ç®—æ³•çš„å…·ä½“å®ç°ã€‚
ç”±äºåƒåœ¾å›æ”¶å™¨åˆ†ä¸ºå¹´è½»ä»£å’Œè€å¹´ä»£ï¼Œé™¤äº†G1ä¹‹å¤–å…¶ä»–åƒåœ¾å›æ”¶å™¨å¿…é¡»æˆå¯¹ç»„åˆè¿›è¡Œä½¿ç”¨ã€‚
å…·ä½“çš„å…³ç³»å›¾å¦‚ä¸‹ï¼š


Serial æ”¶é›†å™¨Serial æ”¶é›†å™¨æ˜¯æœ€åŸºæœ¬çš„ã€å‘å±•å†å²æœ€æ‚ ä¹…çš„æ”¶é›†å™¨ã€‚æ˜¯ä¸€ç§å•çº¿ç¨‹ä¸²è¡Œå›æ”¶å¹´è½»ä»£çš„åƒåœ¾å›æ”¶å™¨ï¼Œåªä¼šä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†å·¥ä½œï¼Œä½¿ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•ã€‚  
.pebrhsqvbgyh{zoom:80%;}

ä¼˜ç‚¹ï¼š

å•çº¿ç¨‹ã€ç®€å•é«˜æ•ˆï¼ˆä¸å…¶ä»–æ”¶é›†å™¨çš„å•çº¿ç¨‹ç›¸æ¯”ï¼‰ã€‚å¯¹äºé™å®šå•ä¸ªCPUçš„ç¯å¢ƒæ¥è¯´ï¼ŒSerialæ”¶é›†å™¨ç”±äºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œä¸“å¿ƒåšåƒåœ¾æ”¶é›†è‡ªç„¶å¯ä»¥è·å¾—æœ€é«˜çš„å•çº¿ç¨‹æ‰‹æœºæ•ˆç‡ã€‚æ”¶é›†å™¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼ˆ â€œStop The Worldâ€ ï¼‰ï¼Œç›´åˆ°å®ƒç»“æŸã€‚

 ç¼ºç‚¹ï¼š

å¤šCPUä¸‹ååé‡ä¸å¦‚å…¶ä»–åƒåœ¾å›æ”¶å™¨ï¼Œå †å¦‚æœåå¤§ä¼šè®©ç”¨æˆ·çº¿ç¨‹å¤„äºé•¿æ—¶é—´çš„ç­‰å¾…ã€‚

é€‚ç”¨åœºæ™¯ï¼š 

Javaç¼–å†™çš„å®¢æˆ·ç«¯ç¨‹åºæˆ–è€…ç¡¬ä»¶é…ç½®æœ‰é™çš„åœºæ™¯ã€‚


-XX:+UseSerialGC&#x3D;serial + serialOld

SerialOldåƒåœ¾å›æ”¶å™¨SerialOldæ˜¯Serialåƒåœ¾å›æ”¶å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œé‡‡ç”¨å•çº¿ç¨‹ä¸²è¡Œå›æ”¶ã€‚ä½¿ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚
.ssxvnkiayspt{zoom:80%;}

ParNew æ”¶é›†å™¨ParNew æ”¶é›†å™¨å…¶å®å°±æ˜¯ Serial æ”¶é›†å™¨åœ¨å¤šCPUä¸‹çš„ä¼˜åŒ–ï¼Œä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾å›æ”¶ã€‚æ–°ç”Ÿä»£é‡‡ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚
-XX:+UseParNewGC æ–°ç”Ÿä»£ä½¿ç”¨ParNewå›æ”¶å™¨ï¼Œ è€å¹´ä»£ä½¿ç”¨ä¸²è¡Œå›æ”¶å™¨

ä¼˜ç‚¹ï¼š

å¤šçº¿ç¨‹ã€ParNew æ”¶é›†å™¨é»˜è®¤å¼€å¯çš„æ”¶é›†çº¿ç¨‹æ•°ä¸CPUçš„æ•°é‡ç›¸åŒï¼Œåœ¨ CPU éå¸¸å¤šçš„ç¯å¢ƒä¸­ï¼Œå¯ä»¥ä½¿ç”¨ -XX:ParallelGCThreads å‚æ•°æ¥é™åˆ¶åƒåœ¾æ”¶é›†çš„çº¿ç¨‹æ•°ã€‚å’Œ Serial æ”¶é›†å™¨ä¸€æ ·å­˜åœ¨ Stop The World é—®é¢˜ã€‚

ç¼ºç‚¹ï¼š

ååé‡å’Œåœé¡¿æ—¶é—´ä¸å¦‚G1ï¼Œæ‰€ä»¥åœ¨JDK9ä¹‹åä¸å»ºè®®ä½¿ç”¨ã€‚

é€‚ç”¨åœºæ™¯ï¼š

JDK8åŠä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œä¸CMSè€å¹´ä»£åƒåœ¾å›æ”¶å™¨æ­é…ä½¿ç”¨

CMS æ”¶é›†å™¨CMS(Concurrent Mark Sweep)ï¼Œä»åå­—ä¸­çš„Mark Sweepè¿™ä¸¤ä¸ªè¯å¯ä»¥çœ‹å‡ºï¼ŒCMS æ”¶é›†å™¨æ˜¯ä¸€ç§ æ ‡è®°-æ¸…é™¤ç®—æ³•å®ç°çš„ã€‚ è€å¹´ä»£æ”¶é›†å™¨ã€‚å‚æ•°ï¼šXX:+UseConcMarkSweepGCã€‚
CMSåƒåœ¾å›æ”¶å™¨å…³æ³¨çš„æ˜¯ç³»ç»Ÿçš„æš‚åœæ—¶é—´ï¼Œå…è®¸ç”¨æˆ·çº¿ç¨‹å’Œåƒåœ¾å›æ”¶çº¿ç¨‹åœ¨æŸäº›æ­¥éª¤ä¸­åŒæ—¶æ‰§è¡Œï¼Œå‡å°‘äº†ç”¨æˆ·çº¿ç¨‹çš„ç­‰å¾…æ—¶é—´ã€‚

CMSæ‰§è¡Œæ­¥éª¤ï¼š
1.åˆå§‹æ ‡è®°ï¼Œç”¨æçŸ­çš„æ—¶é—´æ ‡è®°å‡ºGC Rootsèƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ã€‚é€Ÿåº¦å¾ˆå¿«ä½†æ˜¯ä»å­˜åœ¨Stop The Worldé—®é¢˜ã€‚
2.å¹¶å‘æ ‡è®°,   æ ‡è®°æ‰€æœ‰çš„å¯¹è±¡ï¼Œç”¨æˆ·çº¿ç¨‹ä¸éœ€è¦æš‚åœã€‚
3.é‡æ–°æ ‡è®°ï¼Œç”±äºå¹¶å‘æ ‡è®°é˜¶æ®µæœ‰äº›å¯¹è±¡ä¼šå‘ç”Ÿäº†å˜åŒ–ï¼Œå­˜åœ¨é”™æ ‡ã€æ¼æ ‡ç­‰æƒ…å†µï¼Œéœ€è¦é‡æ–°æ ‡è®°ã€‚å­˜åœ¨Stop The Worldé—®é¢˜ã€‚
4.å¹¶å‘æ¸…ç†ï¼Œæ¸…ç†æ­»äº¡çš„å¯¹è±¡ï¼Œç”¨æˆ·çº¿ç¨‹ä¸éœ€è¦æš‚åœã€‚ä½†æ˜¯æ¸…é™¤çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä»»ç„¶ä¼šæœ‰æ–°çš„åƒåœ¾äº§ç”Ÿï¼Œè¿™äº›åƒåœ¾å°±å«æµ®åŠ¨åƒåœ¾ï¼Œå¦‚æœå½“ç”¨æˆ·éœ€è¦å­˜å…¥ä¸€ä¸ªå¾ˆå¤§çš„å¯¹è±¡æ—¶ï¼Œæ–°ç”Ÿä»£æ”¾ä¸ä¸‹å»ï¼Œè€å¹´ä»£ç”±äºæµ®åŠ¨åƒåœ¾è¿‡å¤šï¼Œå°±ä¼šé€€åŒ–ä¸º serial Old æ”¶é›†å™¨ï¼Œå°†è€å¹´ä»£åƒåœ¾è¿›è¡Œæ ‡è®°-æ•´ç†ï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯å¾ˆè€—è´¹æ—¶é—´çš„ï¼

åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­è€—æ—¶æœ€é•¿çš„å¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…é™¤è¿‡ç¨‹ä¸­ï¼Œæ”¶é›†å™¨çº¿ç¨‹éƒ½å¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·å·¥ä½œï¼Œä¸éœ€è¦è¿›è¡Œåœé¡¿ã€‚
CMS åƒåœ¾å›æ”¶å™¨åœ¨ Java 9 ä¸­å·²ç»è¢«æ ‡è®°ä¸ºè¿‡æ—¶(deprecated)ï¼Œå¹¶åœ¨ Java 14 ä¸­è¢«ç§»é™¤ã€‚

ä¼˜ç‚¹ï¼š

ç³»ç»Ÿç”±äºåƒåœ¾å›æ”¶å‡ºç°çš„åœé¡¿æ—¶é—´è¾ƒçŸ­ï¼Œç”¨æˆ·ä½“éªŒå¥½ã€‚

ç¼ºç‚¹ï¼š

ååé‡ä½: ä½åœé¡¿æ—¶é—´æ˜¯ä»¥ç‰ºç‰²ååé‡ä¸ºä»£ä»·çš„ï¼Œå¯¼è‡´ CPU åˆ©ç”¨ç‡ä¸å¤Ÿé«˜ã€‚

æ— æ³•å¤„ç†åœ¨å¹¶å‘æ¸…ç†è¿‡ç¨‹ä¸­äº§ç”Ÿçš„â€œæµ®åŠ¨åƒåœ¾â€ï¼Œä¸èƒ½åšåˆ°å®Œå…¨çš„åƒåœ¾å›æ”¶ã€‚å¦‚æœé¢„ç•™çš„å†…å­˜ä¸å¤Ÿå­˜æ”¾æµ®åŠ¨åƒåœ¾ï¼Œå°±ä¼šå‡ºç° Concurrent Mode Failureï¼Œè¿™æ—¶è™šæ‹Ÿæœºå°†ä¸´æ—¶å¯ç”¨ Serial Old æ¥æ›¿ä»£ CMSã€‚

æ ‡è®° - æ¸…é™¤ç®—æ³•å¯¼è‡´çš„ç©ºé—´ç¢ç‰‡ï¼Œå¾€å¾€å‡ºç°è€å¹´ä»£ç©ºé—´å‰©ä½™ï¼Œä½†æ— æ³•æ‰¾åˆ°è¶³å¤Ÿå¤§è¿ç»­ç©ºé—´æ¥åˆ†é…å½“å‰å¯¹è±¡ï¼Œä¸å¾—ä¸æå‰è§¦å‘ä¸€æ¬¡ Full GCã€‚


é€‚ç”¨åœºæ™¯:

å¤§å‹çš„äº’è”ç½‘ç³»ç»Ÿä¸­ç”¨æˆ·è¯·æ±‚æ•°æ®é‡å¤§ã€é¢‘ç‡é«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚è®¢å•æ¥å£ã€å•†å“æ¥å£ç­‰

Parallel Scavengeåƒåœ¾å›æ”¶å™¨Parallel Scavengeæ˜¯JDK8é»˜è®¤çš„å¹´è½»ä»£åƒåœ¾å›æ”¶å™¨ï¼Œå¤šçº¿ç¨‹å¹¶è¡Œå›æ”¶ï¼Œå…³æ³¨çš„æ˜¯ç³»ç»Ÿçš„ååé‡ï¼ˆæŒ‡ CPU ç”¨äºè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´å æ€»æ—¶é—´çš„æ¯”å€¼ï¼‰ã€‚å…·å¤‡è‡ªåŠ¨è°ƒæ•´å †å†…å­˜å¤§å°çš„ç‰¹ç‚¹ã€‚ä½¿ç”¨ æ ‡è®°-å¤åˆ¶ç®—æ³•ã€‚
ä¼˜ç‚¹ï¼š

ååé‡é«˜ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªå¼€å…³å‚æ•°æ‰“å¼€ GC è‡ªé€‚åº”çš„è°ƒèŠ‚ç­–ç•¥(GC Ergonomics)ã€‚ä¸ºäº†æé«˜ååé‡ï¼Œè™šæ‹Ÿæœºä¼šåŠ¨æ€è°ƒæ•´å †çš„å‚æ•°ã€‚

GCè‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ï¼šParallel Scavengeæ”¶é›†å™¨å¯è®¾ç½®-XX:+UseAdptiveSizePolicyå‚æ•°ã€‚å½“å¼€å…³æ‰“å¼€æ—¶ä¸éœ€è¦æ‰‹åŠ¨æŒ‡å®šæ–°ç”Ÿä»£çš„å¤§å°ï¼ˆ-Xmnï¼‰ã€Edenä¸SurvivoråŒºçš„æ¯”ä¾‹ï¼ˆ-XX:SurvivorRationï¼‰ã€æ™‹å‡è€å¹´ä»£çš„å¯¹è±¡å¹´é¾„ï¼ˆ-XX:PretenureSizeThresholdï¼‰ç­‰ï¼Œè™šæ‹Ÿæœºä¼šæ ¹æ®ç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µæ”¶é›†æ€§èƒ½ç›‘æ§ä¿¡æ¯ï¼ŒåŠ¨æ€è®¾ç½®è¿™äº›å‚æ•°ä»¥æä¾›æœ€ä¼˜çš„åœé¡¿æ—¶é—´å’Œæœ€é«˜çš„ååé‡ï¼Œè¿™ç§è°ƒèŠ‚æ–¹å¼ç§°ä¸ºGCçš„è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ã€‚



ç¼ºç‚¹ï¼š

ä¸èƒ½ä¿è¯å•æ¬¡çš„åœé¡¿æ—¶é—´ã€‚

é€‚ç”¨åœºæ™¯ï¼š

åå°ä»»åŠ¡ï¼Œä¸éœ€è¦ä¸ç”¨æˆ·äº¤äº’ï¼Œå¹¶ä¸”å®¹æ˜“äº§ç”Ÿå¤§é‡çš„å¯¹è±¡ã€‚æ¯”å¦‚ï¼šå¤§æ•°æ®çš„å¤„ç†ï¼Œå¤§æ–‡ä»¶å¯¼å‡ºã€‚

Parallel Oldåƒåœ¾å›æ”¶å™¨Parallel Scavenge æ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ã€‚ä½¿ç”¨å¤šçº¿ç¨‹å’Œæ ‡è®°-æ•´ç†ç®—æ³•ã€‚åœ¨æ³¨é‡ååé‡ä»¥åŠ CPU èµ„æºçš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼˜å…ˆè€ƒè™‘ Parallel Scavenge æ”¶é›†å™¨å’Œ Parallel Old æ”¶é›†å™¨ã€‚
.wjyviewiwnpn{zoom:80%;}

ä¼˜ç‚¹ï¼š

å¹¶å‘æ”¶é›†ï¼Œåœ¨å¤šæ ¸CPUä¸‹æ•ˆç‡è¾ƒé«˜

ç¼ºç‚¹ï¼š

æš‚åœæ—¶é—´ä¼šæ¯”è¾ƒé•¿

é€‚ç”¨åœºæ™¯ï¼š

ä¸Parallel Scavengeé…å¥—ä½¿ç”¨

G1åƒåœ¾å›æ”¶å™¨JDK9ä¹‹åé»˜è®¤çš„åƒåœ¾å›æ”¶å™¨æ˜¯G1ï¼ˆGarbage Firstï¼‰åƒåœ¾å›æ”¶å™¨ã€‚Parallel Scavengeå…³æ³¨ååé‡ï¼Œå…è®¸ç”¨æˆ·è®¾ç½®æœ€å¤§æš‚åœæ—¶é—´ ï¼Œä½†æ˜¯ä¼šå‡å°‘å¹´è½»ä»£å¯ç”¨ç©ºé—´çš„å¤§å°ã€‚CMSå…³æ³¨æš‚åœæ—¶é—´ï¼Œä½†æ˜¯ååé‡æ–¹é¢ä¼šä¸‹é™ã€‚
è€ŒG1è®¾è®¡ç›®æ ‡å°±æ˜¯å°†ä¸Šè¿°ä¸¤ç§åƒåœ¾å›æ”¶å™¨çš„ä¼˜ç‚¹èåˆï¼š
1.æ”¯æŒå·¨å¤§çš„å †ç©ºé—´å›æ”¶ï¼Œå¹¶æœ‰è¾ƒé«˜çš„ååé‡ã€‚
2.æ”¯æŒå¤šCPUå¹¶è¡Œåƒåœ¾å›æ”¶ã€‚
3.å…è®¸ç”¨æˆ·è®¾ç½®æœ€å¤§æš‚åœæ—¶é—´ã€‚
G1å‡ºç°ä¹‹å‰çš„åƒåœ¾å›æ”¶å™¨ï¼Œå¹´è½»ä»£å’Œè€å¹´ä»£ä¸€èˆ¬æ˜¯è¿ç»­çš„ï¼Œå¦‚ä¸‹å›¾ï¼š
.rlvcyajlvkem{zoom:80%;}

G1çš„æ•´ä¸ªå †ä¼šè¢«åˆ’åˆ†æˆå¤šä¸ªå¤§å°ç›¸ç­‰çš„åŒºåŸŸï¼Œç§°ä¹‹ä¸ºåŒºRegionï¼ŒåŒºåŸŸä¸è¦æ±‚æ˜¯è¿ç»­çš„ã€‚æ¯ä¸ª Region é€»è¾‘ä¸Šå¯å±äº Edenã€Survivorã€Oldæˆ– Humongousï¼ˆå­˜å‚¨å¤§äº Region ä¸€åŠå¤§å°çš„å¯¹è±¡ï¼‰ã€‚Regionçš„å¤§å°é€šè¿‡å †ç©ºé—´å¤§å°&#x2F;2048è®¡ç®—å¾—åˆ°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°-XX:G1HeapRegionSize&#x3D;32mæŒ‡å®š(å…¶ä¸­32mæŒ‡å®šregionå¤§å°ä¸º32M)ï¼ŒRegion sizeå¿…é¡»æ˜¯2çš„æŒ‡æ•°å¹‚ï¼Œå–å€¼èŒƒå›´ä»1Måˆ°32Mã€‚
.ahsvfjnqsdol{zoom:80%;}

G1 æ‰§è¡Œæµç¨‹1. Young GCï¼ˆæ–°ç”Ÿä»£å›æ”¶ï¼‰å¹´è½»ä»£å›æ”¶ï¼ˆYoung GCï¼‰ï¼Œå›æ”¶EdenåŒºå’ŒSurvivoråŒºä¸­ä¸ç”¨çš„å¯¹è±¡ã€‚ä¼šå¯¼è‡´STWï¼ŒG1ä¸­å¯ä»¥é€šè¿‡å‚æ•° -XX:MaxGCPauseMillis=nï¼ˆé»˜è®¤200ï¼‰è®¾ç½®æ¯æ¬¡åƒåœ¾å›æ”¶æ—¶çš„æœ€å¤§æš‚åœæ—¶é—´æ¯«ç§’æ•°ï¼ŒG1åƒåœ¾å›æ”¶å™¨ä¼šå°½å¯èƒ½åœ°ä¿è¯æš‚åœæ—¶é—´ã€‚

è§¦å‘æ¡ä»¶ï¼š
Eden åŒºå æ»¡ï¼Œæˆ– G1 é¢„æµ‹å›æ”¶æ—¶é—´æ¥è¿‘ç›®æ ‡åœé¡¿æ—¶é—´ã€‚

æ­¥éª¤ï¼š

æ–°åˆ›å»ºçš„å¯¹è±¡ä¼šå­˜æ”¾åœ¨EdenåŒºã€‚å½“G1åˆ¤æ–­å¹´è½»ä»£åŒºä¸è¶³ï¼ˆmaxé»˜è®¤60%ï¼‰ï¼Œæ— æ³•åˆ†é…å¯¹è±¡æ—¶éœ€è¦å›æ”¶æ—¶ä¼šæ‰§è¡ŒYoung GCã€‚

æ ‡è®°å‡ºEdenå’ŒSurvivoråŒºåŸŸä¸­çš„å­˜æ´»å¯¹è±¡ã€‚

æ ¹æ®é…ç½®çš„æœ€å¤§æš‚åœæ—¶é—´é€‰æ‹©æŸäº›åŒºåŸŸå°†å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°ä¸€ä¸ªæ–°çš„SurvivoråŒºä¸­ï¼ˆå¹´é¾„+1ï¼‰ï¼Œæ¸…ç©ºè¿™äº›åŒºåŸŸã€‚

G1åœ¨è¿›è¡ŒYoung GCçš„è¿‡ç¨‹ä¸­ä¼šå»è®°å½•æ¯æ¬¡åƒåœ¾å›æ”¶æ—¶æ¯ä¸ªEdenåŒºå’ŒSurvivoråŒºçš„å¹³å‡è€—æ—¶ï¼Œä»¥ä½œä¸ºä¸‹æ¬¡å›æ”¶æ—¶çš„å‚è€ƒä¾æ®ã€‚è¿™æ ·å°±å¯ä»¥æ ¹æ®é…ç½®çš„æœ€å¤§æš‚åœæ—¶é—´è®¡ç®—å‡ºæœ¬æ¬¡å›æ”¶æ—¶æœ€å¤šèƒ½å›æ”¶å¤šå°‘ä¸ªRegionåŒºåŸŸäº†ã€‚æ¯”å¦‚ -XX:MaxGCPauseMillis&#x3D;nï¼ˆé»˜è®¤200ï¼‰ï¼Œæ¯ä¸ªRegionå›æ”¶è€—æ—¶40msï¼Œé‚£ä¹ˆè¿™æ¬¡å›æ”¶æœ€å¤šåªèƒ½å›æ”¶4ä¸ªRegionã€‚


åç»­Young GCæ—¶ä¸ä¹‹å‰ç›¸åŒï¼Œåªä¸è¿‡SurvivoråŒºä¸­å­˜æ´»å¯¹è±¡ä¼šè¢«æ¬è¿åˆ°å¦ä¸€ä¸ªSurvivoråŒºã€‚

å½“æŸä¸ªåœ¨SurvivoråŒºå­˜æ´»å¯¹è±¡çš„å¹´é¾„åˆ°è¾¾é˜ˆå€¼ï¼ˆé»˜è®¤15ï¼‰ï¼Œå°†è¢«æ”¾å…¥è€å¹´ä»£ã€‚

éƒ¨åˆ†å¯¹è±¡å¦‚æœå¤§å°è¶…è¿‡Regionçš„ä¸€åŠï¼Œä¼šç›´æ¥æ”¾å…¥è€å¹´ä»£ï¼Œè¿™ç±»è€å¹´ä»£è¢«ç§°ä¸ºHumongousåŒºã€‚æ¯”å¦‚å †å†…å­˜æ˜¯4Gï¼Œæ¯ä¸ªRegionæ˜¯2Mï¼Œåªè¦ä¸€ä¸ªå¤§å¯¹è±¡è¶…è¿‡äº†1Må°±è¢«æ”¾å…¥HumongousåŒºï¼Œå¦‚æœå¯¹è±¡è¿‡å¤§ä¼šæ¨ªè·¨å¤šä¸ªRegionã€‚

å¤šæ¬¡å›æ”¶ä¹‹åï¼Œä¼šå‡ºç°å¾ˆå¤šOldè€å¹´ä»£åŒºï¼Œæ­¤æ—¶æ€»å †å æœ‰ç‡è¾¾åˆ°é˜ˆå€¼æ—¶ï¼ˆ-XX:InitiatingHeapOccupancyPercenté»˜è®¤45%ï¼‰ä¼šè§¦å‘æ··åˆå›æ”¶MixedGCã€‚å›æ”¶æ‰€æœ‰å¹´è½»ä»£å’Œéƒ¨åˆ†è€å¹´ä»£çš„å¯¹è±¡ä»¥åŠå¤§å¯¹è±¡åŒºã€‚é‡‡ç”¨å¤åˆ¶ç®—æ³•æ¥å®Œæˆã€‚




2. Mixed GCï¼ˆæ··åˆå›æ”¶ï¼Œæ ¸å¿ƒæµç¨‹ï¼‰
è§¦å‘æ¡ä»¶ï¼š
è€å¹´ä»£å ç”¨è¾¾ 45%ï¼ˆé»˜è®¤ï¼‰æˆ–æ‰‹åŠ¨è§¦å‘ã€‚G1å¯¹è€å¹´ä»£çš„æ¸…ç†ä¼šé€‰æ‹©å­˜æ´»åº¦æœ€ä½çš„åŒºåŸŸæ¥è¿›è¡Œå›æ”¶ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å›æ”¶æ•ˆç‡æœ€é«˜ï¼Œè¿™ä¹Ÿæ˜¯G1ï¼ˆGarbage firstï¼‰åç§°çš„ç”±æ¥ã€‚æœ€åæ¸…ç†é˜¶æ®µä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚

æ­¥éª¤ï¼š

åˆå§‹æ ‡è®°ï¼ˆSTWï¼‰ï¼šé‡‡ç”¨ä¸‰è‰²æ ‡è®°æ³•æ ‡è®°ä»GC Rootå¯ç›´è¾¾çš„å¯¹è±¡ã€‚ STWæ—¶é—´æçŸ­ã€‚
å¹¶å‘æ ‡è®°ï¼ˆå¹¶è¡Œï¼‰ï¼šé€’å½’æ ‡è®°æ‰€æœ‰å­˜æ´»å¯¹è±¡ï¼Œä½¿ç”¨ SATBï¼ˆå¿«ç…§ï¼‰è®°å½•å¼•ç”¨å˜åŒ–ï¼Œé¿å…æ¼æ ‡ã€‚
æœ€ç»ˆæ ‡è®°ï¼ˆSTWï¼‰ï¼šå¤„ç†å¹¶å‘æ ‡è®°æœŸé—´çš„å¼•ç”¨å˜æ›´ï¼Œä¿®å¤æ¼æ ‡ã€‚
ç­›é€‰å›æ”¶ï¼ˆSTWï¼‰ï¼š
æŒ‰ â€œå›æ”¶æ”¶ç›Šâ€ æ’åº Regionï¼Œé€‰æ‹©å›æ”¶é›†åˆï¼ˆCSetï¼‰ã€‚
å¤åˆ¶å­˜æ´»å¯¹è±¡åˆ°æ–° Regionï¼Œæ¸…ç©ºåŸ Regionã€‚






æ³¨æ„ï¼šå¦‚æœæ¸…ç†è¿‡ç¨‹ä¸­å‘ç°æ²¡æœ‰è¶³å¤Ÿçš„ç©ºRegionå­˜æ”¾è½¬ç§»çš„å¯¹è±¡ï¼Œä¼šå‡ºç°Full GCã€‚å•çº¿ç¨‹æ‰§è¡Œæ ‡è®°-æ•´ç†ç®—æ³•ï¼Œæ­¤æ—¶ä¼šå¯¼è‡´ç”¨æˆ·çº¿ç¨‹çš„æš‚åœã€‚æ‰€ä»¥å°½é‡ä¿è¯åº”è¯¥ç”¨çš„å †å†…å­˜æœ‰ä¸€å®šå¤šä½™çš„ç©ºé—´ã€‚
3. Full GC
è§¦å‘æ¡ä»¶ï¼š

G1 åœ¨è€å¹´ä»£å†…å­˜ä¸è¶³æ—¶ï¼ˆè€å¹´ä»£æ‰€å å†…å­˜è¶…è¿‡é˜ˆå€¼ï¼‰ã€‚
å¦‚æœåƒåœ¾äº§ç”Ÿé€Ÿåº¦æ…¢äºåƒåœ¾å›æ”¶é€Ÿåº¦ï¼Œä¸ä¼šè§¦å‘ Full GCï¼Œè¿˜æ˜¯å¹¶å‘åœ°è¿›è¡Œæ¸…ç†
å¦‚æœåƒåœ¾äº§ç”Ÿé€Ÿåº¦å¿«äºåƒåœ¾å›æ”¶é€Ÿåº¦ï¼Œä¾¿ä¼šè§¦å‘ Full GCï¼Œç„¶åé€€åŒ–æˆ serial Old æ”¶é›†å™¨ä¸²è¡Œçš„æ”¶é›†ï¼Œå°±ä¼šå¯¼è‡´åœé¡¿çš„æ—¶å€™é•¿ã€‚


ç‰¹ç‚¹ï¼š


å•çº¿ç¨‹å…¨å †æ‰«æï¼Œåœé¡¿æ—¶é—´æé•¿ï¼Œéœ€é€šè¿‡è°ƒä¼˜é¿å…
å­¦ä¹ æ–‡çŒ®

https://blog.csdn.net/weixin_50280576/article/details/113775575
https://lisxpq12rl7.feishu.cn/wiki/F2AFw0doOiW89Fkr8kGcCTyVnLh
https://pdai.tech/md/java/jvm/java-jvm-x-overview.html
https://javaguide.cn/java/jvm/jvm-garbage-collection.html
https://javabetter.cn/jvm/jit.html

]]></content>
      <categories>
        <category>JAVA</category>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Javaè¿›é˜¶ å­¦ä¹ ç¬”è®°</tag>
      </tags>
  </entry>
</search>
